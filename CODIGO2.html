<!-- Basic Info Tab -->
<div id="basic-tab" class="tab-content active">
    <h2 style="color: #ffd700; margin-bottom: 2rem;">üìã Informaci√≥n B√°sica</h2>
    
    <div class="form-grid">
        <div class="form-group">
            <label class="form-label">Nombre del Personaje</label>
            <input type="text" class="form-input" id="characterName" placeholder="Ej: Nombre del Personaje" 
                   onchange="updateCharacterDisplay()" oninput="updateCharacterDisplay()">
        </div>
        
        <div class="form-group">
            <label class="form-label">Jugador</label>
            <input type="text" class="form-input" id="playerName" placeholder="Tu nombre">
        </div>
        
        <div class="form-group">
            <label class="form-label">Raza</label>
            <select class="form-input" id="race" onchange="updateCharacterDisplay(); updateAllBasicStats();">
                <option value="">Selecciona Raza</option>
                <option value="humano">Humano</option>
                <option value="elfo">Elfo</option>
                <option value="enano">Enano</option>
                <option value="mediano">Mediano</option>
                <option value="orco">Orco</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Alineamiento</label>
            <select class="form-input" id="alignment">
                <option value="LB">Legal Bueno</option>
                <option value="NB">Neutral Bueno</option>
                <option value="CB">Ca√≥tico Bueno</option>
                <option value="LN">Legal Neutral</option>
                <option value="N" selected>Neutral Aut√©ntico</option>
                <option value="CN">Ca√≥tico Neutral</option>
                <option value="LM">Legal Malvado</option>
                <option value="NM">Neutral Malvado</option>
                <option value="CM">Ca√≥tico Malvado</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Altura (cm)</label>
            <input type="number" class="form-input" id="characterHeight" min="1" max="30000" 
                   placeholder="Ej: 175" onchange="updateCharacterSize()" oninput="updateCharacterSize()">
        </div>

        <div class="form-group">
            <label class="form-label">Tama√±o</label>
            <input type="text" class="form-input" id="characterSize" value="Mediano" readonly>
        </div>

        <div class="form-group">
            <label class="form-label">Religi√≥n</label>
            <select class="form-input" id="religion">
                <option value="">Sin religi√≥n</option>
                <option value="ao">Ao (El Oculto)</option>
                <option value="lathander">Lathander</option>
                <option value="gond">Gond</option>
                <option value="tyr">Tyr</option>
                <option value="helm">Helm</option>
                <option value="tempus">Tempus</option>
                <option value="mystra">Mystra</option>
                <option value="selune">Sel√ªne</option>
                <option value="shar">Shar</option>
                <option value="cyric">Cyric</option>
                <option value="bane">Bane</option>
                <option value="bhaal">Bhaal</option>
                <option value="myrkul">Myrkul</option>
                <option value="kelemvor">Kelemvor</option>
                <option value="otro">Otro</option>
            </select>
        </div>
        
        <div class="form-group">
            <label class="form-label">Experiencia</label>
            <input type="number" class="form-input" id="experience" value="0" min="0"
                   onchange="updateFromXP()" oninput="updateFromXP()">
        </div>
        
        <div class="form-group">
            <label class="form-label">Nivel</label>
            <input type="number" class="form-input" id="Level" value="1" min="1" max="20"
                   onchange="updateFromLevel()" oninput="updateFromLevel()">
        </div>
    </div>

    <!-- Salvaciones -->
    <div class="combat-section">
        <h3 style="color: #ffd700; margin-bottom: 1rem;">üõ°Ô∏è Tiradas de Salvaci√≥n</h3>
        
        <!-- Encabezados -->
        <div class="saves-headers">
            <div class="save-type-header">Tipo de Salvaci√≥n</div>
            <div class="save-data-headers">
                <span class="header-item">Base</span>
                <span class="header-item">Mod1</span>
                <span class="header-item">Mod2</span>
                <span class="header-item">Total</span>
            </div>
        </div>
        
        <div class="saving-throws-vertical" id="saving-throws">
            <div class="saving-throw-row">
                <div class="save-type-name">Par√°lisis/Veneno/Muerte</div>
                <div class="save-data-row">
                    <span class="save-value" id="save-paralysis-base">14</span>
                    <input type="number" id="save-paralysis-mod1" value="0" class="save-modifier-input" 
                           oninput="updateSavingThrows()">
                    <input type="number" id="save-paralysis-mod2" value="0" class="save-modifier-input" 
                           oninput="updateSavingThrows()">
                    <span class="save-total-value" id="save-paralysis-total">14</span>
                </div>
            </div>
            
            <div class="saving-throw-row">
                <div class="save-type-name">Cetros/Varas/Varitas</div>
                <div class="save-data-row">
                    <span class="save-value" id="save-rods-base">16</span>
                    <input type="number" id="save-rods-mod1" value="0" class="save-modifier-input" 
                           oninput="updateSavingThrows()">
                    <input type="number" id="save-rods-mod2" value="0" class="save-modifier-input" 
                           oninput="updateSavingThrows()">
                    <span class="save-total-value" id="save-rods-total">16</span>
                </div>
            </div>
            
            <div class="saving-throw-row">
                <div class="save-type-name">Petrificaci√≥n/Polimorfismo</div>
                <div class="save-data-row">
                    <span class="save-value" id="save-petrification-base">12</span>
                    <input type="number" id="save-petrification-mod1" value="0" class="save-modifier-input" 
                           oninput="updateSavingThrows()">
                    <input type="number" id="save-petrification-mod2" value="0" class="save-modifier-input" 
                           oninput="updateSavingThrows()">
                    <span class="save-total-value" id="save-petrification-total">12</span>
                </div>
            </div>
            
            <div class="saving-throw-row">
                <div class="save-type-name">Arma de Aliento</div>
                <div class="save-data-row">
                    <span class="save-value" id="save-breath-base">17</span>
                    <input type="number" id="save-breath-mod1" value="0" class="save-modifier-input" 
                           oninput="updateSavingThrows()">
                    <input type="number" id="save-breath-mod2" value="0" class="save-modifier-input" 
                           oninput="updateSavingThrows()">
                    <span class="save-total-value" id="save-breath-total">17</span>
                </div>
            </div>
            
            <div class="saving-throw-row">
                <div class="save-type-name">Conjuros</div>
                <div class="save-data-row">
                    <span class="save-value" id="save-spells-base">17</span>
                    <input type="number" id="save-spells-mod1" value="0" class="save-modifier-input" 
                           oninput="updateSavingThrows()">
                    <input type="number" id="save-spells-mod2" value="0" class="save-modifier-input" 
                           oninput="updateSavingThrows()">
                    <span class="save-total-value" id="save-spells-total">17</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Stats Display -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-value-container">
                <div class="stat-value" id="totalHP">10</div>
                <div class="stat-detail" id="hp-breakdown">Base: 10</div>
                <input type="number" id="hp-manual-bonus" value="0" class="manual-bonus-input" 
                       placeholder="Bonus" oninput="updateHitPoints()">
            </div>
            <div class="stat-label">Puntos de Golpe</div>
        </div>
        
        <!-- Man√° Arcano - Solo para Hechiceros -->
        <div class="stat-card mana-card" id="arcane-mana-card" style="display: none;">
            <div class="stat-value-container">
                <div class="stat-value" id="arcaneMana">0</div>
                <div class="stat-detail" id="arcane-mana-breakdown">0/0</div>
                <input type="number" id="arcane-mana-manual" value="0" class="manual-bonus-input" 
                       placeholder="Bonus" oninput="updateArcaneMana()">
            </div>
            <div class="stat-label">Man√° Arcano</div>
        </div>
        
        <!-- Man√° Divino - Solo para Sacerdotes -->
        <div class="stat-card mana-card" id="divine-mana-card" style="display: none;">
            <div class="stat-value-container">
                <div class="stat-value" id="divineMana">0</div>
                <div class="stat-detail" id="divine-mana-breakdown">0/0</div>
                <input type="number" id="divine-mana-manual" value="0" class="manual-bonus-input" 
                       placeholder="Bonus" oninput="updateDivineMana()">
            </div>
            <div class="stat-label">Man√° Divino</div>
        </div>
        
        <!-- Pool PSP - Solo para Psi√≥nicos -->
        <div class="stat-card psp-card" id="psp-card" style="display: none;">
            <div class="stat-value-container">
                <div class="stat-value" id="pspPool">0</div>
                <div class="stat-detail" id="psp-breakdown">Base + Mods</div>
                <input type="number" id="psp-manual" value="0" class="manual-bonus-input" 
                       placeholder="Bonus" oninput="updatePSPPool()">
            </div>
            <div class="stat-label">Pool PSP</div>
        </div>
    </div>

    <!-- Informaci√≥n de Progreso XP/Nivel -->
    <div class="xp-progress-section">
        <div id="nextLevelInfo" class="next-level-info">
            <strong>Nivel 1</strong><br>
            <small>Selecciona clases para ver progreso XP</small>
        </div>
    </div>
</div>

<style>
/* Estilos espec√≠ficos para el Tab B√°sico */

/* Grid de formularios */
.form-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.form-label {
    font-weight: 600;
    color: #ffd700;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.form-input {
    padding: 0.8rem 1rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
    color: #e5e5e5;
    font-size: 1rem;
    transition: all 0.3s ease;
}

.form-input:focus {
    outline: none;
    border-color: #ffd700;
    background: rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
}

/* Secci√≥n de combate (salvaciones) */
.combat-section {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

/* Salvaciones - Headers */
.saves-headers {
    display: flex;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.8rem 1rem;
    background: rgba(0, 150, 0, 0.15);
    border-radius: 8px;
    border: 1px solid rgba(0, 150, 0, 0.3);
}

.save-type-header {
    color: #90EE90;
    font-weight: bold;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    flex: 2;
}

.save-data-headers {
    display: flex;
    align-items: center;
    gap: 2rem;
    flex: 3;
}

.header-item {
    color: #90EE90;
    font-weight: bold;
    font-size: 0.85rem;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    text-align: center;
    min-width: 60px;
}

/* Salvaciones - Filas */
.saving-throws-vertical {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.saving-throw-row {
    background: rgba(0, 150, 0, 0.08);
    border: 1px solid rgba(0, 150, 0, 0.25);
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: all 0.3s ease;
}

.saving-throw-row:hover {
    background: rgba(0, 150, 0, 0.12);
    border-color: rgba(0, 150, 0, 0.4);
    transform: translateX(3px);
}

.save-type-name {
    color: #e5e5e5;
    font-weight: 600;
    font-size: 0.95rem;
    flex: 2;
    min-width: 200px;
}

.save-data-row {
    display: flex;
    align-items: center;
    gap: 2rem;
    flex: 3;
}

.save-value {
    color: #00FF7F;
    font-weight: bold;
    font-size: 1.1rem;
    min-width: 60px;
    text-align: center;
    background: rgba(0, 255, 127, 0.1);
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    border: 1px solid rgba(0, 255, 127, 0.3);
}

.save-modifier-input {
    width: 60px;
    padding: 0.4rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: #e5e5e5;
    font-size: 0.9rem;
    text-align: center;
    font-weight: 500;
}

.save-modifier-input:focus {
    outline: none;
    border-color: #ffd700;
    background: rgba(255, 255, 255, 0.1);
    box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
}

.save-total-value {
    color: #ffd700;
    font-weight: bold;
    font-size: 1.2rem;
    min-width: 60px;
    text-align: center;
    background: rgba(255, 215, 0, 0.15);
    padding: 0.4rem 0.8rem;
    border-radius: 8px;
    border: 2px solid rgba(255, 215, 0, 0.4);
}

/* Stats Cards */
.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1.5rem;
    margin: 2rem 0;
}

.stat-card {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    border-color: rgba(255, 215, 0, 0.3);
}

.stat-value-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
}

.stat-value {
    font-size: 2rem;
    font-weight: 700;
    color: #ffd700;
    margin-bottom: 0.5rem;
}

.stat-label {
    color: #b0b0b0;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-detail {
    font-size: 0.8rem;
    color: #b0b0b0;
    text-align: center;
    min-height: 20px;
    font-weight: 500;
}

.manual-bonus-input {
    width: 70px;
    padding: 0.3rem;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    color: #e5e5e5;
    font-size: 0.8rem;
    text-align: center;
    margin-top: 0.3rem;
}

.manual-bonus-input:focus {
    outline: none;
    border-color: #ffd700;
    background: rgba(255, 255, 255, 0.12);
    box-shadow: 0 0 8px rgba(255, 215, 0, 0.2);
}

.manual-bonus-input::placeholder {
    color: #666;
    font-size: 0.7rem;
}

/* Cards especializados */
.mana-card {
    border: 2px solid rgba(138, 43, 226, 0.4);
    background: linear-gradient(135deg, rgba(75, 0, 130, 0.15), rgba(138, 43, 226, 0.15));
}

.psp-card {
    border: 2px solid rgba(199, 21, 133, 0.4);
    background: linear-gradient(135deg, rgba(255, 20, 147, 0.15), rgba(199, 21, 133, 0.15));
}

/* Progreso XP */
.xp-progress-section {
    margin-top: 2rem;
    display: flex;
    justify-content: center;
}

.next-level-info {
    max-width: 500px;
    padding: 1rem;
    background: rgba(255, 215, 0, 0.1);
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 8px;
    font-size: 0.9rem;
    color: #ffd700;
    line-height: 1.5;
    text-align: center;
}

.progress-bar {
    width: 100%;
    height: 8px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
    margin-top: 8px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #ffd700, #ffed4e);
    transition: width 0.3s ease;
    border-radius: 4px;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .saves-headers {
        flex-direction: column;
        gap: 0.8rem;
        text-align: center;
    }
    
    .save-data-headers {
        justify-content: center;
    }
    
    .saving-throw-row {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .save-type-name {
        min-width: auto;
    }
    
    .save-data-row {
        justify-content: center;
        flex-wrap: wrap;
        gap: 1rem;
    }
}

@media (max-width: 768px) {
    .stats-row {
        grid-template-columns: 1fr;
    }
    
    .save-data-row {
        gap: 0.8rem;
    }
    
    .header-item {
        min-width: 50px;
        font-size: 0.8rem;
    }
    
    .form-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .saves-headers {
        padding: 0.6rem;
    }
    
    .saving-throw-row {
        padding: 0.8rem;
    }
    
    .save-data-headers {
        gap: 1rem;
    }
    
    .save-data-row {
        gap: 0.6rem;
    }
}
</style>

<script>
// Funciones para el Tab B√°sico

// Actualizar display del personaje en el sidebar
function updateCharacterDisplay() {
    const name = document.getElementById('characterName').value;
    const race = document.getElementById('race').value;
    
    // Actualizar nombre
    const nameDisplay = document.getElementById('characterNameDisplay');
    if (nameDisplay) {
        nameDisplay.textContent = name || 'Nuevo Personaje';
    }
    
    // Actualizar informaci√≥n de clase (se obtiene de los dropdowns del sidebar)
    updateClassDisplay();
    
    // Actualizar avatar basado en raza
    updateCharacterAvatar(race);
}

function updateCharacterAvatar(race) {
    const avatar = document.getElementById('characterAvatar');
    if (avatar) {
        const avatars = {
            'humano': 'üßë',
            'elfo': 'üßù',
            'enano': 'üë®‚Äçü¶≤',
            'mediano': 'üë¶',
            'orco': 'üëπ'
        };
        avatar.textContent = avatars[race] || 'üë§';
    }
}

function updateClassDisplay() {
    const classDisplay = document.getElementById('characterClassDisplay');
    if (classDisplay) {
        const primaryClass = document.getElementById('primary-selected-name')?.textContent;
        if (primaryClass && primaryClass !== 'Selecciona una clase') {
            classDisplay.textContent = primaryClass;
        } else {
            classDisplay.textContent = 'Selecciona una clase';
        }
    }
}

// Actualizar tama√±o del personaje basado en altura
function updateCharacterSize() {
    const height = parseInt(document.getElementById('characterHeight').value);
    const sizeField = document.getElementById('characterSize');
    
    if (!height || !sizeField) return;
    
    let size = 'Mediano';
    if (height < 60) size = 'Diminuto';
    else if (height < 120) size = 'Menudo';
    else if (height < 150) size = 'Peque√±o';
    else if (height < 240) size = 'Mediano';
    else if (height < 360) size = 'Grande';
    else if (height < 480) size = 'Enorme';
    else if (height < 720) size = 'Gargantuesco';
    else size = 'Colosal';
    
    sizeField.value = size;
}

// Actualizar desde XP
function updateFromXP() {
    const xp = parseInt(document.getElementById('experience').value) || 0;
    const levelField = document.getElementById('Level');
    
    // Tabla b√°sica de XP (se puede expandir seg√∫n las clases)
    const xpTable = [0, 2000, 4000, 8000, 16000, 32000, 64000, 125000, 250000, 500000, 750000, 1000000];
    
    let level = 1;
    for (let i = 0; i < xpTable.length; i++) {
        if (xp >= xpTable[i]) {
            level = i + 1;
        }
    }
    
    levelField.value = Math.min(level, 20);
    updateLevelDisplay();
    updateSavingThrowsFromLevel();
}

// Actualizar desde Nivel
function updateFromLevel() {
    const level = parseInt(document.getElementById('Level').value) || 1;
    updateLevelDisplay();
    updateSavingThrowsFromLevel();
}

function updateLevelDisplay() {
    const level = parseInt(document.getElementById('Level').value) || 1;
    const levelDisplay = document.getElementById('characterLevelDisplay');
    if (levelDisplay) {
        levelDisplay.textContent = level;
    }
}

// Sistema de salvaciones
function updateSavingThrowsFromLevel() {
    const level = parseInt(document.getElementById('Level').value) || 1;
    
    // Valores base para nivel 1 (se pueden ajustar seg√∫n la clase)
    const baseSaves = {
        paralysis: 14,
        rods: 16, 
        petrification: 12,
        breath: 17,
        spells: 17
    };
    
    // Mejorar salvaciones por nivel (aproximaci√≥n general)
    const levelBonus = Math.floor((level - 1) / 3);
    
    document.getElementById('save-paralysis-base').textContent = Math.max(2, baseSaves.paralysis - levelBonus);
    document.getElementById('save-rods-base').textContent = Math.max(2, baseSaves.rods - levelBonus);
    document.getElementById('save-petrification-base').textContent = Math.max(2, baseSaves.petrification - levelBonus);
    document.getElementById('save-breath-base').textContent = Math.max(2, baseSaves.breath - levelBonus);
    document.getElementById('save-spells-base').textContent = Math.max(2, baseSaves.spells - levelBonus);
    
    updateSavingThrows();
}

function updateSavingThrows() {
    const saveTypes = ['paralysis', 'rods', 'petrification', 'breath', 'spells'];
    
    saveTypes.forEach(type => {
        const base = parseInt(document.getElementById(`save-${type}-base`).textContent) || 0;
        const mod1 = parseInt(document.getElementById(`save-${type}-mod1`).value) || 0;
        const mod2 = parseInt(document.getElementById(`save-${type}-mod2`).value) || 0;
        const total = Math.max(2, base + mod1 + mod2);
        
        document.getElementById(`save-${type}-total`).textContent = total;
    });
}

// Sistema de puntos de golpe
function updateHitPoints() {
    const level = parseInt(document.getElementById('Level').value) || 1;
    const manualBonus = parseInt(document.getElementById('hp-manual-bonus').value) || 0;
    
    // HP base (se puede mejorar con constituci√≥n y clase)
    const baseHP = 10 + (level - 1) * 5; // Aproximaci√≥n b√°sica
    const totalHP = baseHP + manualBonus;
    
    document.getElementById('totalHP').textContent = totalHP;
    document.getElementById('hp-breakdown').textContent = `Base: ${baseHP} + Bonus: ${manualBonus}`;
}

// Sistemas de man√° (para clases espec√≠ficas)
function updateArcaneMana() {
    // Implementar seg√∫n la l√≥gica de clases de hechicero
    console.log('Actualizando man√° arcano');
}

function updateDivineMana() {
    // Implementar seg√∫n la l√≥gica de clases de sacerdote
    console.log('Actualizando man√° divino');
}

function updatePSPPool() {
    // Implementar seg√∫n la l√≥gica de clases psi√≥nicas
    console.log('Actualizando pool PSP');
}

// Funci√≥n general para actualizar todos los stats b√°sicos
function updateAllBasicStats() {
    updateCharacterDisplay();
    updateCharacterSize();
    updateFromLevel();
    updateHitPoints();
    updateSavingThrows();
    showClassSpecificStats();
}

// Mostrar stats espec√≠ficos por clase
function showClassSpecificStats() {
    // Ocultar todos los cards especiales por defecto
    const arcaneCard = document.getElementById('arcane-mana-card');
    const divineCard = document.getElementById('divine-mana-card');
    const pspCard = document.getElementById('psp-card');
    
    if (arcaneCard) arcaneCard.style.display = 'none';
    if (divineCard) divineCard.style.display = 'none';
    if (pspCard) pspCard.style.display = 'none';
    
    // Obtener clases seleccionadas
    const primaryClass = document.getElementById('primary-selected-name')?.textContent;
    const secondaryClass = document.getElementById('secondary-selected-name')?.textContent;
    const tertiaryClass = document.getElementById('tertiary-selected-name')?.textContent;
    
    // Definir categor√≠as de lanzadores
    const arcaneCasters = ['Mago', 'Hechicero', 'Bruja', 'Art√≠fice'];
    const divineCasters = ['Cl√©rigo', 'Druida', 'Cham√°n', 'Palad√≠n', 'Ranger'];
    const psionicCasters = ['Psi√≥nico'];
    
    // Mostrar cards apropiados
    const allClasses = [primaryClass, secondaryClass, tertiaryClass].filter(c => c && c !== 'Selecciona una clase' && c !== 'Sin categor√≠a secundaria' && c !== 'Sin categor√≠a terciaria');
    
    if (allClasses.some(c => arcaneCasters.includes(c))) {
        if (arcaneCard) arcaneCard.style.display = 'block';
        updateArcaneMana();
    }
    
    if (allClasses.some(c => divineCasters.includes(c))) {
        if (divineCard) divineCard.style.display = 'block';
        updateDivineMana();
    }
    
    if (allClasses.some(c => psionicCasters.includes(c))) {
        if (pspCard) pspCard.style.display = 'block';
        updatePSPPool();
    }
}

// Actualizar informaci√≥n de progreso XP
function updateXPProgressInfo() {
    const level = parseInt(document.getElementById('Level').value) || 1;
    const xp = parseInt(document.getElementById('experience').value) || 0;
    const infoDiv = document.getElementById('nextLevelInfo');
    
    if (!infoDiv) return;
    
    // Tabla b√°sica de XP - se puede expandir seg√∫n las clases
    const xpTable = [0, 2000, 4000, 8000, 16000, 32000, 64000, 125000, 250000, 500000, 750000, 1000000];
    
    if (level >= 20) {
        infoDiv.innerHTML = `
            <strong>Nivel M√°ximo Alcanzado</strong><br>
            <small>XP Total: ${xp.toLocaleString()}</small>
        `;
        return;
    }
    
    const currentLevelXP = xpTable[level - 1] || 0;
    const nextLevelXP = xpTable[level] || xpTable[xpTable.length - 1];
    const xpNeeded = nextLevelXP - xp;
    const progress = Math.max(0, Math.min(100, ((xp - currentLevelXP) / (nextLevelXP - currentLevelXP)) * 100));
    
    infoDiv.innerHTML = `
        <strong>Nivel ${level}</strong><br>
        <small>XP: ${xp.toLocaleString()} / ${nextLevelXP.toLocaleString()}</small><br>
        <small>Faltan ${xpNeeded.toLocaleString()} XP para nivel ${level + 1}</small>
        <div class="progress-bar">
            <div class="progress-fill" style="width: ${progress}%"></div>
        </div>
    `;
}

// Funciones mejoradas de man√° y PSP
function updateArcaneMana() {
    const level = parseInt(document.getElementById('Level').value) || 1;
    const manualBonus = parseInt(document.getElementById('arcane-mana-manual')?.value) || 0;
    
    // C√°lculo b√°sico de man√° arcano (se puede ajustar seg√∫n la clase espec√≠fica)
    const baseMana = level * 10 + 20; // Ejemplo: 30 man√° al nivel 1
    const totalMana = baseMana + manualBonus;
    
    const manaElement = document.getElementById('arcaneMana');
    const breakdownElement = document.getElementById('arcane-mana-breakdown');
    
    if (manaElement) manaElement.textContent = totalMana;
    if (breakdownElement) breakdownElement.textContent = `${baseMana}/${totalMana}`;
}

function updateDivineMana() {
    const level = parseInt(document.getElementById('Level').value) || 1;
    const manualBonus = parseInt(document.getElementById('divine-mana-manual')?.value) || 0;
    
    // C√°lculo b√°sico de man√° divino
    const baseMana = level * 8 + 15; // Ejemplo: 23 man√° al nivel 1
    const totalMana = baseMana + manualBonus;
    
    const manaElement = document.getElementById('divineMana');
    const breakdownElement = document.getElementById('divine-mana-breakdown');
    
    if (manaElement) manaElement.textContent = totalMana;
    if (breakdownElement) breakdownElement.textContent = `${baseMana}/${totalMana}`;
}

function updatePSPPool() {
    const level = parseInt(document.getElementById('Level').value) || 1;
    const manualBonus = parseInt(document.getElementById('psp-manual')?.value) || 0;
    
    // C√°lculo b√°sico de PSP
    const basePSP = level * 12 + 18; // Ejemplo: 30 PSP al nivel 1
    const totalPSP = basePSP + manualBonus;
    
    const pspElement = document.getElementById('pspPool');
    const breakdownElement = document.getElementById('psp-breakdown');
    
    if (pspElement) pspElement.textContent = totalPSP;
    if (breakdownElement) breakdownElement.textContent = `Base ${basePSP} + Bonus ${manualBonus}`;
}

// Inicializaci√≥n cuando se carga el tab
function initializeBasicTab() {
    // Configurar event listeners adicionales
    const experienceField = document.getElementById('experience');
    const levelField = document.getElementById('Level');
    
    if (experienceField) {
        experienceField.addEventListener('input', updateXPProgressInfo);
    }
    
    if (levelField) {
        levelField.addEventListener('input', updateXPProgressInfo);
    }
    
    // Actualizar todo al inicializar
    updateAllBasicStats();
    updateXPProgressInfo();
}

// Funci√≥n para validar campos
function validateBasicFields() {
    const name = document.getElementById('characterName').value.trim();
    const race = document.getElementById('race').value;
    const level = parseInt(document.getElementById('Level').value);
    
    const errors = [];
    
    if (!name) errors.push('El nombre del personaje es requerido');
    if (!race) errors.push('Debe seleccionar una raza');
    if (level < 1 || level > 20) errors.push('El nivel debe estar entre 1 y 20');
    
    if (errors.length > 0) {
        showNotification('Errores de validaci√≥n:\n' + errors.join('\n'));
        return false;
    }
    
    return true;
}

// Funci√≥n para exportar datos del tab b√°sico
function exportBasicTabData() {
    return {
        name: document.getElementById('characterName').value,
        player: document.getElementById('playerName').value,
        race: document.getElementById('race').value,
        alignment: document.getElementById('alignment').value,
        height: document.getElementById('characterHeight').value,
        size: document.getElementById('characterSize').value,
        religion: document.getElementById('religion').value,
        experience: document.getElementById('experience').value,
        level: document.getElementById('Level').value,
        savingThrows: {
            paralysis: {
                base: document.getElementById('save-paralysis-base').textContent,
                mod1: document.getElementById('save-paralysis-mod1').value,
                mod2: document.getElementById('save-paralysis-mod2').value,
                total: document.getElementById('save-paralysis-total').textContent
            },
            rods: {
                base: document.getElementById('save-rods-base').textContent,
                mod1: document.getElementById('save-rods-mod1').value,
                mod2: document.getElementById('save-rods-mod2').value,
                total: document.getElementById('save-rods-total').textContent
            },
            petrification: {
                base: document.getElementById('save-petrification-base').textContent,
                mod1: document.getElementById('save-petrification-mod1').value,
                mod2: document.getElementById('save-petrification-mod2').value,
                total: document.getElementById('save-petrification-total').textContent
            },
            breath: {
                base: document.getElementById('save-breath-base').textContent,
                mod1: document.getElementById('save-breath-mod1').value,
                mod2: document.getElementById('save-breath-mod2').value,
                total: document.getElementById('save-breath-total').textContent
            },
            spells: {
                base: document.getElementById('save-spells-base').textContent,
                mod1: document.getElementById('save-spells-mod1').value,
                mod2: document.getElementById('save-spells-mod2').value,
                total: document.getElementById('save-spells-total').textContent
            }
        },
        hitPoints: {
            total: document.getElementById('totalHP').textContent,
            manualBonus: document.getElementById('hp-manual-bonus').value
        },
        mana: {
            arcane: document.getElementById('arcane-mana-manual')?.value || 0,
            divine: document.getElementById('divine-mana-manual')?.value || 0,
            psp: document.getElementById('psp-manual')?.value || 0
        }
    };
}

// Auto-inicializar cuando el documento est√© listo
document.addEventListener('DOMContentLoaded', function() {
    // Esperar un momento para asegurar que todos los elementos est√©n presentes
    setTimeout(initializeBasicTab, 100);
});
</script>
<!-- Abilities Tab -->
<div id="abilities-tab" class="tab-content">
    <h2 style="color: #ffd700; margin-bottom: 2rem;">üí™ Caracter√≠sticas</h2>
    
    <!-- Controles superiores -->
    <div class="abilities-controls">
        <div class="control-group">
            <button class="btn btn-secondary" onclick="rollAllAbilities('4d6')">üé≤ Rodar 4d6 (Drop Lowest)</button>
            <button class="btn btn-secondary" onclick="rollAllAbilities('3d6')">üéØ Rodar 3d6 Standard</button>
            <button class="btn btn-secondary" onclick="setAbilitiesToAverage()">üìä Valores Promedio</button>
            <button class="btn btn-secondary" onclick="enableManualAssignment()">‚úçÔ∏è Asignaci√≥n Manual</button>
        </div>
        
        <div class="debug-toggle">
            <label>
                <input type="checkbox" id="showDebugInfo" onchange="toggleDebugInfo()"> 
                Mostrar Debug
            </label>
        </div>
    </div>

    <!-- Debug info (oculto por defecto) -->
    <div class="debug-info" id="debug-info" style="display: none;">
        Status: Sistema de c√°lculo listo - Modifiers: Racial, Background, Size
    </div>
    
    <div class="abilities-grid">
        <!-- FUERZA -->
        <div class="ability-card">
            <div class="ability-header">
                <div class="ability-source-tag" id="str-source-tag" data-source="rolled">üé≤</div>
                <div class="ability-name">Fuerza</div>
            </div>
            <div class="ability-main-row">
                <div class="ability-value-container">
                    <input type="number" class="ability-base-input" id="strength-base" min="1" max="25" value="10" 
                           oninput="calculateFinalAbility('strength')" onchange="calculateFinalAbility('strength')">
                    <div class="ability-modifiers">
                        <span class="modifier-item">Base: <span id="str-base-display">10</span></span>
                        <span class="modifier-item racial">Racial: <span id="str-racial">+0</span></span>
                        <span class="modifier-item background">Trasfondo: <span id="str-background">+0</span></span>
                        <span class="modifier-item size">Tama√±o: <span id="str-size">+0</span></span>
                    </div>
                    <div class="ability-final-value" id="strength-final">10</div>
                </div>
                <div class="ability-details-row">
                    <div class="ability-detail-box">
                        <span class="detail-name">Golpe</span>
                        <span class="detail-value" id="str-hit-prob">+0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Da√±o</span>
                        <span class="detail-value" id="str-damage-adj">+0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Peso</span>
                        <span class="detail-value" id="str-weight-cap">0kg</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Esf. M√°x.</span>
                        <span class="detail-value" id="str-max-effort">0kg</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Puertas</span>
                        <span class="detail-value" id="str-open-doors">0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Barras</span>
                        <span class="detail-value" id="str-bend-bar">0%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- DESTREZA -->
        <div class="ability-card">
            <div class="ability-header">
                <div class="ability-source-tag" id="dex-source-tag" data-source="rolled">üé≤</div>
                <div class="ability-name">Destreza</div>
            </div>
            <div class="ability-main-row">
                <div class="ability-value-container">
                    <input type="number" class="ability-base-input" id="dexterity-base" min="1" max="25" value="10" 
                           oninput="calculateFinalAbility('dexterity')" onchange="calculateFinalAbility('dexterity')">
                    <div class="ability-modifiers">
                        <span class="modifier-item">Base: <span id="dex-base-display">10</span></span>
                        <span class="modifier-item racial">Racial: <span id="dex-racial">+0</span></span>
                        <span class="modifier-item background">Trasfondo: <span id="dex-background">+0</span></span>
                        <span class="modifier-item size">Tama√±o: <span id="dex-size">+0</span></span>
                    </div>
                    <div class="ability-final-value" id="dexterity-final">10</div>
                </div>
                <div class="ability-details-row">
                    <div class="ability-detail-box">
                        <span class="detail-name">Ajuste Reacci√≥n</span>
                        <span class="detail-value" id="dex-reaction">0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Atq. Proyectiles</span>
                        <span class="detail-value" id="dex-missile">0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Def. CA</span>
                        <span class="detail-value" id="dex-defensive">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CONSTITUCI√ìN -->
        <div class="ability-card">
            <div class="ability-header">
                <div class="ability-source-tag" id="con-source-tag" data-source="rolled">üé≤</div>
                <div class="ability-name">Constituci√≥n</div>
            </div>
            <div class="ability-main-row">
                <div class="ability-value-container">
                    <input type="number" class="ability-base-input" id="constitution-base" min="1" max="25" value="10" 
                           oninput="calculateFinalAbility('constitution')" onchange="calculateFinalAbility('constitution')">
                    <div class="ability-modifiers">
                        <span class="modifier-item">Base: <span id="con-base-display">10</span></span>
                        <span class="modifier-item racial">Racial: <span id="con-racial">+0</span></span>
                        <span class="modifier-item background">Trasfondo: <span id="con-background">+0</span></span>
                        <span class="modifier-item size">Tama√±o: <span id="con-size">+0</span></span>
                    </div>
                    <div class="ability-final-value" id="constitution-final">10</div>
                </div>
                <div class="ability-details-row">
                    <div class="ability-detail-box">
                        <span class="detail-name">HP/Nivel</span>
                        <span class="detail-value" id="con-hp-bonus">0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Shock Sistema</span>
                        <span class="detail-value" id="con-shock-survival">0%</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Superv. Revivir</span>
                        <span class="detail-value" id="con-resurrection">0%</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Prot. Veneno</span>
                        <span class="detail-value" id="con-poison">0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Regeneraci√≥n</span>
                        <span class="detail-value" id="con-regeneration">--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- INTELIGENCIA -->
        <div class="ability-card">
            <div class="ability-header">
                <div class="ability-source-tag" id="int-source-tag" data-source="rolled">üé≤</div>
                <div class="ability-name">Inteligencia</div>
            </div>
            <div class="ability-main-row">
                <div class="ability-value-container">
                    <input type="number" class="ability-base-input" id="intelligence-base" min="1" max="25" value="10" 
                           oninput="calculateFinalAbility('intelligence')" onchange="calculateFinalAbility('intelligence')">
                    <div class="ability-modifiers">
                        <span class="modifier-item">Base: <span id="int-base-display">10</span></span>
                        <span class="modifier-item racial">Racial: <span id="int-racial">+0</span></span>
                        <span class="modifier-item background">Trasfondo: <span id="int-background">+0</span></span>
                        <span class="modifier-item size">Tama√±o: <span id="int-size">+0</span></span>
                    </div>
                    <div class="ability-final-value" id="intelligence-final">10</div>
                </div>
                <div class="ability-details-row">
                    <div class="ability-detail-box">
                        <span class="detail-name">Idiomas</span>
                        <span class="detail-value" id="int-languages">0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Niv. Conjuros</span>
                        <span class="detail-value" id="int-spell-level">0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Oport. Conjuros</span>
                        <span class="detail-value" id="int-spell-chance">0%</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Max Conjuros</span>
                        <span class="detail-value" id="int-max-spells">0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Inmunidad</span>
                        <span class="detail-value" id="int-immunity">--</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- SABIDUR√çA -->
        <div class="ability-card">
            <div class="ability-header">
                <div class="ability-source-tag" id="wis-source-tag" data-source="rolled">üé≤</div>
                <div class="ability-name">Sabidur√≠a</div>
            </div>
            <div class="ability-main-row">
                <div class="ability-value-container">
                    <input type="number" class="ability-base-input" id="wisdom-base" min="1" max="25" value="10" 
                           oninput="calculateFinalAbility('wisdom')" onchange="calculateFinalAbility('wisdom')">
                    <div class="ability-modifiers">
                        <span class="modifier-item">Base: <span id="wis-base-display">10</span></span>
                        <span class="modifier-item racial">Racial: <span id="wis-racial">+0</span></span>
                        <span class="modifier-item background">Trasfondo: <span id="wis-background">+0</span></span>
                        <span class="modifier-item size">Tama√±o: <span id="wis-size">+0</span></span>
                    </div>
                    <div class="ability-final-value" id="wisdom-final">10</div>
                </div>
                <div class="ability-details-row">
                    <div class="ability-detail-box">
                        <span class="detail-name">Def. M√°gica</span>
                        <span class="detail-value" id="wis-magic-defense">0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Bonif. Conjuros</span>
                        <span class="detail-value" id="wis-spell-bonus">0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Fracaso Conjuro</span>
                        <span class="detail-value" id="wis-spell-failure">0%</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- CARISMA -->
        <div class="ability-card">
            <div class="ability-header">
                <div class="ability-source-tag" id="cha-source-tag" data-source="rolled">üé≤</div>
                <div class="ability-name">Carisma</div>
            </div>
            <div class="ability-main-row">
                <div class="ability-value-container">
                    <input type="number" class="ability-base-input" id="charisma-base" min="1" max="25" value="10" 
                           oninput="calculateFinalAbility('charisma')" onchange="calculateFinalAbility('charisma')">
                    <div class="ability-modifiers">
                        <span class="modifier-item">Base: <span id="cha-base-display">10</span></span>
                        <span class="modifier-item racial">Racial: <span id="cha-racial">+0</span></span>
                        <span class="modifier-item background">Trasfondo: <span id="cha-background">+0</span></span>
                        <span class="modifier-item size">Tama√±o: <span id="cha-size">+0</span></span>
                    </div>
                    <div class="ability-final-value" id="charisma-final">10</div>
                </div>
                <div class="ability-details-row">
                    <div class="ability-detail-box">
                        <span class="detail-name">N¬∫ Servidores</span>
                        <span class="detail-value" id="cha-max-servers">0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Lealtad Base</span>
                        <span class="detail-value" id="cha-base-loyalty">0</span>
                    </div>
                    <div class="ability-detail-box">
                        <span class="detail-name">Ajuste Reacci√≥n</span>
                        <span class="detail-value" id="cha-reaction-adj">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen de Modificadores -->
    <div class="modifiers-summary">
        <h3 style="color: #ffd700; margin-bottom: 1rem;">üìä Resumen de Modificadores</h3>
        <div class="summary-grid">
            <div class="summary-item">
                <span class="summary-label">Ataques Cuerpo a Cuerpo:</span>
                <span class="summary-value" id="summary-melee-attack">+0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Da√±o Cuerpo a Cuerpo:</span>
                <span class="summary-value" id="summary-melee-damage">+0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Ataques a Distancia:</span>
                <span class="summary-value" id="summary-ranged-attack">+0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Bonificaci√≥n CA:</span>
                <span class="summary-value" id="summary-ac-bonus">+0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">HP por Nivel:</span>
                <span class="summary-value" id="summary-hp-bonus">+0</span>
            </div>
            <div class="summary-item">
                <span class="summary-label">Idiomas Adicionales:</span>
                <span class="summary-value" id="summary-languages">0</span>
            </div>
        </div>
    </div>

    <!-- Puntuaciones Extraordinarias -->
    <div class="extraordinary-scores" id="extraordinary-scores" style="display: none;">
        <h4 style="color: #ffed4e;">‚ö° Puntuaciones Extraordinarias</h4>
        <div id="extraordinary-list"></div>
    </div>
</div>

<style>
/* Estilos para el Tab Habilidades Mejorado */

.abilities-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.control-group {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.debug-toggle {
    color: #b0b0b0;
    font-size: 0.85rem;
}

.debug-toggle input[type="checkbox"] {
    margin-right: 0.5rem;
}

/* Grid de habilidades */
.abilities-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 1.5rem;
    margin-top: 2rem;
    padding: 0 1rem;
}

/* Card de habilidad */
.ability-card {
    background-color: #2b303b;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
    display: flex;
    flex-direction: column;
    gap: 1rem;
    transition: all 0.3s ease;
    width: 100%;
    box-sizing: border-box;
}

.ability-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.6);
}

/* Header de habilidad */
.ability-header {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.ability-source-tag {
    width: 40px;
    height: 40px;
    background: linear-gradient(135deg, #4CAF50, #45a049);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
}

.ability-source-tag[data-source="manual"] {
    background: linear-gradient(135deg, #FF9800, #F57C00);
    box-shadow: 0 2px 8px rgba(255, 152, 0, 0.3);
}

.ability-source-tag[data-source="rolled"] {
    background: linear-gradient(135deg, #4CAF50, #45a049);
    box-shadow: 0 2px 8px rgba(76, 175, 80, 0.3);
}

.ability-source-tag:hover {
    transform: scale(1.1);
}

.ability-name {
    font-size: 1.2rem;
    font-weight: bold;
    color: #ffd700;
    text-align: left;
    flex: 1;
}

/* Contenedor de valor principal */
.ability-main-row {
    display: flex;
    align-items: flex-start;
    gap: 1.5rem;
    width: 100%;
}

.ability-value-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    min-width: 200px;
    flex-shrink: 0;
}

.ability-base-input {
    width: 80px;
    font-size: 1.8rem;
    font-weight: bold;
    text-align: center;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 8px;
    color: #e5e5e5;
    padding: 0.5rem;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
}

.ability-base-input:focus {
    outline: none;
    border-color: #ffd700;
    background: rgba(255, 255, 255, 0.15);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.3);
}

/* Modificadores */
.ability-modifiers {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
    margin-bottom: 0.5rem;
    width: 100%;
}

.modifier-item {
    display: flex;
    justify-content: space-between;
    font-size: 0.75rem;
    color: #b0b0b0;
    padding: 0.2rem 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 4px;
    border-left: 3px solid transparent;
}

.modifier-item.racial {
    border-left-color: #2196F3;
    color: #87CEEB;
}

.modifier-item.background {
    border-left-color: #9C27B0;
    color: #DDA0DD;
}

.modifier-item.size {
    border-left-color: #FF5722;
    color: #FFB74D;
}

/* Valor final */
.ability-final-value {
    font-size: 2.5rem;
    font-weight: 800;
    color: #ffd700;
    text-align: center;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 215, 0, 0.1));
    border: 2px solid rgba(255, 215, 0, 0.4);
    border-radius: 10px;
    padding: 0.5rem;
    min-width: 80px;
    text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.2);
}

/* Detalles de habilidad */
.ability-details-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 0.8rem;
    width: 100%;
    min-height: 40px;
}

.ability-detail-box {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 0.2rem;
    text-align: center;
    padding: 0.5rem 0.8rem;
    background-color: #16213e;
    border: 1px solid #4a5464;
    border-radius: 8px;
    min-width: 80px;
    transition: all 0.3s ease;
}

.ability-detail-box:hover {
    background-color: #1e2a40;
    border-color: #5a6474;
    transform: translateY(-2px);
}

.detail-name {
    font-size: 0.75rem;
    color: #b0b0b0;
    white-space: nowrap;
}

.detail-value {
    font-size: 1rem;
    font-weight: bold;
    color: #e5e5e5;
    white-space: nowrap;
    transition: all 0.3s ease;
}

.detail-value.positive {
    color: #4CAF50;
    text-shadow: 0 0 8px rgba(76, 175, 80, 0.3);
}

.detail-value.negative {
    color: #f44336;
    text-shadow: 0 0 8px rgba(244, 67, 54, 0.3);
}

.detail-value.neutral {
    color: #e5e5e5;
}

.detail-value.special {
    color: #ff9800;
    text-shadow: 0 0 8px rgba(255, 152, 0, 0.3);
}

/* Resumen de Modificadores */
.modifiers-summary {
    margin-top: 2rem;
    padding: 1.5rem;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    border: 1px solid rgba(255, 215, 0, 0.2);
}

.summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
}

.summary-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.8rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    border-left: 3px solid #ffd700;
}

.summary-label {
    color: #e5e5e5;
    font-weight: 500;
}

.summary-value {
    color: #ffd700;
    font-weight: bold;
    font-size: 1.1rem;
    text-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
}

/* Puntuaciones Extraordinarias */
.extraordinary-scores {
    margin-top: 2rem;
    padding: 1.5rem;
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 193, 7, 0.1));
    border-radius: 12px;
    border: 2px solid rgba(255, 215, 0, 0.3);
    animation: pulse-glow 2s infinite alternate;
}

@keyframes pulse-glow {
    from { box-shadow: 0 0 10px rgba(255, 215, 0, 0.2); }
    to { box-shadow: 0 0 20px rgba(255, 215, 0, 0.4); }
}

.extraordinary-item {
    margin: 0.5rem 0;
    color: #ffed4e;
    font-weight: bold;
}

.debug-info {
    background-color: rgba(26, 26, 26, 0.9);
    border: 1px solid #333;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 8px;
    font-family: 'Courier New', monospace;
    font-size: 0.85rem;
    color: #4CAF50;
    transition: all 0.3s ease;
}

.debug-info.error {
    color: #f44336;
    border-color: #f44336;
}

.debug-info.warning {
    color: #ff9800;
    border-color: #ff9800;
}

/* Animaci√≥n para cambios de valores */
@keyframes value-change {
    0% { transform: scale(1); }
    50% { transform: scale(1.05); }
    100% { transform: scale(1); }
}

.value-changed {
    animation: value-change 0.3s ease;
}

/* Responsive improvements */
@media (max-width: 1024px) {
    .abilities-grid {
        grid-template-columns: 1fr;
    }
    
    .ability-details-row {
        grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
    }
}

@media (max-width: 768px) {
    .abilities-controls {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .summary-grid {
        grid-template-columns: 1fr;
    }
    
    .ability-details-row {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .ability-main-row {
        flex-direction: column;
        align-items: center;
        gap: 1rem;
    }
    
    .ability-value-container {
        min-width: auto;
        width: 100%;
    }
}
</style>

<script>
// Sistema de Habilidades con Modificadores

// Datos de modificadores raciales
const racialModifiers = {
    'humano': {
        str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 0
    },
    'elfo': {
        str: 0, dex: 1, con: -1, int: 0, wis: 0, cha: 0
    },
    'enano': {
        str: 0, dex: 0, con: 1, int: 0, wis: 0, cha: -1
    },
    'mediano': {
        str: -1, dex: 1, con: 0, int: 0, wis: 0, cha: 0
    },
    'orco': {
        str: 1, dex: 0, con: 1, int: -2, wis: 0, cha: -2
    }
};

// Datos de modificadores por trasfondo
const backgroundModifiers = {
    'Soldado': {
        str: 1, dex: 0, con: 1, int: 0, wis: 0, cha: 0
    },
    'Guardia': {
        str: 1, dex: 0, con: 0, int: 0, wis: 1, cha: 0
    },
    'Marinero': {
        str: 1, dex: 1, con: 0, int: 0, wis: 0, cha: 0
    },
    'Campesino': {
        str: 0, dex: 0, con: 1, int: 0, wis: 1, cha: 0
    },
    'Acolito': {
        str: 0, dex: 0, con: 0, int: 0, wis: 2, cha: 0
    },
    'Ermita√±o': {
        str: 0, dex: 0, con: 0, int: 1, wis: 1, cha: 0
    },
    'Noble': {
        str: 0, dex: 0, con: 0, int: 1, wis: 0, cha: 1
    },
    'Erudito': {
        str: 0, dex: 0, con: 0, int: 2, wis: 0, cha: 0
    },
    'Escribano': {
        str: 0, dex: 1, con: 0, int: 1, wis: 0, cha: 0
    },
    'Charlat√°n': {
        str: 0, dex: 1, con: 0, int: 0, wis: 0, cha: 1
    },
    'Animador': {
        str: 0, dex: 1, con: 0, int: 0, wis: 0, cha: 1
    },
    'Criminal': {
        str: 0, dex: 2, con: 0, int: 0, wis: 0, cha: 0
    },
    'Vagabundo': {
        str: 0, dex: 1, con: 1, int: 0, wis: 0, cha: 0
    },
    'Comerciante': {
        str: 0, dex: 0, con: 0, int: 1, wis: 0, cha: 1
    }
};

// Modificadores por tama√±o
const sizeModifiers = {
    'Diminuto': {
        str: -4, dex: 2, con: -2, int: 0, wis: 0, cha: 0
    },
    'Menudo': {
        str: -2, dex: 1, con: -1, int: 0, wis: 0, cha: 0
    },
    'Peque√±o': {
        str: -1, dex: 1, con: 0, int: 0, wis: 0, cha: 0
    },
    'Mediano': {
        str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 0
    },
    'Grande': {
        str: 2, dex: -1, con: 1, int: 0, wis: 0, cha: 0
    },
    'Enorme': {
        str: 4, dex: -2, con: 2, int: 0, wis: 0, cha: 0
    },
    'Gargantuesco': {
        str: 6, dex: -3, con: 3, int: 0, wis: 0, cha: 0
    },
    'Colosal': {
        str: 8, dex: -4, con: 4, int: 0, wis: 0, cha: 0
    }
};

// Tablas de datos de AD&D 2nd Edition (versi√≥n resumida)
const abilityTables = {
    strength: [
        {score: 3, hit: -3, damage: -1, weight: 2.5, effort: 5, doors: 1, bend: 0},
        {score: 4, hit: -2, damage: -1, weight: 5, effort: 23, doors: 1, bend: 0},
        {score: 5, hit: -2, damage: -1, weight: 5, effort: 23, doors: 2, bend: 0},
        {score: 6, hit: -1, damage: 0, weight: 10, effort: 28, doors: 2, bend: 0},
        {score: 7, hit: -1, damage: 0, weight: 10, effort: 28, doors: 2, bend: 0},
        {score: 8, hit: 0, damage: 0, weight: 18, effort: 45, doors: 3, bend: 1},
        {score: 9, hit: 0, damage: 0, weight: 18, effort: 45, doors: 3, bend: 1},
        {score: 10, hit: 0, damage: 0, weight: 20, effort: 58, doors: 3, bend: 2},
        {score: 11, hit: 0, damage: 0, weight: 20, effort: 58, doors: 3, bend: 2},
        {score: 12, hit: 0, damage: 0, weight: 23, effort: 70, doors: 4, bend: 4},
        {score: 13, hit: 0, damage: 0, weight: 23, effort: 70, doors: 4, bend: 4},
        {score: 14, hit: 0, damage: 0, weight: 28, effort: 85, doors: 4, bend: 7},
        {score: 15, hit: 0, damage: 0, weight: 28, effort: 85, doors: 4, bend: 7},
        {score: 16, hit: 0, damage: 1, weight: 35, effort: 98, doors: 5, bend: 10},
        {score: 17, hit: 1, damage: 1, weight: 43, effort: 110, doors: 5, bend: 13},
        {score: 18, hit: 1, damage: 2, weight: 55, effort: 130, doors: 6, bend: 16},
        {score: 19, hit: 3, damage: 7, weight: 245, effort: 320, doors: 16, bend: 50},
        {score: 20, hit: 3, damage: 8, weight: 270, effort: 350, doors: 17, bend: 60},
        {score: 21, hit: 4, damage: 9, weight: 320, effort: 405, doors: 17, bend: 70},
        {score: 22, hit: 4, damage: 10, weight: 395, effort: 485, doors: 18, bend: 80},
        {score: 23, hit: 5, damage: 11, weight: 470, effort: 565, doors: 18, bend: 90},
        {score: 24, hit: 6, damage: 12, weight: 620, effort: 720, doors: 19, bend: 95},
        {score: 25, hit: 7, damage: 14, weight: 770, effort: 875, doors: 19, bend: 99}
    ],
    dexterity: [
        {score: 3, reaction: -3, missile: -3, defensive: 4},
        {score: 4, reaction: -2, missile: -2, defensive: 3},
        {score: 5, reaction: -1, missile: -1, defensive: 2},
        {score: 6, reaction: 0, missile: 0, defensive: 1},
        {score: 7, reaction: 0, missile: 0, defensive: 0},
        {score: 8, reaction: 0, missile: 0, defensive: 0},
        {score: 9, reaction: 0, missile: 0, defensive: 0},
        {score: 10, reaction: 0, missile: 0, defensive: 0},
        {score: 11, reaction: 0, missile: 0, defensive: 0},
        {score: 12, reaction: 0, missile: 0, defensive: 0},
        {score: 13, reaction: 0, missile: 0, defensive: 0},
        {score: 14, reaction: 0, missile: 0, defensive: 0},
        {score: 15, reaction: 0, missile: 0, defensive: -1},
        {score: 16, reaction: 1, missile: 1, defensive: -2},
        {score: 17, reaction: 2, missile: 2, defensive: -3},
        {score: 18, reaction: 2, missile: 2, defensive: -4},
        {score: 19, reaction: 3, missile: 3, defensive: -4},
        {score: 20, reaction: 3, missile: 3, defensive: -4},
        {score: 21, reaction: 4, missile: 4, defensive: -5},
        {score: 22, reaction: 4, missile: 4, defensive: -5},
        {score: 23, reaction: 4, missile: 4, defensive: -5},
        {score: 24, reaction: 5, missile: 5, defensive: -6},
        {score: 25, reaction: 5, missile: 5, defensive: -6}
    ],
    constitution: [
        {score: 3, hp: -2, shock: 35, resurrection: 40, poison: -2},
        {score: 4, hp: -1, shock: 40, resurrection: 45, poison: -1},
        {score: 5, hp: -1, shock: 45, resurrection: 50, poison: -1},
        {score: 6, hp: -1, shock: 50, resurrection: 55, poison: 0},
        {score: 7, hp: 0, shock: 55, resurrection: 60, poison: 0},
        {score: 8, hp: 0, shock: 60, resurrection: 65, poison: 0},
        {score: 9, hp: 0, shock: 65, resurrection: 70, poison: 0},
        {score: 10, hp: 0, shock: 70, resurrection: 75, poison: 0},
        {score: 11, hp: 0, shock: 75, resurrection: 80, poison: 0},
        {score: 12, hp: 0, shock: 80, resurrection: 85, poison: 0},
        {score: 13, hp: 0, shock: 85, resurrection: 90, poison: 0},
        {score: 14, hp: 0, shock: 88, resurrection: 92, poison: 0},
        {score: 15, hp: 1, shock: 90, resurrection: 94, poison: 0},
        {score: 16, hp: 2, shock: 95, resurrection: 96, poison: 0},
        {score: 17, hp: 2, shock: 97, resurrection: 98, poison: 0},
        {score: 18, hp: 2, shock: 99, resurrection: 100, poison: 0},
        {score: 19, hp: 2, shock: 99, resurrection: 100, poison: 1},
        {score: 20, hp: 2, shock: 99, resurrection: 100, poison: 1},
        {score: 21, hp: 2, shock: 99, resurrection: 100, poison: 2},
        {score: 22, hp: 2, shock: 99, resurrection: 100, poison: 2},
        {score: 23, hp: 2, shock: 99, resurrection: 100, poison: 3},
        {score: 24, hp: 2, shock: 99, resurrection: 100, poison: 3},
        {score: 25, hp: 2, shock: 99, resurrection: 100, poison: 4}
    ],
    intelligence: [
        {score: 3, languages: 0, spellLevel: 0, spellChance: 0, maxSpells: 0},
        {score: 4, languages: 0, spellLevel: 0, spellChance: 0, maxSpells: 0},
        {score: 5, languages: 0, spellLevel: 0, spellChance: 0, maxSpells: 0},
        {score: 6, languages: 0, spellLevel: 0, spellChance: 0, maxSpells: 0},
        {score: 7, languages: 0, spellLevel: 0, spellChance: 0, maxSpells: 0},
        {score: 8, languages: 1, spellLevel: 0, spellChance: 0, maxSpells: 0},
        {score: 9, languages: 2, spellLevel: 4, spellChance: 35, maxSpells: 6},
        {score: 10, languages: 2, spellLevel: 5, spellChance: 40, maxSpells: 7},
        {score: 11, languages: 2, spellLevel: 5, spellChance: 45, maxSpells: 7},
        {score: 12, languages: 3, spellLevel: 6, spellChance: 50, maxSpells: 7},
        {score: 13, languages: 3, spellLevel: 6, spellChance: 55, maxSpells: 9},
        {score: 14, languages: 4, spellLevel: 7, spellChance: 60, maxSpells: 9},
        {score: 15, languages: 4, spellLevel: 7, spellChance: 65, maxSpells: 11},
        {score: 16, languages: 5, spellLevel: 8, spellChance: 70, maxSpells: 11},
        {score: 17, languages: 6, spellLevel: 8, spellChance: 75, maxSpells: 14},
        {score: 18, languages: 7, spellLevel: 9, spellChance: 85, maxSpells: 18},
        {score: 19, languages: 8, spellLevel: 9, spellChance: 95, maxSpells: 22},
        {score: 20, languages: 9, spellLevel: 9, spellChance: 96, maxSpells: 25},
        {score: 21, languages: 10, spellLevel: 9, spellChance: 97, maxSpells: 28},
        {score: 22, languages: 11, spellLevel: 9, spellChance: 98, maxSpells: 31},
        {score: 23, languages: 12, spellLevel: 9, spellChance: 99, maxSpells: 34},
        {score: 24, languages: 15, spellLevel: 9, spellChance: 100, maxSpells: 37},
        {score: 25, languages: 20, spellLevel: 9, spellChance: 100, maxSpells: 40}
    ],
    wisdom: [
        {score: 3, magicDefense: -3, spellBonus: 0, spellFailure: 80},
        {score: 4, magicDefense: -2, spellBonus: 0, spellFailure: 70},
        {score: 5, magicDefense: -1, spellBonus: 0, spellFailure: 60},
        {score: 6, magicDefense: -1, spellBonus: 0, spellFailure: 50},
        {score: 7, magicDefense: -1, spellBonus: 0, spellFailure: 40},
        {score: 8, magicDefense: 0, spellBonus: 0, spellFailure: 30},
        {score: 9, magicDefense: 0, spellBonus: 0, spellFailure: 20},
        {score: 10, magicDefense: 0, spellBonus: 0, spellFailure: 15},
        {score: 11, magicDefense: 0, spellBonus: 0, spellFailure: 10},
        {score: 12, magicDefense: 0, spellBonus: 0, spellFailure: 5},
        {score: 13, magicDefense: 0, spellBonus: 1, spellFailure: 0},
        {score: 14, magicDefense: 0, spellBonus: 2, spellFailure: 0},
        {score: 15, magicDefense: 1, spellBonus: 2, spellFailure: 0},
        {score: 16, magicDefense: 2, spellBonus: 2, spellFailure: 0},
        {score: 17, magicDefense: 3, spellBonus: 3, spellFailure: 0},
        {score: 18, magicDefense: 4, spellBonus: 4, spellFailure: 0},
        {score: 19, magicDefense: 4, spellBonus: 4, spellFailure: 0},
        {score: 20, magicDefense: 4, spellBonus: 4, spellFailure: 0},
        {score: 21, magicDefense: 4, spellBonus: 5, spellFailure: 0},
        {score: 22, magicDefense: 4, spellBonus: 6, spellFailure: 0},
        {score: 23, magicDefense: 4, spellBonus: 6, spellFailure: 0},
        {score: 24, magicDefense: 4, spellBonus: 7, spellFailure: 0},
        {score: 25, magicDefense: 4, spellBonus: 8, spellFailure: 0}
    ],
    charisma: [
        {score: 3, maxServers: 1, baseLoyalty: -30, reaction: -25},
        {score: 4, maxServers: 1, baseLoyalty: -25, reaction: -20},
        {score: 5, maxServers: 2, baseLoyalty: -20, reaction: -15},
        {score: 6, maxServers: 2, baseLoyalty: -15, reaction: -10},
        {score: 7, maxServers: 3, baseLoyalty: -10, reaction: -5},
        {score: 8, maxServers: 3, baseLoyalty: -5, reaction: 0},
        {score: 9, maxServers: 4, baseLoyalty: 0, reaction: 0},
        {score: 10, maxServers: 4, baseLoyalty: 0, reaction: 0},
        {score: 11, maxServers: 4, baseLoyalty: 0, reaction: 0},
        {score: 12, maxServers: 5, baseLoyalty: 0, reaction: 0},
        {score: 13, maxServers: 5, baseLoyalty: 0, reaction: 5},
        {score: 14, maxServers: 6, baseLoyalty: 1, reaction: 10},
        {score: 15, maxServers: 7, baseLoyalty: 3, reaction: 15},
        {score: 16, maxServers: 8, baseLoyalty: 4, reaction: 20},
        {score: 17, maxServers: 10, baseLoyalty: 6, reaction: 25},
        {score: 18, maxServers: 15, baseLoyalty: 8, reaction: 30},
        {score: 19, maxServers: 20, baseLoyalty: 10, reaction: 35},
        {score: 20, maxServers: 25, baseLoyalty: 12, reaction: 40},
        {score: 21, maxServers: 30, baseLoyalty: 14, reaction: 45},
        {score: 22, maxServers: 35, baseLoyalty: 16, reaction: 50},
        {score: 23, maxServers: 40, baseLoyalty: 18, reaction: 55},
        {score: 24, maxServers: 45, baseLoyalty: 20, reaction: 60},
        {score: 25, maxServers: 50, baseLoyalty: 20, reaction: 65}
    ]
};

// Funciones principales
function calculateFinalAbility(abilityName) {
    const baseValue = parseInt(document.getElementById(`${abilityName}-base`).value) || 10;
    const race = document.getElementById('race')?.value || '';
    const background = getSelectedBackground();
    const size = document.getElementById('characterSize')?.value || 'Mediano';
    
    // Obtener modificadores
    const racialMod = getRacialModifier(abilityName, race);
    const backgroundMod = getBackgroundModifier(abilityName, background);
    const sizeMod = getSizeModifier(abilityName, size);
    
    // Calcular valor final
    const finalValue = Math.max(1, Math.min(25, baseValue + racialMod + backgroundMod + sizeMod));
    
    // Actualizar displays
    updateAbilityDisplay(abilityName, baseValue, racialMod, backgroundMod, sizeMod, finalValue);
    
    // Calcular beneficios de la habilidad
    updateAbilityBenefits(abilityName, finalValue);
    
    // Actualizar sistemas conectados
    updateConnectedSystems();
}

function updateAbilityDisplay(abilityName, base, racial, background, size, final) {
    const shortName = abilityName.substring(0, 3);
    
    // Actualizar valores en pantalla
    document.getElementById(`${shortName}-base-display`).textContent = base;
    document.getElementById(`${shortName}-racial`).textContent = racial >= 0 ? `+${racial}` : racial;
    document.getElementById(`${shortName}-background`).textContent = background >= 0 ? `+${background}` : background;
    document.getElementById(`${shortName}-size`).textContent = size >= 0 ? `+${size}` : size;
    document.getElementById(`${abilityName}-final`).textContent = final;
    
    // Aplicar animaci√≥n de cambio
    const finalElement = document.getElementById(`${abilityName}-final`);
    finalElement.classList.add('value-changed');
    setTimeout(() => finalElement.classList.remove('value-changed'), 300);
}

function getRacialModifier(abilityName, race) {
    if (!race || !racialModifiers[race]) return 0;
    const shortName = abilityName.substring(0, 3);
    return racialModifiers[race][shortName] || 0;
}

function getBackgroundModifier(abilityName, background) {
    if (!background || !backgroundModifiers[background]) return 0;
    const shortName = abilityName.substring(0, 3);
    return backgroundModifiers[background][shortName] || 0;
}

function getSizeModifier(abilityName, size) {
    if (!size || !sizeModifiers[size]) return 0;
    const shortName = abilityName.substring(0, 3);
    return sizeModifiers[size][shortName] || 0;
}

function getSelectedBackground() {
    const backgroundName = document.getElementById('background-selected-name')?.textContent;
    if (!backgroundName || backgroundName === 'Selecciona un trasfondo') return '';
    return backgroundName;
}

// Actualizar beneficios de habilidades seg√∫n las tablas de AD&D
function updateAbilityBenefits(abilityName, score) {
    const table = abilityTables[abilityName];
    if (!table) return;
    
    const data = table.find(entry => entry.score >= score) || table[table.length - 1];
    const shortName = abilityName.substring(0, 3);
    
    switch(abilityName) {
        case 'strength':
            updateElement(`${shortName}-hit-prob`, formatModifier(data.hit));
            updateElement(`${shortName}-damage-adj`, formatModifier(data.damage));
            updateElement(`${shortName}-weight-cap`, `${data.weight}kg`);
            updateElement(`${shortName}-max-effort`, `${data.effort}kg`);
            updateElement(`${shortName}-open-doors`, data.doors);
            updateElement(`${shortName}-bend-bar`, `${data.bend}%`);
            break;
            
        case 'dexterity':
            updateElement(`${shortName}-reaction`, formatModifier(data.reaction));
            updateElement(`${shortName}-missile`, formatModifier(data.missile));
            updateElement(`${shortName}-defensive`, formatModifier(-data.defensive)); // Negativo porque es bonificaci√≥n a CA
            break;
            
        case 'constitution':
            updateElement(`${shortName}-hp-bonus`, formatModifier(data.hp));
            updateElement(`${shortName}-shock-survival`, `${data.shock}%`);
            updateElement(`${shortName}-resurrection`, `${data.resurrection}%`);
            updateElement(`${shortName}-poison`, formatModifier(data.poison));
            updateElement(`${shortName}-regeneration`, score >= 20 ? '1/ronda' : '--');
            break;
            
        case 'intelligence':
            updateElement(`${shortName}-languages`, data.languages);
            updateElement(`${shortName}-spell-level`, data.spellLevel);
            updateElement(`${shortName}-spell-chance`, `${data.spellChance}%`);
            updateElement(`${shortName}-max-spells`, data.maxSpells);
            updateElement(`${shortName}-immunity`, score >= 18 ? '1st level' : '--');
            break;
            
        case 'wisdom':
            updateElement(`${shortName}-magic-defense`, formatModifier(data.magicDefense));
            updateElement(`${shortName}-spell-bonus`, data.spellBonus);
            updateElement(`${shortName}-spell-failure`, `${data.spellFailure}%`);
            break;
            
        case 'charisma':
            updateElement(`${shortName}-max-servers`, data.maxServers);
            updateElement(`${shortName}-base-loyalty`, `${data.baseLoyalty}%`);
            updateElement(`${shortName}-reaction-adj`, formatModifier(data.reaction));
            break;
    }
}

function updateElement(id, value) {
    const element = document.getElementById(id);
    if (element) {
        element.textContent = value;
        
        // Aplicar clases de estilo seg√∫n el valor
        element.classList.remove('positive', 'negative', 'neutral', 'special');
        if (typeof value === 'string' && value.includes('+')) {
            element.classList.add('positive');
        } else if (typeof value === 'string' && value.includes('-')) {
            element.classList.add('negative');
        } else if (value === 0 || value === '0' || value === '--') {
            element.classList.add('neutral');
        } else {
            element.classList.add('special');
        }
    }
}

function formatModifier(value) {
    if (value === 0) return '0';
    return value > 0 ? `+${value}` : `${value}`;
}

// Funciones de generaci√≥n de habilidades
function rollAllAbilities(diceType = '4d6') {
    const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
    
    abilities.forEach(ability => {
        const rolledValue = rollAbilityScore(diceType);
        document.getElementById(`${ability}-base`).value = rolledValue;
        updateSourceTag(ability, 'rolled');
        calculateFinalAbility(ability);
    });
    
    showNotification(`Caracter√≠sticas generadas con ${diceType}`);
    checkExtraordinaryScores();
}

function rollAbilityScore(diceType) {
    if (diceType === '4d6') {
        // 4d6, drop lowest
        const rolls = [rollDie(6), rollDie(6), rollDie(6), rollDie(6)];
        rolls.sort((a, b) => b - a);
        return rolls[0] + rolls[1] + rolls[2];
    } else {
        // 3d6 standard
        return rollDie(6) + rollDie(6) + rollDie(6);
    }
}

function rollDie(sides) {
    return Math.floor(Math.random() * sides) + 1;
}

function setAbilitiesToAverage() {
    const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
    const averageValues = [13, 12, 13, 12, 14, 11]; // Valores promedio balanceados
    
    abilities.forEach((ability, index) => {
        document.getElementById(`${ability}-base`).value = averageValues[index];
        updateSourceTag(ability, 'assigned');
        calculateFinalAbility(ability);
    });
    
    showNotification('Valores promedio asignados');
}

function enableManualAssignment() {
    const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
    
    abilities.forEach(ability => {
        updateSourceTag(ability, 'manual');
    });
    
    showNotification('Modo de asignaci√≥n manual activado');
}

function updateSourceTag(abilityName, source) {
    const shortName = abilityName.substring(0, 3);
    const tag = document.getElementById(`${shortName}-source-tag`);
    
    if (tag) {
        tag.setAttribute('data-source', source);
        switch(source) {
            case 'rolled':
                tag.textContent = 'üé≤';
                break;
            case 'manual':
                tag.textContent = '‚úçÔ∏è';
                break;
            case 'assigned':
                tag.textContent = 'üìä';
                break;
        }
    }
}

// Funciones de actualizaci√≥n del resumen
function updateConnectedSystems() {
    updateSummaryModifiers();
    updateExtraordinaryScores();
    
    // Conectar con otros sistemas del personaje
    if (typeof updateAllBasicStats === 'function') {
        updateAllBasicStats();
    }
}

function updateSummaryModifiers() {
    const str = parseInt(document.getElementById('strength-final').textContent) || 10;
    const dex = parseInt(document.getElementById('dexterity-final').textContent) || 10;
    const con = parseInt(document.getElementById('constitution-final').textContent) || 10;
    const int = parseInt(document.getElementById('intelligence-final').textContent) || 10;
    
    // Obtener modificadores de las tablas
    const strData = abilityTables.strength.find(entry => entry.score >= str) || abilityTables.strength[abilityTables.strength.length - 1];
    const dexData = abilityTables.dexterity.find(entry => entry.score >= dex) || abilityTables.dexterity[abilityTables.dexterity.length - 1];
    const conData = abilityTables.constitution.find(entry => entry.score >= con) || abilityTables.constitution[abilityTables.constitution.length - 1];
    const intData = abilityTables.intelligence.find(entry => entry.score >= int) || abilityTables.intelligence[abilityTables.intelligence.length - 1];
    
    // Actualizar resumen
    updateElement('summary-melee-attack', formatModifier(strData.hit));
    updateElement('summary-melee-damage', formatModifier(strData.damage));
    updateElement('summary-ranged-attack', formatModifier(dexData.missile));
    updateElement('summary-ac-bonus', formatModifier(-dexData.defensive));
    updateElement('summary-hp-bonus', formatModifier(conData.hp));
    updateElement('summary-languages', intData.languages);
}

function checkExtraordinaryScores() {
    const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
    const extraordinaryItems = [];
    
    abilities.forEach(ability => {
        const score = parseInt(document.getElementById(`${ability}-final`).textContent) || 10;
        if (score >= 18) {
            extraordinaryItems.push(`${ability.charAt(0).toUpperCase() + ability.slice(1)}: ${score}`);
        }
    });
    
    const container = document.getElementById('extraordinary-scores');
    const list = document.getElementById('extraordinary-list');
    
    if (extraordinaryItems.length > 0) {
        container.style.display = 'block';
        list.innerHTML = extraordinaryItems.map(item => `<div class="extraordinary-item">${item}</div>`).join('');
    } else {
        container.style.display = 'none';
    }
}

function updateExtraordinaryScores() {
    checkExtraordinaryScores();
}

// Funciones de utilidad y debug
function toggleDebugInfo() {
    const debugInfo = document.getElementById('debug-info');
    const checkbox = document.getElementById('showDebugInfo');
    
    if (debugInfo) {
        debugInfo.style.display = checkbox.checked ? 'block' : 'none';
        
        if (checkbox.checked) {
            updateDebugInfo();
        }
    }
}

function updateDebugInfo() {
    const debugInfo = document.getElementById('debug-info');
    if (!debugInfo) return;
    
    const race = document.getElementById('race')?.value || 'none';
    const background = getSelectedBackground() || 'none';
    const size = document.getElementById('characterSize')?.value || 'Mediano';
    
    const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
    let debugText = `Sistema de c√°lculo activo\n`;
    debugText += `Raza: ${race} | Trasfondo: ${background} | Tama√±o: ${size}\n\n`;
    
    abilities.forEach(ability => {
        const base = parseInt(document.getElementById(`${ability}-base`).value) || 10;
        const final = parseInt(document.getElementById(`${ability}-final`).textContent) || 10;
        const shortName = ability.substring(0, 3);
        const racialMod = getRacialModifier(ability, race);
        const backgroundMod = getBackgroundModifier(ability, background);
        const sizeMod = getSizeModifier(ability, size);
        
        debugText += `${ability}: ${base} + ${racialMod} + ${backgroundMod} + ${sizeMod} = ${final}\n`;
    });
    
    debugInfo.textContent = debugText;
}

// Funciones de inicializaci√≥n y exportaci√≥n
function initializeAbilitiesTab() {
    // Calcular todos los valores iniciales
    const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
    
    abilities.forEach(ability => {
        calculateFinalAbility(ability);
    });
    
    updateConnectedSystems();
    
    // Configurar event listeners para cambios en raza, trasfondo y tama√±o
    const raceSelect = document.getElementById('race');
    if (raceSelect) {
        raceSelect.addEventListener('change', recalculateAllAbilities);
    }
    
    const sizeField = document.getElementById('characterSize');
    if (sizeField) {
        // Observer para cambios en el tama√±o (ya que se actualiza autom√°ticamente)
        const observer = new MutationObserver(recalculateAllAbilities);
        observer.observe(sizeField, { attributes: true, attributeFilter: ['value'] });
    }
}

function recalculateAllAbilities() {
    const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
    
    abilities.forEach(ability => {
        calculateFinalAbility(ability);
    });
    
    updateConnectedSystems();
    
    if (document.getElementById('showDebugInfo').checked) {
        updateDebugInfo();
    }
}

function exportAbilitiesData() {
    const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
    const data = {};
    
    abilities.forEach(ability => {
        const shortName = ability.substring(0, 3);
        data[ability] = {
            base: parseInt(document.getElementById(`${ability}-base`).value) || 10,
            final: parseInt(document.getElementById(`${ability}-final`).textContent) || 10,
            racial: parseInt(document.getElementById(`${shortName}-racial`).textContent.replace(/[+]/g, '')) || 0,
            background: parseInt(document.getElementById(`${shortName}-background`).textContent.replace(/[+]/g, '')) || 0,
            size: parseInt(document.getElementById(`${shortName}-size`).textContent.replace(/[+]/g, '')) || 0,
            source: document.getElementById(`${shortName}-source-tag`).getAttribute('data-source')
        };
    });
    
    return data;
}

function importAbilitiesData(data) {
    const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
    
    abilities.forEach(ability => {
        if (data[ability]) {
            const abilityData = data[ability];
            document.getElementById(`${ability}-base`).value = abilityData.base;
            
            if (abilityData.source) {
                updateSourceTag(ability, abilityData.source);
            }
            
            calculateFinalAbility(ability);
        }
    });
    
    updateConnectedSystems();
}

function validateAbilitiesTab() {
    const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
    const errors = [];
    
    abilities.forEach(ability => {
        const base = parseInt(document.getElementById(`${ability}-base`).value) || 10;
        const final = parseInt(document.getElementById(`${ability}-final`).textContent) || 10;
        
        if (base < 3 || base > 25) {
            errors.push(`${ability}: valor base debe estar entre 3 y 25`);
        }
        
        if (final < 1 || final > 25) {
            errors.push(`${ability}: valor final fuera de rango v√°lido`);
        }
    });
    
    if (errors.length > 0) {
        showNotification('Errores en habilidades:\n' + errors.join('\n'));
        return false;
    }
    
    return true;
}

// Funci√≥n de notificaci√≥n
function showNotification(message) {
    // Crear elemento de notificaci√≥n si no existe
    let notification = document.querySelector('.notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.className = 'notification';
        document.body.appendChild(notification);
    }
    
    notification.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// Event listeners para inicializaci√≥n autom√°tica
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (document.getElementById('abilities-tab')) {
            initializeAbilitiesTab();
        }
    }, 100);
});

// Funci√≥n global para recalcular cuando cambien otros elementos del personaje
window.recalculateAbilitiesFromExternal = recalculateAllAbilities;
</script>
<!-- Categories Tab -->
<div id="categories-tab" class="tab-content">
    <h2 style="color: #ffd700; margin-bottom: 2rem;">üèõÔ∏è Informaci√≥n de Categor√≠as</h2>
    
    <!-- Controles superiores -->
    <div class="categories-controls">
        <div class="control-group">
            <button class="btn btn-secondary" onclick="refreshCategoryInfo()">üîÑ Actualizar Informaci√≥n</button>
            <button class="btn btn-secondary" onclick="exportCategoryData()">üì§ Exportar Datos</button>
            <button class="btn btn-secondary" id="auto-apply-btn" onclick="toggleAutoApply()" disabled>
                ü§ñ Aplicaci√≥n Autom√°tica (Futuro)
            </button>
        </div>
        
        <div class="info-toggle">
            <label>
                <input type="checkbox" id="showProgressionTables" onchange="toggleProgressionTables()" checked> 
                Mostrar Tablas de Progresi√≥n
            </label>
        </div>
    </div>
    
    <!-- Informaci√≥n de Categor√≠a Principal -->
    <div class="category-info-section" id="primary-category-section">
        <h3 style="color: #ffd700; margin-bottom: 1rem;">üõ°Ô∏è Categor√≠a Principal</h3>
        <div class="category-card primary-card" id="primary-category-card">
            <div class="category-header">
                <div class="category-avatar" id="primary-avatar">‚ùì</div>
                <div class="category-main-info">
                    <div class="category-title" id="primary-title">Selecciona una categor√≠a principal</div>
                    <div class="category-subtitle" id="primary-subtitle">Desde el men√∫ lateral</div>
                    <div class="category-badge primary" id="primary-badge">Principal</div>
                </div>
            </div>
            <div class="category-content">
                <div class="category-description" id="primary-description">
                    La informaci√≥n de tu clase principal aparecer√° aqu√≠ cuando selecciones una opci√≥n en el men√∫ lateral.
                </div>
                <div class="category-stats-grid">
                    <div class="stat-group">
                        <h4>Requerimientos</h4>
                        <div id="primary-requirements">Selecciona una clase</div>
                    </div>
                    <div class="stat-group">
                        <h4>Dados de Golpe</h4>
                        <div id="primary-hit-die">-</div>
                    </div>
                    <div class="stat-group">
                        <h4>GACO Base (Nivel 1)</h4>
                        <div id="primary-thac0">-</div>
                    </div>
                    <div class="stat-group">
                        <h4>Pericias de Arma</h4>
                        <div id="primary-weapon-slots">-</div>
                    </div>
                </div>
                <div class="category-benefits">
                    <h4>Habilidades Especiales</h4>
                    <ul id="primary-benefits-list">
                        <li>Selecciona una categor√≠a para ver las habilidades</li>
                    </ul>
                </div>
                <div class="category-restrictions">
                    <h4>Restricciones</h4>
                    <ul id="primary-restrictions-list">
                        <li>Selecciona una categor√≠a para ver las restricciones</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Tabla de Progresi√≥n Principal -->
        <div class="progression-table-container" id="primary-progression">
            <h4>Progresi√≥n por Nivel</h4>
            <div class="progression-table" id="primary-progression-table">
                <div class="progression-message">Selecciona una clase para ver la progresi√≥n</div>
            </div>
        </div>
    </div>
    
    <!-- Informaci√≥n de Categor√≠a Secundaria -->
    <div class="category-info-section" id="secondary-category-section" style="display: none;">
        <h3 style="color: #ffd700; margin-bottom: 1rem;">‚öîÔ∏è Categor√≠a Secundaria</h3>
        <div class="category-card secondary-card" id="secondary-category-card">
            <div class="category-header">
                <div class="category-avatar" id="secondary-avatar">‚ùì</div>
                <div class="category-main-info">
                    <div class="category-title" id="secondary-title">Sin categor√≠a secundaria</div>
                    <div class="category-subtitle" id="secondary-subtitle">Opcional</div>
                    <div class="category-badge secondary" id="secondary-badge">Secundaria</div>
                </div>
            </div>
            <div class="category-content">
                <div class="category-description" id="secondary-description">
                    Las clases secundarias proporcionan habilidades adicionales pero con progresi√≥n m√°s lenta.
                </div>
                <div class="category-benefits">
                    <h4>Beneficios Adicionales</h4>
                    <ul id="secondary-benefits-list">
                        <li>Selecciona una categor√≠a secundaria</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Informaci√≥n de Categor√≠a Terciaria -->
    <div class="category-info-section" id="tertiary-category-section" style="display: none;">
        <h3 style="color: #ffd700; margin-bottom: 1rem;">‚ú® Categor√≠a Terciaria</h3>
        <div class="category-card tertiary-card" id="tertiary-category-card">
            <div class="category-header">
                <div class="category-avatar" id="tertiary-avatar">‚ùì</div>
                <div class="category-main-info">
                    <div class="category-title" id="tertiary-title">Sin categor√≠a terciaria</div>
                    <div class="category-subtitle" id="tertiary-subtitle">Opcional</div>
                    <div class="category-badge tertiary" id="tertiary-badge">Terciaria</div>
                </div>
            </div>
            <div class="category-content">
                <div class="category-description" id="tertiary-description">
                    Las clases terciarias ofrecen versatilidad adicional con progresi√≥n a√∫n m√°s lenta.
                </div>
                <div class="category-benefits">
                    <h4>Beneficios Menores</h4>
                    <ul id="tertiary-benefits-list">
                        <li>Selecciona una categor√≠a terciaria</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Resumen Combinado -->
    <div class="category-info-section">
        <h3 style="color: #ffd700; margin-bottom: 1rem;">üìä Resumen del Personaje</h3>
        <div class="character-summary-grid">
            <div class="summary-card">
                <h4>Estad√≠sticas Base</h4>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <span class="stat-label">GACO Base:</span>
                        <span class="stat-value" id="summary-gaco">20</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">Dados de Golpe:</span>
                        <span class="stat-value" id="summary-hit-dice">1d8</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">Salvaciones:</span>
                        <span class="stat-value" id="summary-saves">Guerrero Lv1</span>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <h4>Pericias Disponibles</h4>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <span class="stat-label">Armas:</span>
                        <span class="stat-value" id="summary-weapon-slots">4</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">No-Armas:</span>
                        <span class="stat-value" id="summary-nonweapon-slots">3</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-label">Idiomas Adicionales:</span>
                        <span class="stat-value" id="summary-languages">0</span>
                    </div>
                </div>
            </div>
            
            <div class="summary-card">
                <h4>Capacidades Especiales</h4>
                <div class="special-abilities-list" id="summary-special-abilities">
                    <div class="ability-item">Selecciona clases para ver capacidades</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Informaci√≥n de Trasfondo -->
    <div class="category-info-section" id="background-info-section" style="display: none;">
        <h3 style="color: #ffd700; margin-bottom: 1rem;">üìú Informaci√≥n de Trasfondo</h3>
        <div class="category-card background-card">
            <div class="category-header">
                <div class="category-avatar" id="background-avatar">üìú</div>
                <div class="category-main-info">
                    <div class="category-title" id="background-title">Trasfondo Seleccionado</div>
                    <div class="category-subtitle" id="background-subtitle">Historia del personaje</div>
                </div>
            </div>
            <div class="category-content">
                <div class="category-description" id="background-description">
                    Informaci√≥n del trasfondo aparecer√° aqu√≠.
                </div>
                <div class="category-benefits">
                    <h4>Beneficios del Trasfondo</h4>
                    <ul id="background-benefits-list">
                        <li>Selecciona un trasfondo para ver beneficios</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Estilos para Tab Categor√≠as */

.categories-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding: 1rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.control-group {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
}

.info-toggle {
    color: #b0b0b0;
    font-size: 0.85rem;
}

.info-toggle input[type="checkbox"] {
    margin-right: 0.5rem;
}

/* Secciones de categor√≠a */
.category-info-section {
    background: rgba(255, 255, 255, 0.06);
    border: 1px solid rgba(255, 255, 255, 0.12);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    position: relative;
}

.category-info-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, #ffd700, #ffed4e, #ffd700);
    border-radius: 12px 12px 0 0;
}

/* Cards de categor√≠a */
.category-card {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 12px;
    padding: 2rem;
    border: 2px solid transparent;
    transition: all 0.3s ease;
    margin-bottom: 1.5rem;
}

.primary-card {
    border-color: rgba(255, 215, 0, 0.4);
    background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
}

.secondary-card {
    border-color: rgba(156, 39, 176, 0.4);
    background: linear-gradient(135deg, rgba(156, 39, 176, 0.1), rgba(156, 39, 176, 0.05));
}

.tertiary-card {
    border-color: rgba(76, 175, 80, 0.4);
    background: linear-gradient(135deg, rgba(76, 175, 80, 0.1), rgba(76, 175, 80, 0.05));
}

.background-card {
    border-color: rgba(255, 152, 0, 0.4);
    background: linear-gradient(135deg, rgba(255, 152, 0, 0.1), rgba(255, 152, 0, 0.05));
}

/* Header de categor√≠a */
.category-header {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.category-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2.5rem;
    color: #1a1a2e;
    flex-shrink: 0;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
}

.category-main-info {
    flex: 1;
}

.category-title {
    font-size: 1.4rem;
    font-weight: bold;
    color: #ffd700;
    margin-bottom: 0.5rem;
}

.category-subtitle {
    color: #b0b0b0;
    font-size: 0.9rem;
    margin-bottom: 1rem;
    font-style: italic;
}

.category-badge {
    display: inline-block;
    padding: 0.4rem 1rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.category-badge.primary {
    background: rgba(255, 215, 0, 0.2);
    color: #ffd700;
    border: 1px solid rgba(255, 215, 0, 0.4);
}

.category-badge.secondary {
    background: rgba(156, 39, 176, 0.2);
    color: #9c27b0;
    border: 1px solid rgba(156, 39, 176, 0.4);
}

.category-badge.tertiary {
    background: rgba(76, 175, 80, 0.2);
    color: #4caf50;
    border: 1px solid rgba(76, 175, 80, 0.4);
}

/* Contenido de categor√≠a */
.category-content {
    display: grid;
    gap: 2rem;
}

.category-description {
    color: #e5e5e5;
    line-height: 1.6;
    font-size: 1rem;
    background: rgba(255, 255, 255, 0.03);
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #ffd700;
}

.category-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.stat-group {
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-group h4 {
    color: #ffd700;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.stat-group div {
    color: #e5e5e5;
    font-size: 1.1rem;
    font-weight: bold;
}

.category-benefits, .category-restrictions {
    background: rgba(255, 255, 255, 0.03);
    border-radius: 8px;
    padding: 1.5rem;
}

.category-benefits h4, .category-restrictions h4 {
    color: #ffd700;
    margin-bottom: 1rem;
    font-size: 1.1rem;
}

.category-benefits ul, .category-restrictions ul {
    list-style: none;
    padding: 0;
}

.category-benefits li {
    color: #e5e5e5;
    margin-bottom: 0.5rem;
    padding-left: 1.5rem;
    position: relative;
}

.category-benefits li::before {
    content: "‚úì";
    position: absolute;
    left: 0;
    color: #4caf50;
    font-weight: bold;
}

.category-restrictions li {
    color: #ffb74d;
    margin-bottom: 0.5rem;
    padding-left: 1.5rem;
    position: relative;
}

.category-restrictions li::before {
    content: "‚ö†";
    position: absolute;
    left: 0;
    color: #ff9800;
    font-weight: bold;
}

/* Tablas de progresi√≥n */
.progression-table-container {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    margin-top: 1rem;
}

.progression-table-container h4 {
    color: #ffd700;
    margin-bottom: 1rem;
    text-align: center;
}

.progression-table {
    overflow-x: auto;
    border-radius: 8px;
}

.progression-message {
    text-align: center;
    color: #b0b0b0;
    font-style: italic;
    padding: 2rem;
}

.progression-table table {
    width: 100%;
    border-collapse: collapse;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    overflow: hidden;
}

.progression-table th,
.progression-table td {
    padding: 0.8rem;
    text-align: center;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    font-size: 0.9rem;
}

.progression-table th {
    background: rgba(255, 215, 0, 0.2);
    color: #ffd700;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.progression-table td {
    color: #e5e5e5;
}

.progression-table tr:hover td {
    background: rgba(255, 255, 255, 0.08);
}

/* Resumen del personaje */
.character-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
}

.summary-card {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 10px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.summary-card h4 {
    color: #ffd700;
    margin-bottom: 1rem;
    text-align: center;
}

.summary-stats {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.summary-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.5rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 6px;
    border-left: 3px solid #ffd700;
}

.stat-label {
    color: #e5e5e5;
    font-weight: 500;
    font-size: 0.9rem;
}

.stat-value {
    color: #ffd700;
    font-weight: bold;
    font-size: 1rem;
}

.special-abilities-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.ability-item {
    background: rgba(255, 255, 255, 0.05);
    padding: 0.5rem;
    border-radius: 6px;
    border-left: 3px solid #4caf50;
    color: #e5e5e5;
    font-size: 0.9rem;
}

/* Responsive Design */
@media (max-width: 1024px) {
    .category-header {
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .category-stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .categories-controls {
        flex-direction: column;
        gap: 1rem;
        text-align: center;
    }
    
    .character-summary-grid {
        grid-template-columns: 1fr;
    }
    
    .category-stats-grid {
        grid-template-columns: 1fr;
    }
    
    .progression-table {
        font-size: 0.8rem;
    }
    
    .progression-table th,
    .progression-table td {
        padding: 0.5rem 0.3rem;
    }
}

/* Animaciones y efectos */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.category-card {
    animation: fadeIn 0.3s ease;
}

.category-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}
</style>

<script>
// Base de datos completa de clases AD&D 2nd Edition

const classDatabase = {
    // LUCHADORES
    'B√°rbaro': {
        avatar: 'ü™ì',
        subtitle: 'Guerrero tribal salvaje',
        description: 'Los b√°rbaros son guerreros primitivos de tierras inh√≥spitas. Luchan con furia descontrolada y poseen resistencias naturales extraordinarias. Viven seg√∫n c√≥digos tribales antiguos y desconf√≠an de la magia y la civilizaci√≥n.',
        requirements: 'Fue: 15+, Des: 14+, Con: 15+',
        hitDie: '1d12',
        thac0: 20,
        weaponSlots: 4,
        nonweaponSlots: 3,
        benefits: [
            'Furia berserker (+2 ataque/da√±o, -2 CA)',
            'Resistencia a magias (+2 salvaciones)',
            'Supervivencia en tierras salvajes',
            'Salto hacia atr√°s (evitar ataques por la espalda)',
            'Resistencia a ilusiones y encantamientos',
            'Uso limitado de objetos m√°gicos'
        ],
        restrictions: [
            'No puede usar armadura m√°s pesada que cota de malla',
            'M√°ximo 1 objeto m√°gico por categor√≠a',
            'No puede aprender a leer/escribir (inicialmente)',
            'Debe mantener c√≥digo tribal'
        ],
        progression: [
            {level: 1, xp: 0, gaco: 20, saves: [14, 16, 15, 17, 17], hp: 12},
            {level: 2, xp: 2000, gaco: 19, saves: [14, 16, 15, 17, 17], hp: 24},
            {level: 3, xp: 4000, gaco: 18, saves: [13, 15, 14, 16, 16], hp: 36},
            {level: 4, xp: 8000, gaco: 17, saves: [13, 15, 14, 16, 16], hp: 48},
            {level: 5, xp: 16000, gaco: 16, saves: [11, 13, 12, 13, 14], hp: 60}
        ]
    },
    
    'Ranger': {
        avatar: 'üèπ',
        subtitle: 'Guardi√°n de las fronteras',
        description: 'Los rangers son exploradores expertos y protectores de la naturaleza. Combinan habilidades de combate con conocimiento del mundo natural, rastreo y capacidades m√°gicas menores.',
        requirements: 'Fue: 13+, Des: 13+, Con: 14+, Sab: 14+',
        hitDie: '1d10',
        thac0: 20,
        weaponSlots: 4,
        nonweaponSlots: 3,
        benefits: [
            'Rastreo y supervivencia',
            'Enemigos favoritos (+4 ataque/da√±o)',
            'Combate con dos armas (sin penalizaci√≥n)',
            'Conjuros de druida (nivel 8+)',
            'Esconderse en sombras',
            'Moverse en silencio',
            'Seguidores animales (nivel 10+)'
        ],
        restrictions: [
            'Debe ser bueno o neutral',
            'No puede usar objetos m√°gicos de escritura',
            'M√°ximo de armadura: cota de malla √©lfica',
            'Debe proteger la naturaleza'
        ],
        progression: [
            {level: 1, xp: 0, gaco: 20, saves: [14, 16, 15, 17, 17], hp: 10},
            {level: 2, xp: 2250, gaco: 19, saves: [14, 16, 15, 17, 17], hp: 20},
            {level: 3, xp: 4500, gaco: 18, saves: [13, 15, 14, 16, 16], hp: 30},
            {level: 4, xp: 9000, gaco: 17, saves: [13, 15, 14, 16, 16], hp: 40},
            {level: 8, xp: 150000, gaco: 13, saves: [11, 13, 12, 13, 14], hp: 80, spells: '1st: 1'}
        ]
    },
    
    'Guerrero': {
        avatar: '‚öîÔ∏è',
        subtitle: 'Maestro de las armas',
        description: 'Los guerreros son combatientes profesionales, maestros del arte de la guerra. Son los m√°s vers√°tiles en combate y pueden especializarse en cualquier arma.',
        requirements: 'Fue: 9+',
        hitDie: '1d10',
        thac0: 20,
        weaponSlots: 4,
        nonweaponSlots: 3,
        benefits: [
            'Especializaci√≥n en armas',
            'Ataques m√∫ltiples por ronda (altos niveles)',
            'Uso de todas las armas y armaduras',
            'Bonificaci√≥n de +1 cada 3 niveles',
            'Liderazgo de tropas',
            'Construcci√≥n de fortalezas'
        ],
        restrictions: [
            'No puede lanzar conjuros',
            'Limitado en habilidades de ladr√≥n'
        ],
        progression: [
            {level: 1, xp: 0, gaco: 20, saves: [14, 16, 15, 17, 17], hp: 10},
            {level: 2, xp: 2000, gaco: 19, saves: [14, 16, 15, 17, 17], hp: 20},
            {level: 3, xp: 4000, gaco: 18, saves: [13, 15, 14, 16, 16], hp: 30},
            {level: 4, xp: 8000, gaco: 17, saves: [13, 15, 14, 16, 16], hp: 40},
            {level: 7, xp: 64000, gaco: 14, saves: [11, 13, 12, 13, 14], hp: 70, attacks: '3/2'}
        ]
    },
    
    // SACERDOTES
    'Cl√©rigo': {
        avatar: '‚õ™',
        subtitle: 'Servidor de los dioses',
        description: 'Los cl√©rigos son servidores divinos que canalizan el poder de sus deidades. Combinan capacidades de combate con poderosa magia divina, especialmente sanaci√≥n.',
        requirements: 'Sab: 9+',
        hitDie: '1d8',
        thac0: 20,
        weaponSlots: 2,
        nonweaponSlots: 4,
        benefits: [
            'Conjuros divinos',
            'Rechazar muertos vivientes',
            'Sanaci√≥n m√°gica',
            'Protecci√≥n vs. mal',
            'Bendiciones y maldiciones',
            'Comuni√≥n con deidad'
        ],
        restrictions: [
            'Armas limitadas (seg√∫n deidad)',
            'Debe seguir preceptos religiosos',
            'No puede usar armas de filo (tradicional)',
            'Debe ser leal a su alineamiento'
        ],
        progression: [
            {level: 1, xp: 0, gaco: 20, saves: [10, 14, 13, 16, 15], hp: 8, spells: '1st: 1'},
            {level: 2, xp: 1500, gaco: 20, saves: [10, 14, 13, 16, 15], hp: 16, spells: '1st: 2'},
            {level: 3, xp: 3000, gaco: 20, saves: [9, 13, 12, 15, 14], hp: 24, spells: '1st: 2, 2nd: 1'},
            {level: 4, xp: 6000, gaco: 18, saves: [9, 13, 12, 15, 14], hp: 32, spells: '1st: 3, 2nd: 2'},
            {level: 5, xp: 13000, gaco: 18, saves: [7, 11, 10, 13, 12], hp: 40, spells: '1st: 3, 2nd: 3, 3rd: 1'}
        ]
    },
    
    'Druida': {
        avatar: 'üåø',
        subtitle: 'Guardi√°n de la naturaleza',
        description: 'Los druidas son sacerdotes de la naturaleza que protegen el equilibrio natural. Poseen conocimiento profundo del mundo natural y magia relacionada con plantas, animales y elementos.',
        requirements: 'Sab: 12+, Car: 15+',
        hitDie: '1d8',
        thac0: 20,
        weaponSlots: 2,
        nonweaponSlots: 4,
        benefits: [
            'Conjuros de druida',
            'Forma animal (shapechange)',
            'Conocimiento de la naturaleza',
            'Inmunidad a encantamientos de s√≠lfides',
            'Lenguaje secreto de druidas',
            'Paso sin huellas',
            'Resistencia a fuego y fr√≠o'
        ],
        restrictions: [
            'Debe ser neutral (exactamente)',
            'Solo armas y armaduras naturales',
            'No puede tocar metales trabajados',
            'M√°ximo n√∫mero por √°rea geogr√°fica'
        ],
        progression: [
            {level: 1, xp: 0, gaco: 20, saves: [10, 14, 13, 16, 15], hp: 8, spells: '1st: 2'},
            {level: 2, xp: 2000, gaco: 20, saves: [10, 14, 13, 16, 15], hp: 16, spells: '1st: 2, 2nd: 1'},
            {level: 3, xp: 4000, gaco: 20, saves: [9, 13, 12, 15, 14], hp: 24, spells: '1st: 3, 2nd: 2'},
            {level: 7, xp: 60000, gaco: 16, saves: [7, 11, 10, 13, 12], hp: 56, spells: '1st: 4, 2nd: 4, 3rd: 3, 4th: 1', shapechange: '3/day'}
        ]
    },
    
    // HECHICEROS
    'Mago': {
        avatar: 'üîÆ',
        subtitle: 'Maestro de lo arcano',
        description: 'Los magos son estudiosos de la magia arcana que manipulan las fuerzas m√≠sticas del universo a trav√©s del conocimiento y estudio de conjuros antiguos.',
        requirements: 'Int: 9+',
        hitDie: '1d4',
        thac0: 21,
        weaponSlots: 1,
        nonweaponSlots: 4,
        benefits: [
            'Conjuros arcanos',
            'Familiar m√°gico',
            'Investigaci√≥n m√°gica',
            'Creaci√≥n de objetos m√°gicos',
            'Biblioteca de conjuros',
            'Identificaci√≥n de magia'
        ],
        restrictions: [
            'Armadura muy limitada',
            'Pocas armas permitidas',
            'Vulnerable en combate f√≠sico',
            'Necesita componentes para conjuros'
        ],
        progression: [
            {level: 1, xp: 0, gaco: 21, saves: [14, 11, 13, 15, 12], hp: 4, spells: '1st: 1'},
            {level: 2, xp: 2500, gaco: 21, saves: [14, 11, 13, 15, 12], hp: 8, spells: '1st: 2'},
            {level: 3, xp: 5000, gaco: 20, saves: [13, 10, 12, 14, 11], hp: 12, spells: '1st: 2, 2nd: 1'},
            {level: 5, xp: 20000, gaco: 20, saves: [11, 8, 10, 12, 9], hp: 20, spells: '1st: 4, 2nd: 2, 3rd: 1'},
            {level: 9, xp: 135000, gaco: 18, saves: [7, 4, 6, 8, 5], hp: 36, spells: '1st: 4, 2nd: 3, 3rd: 3, 4th: 2, 5th: 1'}
        ]
    },
    
    // BRIBONES
    'Ladr√≥n': {
        avatar: 'üó°Ô∏è',
        subtitle: 'Maestro de las sombras',
        description: 'Los ladrones son expertos en sigilo, trampas y combate furtivo. Viven al margen de la sociedad usando habilidades especializadas para sobrevivir.',
        requirements: 'Des: 9+',
        hitDie: '1d6',
        thac0: 21,
        weaponSlots: 2,
        nonweaponSlots: 4,
        benefits: [
            'Habilidades de ladr√≥n (escalar, esconderse, etc.)',
            'Ataque por la espalda',
            'Detectar y desarmar trampas',
            'Abrir cerraduras',
            'Leer idiomas (altos niveles)',
            'Uso de pergaminos (altos niveles)'
        ],
        restrictions: [
            'Armadura limitada',
            'Armas limitadas',
            'C√≥digo del hampa',
            'Restricciones sociales'
        ],
        progression: [
            {level: 1, xp: 0, gaco: 21, saves: [13, 14, 12, 16, 15], hp: 6, skills: 'Base'},
            {level: 2, xp: 1250, gaco: 21, saves: [13, 14, 12, 16, 15], hp: 12, skills: '+25'},
            {level: 3, xp: 2500, gaco: 20, saves: [12, 13, 11, 15, 14], hp: 18, skills: '+25'},
            {level: 4, xp: 5000, gaco: 20, saves: [12, 13, 11, 15, 14], hp: 24, skills: '+25', backstab: 'x3'},
            {level: 9, xp: 70000, gaco: 16, saves: [9, 10, 8, 12, 11], hp: 54, skills: '+25', backstab: 'x4'}
        ]
    },
    
    'Bardo': {
        avatar: 'üéµ',
        subtitle: 'Trovador y erudito',
        description: 'Los bardos son artistas vers√°tiles que combinan m√∫sica, magia y conocimiento. Son narradores, diplom√°ticos y aventureros con habilidades diversas.',
        requirements: 'Des: 12+, Int: 13+, Car: 15+',
        hitDie: '1d6',
        thac0: 20,
        weaponSlots: 3,
        nonweaponSlots: 4,
        benefits: [
            'Conjuros limitados (mago)',
            'Habilidades de ladr√≥n limitadas',
            'Influencia/Fascinaci√≥n',
            'Conocimiento legendario',
            'Idiomas adicionales',
            'Identificar objetos m√°gicos'
        ],
        restrictions: [
            'Armadura limitada',
            'No puede especializarse en armas',
            'Progresi√≥n m√°s lenta en todas las √°reas'
        ],
        progression: [
            {level: 1, xp: 0, gaco: 20, saves: [13, 14, 12, 16, 15], hp: 6},
            {level: 2, xp: 2000, gaco: 20, saves: [13, 14, 12, 16, 15], hp: 12, spells: '1st: 1'},
            {level: 3, xp: 4000, gaco: 19, saves: [12, 13, 11, 15, 14], hp: 18, spells: '1st: 2'},
            {level: 4, xp: 8000, gaco: 19, saves: [12, 13, 11, 15, 14], hp: 24, spells: '1st: 2, 2nd: 1'},
            {level: 7, xp: 40000, gaco: 16, saves: [10, 11, 9, 13, 12], hp: 42, spells: '1st: 3, 2nd: 2, 3rd: 1'}
        ]
    },
    
    'Psi√≥nico': {
        avatar: 'üß†',
        subtitle: 'Maestro de la mente',
        description: 'Los psi√≥nicos manipulan poderes mentales para afectar la realidad. Usan disciplinas ps√≠quicas en lugar de conjuros tradicionales.',
        requirements: 'Con: 11+, Int: 12+, Sab: 15+',
        hitDie: '1d6',
        thac0: 20,
        weaponSlots: 2,
        nonweaponSlots: 4,
        benefits: [
            'Poderes psi√≥nicos (PSP)',
            'Disciplinas mentales',
            'Resistencia ps√≠quica',
            'Detecci√≥n ps√≠quica',
            'Contacto mental',
            'Defensa vs. ataques mentales'
        ],
        restrictions: [
            'Vulnerable a ataques ps√≠quicos',
            'PSP limitados por nivel',
            'Concentraci√≥n requerida',
            'Rechazo social posible'
        ],
        progression: [
            {level: 1, xp: 0, gaco: 20, saves: [13, 14, 12, 16, 15], hp: 6, psp: 20},
            {level: 2, xp: 2200, gaco: 20, saves: [13, 14, 12, 16, 15], hp: 12, psp: 30},
            {level: 3, xp: 4400, gaco: 19, saves: [12, 13, 11, 15, 14], hp: 18, psp: 40},
            {level: 4, xp: 8800, gaco: 19, saves: [12, 13, 11, 15, 14], hp: 24, psp: 50},
            {level: 9, xp: 200000, gaco: 16, saves: [9, 10, 8, 12, 11], hp: 54, psp: 100}
        ]
    }
};

// Base de datos de trasfondos
const backgroundDatabase = {
    'Soldado': {
        description: 'Veterano de guerra con experiencia en combate organizado y disciplina militar.',
        benefits: ['Entrenamiento marcial', 'Conocimiento militar', 'Camarader√≠a con soldados', 'Resistencia f√≠sica']
    },
    'Guardia': {
        description: 'Protector de la ley y el orden en comunidades civilizadas.',
        benefits: ['Conocimiento legal', 'Autoridad local', 'Entrenamiento en combate urbano', 'Contactos oficiales']
    },
    'Acolito': {
        description: 'Seguidor devoto entrenado en los misterios de una fe espec√≠fica.',
        benefits: ['Conocimiento religioso', 'Acceso a templos', 'Redes religiosas', 'Entrenamiento ceremonial']
    },
    'Erudito': {
        description: 'Estudioso dedicado al conocimiento y la investigaci√≥n acad√©mica.',
        benefits: ['Vasto conocimiento', 'Acceso a bibliotecas', 'Contactos acad√©micos', 'Habilidades de investigaci√≥n']
    },
    'Noble': {
        description: 'Miembro de la aristocracia con educaci√≥n refinada y conexiones pol√≠ticas.',
        benefits: ['Influencia social', 'Recursos financieros', 'Educaci√≥n refinada', 'Contactos nobles']
    },
    'Charlat√°n': {
        description: 'Estafador h√°bil en el enga√±o y la manipulaci√≥n social.',
        benefits: ['Habilidades de enga√±o', 'Contactos criminales', 'Falsificaci√≥n', 'Persuasi√≥n']
    }
};

// Variables globales
let currentClassData = {};
let autoApplyMode = false;

// Funciones principales
function refreshCategoryInfo() {
    // Obtener selecciones actuales
    const primaryClass = getPrimaryClass();
    const secondaryClass = getSecondaryClass();
    const tertiaryClass = getTertiaryClass();
    const background = getSelectedBackground();
    
    // Actualizar cada secci√≥n
    if (primaryClass && classDatabase[primaryClass]) {
        updateCategoryDisplay('primary', classDatabase[primaryClass], primaryClass);
        document.getElementById('primary-category-section').style.display = 'block';
    }
    
    if (secondaryClass && classDatabase[secondaryClass]) {
        updateCategoryDisplay('secondary', classDatabase[secondaryClass], secondaryClass);
        document.getElementById('secondary-category-section').style.display = 'block';
    }
    
    if (tertiaryClass && classDatabase[tertiaryClass]) {
        updateCategoryDisplay('tertiary', classDatabase[tertiaryClass], tertiaryClass);
        document.getElementById('tertiary-category-section').style.display = 'block';
    }
    
    if (background && backgroundDatabase[background]) {
        updateBackgroundDisplay(backgroundDatabase[background], background);
        document.getElementById('background-info-section').style.display = 'block';
    }
    
    // Actualizar resumen combinado
    updateCharacterSummary();
    
    showNotification('Informaci√≥n de categor√≠as actualizada');
}

function updateCategoryDisplay(level, classData, className) {
    const prefix = level;
    
    // Actualizar header
    document.getElementById(`${prefix}-avatar`).textContent = classData.avatar;
    document.getElementById(`${prefix}-title`).textContent = className;
    document.getElementById(`${prefix}-subtitle`).textContent = classData.subtitle;
    
    // Actualizar descripci√≥n y stats
    document.getElementById(`${prefix}-description`).textContent = classData.description;
    document.getElementById(`${prefix}-requirements`).textContent = classData.requirements;
    document.getElementById(`${prefix}-hit-die`).textContent = classData.hitDie;
    document.getElementById(`${prefix}-thac0`).textContent = classData.thac0;
    document.getElementById(`${prefix}-weapon-slots`).textContent = classData.weaponSlots;
    
    // Actualizar beneficios
    const benefitsList = document.getElementById(`${prefix}-benefits-list`);
    benefitsList.innerHTML = classData.benefits.map(benefit => `<li>${benefit}</li>`).join('');
    
    // Actualizar restricciones (solo para clase principal)
    if (level === 'primary') {
        const restrictionsList = document.getElementById(`${prefix}-restrictions-list`);
        restrictionsList.innerHTML = classData.restrictions.map(restriction => `<li>${restriction}</li>`).join('');
        
        // Actualizar tabla de progresi√≥n
        updateProgressionTable(classData.progression);
    }
}

function updateProgressionTable(progression) {
    const container = document.getElementById('primary-progression-table');
    
    if (!progression || progression.length === 0) {
        container.innerHTML = '<div class="progression-message">No hay datos de progresi√≥n disponibles</div>';
        return;
    }
    
    let tableHTML = `
        <table>
            <thead>
                <tr>
                    <th>Nivel</th>
                    <th>XP</th>
                    <th>GACO</th>
                    <th>PG</th>
                    <th>Salvaciones</th>
                    <th>Especial</th>
                </tr>
            </thead>
            <tbody>
    `;
    
    progression.forEach(row => {
        const saves = row.saves ? row.saves.join('/') : '-';
        const special = [];
        if (row.spells) special.push(`Conjuros: ${row.spells}`);
        if (row.attacks) special.push(`Ataques: ${row.attacks}`);
        if (row.psp) special.push(`PSP: ${row.psp}`);
        if (row.shapechange) special.push(`Cambio forma: ${row.shapechange}`);
        if (row.backstab) special.push(`Ataque espalda: ${row.backstab}`);
        if (row.skills) special.push(`Habilidades: ${row.skills}`);
        
        tableHTML += `
            <tr>
                <td>${row.level}</td>
                <td>${row.xp.toLocaleString()}</td>
                <td>${row.gaco}</td>
                <td>${row.hp}</td>
                <td>${saves}</td>
                <td>${special.join(', ') || '-'}</td>
            </tr>
        `;
    });
    
    tableHTML += `
            </tbody>
        </table>
    `;
    
    container.innerHTML = tableHTML;
}

function updateBackgroundDisplay(backgroundData, backgroundName) {
    document.getElementById('background-title').textContent = backgroundName;
    document.getElementById('background-description').textContent = backgroundData.description;
    
    const benefitsList = document.getElementById('background-benefits-list');
    benefitsList.innerHTML = backgroundData.benefits.map(benefit => `<li>${benefit}</li>`).join('');
}

function updateCharacterSummary() {
    const primaryClass = getPrimaryClass();
    const level = parseInt(document.getElementById('Level')?.value) || 1;
    
    if (primaryClass && classDatabase[primaryClass]) {
        const classData = classDatabase[primaryClass];
        const levelData = findLevelData(classData.progression, level);
        
        // Actualizar stats b√°sicos
        document.getElementById('summary-gaco').textContent = levelData ? levelData.gaco : classData.thac0;
        document.getElementById('summary-hit-dice').textContent = classData.hitDie;
        document.getElementById('summary-saves').textContent = `${primaryClass} Lv${level}`;
        
        // Actualizar pericias
        document.getElementById('summary-weapon-slots').textContent = classData.weaponSlots;
        document.getElementById('summary-nonweapon-slots').textContent = classData.nonweaponSlots;
        
        // Actualizar capacidades especiales
        const abilitiesList = document.getElementById('summary-special-abilities');
        const topBenefits = classData.benefits.slice(0, 3);
        abilitiesList.innerHTML = topBenefits.map(benefit => 
            `<div class="ability-item">${benefit}</div>`
        ).join('');
        
        // Actualizar idiomas desde habilidades
        const intFinal = parseInt(document.getElementById('intelligence-final')?.textContent) || 10;
        const intData = findIntelligenceData(intFinal);
        document.getElementById('summary-languages').textContent = intData ? intData.languages : 0;
    }
}

function findLevelData(progression, level) {
    if (!progression) return null;
    
    // Encontrar el nivel m√°s alto que no exceda el nivel actual
    let bestMatch = progression[0];
    for (let i = 0; i < progression.length; i++) {
        if (progression[i].level <= level) {
            bestMatch = progression[i];
        } else {
            break;
        }
    }
    return bestMatch;
}

function findIntelligenceData(score) {
    // Datos simplificados de inteligencia para idiomas
    const intTable = [
        {score: 8, languages: 1},
        {score: 9, languages: 2},
        {score: 12, languages: 3},
        {score: 14, languages: 4},
        {score: 16, languages: 5},
        {score: 17, languages: 6},
        {score: 18, languages: 7},
        {score: 19, languages: 8}
    ];
    
    let bestMatch = intTable[0];
    for (let i = 0; i < intTable.length; i++) {
        if (intTable[i].score <= score) {
            bestMatch = intTable[i];
        }
    }
    return bestMatch;
}

// Funciones de utilidad
function getPrimaryClass() {
    return document.getElementById('primary-selected-name')?.textContent?.trim();
}

function getSecondaryClass() {
    const text = document.getElementById('secondary-selected-name')?.textContent?.trim();
    return (text && text !== 'Sin categor√≠a secundaria' && text !== 'Selecciona primero una categor√≠a principal') ? text : null;
}

function getTertiaryClass() {
    const text = document.getElementById('tertiary-selected-name')?.textContent?.trim();
    return (text && text !== 'Sin categor√≠a terciaria' && text !== 'Selecciona primero una categor√≠a secundaria') ? text : null;
}

function getSelectedBackground() {
    const text = document.getElementById('background-selected-name')?.textContent?.trim();
    return (text && text !== 'Selecciona un trasfondo' && text !== 'Selecciona primero una clase') ? text : null;
}

function toggleProgressionTables() {
    const checkbox = document.getElementById('showProgressionTables');
    const tables = document.querySelectorAll('.progression-table-container');
    
    tables.forEach(table => {
        table.style.display = checkbox.checked ? 'block' : 'none';
    });
}

// Funciones para futura automatizaci√≥n
function toggleAutoApply() {
    autoApplyMode = !autoApplyMode;
    const button = document.getElementById('auto-apply-btn');
    
    if (autoApplyMode) {
        button.textContent = 'ü§ñ Aplicaci√≥n Autom√°tica (ON)';
        button.classList.add('active');
        showNotification('Modo autom√°tico activado - Los cambios se aplicar√°n autom√°ticamente');
        // TODO: Implementar aplicaci√≥n autom√°tica
    } else {
        button.textContent = 'ü§ñ Aplicaci√≥n Autom√°tica (OFF)';
        button.classList.remove('active');
        showNotification('Modo autom√°tico desactivado');
    }
}

function applyClassBonuses() {
    // FUNCI√ìN PREPARADA PARA FUTURA IMPLEMENTACI√ìN
    const primaryClass = getPrimaryClass();
    const level = parseInt(document.getElementById('Level')?.value) || 1;
    
    if (!autoApplyMode || !primaryClass || !classDatabase[primaryClass]) {
        return;
    }
    
    const classData = classDatabase[primaryClass];
    const levelData = findLevelData(classData.progression, level);
    
    // TODO: Aplicar autom√°ticamente:
    // - GACO seg√∫n clase y nivel
    // - Salvaciones seg√∫n clase y nivel  
    // - Slots de pericias
    // - HP base seg√∫n dado de golpe
    // - Restricciones de armas/armaduras
    
    console.log('Aplicando bonificaciones autom√°ticas...', {
        className: primaryClass,
        level: level,
        classData: classData,
        levelData: levelData
    });
}

function exportCategoryData() {
    const data = {
        primary: {
            className: getPrimaryClass(),
            data: getPrimaryClass() ? classDatabase[getPrimaryClass()] : null
        },
        secondary: {
            className: getSecondaryClass(),
            data: getSecondaryClass() ? classDatabase[getSecondaryClass()] : null
        },
        tertiary: {
            className: getTertiaryClass(),
            data: getTertiaryClass() ? classDatabase[getTertiaryClass()] : null
        },
        background: {
            name: getSelectedBackground(),
            data: getSelectedBackground() ? backgroundDatabase[getSelectedBackground()] : null
        },
        autoApplyMode: autoApplyMode,
        lastUpdate: new Date().toISOString()
    };
    
    console.log('Datos de categor√≠as exportados:', data);
    showNotification('Datos exportados a consola');
    return data;
}

// Funci√≥n de notificaci√≥n
function showNotification(message) {
    let notification = document.querySelector('.notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.className = 'notification';
        document.body.appendChild(notification);
    }
    
    notification.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

// Inicializaci√≥n autom√°tica
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
        if (document.getElementById('categories-tab')) {
            refreshCategoryInfo();
            
            // Observer para cambios en los dropdowns
            const observer = new MutationObserver(() => {
                setTimeout(refreshCategoryInfo, 100);
            });
            
            ['primary-selected-name', 'secondary-selected-name', 'tertiary-selected-name', 'background-selected-name'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    observer.observe(element, { childList: true, characterData: true, subtree: true });
                }
            });
        }
    }, 200);
});

// Funci√≥n global para actualizaci√≥n externa
window.updateCategoriesFromExternal = refreshCategoryInfo;
<!-- COMBAT TAB -->
<div id="combat-tab" class="tab-content">
    <div class="combat-container">
        <!-- Combat Stats Section -->
        <div class="combat-stats-grid">
            <!-- Armor Class Card -->
            <div class="combat-stat-card">
                <div class="stat-header">
                    <h3>üõ°Ô∏è Clase de Armadura (CA)</h3>
                    <button class="detail-toggle" onclick="toggleCombatDetail('ac-details')">üìä</button>
                </div>
                <div class="ac-display">
                    <div class="ac-main-value">
                        <span id="final-ac">10</span>
                        <small>CA Total</small>
                    </div>
                    <div class="ac-breakdown" id="ac-details" style="display: none;">
                        <div class="ac-component">
                            <span>Base:</span>
                            <span id="ac-base">10</span>
                        </div>
                        <div class="ac-component">
                            <span>Armadura:</span>
                            <span id="ac-armor">0</span>
                        </div>
                        <div class="ac-component">
                            <span>Escudo:</span>
                            <span id="ac-shield">0</span>
                        </div>
                        <div class="ac-component">
                            <span>Destreza:</span>
                            <span id="ac-dex">0</span>
                        </div>
                        <div class="ac-component">
                            <span>M√°gico:</span>
                            <input type="number" id="ac-magic" value="0" min="-10" max="10" onchange="updateCombatStats()">
                        </div>
                        <div class="ac-component">
                            <span>Otros:</span>
                            <input type="number" id="ac-misc" value="0" min="-10" max="10" onchange="updateCombatStats()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- THAC0 Card -->
            <div class="combat-stat-card">
                <div class="stat-header">
                    <h3>‚öîÔ∏è GACO</h3>
                    <button class="detail-toggle" onclick="toggleCombatDetail('gaco-details')">üìä</button>
                </div>
                <div class="gaco-display">
                    <div class="gaco-main-value">
                        <span id="final-gaco">20</span>
                        <small>GACO Total</small>
                    </div>
                    <div class="gaco-breakdown" id="gaco-details" style="display: none;">
                        <div class="gaco-component">
                            <span>Base (Clase/Nivel):</span>
                            <span id="gaco-base">20</span>
                        </div>
                        <div class="gaco-component">
                            <span>Fuerza:</span>
                            <span id="gaco-str">0</span>
                        </div>
                        <div class="gaco-component">
                            <span>Arma M√°gica:</span>
                            <input type="number" id="gaco-magic" value="0" min="-10" max="10" onchange="updateCombatStats()">
                        </div>
                        <div class="gaco-component">
                            <span>Especializaci√≥n:</span>
                            <span id="gaco-spec">0</span>
                        </div>
                        <div class="gaco-component">
                            <span>Otros:</span>
                            <input type="number" id="gaco-misc" value="0" min="-10" max="10" onchange="updateCombatStats()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Initiative Card -->
            <div class="combat-stat-card">
                <div class="stat-header">
                    <h3>‚ö° Iniciativa</h3>
                </div>
                <div class="initiative-display">
                    <div class="initiative-value">
                        <span id="initiative-mod">+0</span>
                        <small>Modificador</small>
                    </div>
                    <div class="initiative-breakdown">
                        <div class="initiative-component">
                            <span>Destreza:</span>
                            <span id="init-dex">0</span>
                        </div>
                        <div class="initiative-component">
                            <span>Tama√±o:</span>
                            <span id="init-size">0</span>
                        </div>
                        <div class="initiative-component">
                            <span>Otros:</span>
                            <input type="number" id="init-misc" value="0" min="-10" max="10" onchange="updateCombatStats()">
                        </div>
                    </div>
                    <button class="roll-initiative-btn" onclick="rollInitiative()">üé≤ Tirar Iniciativa</button>
                    <div id="initiative-result" class="initiative-result"></div>
                </div>
            </div>

            <!-- Movement Card -->
            <div class="combat-stat-card">
                <div class="stat-header">
                    <h3>üëü Movimiento</h3>
                </div>
                <div class="movement-display">
                    <div class="movement-rates">
                        <div class="movement-rate">
                            <span class="rate-value" id="base-movement">12</span>
                            <span class="rate-label">Base</span>
                        </div>
                        <div class="movement-rate">
                            <span class="rate-value" id="combat-movement">4</span>
                            <span class="rate-label">Combate</span>
                        </div>
                        <div class="movement-rate">
                            <span class="rate-value" id="running-movement">24</span>
                            <span class="rate-label">Corriendo</span>
                        </div>
                    </div>
                    <div class="movement-modifiers">
                        <label>Mod. Armadura:</label>
                        <input type="number" id="armor-movement-penalty" value="0" min="-10" max="0" onchange="updateMovement()">
                        <label>Otros:</label>
                        <input type="number" id="movement-misc" value="0" min="-10" max="10" onchange="updateMovement()">
                    </div>
                </div>
            </div>
        </div>

        <!-- Weapons Section -->
        <div class="weapons-section">
            <div class="section-header">
                <h2>‚öîÔ∏è Armas</h2>
                <button class="add-weapon-btn" onclick="addWeaponSlot()">+ Agregar Arma</button>
            </div>
            
            <div class="weapons-grid" id="weapons-container">
                <!-- Main Hand Weapon -->
                <div class="weapon-slot" data-slot="0">
                    <div class="weapon-header">
                        <h4>üó°Ô∏è Arma Principal</h4>
                        <button class="weapon-remove" onclick="removeWeaponSlot(0)" style="display: none;">‚ùå</button>
                    </div>
                    <div class="weapon-info">
                        <div class="weapon-basic-info">
                            <input type="text" class="weapon-name" placeholder="Nombre del arma" onchange="updateWeaponStats(0)">
                            <select class="weapon-type" onchange="updateWeaponStats(0)">
                                <option value="">Seleccionar tipo...</option>
                                <option value="espada-larga">Espada Larga</option>
                                <option value="espada-corta">Espada Corta</option>
                                <option value="daga">Daga</option>
                                <option value="maza">Maza</option>
                                <option value="hacha-batalla">Hacha de Batalla</option>
                                <option value="lanza">Lanza</option>
                                <option value="arco-largo">Arco Largo</option>
                                <option value="arco-corto">Arco Corto</option>
                                <option value="ballesta">Ballesta</option>
                                <option value="honda">Honda</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="weapon-stats-grid">
                            <div class="weapon-stat">
                                <label>Velocidad:</label>
                                <input type="number" class="weapon-speed" min="1" max="20" onchange="updateWeaponStats(0)">
                            </div>
                            <div class="weapon-stat">
                                <label>Da√±o P:</label>
                                <input type="text" class="weapon-damage-s" placeholder="1d8" onchange="updateWeaponStats(0)">
                            </div>
                            <div class="weapon-stat">
                                <label>Da√±o G:</label>
                                <input type="text" class="weapon-damage-l" placeholder="1d12" onchange="updateWeaponStats(0)">
                            </div>
                            <div class="weapon-stat">
                                <label>Encant.:</label>
                                <input type="number" class="weapon-magic" value="0" min="-5" max="5" onchange="updateWeaponStats(0)">
                            </div>
                        </div>
                        <div class="weapon-specialization">
                            <label>
                                <input type="checkbox" class="weapon-proficient" onchange="updateWeaponStats(0)">
                                Competente
                            </label>
                            <label>
                                <input type="checkbox" class="weapon-specialized" onchange="updateWeaponStats(0)">
                                Especializado
                            </label>
                            <label>
                                <input type="checkbox" class="weapon-mastery" onchange="updateWeaponStats(0)">
                                Maestr√≠a
                            </label>
                        </div>
                        <div class="weapon-attack-display">
                            <div class="attack-bonus">
                                <span>Ataque: </span>
                                <span class="weapon-attack-bonus" id="weapon-attack-0">+0</span>
                            </div>
                            <div class="damage-bonus">
                                <span>Da√±o: </span>
                                <span class="weapon-damage-bonus" id="weapon-damage-0">+0</span>
                            </div>
                            <div class="attacks-per-round">
                                <span>Ataques/Ronda: </span>
                                <span class="weapon-apr" id="weapon-apr-0">1</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Off Hand Weapon -->
                <div class="weapon-slot" data-slot="1">
                    <div class="weapon-header">
                        <h4>üõ°Ô∏è Mano Secundaria</h4>
                        <button class="weapon-remove" onclick="removeWeaponSlot(1)" style="display: none;">‚ùå</button>
                    </div>
                    <div class="weapon-info">
                        <div class="weapon-basic-info">
                            <input type="text" class="weapon-name" placeholder="Escudo o arma secundaria" onchange="updateWeaponStats(1)">
                            <select class="weapon-type" onchange="updateWeaponStats(1)">
                                <option value="">Seleccionar...</option>
                                <option value="escudo-pequeno">Escudo Peque√±o (+1 CA)</option>
                                <option value="escudo-mediano">Escudo Mediano (+1 CA)</option>
                                <option value="escudo-grande">Escudo Grande (+2 CA)</option>
                                <option value="daga">Daga</option>
                                <option value="espada-corta">Espada Corta</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="two-weapon-fighting" id="twf-options-1" style="display: none;">
                            <label>
                                <input type="checkbox" class="ambidextrous" onchange="updateTwoWeaponFighting()">
                                Ambidiestro
                            </label>
                            <label>
                                <input type="checkbox" class="two-weapon-style" onchange="updateTwoWeaponFighting()">
                                Estilo Dos Armas
                            </label>
                            <div class="twf-penalties">
                                <span>Penalizaciones: Principal <span id="twf-main-penalty">-2</span>, Secundaria <span id="twf-off-penalty">-4</span></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ranged Weapon -->
                <div class="weapon-slot" data-slot="2">
                    <div class="weapon-header">
                        <h4>üèπ Arma a Distancia</h4>
                        <button class="weapon-remove" onclick="removeWeaponSlot(2)" style="display: none;">‚ùå</button>
                    </div>
                    <div class="weapon-info">
                        <div class="weapon-basic-info">
                            <input type="text" class="weapon-name" placeholder="Arma a distancia" onchange="updateWeaponStats(2)">
                            <select class="weapon-type" onchange="updateWeaponStats(2)">
                                <option value="">Seleccionar tipo...</option>
                                <option value="arco-largo">Arco Largo</option>
                                <option value="arco-corto">Arco Corto</option>
                                <option value="ballesta-ligera">Ballesta Ligera</option>
                                <option value="ballesta-pesada">Ballesta Pesada</option>
                                <option value="honda">Honda</option>
                                <option value="jabalina">Jabalina</option>
                                <option value="daga-arrojadiza">Daga Arrojadiza</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div class="ranged-specific">
                            <div class="range-info">
                                <label>Alcance Corto:</label>
                                <input type="number" class="range-short" placeholder="50" onchange="updateWeaponStats(2)">
                                <label>Alcance Medio:</label>
                                <input type="number" class="range-medium" placeholder="100" onchange="updateWeaponStats(2)">
                                <label>Alcance Largo:</label>
                                <input type="number" class="range-long" placeholder="150" onchange="updateWeaponStats(2)">
                            </div>
                            <div class="ammunition">
                                <label>Munici√≥n:</label>
                                <input type="text" class="ammo-type" placeholder="Flechas, virotes..." onchange="updateWeaponStats(2)">
                                <label>Cantidad:</label>
                                <input type="number" class="ammo-count" value="20" min="0" onchange="updateWeaponStats(2)">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Armor Section -->
        <div class="armor-section">
            <div class="section-header">
                <h2>üõ°Ô∏è Armadura</h2>
            </div>
            
            <div class="armor-grid">
                <!-- Body Armor -->
                <div class="armor-slot">
                    <h4>üëï Armadura Corporal</h4>
                    <div class="armor-info">
                        <input type="text" id="body-armor-name" placeholder="Nombre de la armadura" onchange="updateArmorStats()">
                        <select id="body-armor-type" onchange="updateArmorStats()">
                            <option value="">Sin armadura (CA 10)</option>
                            <option value="cuero">Armadura de Cuero (CA 8)</option>
                            <option value="cuero-tachonado">Cuero Tachonado (CA 7)</option>
                            <option value="cota-anillas">Cota de Anillas (CA 7)</option>
                            <option value="cota-escamas">Cota de Escamas (CA 6)</option>
                            <option value="cota-mallas">Cota de Mallas (CA 5)</option>
                            <option value="brigantina">Brigantina (CA 6)</option>
                            <option value="cota-laminada">Cota Laminada (CA 4)</option>
                            <option value="bandas">Armadura de Bandas (CA 4)</option>
                            <option value="laminada">Armadura Laminada (CA 3)</option>
                            <option value="placas">Armadura de Placas (CA 3)</option>
                            <option value="completa">Armadura Completa (CA 1)</option>
                            <option value="custom">Personalizada</option>
                        </select>
                        <div class="armor-stats">
                            <label>CA Base:</label>
                            <input type="number" id="armor-ac" min="1" max="10" onchange="updateArmorStats()">
                            <label>Encant.:</label>
                            <input type="number" id="armor-magic" value="0" min="-5" max="5" onchange="updateArmorStats()">
                            <label>Peso:</label>
                            <input type="number" id="armor-weight" min="0" step="0.1" onchange="updateArmorStats()">
                        </div>
                        <div class="armor-restrictions">
                            <label>Penalizaci√≥n Movimiento:</label>
                            <input type="number" id="armor-move-penalty" value="0" min="-10" max="0" onchange="updateArmorStats()">
                            <label>Penalizaci√≥n Sigiloso:</label>
                            <input type="number" id="armor-stealth-penalty" value="0" min="-20" max="0" onchange="updateArmorStats()">
                        </div>
                    </div>
                </div>

                <!-- Shield -->
                <div class="armor-slot">
                    <h4>üõ°Ô∏è Escudo</h4>
                    <div class="armor-info">
                        <input type="text" id="shield-name" placeholder="Nombre del escudo" onchange="updateArmorStats()">
                        <select id="shield-type" onchange="updateArmorStats()">
                            <option value="">Sin escudo</option>
                            <option value="escudo-pequeno">Escudo Peque√±o (+1 CA)</option>
                            <option value="escudo-mediano">Escudo Mediano (+1 CA)</option>
                            <option value="escudo-grande">Escudo Grande (+2 CA)</option>
                            <option value="pav√©s">Pav√©s (+3 CA, vs proyectiles)</option>
                            <option value="custom">Personalizado</option>
                        </select>
                        <div class="shield-stats">
                            <label>Bonus CA:</label>
                            <input type="number" id="shield-ac" value="0" min="0" max="5" onchange="updateArmorStats()">
                            <label>Encant.:</label>
                            <input type="number" id="shield-magic" value="0" min="-5" max="5" onchange="updateArmorStats()">
                            <label>Peso:</label>
                            <input type="number" id="shield-weight" min="0" step="0.1" onchange="updateArmorStats()">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Combat Actions Section -->
        <div class="combat-actions-section">
            <div class="section-header">
                <h2>‚ö° Acciones de Combate</h2>
            </div>
            
            <div class="combat-actions-grid">
                <!-- Attack Buttons -->
                <div class="action-group">
                    <h4>üó°Ô∏è Ataques</h4>
                    <div class="action-buttons">
                        <button class="combat-action-btn" onclick="rollAttack('main')">
                            <span class="action-icon">‚öîÔ∏è</span>
                            <span class="action-text">Ataque Principal</span>
                        </button>
                        <button class="combat-action-btn" onclick="rollAttack('offhand')" id="offhand-attack-btn" style="display: none;">
                            <span class="action-icon">üó°Ô∏è</span>
                            <span class="action-text">Ataque Secundario</span>
                        </button>
                        <button class="combat-action-btn" onclick="rollAttack('ranged')">
                            <span class="action-icon">üèπ</span>
                            <span class="action-text">Ataque a Distancia</span>
                        </button>
                    </div>
                </div>

                <!-- Damage Buttons -->
                <div class="action-group">
                    <h4>üí• Da√±o</h4>
                    <div class="action-buttons">
                        <button class="combat-action-btn" onclick="rollDamage('main')">
                            <span class="action-icon">üí•</span>
                            <span class="action-text">Da√±o Principal</span>
                        </button>
                        <button class="combat-action-btn" onclick="rollDamage('ranged')">
                            <span class="action-icon">üéØ</span>
                            <span class="action-text">Da√±o a Distancia</span>
                        </button>
                        <button class="combat-action-btn" onclick="rollCritical()">
                            <span class="action-icon">üíÄ</span>
                            <span class="action-text">Cr√≠tico</span>
                        </button>
                    </div>
                </div>

                <!-- Defensive Actions -->
                <div class="action-group">
                    <h4>üõ°Ô∏è Defensa</h4>
                    <div class="action-buttons">
                        <button class="combat-action-btn" onclick="rollSavingThrow('combat')">
                            <span class="action-icon">üé≤</span>
                            <span class="action-text">Salvaci√≥n</span>
                        </button>
                        <button class="combat-action-btn" onclick="toggleDefensiveStance()">
                            <span class="action-icon">üõ°Ô∏è</span>
                            <span class="action-text">Postura Defensiva</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Combat Log -->
            <div class="combat-log">
                <div class="log-header">
                    <h4>üìã Registro de Combate</h4>
                    <button class="clear-log-btn" onclick="clearCombatLog()">üóëÔ∏è Limpiar</button>
                </div>
                <div class="log-content" id="combat-log"></div>
            </div>
        </div>
    </div>
</div>

<!-- COMBAT TAB CSS -->
<style>
.combat-container {
    padding: 1rem;
    max-width: 1200px;
    margin: 0 auto;
}

/* Combat Stats Grid */
.combat-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.combat-stat-card {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 1px solid #4a5568;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.stat-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.stat-header h3 {
    margin: 0;
    color: #e2e8f0;
    font-size: 1.1rem;
}

.detail-toggle {
    background: #4299e1;
    border: none;
    padding: 0.3rem 0.6rem;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-size: 0.8rem;
}

/* AC Display */
.ac-display, .gaco-display {
    text-align: center;
}

.ac-main-value, .gaco-main-value {
    margin-bottom: 1rem;
}

.ac-main-value span, .gaco-main-value span {
    font-size: 2.5rem;
    font-weight: bold;
    color: #f7fafc;
    text-shadow: 0 0 10px rgba(66, 153, 225, 0.5);
}

.ac-main-value small, .gaco-main-value small {
    display: block;
    color: #cbd5e0;
    font-size: 0.8rem;
    margin-top: 0.5rem;
}

.ac-breakdown, .gaco-breakdown {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
}

.ac-component, .gaco-component {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    color: #e2e8f0;
}

.ac-component input, .gaco-component input {
    width: 60px;
    padding: 0.2rem 0.4rem;
    background: #2d3748;
    border: 1px solid #4a5568;
    border-radius: 4px;
    color: #e2e8f0;
    text-align: center;
}

/* Initiative Display */
.initiative-display {
    text-align: center;
}

.initiative-value {
    margin-bottom: 1rem;
}

.initiative-value span {
    font-size: 2rem;
    font-weight: bold;
    color: #48bb78;
}

.initiative-breakdown {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1rem;
}

.initiative-component {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
    color: #e2e8f0;
}

.roll-initiative-btn {
    background: linear-gradient(135deg, #48bb78, #38a169);
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.roll-initiative-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(72, 187, 120, 0.4);
}

.initiative-result {
    margin-top: 1rem;
    padding: 0.8rem;
    background: rgba(72, 187, 120, 0.1);
    border-radius: 8px;
    color: #48bb78;
    font-weight: bold;
    min-height: 20px;
}

/* Movement Display */
.movement-display {
    text-align: center;
}

.movement-rates {
    display: flex;
    justify-content: space-around;
    margin-bottom: 1rem;
}

.movement-rate {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.rate-value {
    font-size: 1.8rem;
    font-weight: bold;
    color: #ed8936;
}

.rate-label {
    font-size: 0.8rem;
    color: #cbd5e0;
    margin-top: 0.2rem;
}

.movement-modifiers {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 1rem;
    display: grid;
    grid-template-columns: auto 1fr;
    gap: 0.5rem;
    align-items: center;
}

.movement-modifiers label {
    color: #e2e8f0;
    font-size: 0.9rem;
}

.movement-modifiers input {
    width: 60px;
    padding: 0.2rem 0.4rem;
    background: #2d3748;
    border: 1px solid #4a5568;
    border-radius: 4px;
    color: #e2e8f0;
    text-align: center;
}

/* Weapons Section */
.weapons-section {
    margin-bottom: 2rem;
}

.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #4a5568;
}

.section-header h2 {
    color: #f7fafc;
    margin: 0;
}

.add-weapon-btn {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-weight: bold;
}

.weapons-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1.5rem;
}

.weapon-slot {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 1px solid #4a5568;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.weapon-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #4a5568;
}

.weapon-header h4 {
    margin: 0;
    color: #e2e8f0;
}

.weapon-remove {
    background: #e53e3e;
    border: none;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-size: 0.8rem;
}

.weapon-basic-info {
    display: grid;
    grid-template-columns: 2fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.weapon-name, .weapon-type {
    padding: 0.6rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 6px;
    color: #e2e8f0;
}

.weapon-stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

.weapon-stat {
    display: flex;
    flex-direction: column;
}

.weapon-stat label {
    color: #cbd5e0;
    font-size: 0.8rem;
    margin-bottom: 0.2rem;
}

.weapon-stat input {
    padding: 0.4rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 4px;
    color: #e2e8f0;
    text-align: center;
}

.weapon-specialization {
    display: flex;
    gap: 1rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
}

.weapon-specialization label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #e2e8f0;
    font-size: 0.9rem;
    cursor: pointer;
}

.weapon-specialization input[type="checkbox"] {
    accent-color: #4299e1;
}

.weapon-attack-display {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 1rem;
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
}

.attack-bonus, .damage-bonus, .attacks-per-round {
    display: flex;
    justify-content: space-between;
    align-items: center;
    color: #e2e8f0;
}

.weapon-attack-bonus, .weapon-damage-bonus, .weapon-apr {
    font-weight: bold;
    color: #4299e1;
}

.two-weapon-fighting {
    background: rgba(237, 137, 54, 0.1);
    border: 1px solid #ed8936;
    border-radius: 8px;
    padding: 1rem;
    margin-top: 1rem;
}

.two-weapon-fighting label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #ed8936;
    margin-bottom: 0.5rem;
}

.twf-penalties {
    color: #fed7aa;
    font-size: 0.9rem;
    text-align: center;
    margin-top: 0.5rem;
}

.ranged-specific {
    margin-top: 1rem;
}

.range-info {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.range-info label {
    color: #cbd5e0;
    font-size: 0.8rem;
}

.range-info input {
    padding: 0.3rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 4px;
    color: #e2e8f0;
    text-align: center;
}

.ammunition {
    display: grid;
    grid-template-columns: 2fr 1fr 1fr;
    gap: 0.5rem;
    align-items: end;
}

.ammunition label {
    color: #cbd5e0;
    font-size: 0.8rem;
}

.ammunition input {
    padding: 0.4rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 4px;
    color: #e2e8f0;
}

/* Armor Section */
.armor-section {
    margin-bottom: 2rem;
}

.armor-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
}

.armor-slot {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 1px solid #4a5568;
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.armor-slot h4 {
    color: #e2e8f0;
    margin: 0 0 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #4a5568;
}

.armor-info input, .armor-info select {
    width: 100%;
    padding: 0.6rem;
    margin-bottom: 1rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 6px;
    color: #e2e8f0;
}

.armor-stats, .shield-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.armor-stats label, .shield-stats label {
    color: #cbd5e0;
    font-size: 0.8rem;
    margin-bottom: 0.2rem;
    display: block;
}

.armor-stats input, .shield-stats input {
    width: 100%;
    padding: 0.4rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 4px;
    color: #e2e8f0;
    text-align: center;
    margin-bottom: 0;
}

.armor-restrictions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
}

.armor-restrictions label {
    color: #cbd5e0;
    font-size: 0.8rem;
    margin-bottom: 0.2rem;
    display: block;
}

.armor-restrictions input {
    width: 100%;
    padding: 0.4rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 4px;
    color: #e2e8f0;
    text-align: center;
}

/* Combat Actions Section */
.combat-actions-section {
    margin-bottom: 2rem;
}

.combat-actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.action-group {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 1px solid #4a5568;
    border-radius: 12px;
    padding: 1.5rem;
}

.action-group h4 {
    color: #e2e8f0;
    margin: 0 0 1rem 0;
    text-align: center;
}

.action-buttons {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.combat-action-btn {
    display: flex;
    align-items: center;
    gap: 0.8rem;
    padding: 1rem;
    background: linear-gradient(135deg, #4a5568, #2d3748);
    border: 1px solid #718096;
    border-radius: 8px;
    color: #e2e8f0;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 1rem;
}

.combat-action-btn:hover {
    background: linear-gradient(135deg, #718096, #4a5568);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.action-icon {
    font-size: 1.2rem;
}

.action-text {
    flex: 1;
    text-align: left;
}

/* Combat Log */
.combat-log {
    background: linear-gradient(135deg, #1a202c, #2d3748);
    border: 1px solid #4a5568;
    border-radius: 12px;
    overflow: hidden;
}

.log-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #2d3748;
    border-bottom: 1px solid #4a5568;
}

.log-header h4 {
    margin: 0;
    color: #e2e8f0;
}

.clear-log-btn {
    background: #e53e3e;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-size: 0.9rem;
}

.log-content {
    max-height: 300px;
    overflow-y: auto;
    padding: 1rem;
}

.log-entry {
    background: rgba(0, 0, 0, 0.2);
    border-left: 4px solid #4299e1;
    padding: 0.8rem;
    margin-bottom: 0.8rem;
    border-radius: 0 8px 8px 0;
    color: #e2e8f0;
}

.log-entry.critical {
    border-left-color: #e53e3e;
    background: rgba(229, 62, 62, 0.1);
}

.log-entry.success {
    border-left-color: #48bb78;
    background: rgba(72, 187, 120, 0.1);
}

.log-timestamp {
    font-size: 0.7rem;
    color: #a0aec0;
    float: right;
}

/* Responsive Design */
@media (max-width: 768px) {
    .combat-stats-grid {
        grid-template-columns: 1fr;
    }
    
    .weapons-grid {
        grid-template-columns: 1fr;
    }
    
    .armor-grid {
        grid-template-columns: 1fr;
    }
    
    .combat-actions-grid {
        grid-template-columns: 1fr;
    }
    
    .weapon-basic-info {
        grid-template-columns: 1fr;
    }
    
    .weapon-stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .combat-container {
        padding: 0.5rem;
    }
    
    .weapon-slot, .armor-slot, .combat-stat-card {
        padding: 1rem;
    }
    
    .movement-rates {
        flex-direction: column;
        gap: 0.5rem;
    }
}
</style>

<!-- COMBAT TAB JAVASCRIPT -->
<script>
// Weapon database for auto-fill
const weaponDatabase = {
    'espada-larga': {
        speed: 5,
        damageS: '1d8',
        damageL: '1d12',
        type: 'Cortante',
        category: 'Melee'
    },
    'espada-corta': {
        speed: 3,
        damageS: '1d6',
        damageL: '1d8',
        type: 'Cortante',
        category: 'Melee'
    },
    'daga': {
        speed: 2,
        damageS: '1d4',
        damageL: '1d3',
        type: 'Cortante/Perforante',
        category: 'Melee/Ranged'
    },
    'maza': {
        speed: 7,
        damageS: '1d6+1',
        damageL: '1d6',
        type: 'Contundente',
        category: 'Melee'
    },
    'hacha-batalla': {
        speed: 7,
        damageS: '1d8',
        damageL: '1d8',
        type: 'Cortante',
        category: 'Melee'
    },
    'lanza': {
        speed: 6,
        damageS: '1d6',
        damageL: '1d8',
        type: 'Perforante',
        category: 'Melee'
    },
    'arco-largo': {
        speed: 8,
        damageS: '1d6',
        damageL: '1d6',
        type: 'Perforante',
        category: 'Ranged',
        ranges: [70, 140, 210]
    },
    'arco-corto': {
        speed: 7,
        damageS: '1d6',
        damageL: '1d6',
        type: 'Perforante',
        category: 'Ranged',
        ranges: [50, 100, 150]
    },
    'ballesta-ligera': {
        speed: 7,
        damageS: '1d4',
        damageL: '1d4',
        type: 'Perforante',
        category: 'Ranged',
        ranges: [60, 120, 180]
    },
    'ballesta-pesada': {
        speed: 10,
        damageS: '1d4+1',
        damageL: '1d6+1',
        type: 'Perforante',
        category: 'Ranged',
        ranges: [80, 160, 240]
    },
    'honda': {
        speed: 6,
        damageS: '1d4+1',
        damageL: '1d6+1',
        type: 'Contundente',
        category: 'Ranged',
        ranges: [40, 80, 160]
    }
};

// Armor database
const armorDatabase = {
    'cuero': { ac: 8, weight: 15, movePenalty: 0, stealthPenalty: 0 },
    'cuero-tachonado': { ac: 7, weight: 25, movePenalty: 0, stealthPenalty: -1 },
    'cota-anillas': { ac: 7, weight: 30, movePenalty: 0, stealthPenalty: -1 },
    'cota-escamas': { ac: 6, weight: 40, movePenalty: -1, stealthPenalty: -1 },
    'cota-mallas': { ac: 5, weight: 40, movePenalty: -1, stealthPenalty: -2 },
    'brigantina': { ac: 6, weight: 35, movePenalty: -1, stealthPenalty: -1 },
    'cota-laminada': { ac: 4, weight: 45, movePenalty: -2, stealthPenalty: -3 },
    'bandas': { ac: 4, weight: 35, movePenalty: -2, stealthPenalty: -2 },
    'laminada': { ac: 3, weight: 50, movePenalty: -3, stealthPenalty: -4 },
    'placas': { ac: 3, weight: 50, movePenalty: -3, stealthPenalty: -4 },
    'completa': { ac: 1, weight: 70, movePenalty: -4, stealthPenalty: -5 }
};

// Shield database
const shieldDatabase = {
    'escudo-pequeno': { ac: 1, weight: 3 },
    'escudo-mediano': { ac: 1, weight: 10 },
    'escudo-grande': { ac: 2, weight: 15 },
    'pav√©s': { ac: 3, weight: 25 }
};

// Initialize combat tab
function initializeCombatTab() {
    updateCombatStats();
    updateArmorStats();
    updateMovement();
    updateAllWeaponStats();
}

// Update all combat statistics
function updateCombatStats() {
    updateArmorClass();
    updateGACO();
    updateInitiative();
    updateMovement();
}

// Update Armor Class calculation
function updateArmorClass() {
    const acBase = 10;
    const acArmor = getArmorAC();
    const acShield = getShieldAC();
    const acDex = getDexterityACModifier();
    const acMagic = parseInt(document.getElementById('ac-magic')?.value || 0);
    const acMisc = parseInt(document.getElementById('ac-misc')?.value || 0);
    
    const finalAC = acBase - acArmor + acShield + acDex + acMagic + acMisc;
    
    // Update display
    document.getElementById('final-ac').textContent = finalAC;
    document.getElementById('ac-base').textContent = acBase;
    document.getElementById('ac-armor').textContent = -acArmor;
    document.getElementById('ac-shield').textContent = acShield;
    document.getElementById('ac-dex').textContent = acDex;
    
    return finalAC;
}

// Update GACO calculation
function updateGACO() {
    const gacoBase = getBaseGACO();
    const gacoStr = getStrengthAttackModifier();
    const gacoMagic = parseInt(document.getElementById('gaco-magic')?.value || 0);
    const gacoSpec = getSpecializationBonus();
    const gacoMisc = parseInt(document.getElementById('gaco-misc')?.value || 0);
    
    const finalGACO = gacoBase - gacoStr - gacoMagic - gacoSpec - gacoMisc;
    
    // Update display
    document.getElementById('final-gaco').textContent = finalGACO;
    document.getElementById('gaco-base').textContent = gacoBase;
    document.getElementById('gaco-str').textContent = gacoStr;
    document.getElementById('gaco-spec').textContent = gacoSpec;
    
    return finalGACO;
}

// Update Initiative calculation
function updateInitiative() {
    const initDex = getDexterityInitModifier();
    const initSize = getSizeInitModifier();
    const initMisc = parseInt(document.getElementById('init-misc')?.value || 0);
    
    const finalInit = initDex + initSize + initMisc;
    
    // Update display
    document.getElementById('initiative-mod').textContent = (finalInit >= 0 ? '+' : '') + finalInit;
    document.getElementById('init-dex').textContent = initDex;
    document.getElementById('init-size').textContent = initSize;
    
    return finalInit;
}

// Update Movement rates
function updateMovement() {
    const baseMove = getBaseMovement();
    const armorPenalty = parseInt(document.getElementById('armor-movement-penalty')?.value || 0);
    const miscMod = parseInt(document.getElementById('movement-misc')?.value || 0);
    
    const finalBaseMove = Math.max(1, baseMove + armorPenalty + miscMod);
    const combatMove = Math.floor(finalBaseMove / 3);
    const runningMove = finalBaseMove * 2;
    
    // Update display
    document.getElementById('base-movement').textContent = finalBaseMove;
    document.getElementById('combat-movement').textContent = combatMove;
    document.getElementById('running-movement').textContent = runningMove;
}

// Get base GACO from class and level
function getBaseGACO() {
    const level = parseInt(document.getElementById('level')?.value || 1);
    const primaryClass = document.getElementById('primary-dropdown-header')?.textContent?.trim() || '';
    
    // GACO progression by class type (AD&D 2e)
    const gacoProgression = {
        'Guerrero': [20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1],
        'B√°rbaro': [20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1],
        'Palad√≠n': [20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1],
        'Ranger': [20, 19, 18, 17, 16, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1],
        'Cl√©rigo': [20, 20, 20, 18, 18, 18, 16, 16, 16, 14, 14, 14, 12, 12, 12, 10, 10, 10, 8, 8],
        'Druida': [20, 20, 20, 18, 18, 18, 16, 16, 16, 14, 14, 14, 12, 12, 12, 10, 10, 10, 8, 8],
        'Mago': [20, 20, 20, 19, 19, 19, 18, 18, 18, 17, 17, 17, 16, 16, 16, 15, 15, 15, 14, 14],
        'Ladr√≥n': [20, 20, 19, 19, 18, 18, 17, 17, 16, 16, 15, 15, 14, 14, 13, 13, 12, 12, 11, 11],
        'Bardo': [20, 20, 19, 19, 18, 18, 17, 17, 16, 16, 15, 15, 14, 14, 13, 13, 12, 12, 11, 11]
    };
    
    const progression = gacoProgression[primaryClass] || gacoProgression['Guerrero'];
    return progression[Math.min(level - 1, progression.length - 1)] || 20;
}

// Get base movement from race/class
function getBaseMovement() {
    const race = document.getElementById('primary-dropdown-header')?.textContent?.trim() || '';
    
    // Base movement by race (AD&D 2e)
    const movementByRace = {
        'Humano': 12,
        'Elfo': 12,
        'Enano': 6,
        'Halfling': 6,
        'Gnomo': 6,
        'Semielfos': 12,
        'Semiorcos': 12
    };
    
    return movementByRace[race] || 12;
}

// Get armor AC value
function getArmorAC() {
    const armorType = document.getElementById('body-armor-type')?.value || '';
    const customAC = parseInt(document.getElementById('armor-ac')?.value || 10);
    const armorMagic = parseInt(document.getElementById('armor-magic')?.value || 0);
    
    if (armorType === 'custom') {
        return 10 - customAC - armorMagic;
    }
    
    const armorData = armorDatabase[armorType];
    if (armorData) {
        return 10 - armorData.ac - armorMagic;
    }
    
    return 0; // No armor
}

// Get shield AC bonus
function getShieldAC() {
    const shieldType = document.getElementById('shield-type')?.value || '';
    const customAC = parseInt(document.getElementById('shield-ac')?.value || 0);
    const shieldMagic = parseInt(document.getElementById('shield-magic')?.value || 0);
    
    if (shieldType === 'custom') {
        return -(customAC + shieldMagic);
    }
    
    const shieldData = shieldDatabase[shieldType];
    if (shieldData) {
        return -(shieldData.ac + shieldMagic);
    }
    
    return 0; // No shield
}

// Get Dexterity AC modifier
function getDexterityACModifier() {
    const dexScore = parseInt(document.getElementById('dexterity-final')?.textContent || 10);
    
    if (dexScore >= 18) return -4;
    if (dexScore >= 17) return -3;
    if (dexScore >= 16) return -2;
    if (dexScore >= 15) return -1;
    if (dexScore <= 5) return 4;
    if (dexScore <= 6) return 3;
    if (dexScore <= 8) return 2;
    if (dexScore <= 14) return 1;
    return 0;
}

// Get Dexterity initiative modifier
function getDexterityInitModifier() {
    const dexScore = parseInt(document.getElementById('dexterity-final')?.textContent || 10);
    
    if (dexScore >= 18) return -3;
    if (dexScore >= 16) return -2;
    if (dexScore >= 15) return -1;
    if (dexScore <= 3) return 4;
    if (dexScore <= 5) return 3;
    if (dexScore <= 8) return 2;
    if (dexScore <= 14) return 1;
    return 0;
}

// Get size initiative modifier
function getSizeInitModifier() {
    const height = parseInt(document.getElementById('height')?.value || 170);
    
    if (height >= 200) return 1; // Large
    if (height <= 120) return -1; // Small
    return 0; // Medium
}

// Get Strength attack modifier
function getStrengthAttackModifier() {
    const strScore = parseInt(document.getElementById('strength-final')?.textContent || 10);
    
    if (strScore >= 19) return 3;
    if (strScore >= 18) return 2;
    if (strScore >= 17) return 1;
    if (strScore >= 16) return 0;
    if (strScore <= 3) return -3;
    if (strScore <= 5) return -2;
    if (strScore <= 7) return -1;
    return 0;
}

// Get Strength damage modifier
function getStrengthDamageModifier() {
    const strScore = parseInt(document.getElementById('strength-final')?.textContent || 10);
    
    if (strScore >= 19) return 7;
    if (strScore >= 18) return 6;
    if (strScore >= 17) return 1;
    if (strScore >= 16) return 0;
    if (strScore <= 3) return -1;
    if (strScore <= 5) return -1;
    return 0;
}

// Get specialization bonus
function getSpecializationBonus() {
    // Check main weapon specialization
    const weaponSlot = document.querySelector('.weapon-slot[data-slot="0"]');
    if (!weaponSlot) return 0;
    
    const specialized = weaponSlot.querySelector('.weapon-specialized')?.checked;
    const mastery = weaponSlot.querySelector('.weapon-mastery')?.checked;
    
    if (mastery) return 3;
    if (specialized) return 1;
    return 0;
}

// Update weapon statistics
function updateWeaponStats(slotIndex) {
    const weaponSlot = document.querySelector(`.weapon-slot[data-slot="${slotIndex}"]`);
    if (!weaponSlot) return;
    
    const weaponType = weaponSlot.querySelector('.weapon-type').value;
    const weaponData = weaponDatabase[weaponType];
    
    // Auto-fill weapon data if available
    if (weaponData && weaponType !== 'custom') {
        weaponSlot.querySelector('.weapon-speed').value = weaponData.speed;
        weaponSlot.querySelector('.weapon-damage-s').value = weaponData.damageS;
        weaponSlot.querySelector('.weapon-damage-l').value = weaponData.damageL;
        
        // Set ranges for ranged weapons
        if (weaponData.ranges && slotIndex === 2) {
            weaponSlot.querySelector('.range-short').value = weaponData.ranges[0];
            weaponSlot.querySelector('.range-medium').value = weaponData.ranges[1];
            weaponSlot.querySelector('.range-long').value = weaponData.ranges[2];
        }
    }
    
    // Calculate attack bonuses
    updateWeaponAttackBonus(slotIndex);
    updateWeaponDamageBonus(slotIndex);
    updateAttacksPerRound(slotIndex);
    
    // Show/hide two-weapon fighting options
    if (slotIndex === 1) {
        const isWeapon = weaponType && !weaponType.includes('escudo');
        const twfOptions = weaponSlot.querySelector('#twf-options-1');
        const offhandBtn = document.getElementById('offhand-attack-btn');
        
        if (isWeapon) {
            twfOptions.style.display = 'block';
            offhandBtn.style.display = 'inline-flex';
        } else {
            twfOptions.style.display = 'none';
            offhandBtn.style.display = 'none';
        }
        
        updateTwoWeaponFighting();
    }
    
    updateCombatStats();
}

// Update weapon attack bonus
function updateWeaponAttackBonus(slotIndex) {
    const weaponSlot = document.querySelector(`.weapon-slot[data-slot="${slotIndex}"]`);
    if (!weaponSlot) return;
    
    let attackBonus = 0;
    
    // Base GACO bonus (strength for melee, dex for ranged)
    if (slotIndex === 2) { // Ranged
        attackBonus += getDexterityAttackModifier();
    } else { // Melee
        attackBonus += getStrengthAttackModifier();
    }
    
    // Magic weapon bonus
    const magicBonus = parseInt(weaponSlot.querySelector('.weapon-magic').value || 0);
    attackBonus += magicBonus;
    
    // Proficiency bonuses
    const proficient = weaponSlot.querySelector('.weapon-proficient')?.checked;
    const specialized = weaponSlot.querySelector('.weapon-specialized')?.checked;
    const mastery = weaponSlot.querySelector('.weapon-mastery')?.checked;
    
    if (!proficient) {
        attackBonus -= 2; // Non-proficiency penalty
    } else if (mastery) {
        attackBonus += 3;
    } else if (specialized) {
        attackBonus += 1;
    }
    
    // Two-weapon fighting penalties
    if (slotIndex === 1 && weaponSlot.querySelector('.weapon-type').value && !weaponSlot.querySelector('.weapon-type').value.includes('escudo')) {
        const penalty = getTwoWeaponPenalty(false); // Off-hand penalty
        attackBonus += penalty;
    }
    
    // Update display
    const display = weaponSlot.querySelector('.weapon-attack-bonus');
    display.textContent = (attackBonus >= 0 ? '+' : '') + attackBonus;
    display.id = `weapon-attack-${slotIndex}`;
}

// Update weapon damage bonus
function updateWeaponDamageBonus(slotIndex) {
    const weaponSlot = document.querySelector(`.weapon-slot[data-slot="${slotIndex}"]`);
    if (!weaponSlot) return;
    
    let damageBonus = 0;
    
    // Strength damage bonus (melee only)
    if (slotIndex !== 2) {
        damageBonus += getStrengthDamageModifier();
    }
    
    // Magic weapon bonus
    const magicBonus = parseInt(weaponSlot.querySelector('.weapon-magic').value || 0);
    damageBonus += magicBonus;
    
    // Specialization bonuses
    const specialized = weaponSlot.querySelector('.weapon-specialized')?.checked;
    const mastery = weaponSlot.querySelector('.weapon-mastery')?.checked;
    
    if (mastery) {
        damageBonus += 3;
    } else if (specialized) {
        damageBonus += 2;
    }
    
    // Update display
    const display = weaponSlot.querySelector('.weapon-damage-bonus');
    display.textContent = (damageBonus >= 0 ? '+' : '') + damageBonus;
    display.id = `weapon-damage-${slotIndex}`;
}

// Update attacks per round
function updateAttacksPerRound(slotIndex) {
    const weaponSlot = document.querySelector(`.weapon-slot[data-slot="${slotIndex}"]`);
    if (!weaponSlot) return;
    
    let apr = 1;
    const level = parseInt(document.getElementById('level')?.value || 1);
    const primaryClass = document.getElementById('primary-dropdown-header')?.textContent?.trim() || '';
    
    // Base attacks by class and level
    if (['Guerrero', 'B√°rbaro', 'Palad√≠n', 'Ranger'].includes(primaryClass)) {
        if (level >= 13) apr = 2;
        else if (level >= 7) apr = 1.5;
    }
    
    // Specialization bonuses
    const specialized = weaponSlot.querySelector('.weapon-specialized')?.checked;
    const mastery = weaponSlot.querySelector('.weapon-mastery')?.checked;
    
    if (mastery) {
        apr += 1;
    } else if (specialized) {
        apr += 0.5;
    }
    
    // Ranged weapon rate of fire
    if (slotIndex === 2) {
        const weaponType = weaponSlot.querySelector('.weapon-type').value;
        if (weaponType === 'arco-largo' || weaponType === 'arco-corto') {
            apr = 2; // Bows have 2 attacks per round
        }
    }
    
    // Update display
    const display = weaponSlot.querySelector('.weapon-apr');
    display.textContent = apr;
    display.id = `weapon-apr-${slotIndex}`;
}

// Get Dexterity attack modifier for ranged weapons
function getDexterityAttackModifier() {
    const dexScore = parseInt(document.getElementById('dexterity-final')?.textContent || 10);
    
    if (dexScore >= 19) return 3;
    if (dexScore >= 18) return 2;
    if (dexScore >= 17) return 1;
    if (dexScore >= 16) return 0;
    if (dexScore <= 3) return -3;
    if (dexScore <= 5) return -2;
    if (dexScore <= 7) return -1;
    return 0;
}

// Update two-weapon fighting penalties
function updateTwoWeaponFighting() {
    const weaponSlot = document.querySelector('.weapon-slot[data-slot="1"]');
    if (!weaponSlot) return;
    
    const ambidextrous = weaponSlot.querySelector('.ambidextrous')?.checked;
    const twoWeaponStyle = weaponSlot.querySelector('.two-weapon-style')?.checked;
    
    let mainPenalty = -2;
    let offPenalty = -4;
    
    if (ambidextrous) {
        mainPenalty = 0;
        offPenalty = -2;
    }
    
    if (twoWeaponStyle) {
        mainPenalty += 1;
        offPenalty += 1;
    }
    
    // Update display
    document.getElementById('twf-main-penalty').textContent = mainPenalty;
    document.getElementById('twf-off-penalty').textContent = offPenalty;
    
    // Update weapon bonuses
    updateWeaponAttackBonus(0); // Main hand
    updateWeaponAttackBonus(1); // Off hand
}

// Get two-weapon fighting penalty
function getTwoWeaponPenalty(isMainHand) {
    const weaponSlot = document.querySelector('.weapon-slot[data-slot="1"]');
    if (!weaponSlot) return 0;
    
    const ambidextrous = weaponSlot.querySelector('.ambidextrous')?.checked;
    const twoWeaponStyle = weaponSlot.querySelector('.two-weapon-style')?.checked;
    
    let penalty = isMainHand ? -2 : -4;
    
    if (ambidextrous) {
        penalty = isMainHand ? 0 : -2;
    }
    
    if (twoWeaponStyle) {
        penalty += 1;
    }
    
    return penalty;
}

// Update armor statistics
function updateArmorStats() {
    const armorType = document.getElementById('body-armor-type')?.value || '';
    const armorData = armorDatabase[armorType];
    
    if (armorData && armorType !== 'custom') {
        document.getElementById('armor-ac').value = armorData.ac;
        document.getElementById('armor-weight').value = armorData.weight;
        document.getElementById('armor-move-penalty').value = armorData.movePenalty;
        document.getElementById('armor-stealth-penalty').value = armorData.stealthPenalty;
    }
    
    const shieldType = document.getElementById('shield-type')?.value || '';
    const shieldData = shieldDatabase[shieldType];
    
    if (shieldData && shieldType !== 'custom') {
        document.getElementById('shield-ac').value = shieldData.ac;
        document.getElementById('shield-weight').value = shieldData.weight;
    }
    
    updateCombatStats();
}

// Add new weapon slot
function addWeaponSlot() {
    const weaponsContainer = document.getElementById('weapons-container');
    const slots = weaponsContainer.querySelectorAll('.weapon-slot');
    const newSlotIndex = slots.length;
    
    const newSlot = document.createElement('div');
    newSlot.className = 'weapon-slot';
    newSlot.setAttribute('data-slot', newSlotIndex);
    
    newSlot.innerHTML = `
        <div class="weapon-header">
            <h4>‚öîÔ∏è Arma ${newSlotIndex + 1}</h4>
            <button class="weapon-remove" onclick="removeWeaponSlot(${newSlotIndex})">‚ùå</button>
        </div>
        <div class="weapon-info">
            <div class="weapon-basic-info">
                <input type="text" class="weapon-name" placeholder="Nombre del arma" onchange="updateWeaponStats(${newSlotIndex})">
                <select class="weapon-type" onchange="updateWeaponStats(${newSlotIndex})">
                    <option value="">Seleccionar tipo...</option>
                    <option value="espada-larga">Espada Larga</option>
                    <option value="espada-corta">Espada Corta</option>
                    <option value="daga">Daga</option>
                    <option value="maza">Maza</option>
                    <option value="hacha-batalla">Hacha de Batalla</option>
                    <option value="lanza">Lanza</option>
                    <option value="arco-largo">Arco Largo</option>
                    <option value="arco-corto">Arco Corto</option>
                    <option value="ballesta">Ballesta</option>
                    <option value="honda">Honda</option>
                    <option value="custom">Personalizado</option>
                </select>
            </div>
            <div class="weapon-stats-grid">
                <div class="weapon-stat">
                    <label>Velocidad:</label>
                    <input type="number" class="weapon-speed" min="1" max="20" onchange="updateWeaponStats(${newSlotIndex})">
                </div>
                <div class="weapon-stat">
                    <label>Da√±o P:</label>
                    <input type="text" class="weapon-damage-s" placeholder="1d8" onchange="updateWeaponStats(${newSlotIndex})">
                </div>
                <div class="weapon-stat">
                    <label>Da√±o G:</label>
                    <input type="text" class="weapon-damage-l" placeholder="1d12" onchange="updateWeaponStats(${newSlotIndex})">
                </div>
                <div class="weapon-stat">
                    <label>Encant.:</label>
                    <input type="number" class="weapon-magic" value="0" min="-5" max="5" onchange="updateWeaponStats(${newSlotIndex})">
                </div>
            </div>
            <div class="weapon-specialization">
                <label>
                    <input type="checkbox" class="weapon-proficient" onchange="updateWeaponStats(${newSlotIndex})">
                    Competente
                </label>
                <label>
                    <input type="checkbox" class="weapon-specialized" onchange="updateWeaponStats(${newSlotIndex})">
                    Especializado
                </label>
                <label>
                    <input type="checkbox" class="weapon-mastery" onchange="updateWeaponStats(${newSlotIndex})">
                    Maestr√≠a
                </label>
            </div>
            <div class="weapon-attack-display">
                <div class="attack-bonus">
                    <span>Ataque: </span>
                    <span class="weapon-attack-bonus" id="weapon-attack-${newSlotIndex}">+0</span>
                </div>
                <div class="damage-bonus">
                    <span>Da√±o: </span>
                    <span class="weapon-damage-bonus" id="weapon-damage-${newSlotIndex}">+0</span>
                </div>
                <div class="attacks-per-round">
                    <span>Ataques/Ronda: </span>
                    <span class="weapon-apr" id="weapon-apr-${newSlotIndex}">1</span>
                </div>
            </div>
        </div>
    `;
    
    weaponsContainer.appendChild(newSlot);
    updateWeaponStats(newSlotIndex);
}

// Remove weapon slot
function removeWeaponSlot(slotIndex) {
    const weaponSlot = document.querySelector(`.weapon-slot[data-slot="${slotIndex}"]`);
    if (weaponSlot && slotIndex > 2) { // Don't remove the first 3 slots
        weaponSlot.remove();
    }
}

// Update all weapon stats
function updateAllWeaponStats() {
    const weaponSlots = document.querySelectorAll('.weapon-slot');
    weaponSlots.forEach((slot, index) => {
        updateWeaponStats(index);
    });
}

// Toggle combat detail sections
function toggleCombatDetail(detailId) {
    const detail = document.getElementById(detailId);
    if (detail) {
        detail.style.display = detail.style.display === 'none' ? 'block' : 'none';
    }
}

// Roll initiative
function rollInitiative() {
    const initMod = updateInitiative();
    const roll = Math.floor(Math.random() * 10) + 1; // d10
    const total = roll + initMod;
    
    const resultDiv = document.getElementById('initiative-result');
    resultDiv.innerHTML = `
        <strong>Iniciativa:</strong> ${roll} + ${initMod} = ${total}
        <div class="log-timestamp">${new Date().toLocaleTimeString()}</div>
    `;
    
    logCombatAction(`Tirada de Iniciativa: ${roll} + ${initMod} = ${total}`, 'info');
}

// Roll attack
function rollAttack(weaponType) {
    const roll = Math.floor(Math.random() * 20) + 1;
    let weaponSlotIndex = 0;
    let weaponName = 'Desconocida';
    let attackBonus = 0;
    
    switch (weaponType) {
        case 'main':
            weaponSlotIndex = 0;
            break;
        case 'offhand':
            weaponSlotIndex = 1;
            break;
        case 'ranged':
            weaponSlotIndex = 2;
            break;
    }
    
    const weaponSlot = document.querySelector(`.weapon-slot[data-slot="${weaponSlotIndex}"]`);
    if (weaponSlot) {
        weaponName = weaponSlot.querySelector('.weapon-name').value || 'Sin nombre';
        const bonusText = weaponSlot.querySelector('.weapon-attack-bonus').textContent;
        attackBonus = parseInt(bonusText.replace('+', '')) || 0;
    }
    
    const total = roll + attackBonus;
    const isCritical = roll === 20;
    const isFumble = roll === 1;
    
    let resultClass = 'info';
    let resultText = `Ataque con ${weaponName}: ${roll}`;
    
    if (attackBonus !== 0) {
        resultText += ` + ${attackBonus} = ${total}`;
    }
    
    if (isCritical) {
        resultText += ' - ¬°CR√çTICO!';
        resultClass = 'critical';
    } else if (isFumble) {
        resultText += ' - ¬°Pifia!';
        resultClass = 'error';
    }
    
    logCombatAction(resultText, resultClass);
}

// Roll damage
function rollDamage(weaponType) {
    let weaponSlotIndex = 0;
    let weaponName = 'Desconocida';
    let damageBonus = 0;
    let damageDice = '1d4';
    
    switch (weaponType) {
        case 'main':
            weaponSlotIndex = 0;
            break;
        case 'ranged':
            weaponSlotIndex = 2;
            break;
    }
    
    const weaponSlot = document.querySelector(`.weapon-slot[data-slot="${weaponSlotIndex}"]`);
    if (weaponSlot) {
        weaponName = weaponSlot.querySelector('.weapon-name').value || 'Sin nombre';
        const bonusText = weaponSlot.querySelector('.weapon-damage-bonus').textContent;
        damageBonus = parseInt(bonusText.replace('+', '')) || 0;
        damageDice = weaponSlot.querySelector('.weapon-damage-s').value || '1d4';
    }
    
    const damage = rollDice(damageDice);
    const total = damage + damageBonus;
    
    let resultText = `Da√±o con ${weaponName}: ${damageDice} = ${damage}`;
    
    if (damageBonus !== 0) {
        resultText += ` + ${damageBonus} = ${total}`;
    }
    
    resultText += ` puntos de da√±o`;
    
    logCombatAction(resultText, 'success');
}

// Roll critical hit
function rollCritical() {
    const mainWeaponSlot = document.querySelector('.weapon-slot[data-slot="0"]');
    if (!mainWeaponSlot) return;
    
    const weaponName = mainWeaponSlot.querySelector('.weapon-name').value || 'Sin nombre';
    const bonusText = mainWeaponSlot.querySelector('.weapon-damage-bonus').textContent;
    const damageBonus = parseInt(bonusText.replace('+', '')) || 0;
    const damageDice = mainWeaponSlot.querySelector('.weapon-damage-s').value || '1d4';
    
    // Double damage for critical
    const damage1 = rollDice(damageDice);
    const damage2 = rollDice(damageDice);
    const total = damage1 + damage2 + damageBonus;
    
    let resultText = `¬°CR√çTICO! con ${weaponName}: ${damageDice} + ${damageDice} = ${damage1} + ${damage2}`;
    
    if (damageBonus !== 0) {
        resultText += ` + ${damageBonus} = ${total}`;
    }
    
    resultText += ` puntos de da√±o`;
    
    logCombatAction(resultText, 'critical');
}

// Roll saving throw
function rollSavingThrow(type) {
    const roll = Math.floor(Math.random() * 20) + 1;
    const level = parseInt(document.getElementById('level')?.value || 1);
    
    // Base saving throw (simplified)
    const baseSave = Math.max(1, 20 - Math.floor(level / 2));
    const total = roll + (20 - baseSave);
    
    let resultClass = roll >= baseSave ? 'success' : 'info';
    let resultText = `Salvaci√≥n: ${roll}`;
    
    if (roll >= baseSave) {
        resultText += ' - ¬°√âXITO!';
    } else {
        resultText += ' - Fallo';
    }
    
    logCombatAction(resultText, resultClass);
}

// Toggle defensive stance
let defensiveStance = false;
function toggleDefensiveStance() {
    defensiveStance = !defensiveStance;
    
    if (defensiveStance) {
        logCombatAction('Postura Defensiva ACTIVADA (+2 CA, -2 Ataque)', 'info');
    } else {
        logCombatAction('Postura Defensiva DESACTIVADA', 'info');
    }
    
    updateCombatStats();
}

// Utility function to roll dice
function rollDice(diceString) {
    // Parse dice notation (e.g., "1d8", "2d6+1")
    const match = diceString.match(/(\d+)d(\d+)(\+\d+)?/);
    if (!match) return 1;
    
    const numDice = parseInt(match[1]);
    const diceSize = parseInt(match[2]);
    const bonus = parseInt(match[3]) || 0;
    
    let total = 0;
    for (let i = 0; i < numDice; i++) {
        total += Math.floor(Math.random() * diceSize) + 1;
    }
    
    return total + bonus;
}

// Log combat actions
function logCombatAction(message, type = 'info') {
    const logContent = document.getElementById('combat-log');
    const logEntry = document.createElement('div');
    logEntry.className = `log-entry ${type}`;
    
    logEntry.innerHTML = `
        ${message}
        <span class="log-timestamp">${new Date().toLocaleTimeString()}</span>
    `;
    
    logContent.appendChild(logEntry);
    logContent.scrollTop = logContent.scrollHeight;
}

// Clear combat log
function clearCombatLog() {
    const logContent = document.getElementById('combat-log');
    logContent.innerHTML = '';
}

// Initialize combat tab when the page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeCombatTab);
} else {
    initializeCombatTab();
}

// Update combat stats when switching to combat tab
document.addEventListener('tabChanged', function(e) {
    if (e.detail === 'combat') {
        setTimeout(initializeCombatTab, 100);
    }
});
</script>
<!-- SKILLS TAB -->
<div id="skills-tab" class="tab-content">
    <div class="skills-container">
        <!-- Skills Header -->
        <div class="skills-header">
            <h2>üéØ Pericias</h2>
            <div class="skills-summary">
                <div class="slots-info">
                    <span class="slots-used" id="slots-used">0</span> / 
                    <span class="slots-total" id="slots-total">4</span> 
                    Slots Usados
                </div>
                <div class="skills-actions">
                    <button class="auto-assign-btn" onclick="autoAssignSkills()">üé≤ Asignaci√≥n Autom√°tica</button>
                    <button class="reset-skills-btn" onclick="resetAllSkills()">üîÑ Reiniciar</button>
                </div>
            </div>
        </div>

        <!-- Skill Categories -->
        <div class="skills-categories">
            <!-- General Skills -->
            <div class="skill-category">
                <div class="category-header" onclick="toggleCategory('general-skills')">
                    <h3>‚öîÔ∏è Habilidades Generales</h3>
                    <span class="category-toggle">‚ñº</span>
                </div>
                <div class="skills-grid" id="general-skills">
                    <!-- Agriculture -->
                    <div class="skill-card" data-skill="agriculture">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üåæ Agricultura</h4>
                                <span class="skill-base">Inteligencia</span>
                            </div>
                            <div class="skill-controls">
                                <label class="skill-checkbox">
                                    <input type="checkbox" onchange="toggleSkill('agriculture')" class="skill-toggle">
                                    <span class="checkmark"></span>
                                </label>
                                <input type="number" class="skill-slots" min="0" max="3" value="0" onchange="updateSkill('agriculture')" disabled>
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score" id="agriculture-base">10</span>
                                <span class="skill-bonus" id="agriculture-bonus">+0</span>
                                <span class="final-score" id="agriculture-final">= 10%</span>
                            </div>
                            <div class="skill-description">
                                Conocimiento sobre cultivos, ganader√≠a, irrigaci√≥n y t√©cnicas agr√≠colas. Permite identificar plantas comestibles y venenosas.
                            </div>
                        </div>
                    </div>

                    <!-- Animal Handling -->
                    <div class="skill-card" data-skill="animal-handling">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üêé Manejo de Animales</h4>
                                <span class="skill-base">Sabidur√≠a</span>
                            </div>
                            <div class="skill-controls">
                                <label class="skill-checkbox">
                                    <input type="checkbox" onchange="toggleSkill('animal-handling')" class="skill-toggle">
                                    <span class="checkmark"></span>
                                </label>
                                <input type="number" class="skill-slots" min="0" max="3" value="0" onchange="updateSkill('animal-handling')" disabled>
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score" id="animal-handling-base">10</span>
                                <span class="skill-bonus" id="animal-handling-bonus">+0</span>
                                <span class="final-score" id="animal-handling-final">= 10%</span>
                            </div>
                            <div class="skill-description">
                                Habilidad para entrenar, calmar y controlar animales. Incluye equitaci√≥n y cuidado veterinario b√°sico.
                            </div>
                        </div>
                    </div>

                    <!-- Animal Lore -->
                    <div class="skill-card" data-skill="animal-lore">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>ü¶é Conocimiento Animal</h4>
                                <span class="skill-base">Inteligencia</span>
                            </div>
                            <div class="skill-controls">
                                <label class="skill-checkbox">
                                    <input type="checkbox" onchange="toggleSkill('animal-lore')" class="skill-toggle">
                                    <span class="checkmark"></span>
                                </label>
                                <input type="number" class="skill-slots" min="0" max="3" value="0" onchange="updateSkill('animal-lore')" disabled>
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score" id="animal-lore-base">10</span>
                                <span class="skill-bonus" id="animal-lore-bonus">+0</span>
                                <span class="final-score" id="animal-lore-final">= 10%</span>
                            </div>
                            <div class="skill-description">
                                Conocimiento sobre especies animales, sus comportamientos, h√°bitats y caracter√≠sticas especiales.
                            </div>
                        </div>
                    </div>

                    <!-- Appraising -->
                    <div class="skill-card" data-skill="appraising">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üíé Tasaci√≥n</h4>
                                <span class="skill-base">Inteligencia</span>
                            </div>
                            <div class="skill-controls">
                                <label class="skill-checkbox">
                                    <input type="checkbox" onchange="toggleSkill('appraising')" class="skill-toggle">
                                    <span class="checkmark"></span>
                                </label>
                                <input type="number" class="skill-slots" min="0" max="3" value="0" onchange="updateSkill('appraising')" disabled>
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score" id="appraising-base">10</span>
                                <span class="skill-bonus" id="appraising-bonus">+0</span>
                                <span class="final-score" id="appraising-final">= 10%</span>
                            </div>
                            <div class="skill-description">
                                Habilidad para determinar el valor real de objetos, gemas, obras de arte y otros art√≠culos valiosos.
                            </div>
                        </div>
                    </div>

                    <!-- Armorer -->
                    <div class="skill-card" data-skill="armorer">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üõ°Ô∏è Armero</h4>
                                <span class="skill-base">Inteligencia</span>
                            </div>
                            <div class="skill-controls">
                                <label class="skill-checkbox">
                                    <input type="checkbox" onchange="toggleSkill('armorer')" class="skill-toggle">
                                    <span class="checkmark"></span>
                                </label>
                                <input type="number" class="skill-slots" min="0" max="3" value="0" onchange="updateSkill('armorer')" disabled>
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score" id="armorer-base">10</span>
                                <span class="skill-bonus" id="armorer-bonus">+0</span>
                                <span class="final-score" id="armorer-final">= 10%</span>
                            </div>
                            <div class="skill-description">
                                Fabricaci√≥n, reparaci√≥n y mantenimiento de armaduras de todo tipo. Incluye trabajo con cuero y metal.
                            </div>
                        </div>
                    </div>

                    <!-- Artistic Ability -->
                    <div class="skill-card" data-skill="artistic-ability">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üé® Habilidad Art√≠stica</h4>
                                <span class="skill-base">Sabidur√≠a</span>
                            </div>
                            <div class="skill-controls">
                                <label class="skill-checkbox">
                                    <input type="checkbox" onchange="toggleSkill('artistic-ability')" class="skill-toggle">
                                    <span class="checkmark"></span>
                                </label>
                                <input type="number" class="skill-slots" min="0" max="3" value="0" onchange="updateSkill('artistic-ability')" disabled>
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score" id="artistic-ability-base">10</span>
                                <span class="skill-bonus" id="artistic-ability-bonus">+0</span>
                                <span class="final-score" id="artistic-ability-final">= 10%</span>
                            </div>
                            <div class="skill-description">
                                Talento para crear obras de arte: pintura, escultura, m√∫sica, poes√≠a. Incluye apreciaci√≥n art√≠stica.
                            </div>
                        </div>
                    </div>

                    <!-- Astronomy -->
                    <div class="skill-card" data-skill="astronomy">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üåü Astronom√≠a</h4>
                                <span class="skill-base">Inteligencia</span>
                            </div>
                            <div class="skill-controls">
                                <label class="skill-checkbox">
                                    <input type="checkbox" onchange="toggleSkill('astronomy')" class="skill-toggle">
                                    <span class="checkmark"></span>
                                </label>
                                <input type="number" class="skill-slots" min="0" max="3" value="0" onchange="updateSkill('astronomy')" disabled>
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score" id="astronomy-base">10</span>
                                <span class="skill-bonus" id="astronomy-bonus">+0</span>
                                <span class="final-score" id="astronomy-final">= 10%</span>
                            </div>
                            <div class="skill-description">
                                Conocimiento de estrellas, planetas y fen√≥menos celestiales. √ötil para navegaci√≥n y predicci√≥n de eventos.
                            </div>
                        </div>
                    </div>

                    <!-- Blacksmithing -->
                    <div class="skill-card" data-skill="blacksmithing">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üî® Herrer√≠a</h4>
                                <span class="skill-base">Fuerza</span>
                            </div>
                            <div class="skill-controls">
                                <label class="skill-checkbox">
                                    <input type="checkbox" onchange="toggleSkill('blacksmithing')" class="skill-toggle">
                                    <span class="checkmark"></span>
                                </label>
                                <input type="number" class="skill-slots" min="0" max="3" value="0" onchange="updateSkill('blacksmithing')" disabled>
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score" id="blacksmithing-base">10</span>
                                <span class="skill-bonus" id="blacksmithing-bonus">+0</span>
                                <span class="final-score" id="blacksmithing-final">= 10%</span>
                            </div>
                            <div class="skill-description">
                                Trabajo del hierro y otros metales. Fabricaci√≥n de herramientas, armas b√°sicas y objetos met√°licos.
                            </div>
                        </div>
                    </div>

                    <!-- Bowyer/Fletcher -->
                    <div class="skill-card" data-skill="bowyer-fletcher">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üèπ Arquero/Flechero</h4>
                                <span class="skill-base">Destreza</span>
                            </div>
                            <div class="skill-controls">
                                <label class="skill-checkbox">
                                    <input type="checkbox" onchange="toggleSkill('bowyer-fletcher')" class="skill-toggle">
                                    <span class="checkmark"></span>
                                </label>
                                <input type="number" class="skill-slots" min="0" max="3" value="0" onchange="updateSkill('bowyer-fletcher')" disabled>
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score" id="bowyer-fletcher-base">10</span>
                                <span class="skill-bonus" id="bowyer-fletcher-bonus">+0</span>
                                <span class="final-score" id="bowyer-fletcher-final">= 10%</span>
                            </div>
                            <div class="skill-description">
                                Fabricaci√≥n y reparaci√≥n de arcos, ballestas, flechas y virotes. Incluye selecci√≥n de materiales.
                            </div>
                        </div>
                    </div>

                    <!-- Brewing -->
                    <div class="skill-card" data-skill="brewing">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üç∫ Destiler√≠a</h4>
                                <span class="skill-base">Inteligencia</span>
                            </div>
                            <div class="skill-controls">
                                <label class="skill-checkbox">
                                    <input type="checkbox" onchange="toggleSkill('brewing')" class="skill-toggle">
                                    <span class="checkmark"></span>
                                </label>
                                <input type="number" class="skill-slots" min="0" max="3" value="0" onchange="updateSkill('brewing')" disabled>
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score" id="brewing-base">10</span>
                                <span class="skill-bonus" id="brewing-bonus">+0</span>
                                <span class="final-score" id="brewing-final">= 10%</span>
                            </div>
                            <div class="skill-description">
                                Creaci√≥n de bebidas alcoh√≥licas: cerveza, vino, licores. Incluye fermentaci√≥n y destilaci√≥n.
                            </div>
                        </div>
                    </div>

                    <!-- Carpentry -->
                    <div class="skill-card" data-skill="carpentry">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>ü™µ Carpinter√≠a</h4>
                                <span class="skill-base">Fuerza</span>
                            </div>
                            <div class="skill-controls">
                                <label class="skill-checkbox">
                                    <input type="checkbox" onchange="toggleSkill('carpentry')" class="skill-toggle">
                                    <span class="checkmark"></span>
                                </label>
                                <input type="number" class="skill-slots" min="0" max="3" value="0" onchange="updateSkill('carpentry')" disabled>
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score" id="carpentry-base">10</span>
                                <span class="skill-bonus" id="carpentry-bonus">+0</span>
                                <span class="final-score" id="carpentry-final">= 10%</span>
                            </div>
                            <div class="skill-description">
                                Trabajo de la madera: construcci√≥n de estructuras, muebles, herramientas y objetos diversos.
                            </div>
                        </div>
                    </div>

                    <!-- Continue with more skills... -->
                    <!-- Note: Adding more skills to avoid extremely long artifact -->
                </div>
            </div>

            <!-- Rogue Skills -->
            <div class="skill-category">
                <div class="category-header" onclick="toggleCategory('rogue-skills')">
                    <h3>ü•∑ Habilidades de Ladr√≥n</h3>
                    <span class="category-toggle">‚ñº</span>
                </div>
                <div class="skills-grid" id="rogue-skills">
                    <!-- Climb Walls -->
                    <div class="skill-card rogue-skill" data-skill="climb-walls">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üßó Escalar Muros</h4>
                                <span class="skill-base">Base: 60%</span>
                            </div>
                            <div class="skill-controls">
                                <span class="rogue-level-bonus" id="climb-walls-level">+0</span>
                                <input type="number" class="skill-modifier" value="0" onchange="updateRogueSkill('climb-walls')">
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score">60%</span>
                                <span class="skill-bonus" id="climb-walls-bonus">+0</span>
                                <span class="final-score" id="climb-walls-final">= 60%</span>
                            </div>
                            <div class="skill-description">
                                Habilidad para escalar superficies verticales sin equipo especial. Incluye muros, acantilados y edificios.
                            </div>
                        </div>
                    </div>

                    <!-- Find/Remove Traps -->
                    <div class="skill-card rogue-skill" data-skill="find-remove-traps">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>ü™§ Encontrar/Desarmar Trampas</h4>
                                <span class="skill-base">Base: 5%</span>
                            </div>
                            <div class="skill-controls">
                                <span class="rogue-level-bonus" id="find-remove-traps-level">+0</span>
                                <input type="number" class="skill-modifier" value="0" onchange="updateRogueSkill('find-remove-traps')">
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score">5%</span>
                                <span class="skill-bonus" id="find-remove-traps-bonus">+0</span>
                                <span class="final-score" id="find-remove-traps-final">= 5%</span>
                            </div>
                            <div class="skill-description">
                                Detectar y desarmar trampas mec√°nicas. Incluye cerraduras, resortes ocultos y mecanismos.
                            </div>
                        </div>
                    </div>

                    <!-- Hide in Shadows -->
                    <div class="skill-card rogue-skill" data-skill="hide-shadows">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üåë Ocultarse en Sombras</h4>
                                <span class="skill-base">Base: 5%</span>
                            </div>
                            <div class="skill-controls">
                                <span class="rogue-level-bonus" id="hide-shadows-level">+0</span>
                                <input type="number" class="skill-modifier" value="0" onchange="updateRogueSkill('hide-shadows')">
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score">5%</span>
                                <span class="skill-bonus" id="hide-shadows-bonus">+0</span>
                                <span class="final-score" id="hide-shadows-final">= 5%</span>
                            </div>
                            <div class="skill-description">
                                Permanecer invisible mientras hay sombras disponibles. Requiere estar inm√≥vil.
                            </div>
                        </div>
                    </div>

                    <!-- Move Silently -->
                    <div class="skill-card rogue-skill" data-skill="move-silently">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üë§ Moverse Silenciosamente</h4>
                                <span class="skill-base">Base: 10%</span>
                            </div>
                            <div class="skill-controls">
                                <span class="rogue-level-bonus" id="move-silently-level">+0</span>
                                <input type="number" class="skill-modifier" value="0" onchange="updateRogueSkill('move-silently')">
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score">10%</span>
                                <span class="skill-bonus" id="move-silently-bonus">+0</span>
                                <span class="final-score" id="move-silently-final">= 10%</span>
                            </div>
                            <div class="skill-description">
                                Desplazarse sin hacer ruido. √ötil para acercarse a enemigos o evitar detectores.
                            </div>
                        </div>
                    </div>

                    <!-- Open Locks -->
                    <div class="skill-card rogue-skill" data-skill="open-locks">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üîì Abrir Cerraduras</h4>
                                <span class="skill-base">Base: 10%</span>
                            </div>
                            <div class="skill-controls">
                                <span class="rogue-level-bonus" id="open-locks-level">+0</span>
                                <input type="number" class="skill-modifier" value="0" onchange="updateRogueSkill('open-locks')">
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score">10%</span>
                                <span class="skill-bonus" id="open-locks-bonus">+0</span>
                                <span class="final-score" id="open-locks-final">= 10%</span>
                            </div>
                            <div class="skill-description">
                                Forzar cerraduras usando ganz√∫as. La dificultad var√≠a seg√∫n la calidad de la cerradura.
                            </div>
                        </div>
                    </div>

                    <!-- Pick Pockets -->
                    <div class="skill-card rogue-skill" data-skill="pick-pockets">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üëù Hurto</h4>
                                <span class="skill-base">Base: 15%</span>
                            </div>
                            <div class="skill-controls">
                                <span class="rogue-level-bonus" id="pick-pockets-level">+0</span>
                                <input type="number" class="skill-modifier" value="0" onchange="updateRogueSkill('pick-pockets')">
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score">15%</span>
                                <span class="skill-bonus" id="pick-pockets-bonus">+0</span>
                                <span class="final-score" id="pick-pockets-final">= 15%</span>
                            </div>
                            <div class="skill-description">
                                Robar objetos peque√±os sin ser detectado. Incluye carterismo y sustracci√≥n discreta.
                            </div>
                        </div>
                    </div>

                    <!-- Read Languages -->
                    <div class="skill-card rogue-skill" data-skill="read-languages">
                        <div class="skill-header">
                            <div class="skill-info">
                                <h4>üìú Leer Lenguajes</h4>
                                <span class="skill-base">Base: 0%</span>
                            </div>
                            <div class="skill-controls">
                                <span class="rogue-level-bonus" id="read-languages-level">+0</span>
                                <input type="number" class="skill-modifier" value="0" onchange="updateRogueSkill('read-languages')">
                            </div>
                        </div>
                        <div class="skill-details">
                            <div class="skill-calculation">
                                <span class="base-score">0%</span>
                                <span class="skill-bonus" id="read-languages-bonus">+0</span>
                                <span class="final-score" id="read-languages-final">= 0%</span>
                            </div>
                            <div class="skill-description">
                                Descifrar textos en idiomas desconocidos. Solo disponible a partir del nivel 4.
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Weapon Specializations -->
            <div class="skill-category">
                <div class="category-header" onclick="toggleCategory('weapon-skills')">
                    <h3>‚öîÔ∏è Competencias con Armas</h3>
                    <span class="category-toggle">‚ñº</span>
                </div>
                <div class="weapons-proficiency" id="weapon-skills">
                    <div class="weapon-proficiency-header">
                        <div class="proficiency-summary">
                            <span class="weapon-slots-used" id="weapon-slots-used">0</span> / 
                            <span class="weapon-slots-total" id="weapon-slots-total">4</span> 
                            Slots de Armas
                        </div>
                        <button class="add-weapon-proficiency" onclick="addWeaponProficiency()">+ Agregar Competencia</button>
                    </div>
                    
                    <div class="weapon-proficiencies-list" id="weapon-proficiencies-list">
                        <!-- Dynamic weapon proficiencies will be added here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Skills Roll Section -->
        <div class="skills-roll-section">
            <h3>üé≤ Tiradas de Pericias</h3>
            <div class="quick-rolls">
                <div class="roll-category">
                    <h4>Pericias Activas</h4>
                    <div class="active-skills-rolls" id="active-skills-rolls">
                        <!-- Dynamic skill roll buttons will appear here -->
                    </div>
                </div>
                <div class="roll-category">
                    <h4>Habilidades de Ladr√≥n</h4>
                    <div class="rogue-skills-rolls">
                        <button class="skill-roll-btn" onclick="rollRogueSkill('climb-walls')">üßó Escalar</button>
                        <button class="skill-roll-btn" onclick="rollRogueSkill('find-remove-traps')">ü™§ Trampas</button>
                        <button class="skill-roll-btn" onclick="rollRogueSkill('hide-shadows')">üåë Ocultarse</button>
                        <button class="skill-roll-btn" onclick="rollRogueSkill('move-silently')">üë§ Silencio</button>
                        <button class="skill-roll-btn" onclick="rollRogueSkill('open-locks')">üîì Cerraduras</button>
                        <button class="skill-roll-btn" onclick="rollRogueSkill('pick-pockets')">üëù Hurto</button>
                        <button class="skill-roll-btn" onclick="rollRogueSkill('read-languages')" id="read-languages-btn" style="display: none;">üìú Leer</button>
                    </div>
                </div>
            </div>
            
            <!-- Roll Results -->
            <div class="roll-results" id="skill-roll-results">
                <div class="results-header">
                    <h4>üìã Resultados</h4>
                    <button class="clear-results-btn" onclick="clearSkillResults()">üóëÔ∏è Limpiar</button>
                </div>
                <div class="results-content" id="skill-results-content">
                    <!-- Roll results will appear here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- SKILLS TAB CSS -->
<style>
.skills-container {
    padding: 1rem;
    max-width: 1400px;
    margin: 0 auto;
}

/* Skills Header */
.skills-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #4a5568;
}

.skills-header h2 {
    color: #f7fafc;
    margin: 0;
}

.skills-summary {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.slots-info {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    padding: 0.8rem 1.2rem;
    border-radius: 8px;
    color: white;
    font-weight: bold;
}

.slots-used {
    color: #fed7aa;
}

.skills-actions {
    display: flex;
    gap: 1rem;
}

.auto-assign-btn, .reset-skills-btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.auto-assign-btn {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

.reset-skills-btn {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
    color: white;
}

.auto-assign-btn:hover, .reset-skills-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Skill Categories */
.skills-categories {
    margin-bottom: 2rem;
}

.skill-category {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 1px solid #4a5568;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    overflow: hidden;
}

.category-header {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    padding: 1rem 1.5rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #4a5568;
    transition: all 0.3s ease;
}

.category-header:hover {
    background: linear-gradient(135deg, #4a5568, #2d3748);
}

.category-header h3 {
    color: #e2e8f0;
    margin: 0;
    font-size: 1.2rem;
}

.category-toggle {
    color: #cbd5e0;
    font-size: 1.2rem;
    transition: transform 0.3s ease;
}

.category-header.collapsed .category-toggle {
    transform: rotate(-90deg);
}

.skills-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
    gap: 1rem;
    padding: 1.5rem;
}

/* Skill Cards */
.skill-card {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 1px solid #4a5568;
    border-radius: 10px;
    padding: 1rem;
    transition: all 0.3s ease;
}

.skill-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    border-color: #4299e1;
}

.skill-card.active {
    border-color: #48bb78;
    box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.2);
}

.skill-card.rogue-skill {
    border-left: 4px solid #9f7aea;
}

.skill-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.skill-info h4 {
    color: #e2e8f0;
    margin: 0 0 0.2rem 0;
    font-size: 1rem;
}

.skill-base {
    color: #cbd5e0;
    font-size: 0.8rem;
}

.skill-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

/* Custom Checkbox */
.skill-checkbox {
    position: relative;
    cursor: pointer;
    user-select: none;
}

.skill-checkbox input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
}

.checkmark {
    height: 20px;
    width: 20px;
    background: #2d3748;
    border: 2px solid #4a5568;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.skill-checkbox:hover .checkmark {
    border-color: #4299e1;
}

.skill-checkbox input:checked ~ .checkmark {
    background: #48bb78;
    border-color: #48bb78;
}

.checkmark:after {
    content: "";
    position: absolute;
    display: none;
}

.skill-checkbox input:checked ~ .checkmark:after {
    display: block;
}

.skill-checkbox .checkmark:after {
    left: 6px;
    top: 2px;
    width: 4px;
    height: 10px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
}

.skill-slots {
    width: 50px;
    padding: 0.4rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 4px;
    color: #e2e8f0;
    text-align: center;
}

.skill-slots:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.skill-slots:enabled {
    border-color: #4299e1;
}

/* Skill Details */
.skill-details {
    margin-top: 1rem;
}

.skill-calculation {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.8rem;
    font-weight: bold;
}

.base-score {
    color: #4299e1;
    background: rgba(66, 153, 225, 0.1);
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
}

.skill-bonus {
    color: #48bb78;
}

.final-score {
    color: #f7fafc;
    background: rgba(247, 250, 252, 0.1);
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
}

.skill-description {
    color: #cbd5e0;
    font-size: 0.9rem;
    line-height: 1.4;
    font-style: italic;
}

/* Rogue Skills */
.rogue-level-bonus {
    background: #9f7aea;
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    font-size: 0.8rem;
    font-weight: bold;
    min-width: 40px;
    text-align: center;
}

.skill-modifier {
    width: 60px;
    padding: 0.4rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 4px;
    color: #e2e8f0;
    text-align: center;
}

/* Weapon Proficiencies */
.weapon-proficiency-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
}

.proficiency-summary {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
    padding: 0.8rem 1.2rem;
    border-radius: 8px;
    color: white;
    font-weight: bold;
}

.add-weapon-proficiency {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-weight: bold;
}

.weapon-proficiencies-list {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    padding: 1rem;
}

.weapon-proficiency-card {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 1px solid #4a5568;
    border-radius: 8px;
    padding: 1rem;
    border-left: 4px solid #ed8936;
}

.weapon-proficiency-header-card {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
}

.weapon-proficiency-name {
    width: 100%;
    padding: 0.5rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 4px;
    color: #e2e8f0;
    margin-bottom: 0.8rem;
}

.weapon-proficiency-levels {
    display: flex;
    gap: 1rem;
    justify-content: space-between;
}

.proficiency-level {
    display: flex;
    align-items: center;
    gap: 0.3rem;
    color: #e2e8f0;
    font-size: 0.9rem;
}

.proficiency-level input[type="radio"] {
    accent-color: #ed8936;
}

.remove-weapon-proficiency {
    background: #e53e3e;
    border: none;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
    color: white;
    cursor: pointer;
    font-size: 0.8rem;
}

/* Skills Roll Section */
.skills-roll-section {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 1px solid #4a5568;
    border-radius: 12px;
    padding: 1.5rem;
}

.skills-roll-section h3 {
    color: #f7fafc;
    margin: 0 0 1.5rem 0;
    text-align: center;
}

.quick-rolls {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
}

.roll-category h4 {
    color: #e2e8f0;
    margin: 0 0 1rem 0;
    text-align: center;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #4a5568;
}

.active-skills-rolls, .rogue-skills-rolls {
    display: flex;
    flex-wrap: wrap;
    gap: 0.8rem;
    justify-content: center;
}

.skill-roll-btn {
    background: linear-gradient(135deg, #4a5568, #2d3748);
    border: 1px solid #718096;
    padding: 0.8rem 1.2rem;
    border-radius: 8px;
    color: #e2e8f0;
    cursor: pointer;
    font-size: 0.9rem;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.skill-roll-btn:hover {
    background: linear-gradient(135deg, #718096, #4a5568);
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.skill-roll-btn:active {
    transform: translateY(0);
}

/* Roll Results */
.roll-results {
    background: linear-gradient(135deg, #1a202c, #2d3748);
    border: 1px solid #4a5568;
    border-radius: 8px;
    max-height: 300px;
    overflow: hidden;
}

.results-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #2d3748;
    border-bottom: 1px solid #4a5568;
}

.results-header h4 {
    margin: 0;
    color: #e2e8f0;
}

.clear-results-btn {
    background: #e53e3e;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-size: 0.9rem;
}

.results-content {
    max-height: 200px;
    overflow-y: auto;
    padding: 1rem;
}

.skill-result-entry {
    background: rgba(0, 0, 0, 0.2);
    border-left: 4px solid #4299e1;
    padding: 0.8rem;
    margin-bottom: 0.8rem;
    border-radius: 0 8px 8px 0;
    color: #e2e8f0;
}

.skill-result-entry.success {
    border-left-color: #48bb78;
    background: rgba(72, 187, 120, 0.1);
}

.skill-result-entry.failure {
    border-left-color: #e53e3e;
    background: rgba(229, 62, 62, 0.1);
}

.skill-result-entry.critical {
    border-left-color: #ed8936;
    background: rgba(237, 137, 54, 0.1);
}

.result-timestamp {
    font-size: 0.7rem;
    color: #a0aec0;
    float: right;
}

/* Responsive Design */
@media (max-width: 768px) {
    .skills-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
        text-align: center;
    }
    
    .skills-summary {
        justify-content: center;
    }
    
    .skills-grid {
        grid-template-columns: 1fr;
        padding: 1rem;
    }
    
    .skill-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .skill-controls {
        justify-content: space-between;
    }
    
    .quick-rolls {
        grid-template-columns: 1fr;
    }
    
    .weapon-proficiencies-list {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .skills-container {
        padding: 0.5rem;
    }
    
    .skill-card {
        padding: 0.8rem;
    }
    
    .skills-actions {
        flex-direction: column;
    }
    
    .weapon-proficiency-levels {
        flex-direction: column;
        gap: 0.5rem;
    }
}

/* Collapsed Categories */
.skills-grid.collapsed {
    display: none;
}

.weapon-skills.collapsed {
    display: none;
}
</style>

<!-- SKILLS TAB JAVASCRIPT -->
<script>
// Skill base abilities mapping
const skillAbilities = {
    'agriculture': 'intelligence',
    'animal-handling': 'wisdom',
    'animal-lore': 'intelligence',
    'appraising': 'intelligence',
    'armorer': 'intelligence',
    'artistic-ability': 'wisdom',
    'astronomy': 'intelligence',
    'blacksmithing': 'strength',
    'bowyer-fletcher': 'dexterity',
    'brewing': 'intelligence',
    'carpentry': 'strength'
    // Add more skills as needed
};

// Rogue skills base values and progression
const rogueSkills = {
    'climb-walls': { base: 60, perLevel: 5 },
    'find-remove-traps': { base: 5, perLevel: 5 },
    'hide-shadows': { base: 5, perLevel: 5 },
    'move-silently': { base: 10, perLevel: 5 },
    'open-locks': { base: 10, perLevel: 5 },
    'pick-pockets': { base: 15, perLevel: 5 },
    'read-languages': { base: 0, perLevel: 5, minLevel: 4 }
};

// Available weapon types for proficiencies
const weaponTypes = {
    // Melee weapons
    'sword-long': 'Espada Larga',
    'sword-short': 'Espada Corta',
    'sword-bastard': 'Espada Bastarda',
    'sword-two-handed': 'Espada a Dos Manos',
    'dagger': 'Daga',
    'mace': 'Maza',
    'war-hammer': 'Martillo de Guerra',
    'battle-axe': 'Hacha de Batalla',
    'hand-axe': 'Hacha de Mano',
    'spear': 'Lanza',
    'halberd': 'Alabarda',
    'staff': 'Bast√≥n',
    'club': 'Garrote',
    // Ranged weapons
    'long-bow': 'Arco Largo',
    'short-bow': 'Arco Corto',
    'composite-bow': 'Arco Compuesto',
    'light-crossbow': 'Ballesta Ligera',
    'heavy-crossbow': 'Ballesta Pesada',
    'sling': 'Honda',
    'dart': 'Dardo',
    'javelin': 'Jabalina'
};

// Current skill states
let skillSlots = {
    used: 0,
    total: 4,
    skills: {}
};

let weaponSlots = {
    used: 0,
    total: 4,
    proficiencies: []
};

// Initialize skills tab
function initializeSkillsTab() {
    updateSkillSlots();
    updateRogueSkills();
    updateWeaponSlots();
    updateActiveSkillsRolls();
    calculateSkillSlots();
}

// Calculate available skill slots based on class and intelligence
function calculateSkillSlots() {
    const level = parseInt(document.getElementById('level')?.value || 1);
    const intelligence = parseInt(document.getElementById('intelligence-final')?.textContent || 10);
    const primaryClass = document.getElementById('primary-dropdown-header')?.textContent?.trim() || '';
    
    // Base skill slots by class
    const classSkillSlots = {
        'Guerrero': 3,
        'B√°rbaro': 2,
        'Palad√≠n': 2,
        'Ranger': 3,
        'Cl√©rigo': 2,
        'Druida': 2,
        'Mago': 1,
        'Ladr√≥n': 4,
        'Bardo': 6
    };
    
    let baseSlots = classSkillSlots[primaryClass] || 3;
    
    // Intelligence modifier to skill slots
    let intModifier = 0;
    if (intelligence >= 18) intModifier = 3;
    else if (intelligence >= 16) intModifier = 2;
    else if (intelligence >= 15) intModifier = 1;
    else if (intelligence <= 7) intModifier = -1;
    else if (intelligence <= 5) intModifier = -2;
    
    skillSlots.total = Math.max(1, baseSlots + intModifier);
    
    // Calculate weapon proficiency slots
    const weaponSlotsByClass = {
        'Guerrero': 4,
        'B√°rbaro': 4,
        'Palad√≠n': 3,
        'Ranger': 4,
        'Cl√©rigo': 2,
        'Druida': 2,
        'Mago': 1,
        'Ladr√≥n': 2,
        'Bardo': 3
    };
    
    weaponSlots.total = weaponSlotsByClass[primaryClass] || 2;
    
    updateSkillSlots();
    updateWeaponSlots();
}

// Update skill slots display
function updateSkillSlots() {
    document.getElementById('slots-used').textContent = skillSlots.used;
    document.getElementById('slots-total').textContent = skillSlots.total;
}

// Update weapon slots display
function updateWeaponSlots() {
    document.getElementById('weapon-slots-used').textContent = weaponSlots.used;
    document.getElementById('weapon-slots-total').textContent = weaponSlots.total;
}

// Toggle skill activation
function toggleSkill(skillId) {
    const skillCard = document.querySelector(`[data-skill="${skillId}"]`);
    const checkbox = skillCard.querySelector('.skill-toggle');
    const slotsInput = skillCard.querySelector('.skill-slots');
    
    if (checkbox.checked) {
        // Activate skill
        slotsInput.disabled = false;
        slotsInput.value = 1;
        skillCard.classList.add('active');
        skillSlots.skills[skillId] = 1;
        skillSlots.used += 1;
    } else {
        // Deactivate skill
        slotsInput.disabled = true;
        slotsInput.value = 0;
        skillCard.classList.remove('active');
        if (skillSlots.skills[skillId]) {
            skillSlots.used -= skillSlots.skills[skillId];
        }
        delete skillSlots.skills[skillId];
    }
    
    updateSkill(skillId);
    updateSkillSlots();
    updateActiveSkillsRolls();
}

// Update individual skill calculation
function updateSkill(skillId) {
    const skillCard = document.querySelector(`[data-skill="${skillId}"]`);
    if (!skillCard) return;
    
    const slotsInput = skillCard.querySelector('.skill-slots');
    const slots = parseInt(slotsInput.value || 0);
    
    // Update slot usage
    if (skillSlots.skills[skillId]) {
        skillSlots.used -= skillSlots.skills[skillId];
    }
    skillSlots.skills[skillId] = slots;
    skillSlots.used += slots;
    
    // Prevent exceeding available slots
    if (skillSlots.used > skillSlots.total) {
        const excess = skillSlots.used - skillSlots.total;
        slotsInput.value = Math.max(0, slots - excess);
        skillSlots.skills[skillId] = parseInt(slotsInput.value);
        skillSlots.used -= excess;
    }
    
    // Calculate skill percentage
    const baseAbility = skillAbilities[skillId];
    if (!baseAbility) return;
    
    const abilityScore = parseInt(document.getElementById(`${baseAbility}-final`)?.textContent || 10);
    const basePercentage = abilityScore;
    const slotBonus = slots * 15; // +15% per slot
    const finalPercentage = Math.min(95, basePercentage + slotBonus);
    
    // Update display
    skillCard.querySelector(`#${skillId}-base`).textContent = basePercentage;
    skillCard.querySelector(`#${skillId}-bonus`).textContent = slotBonus > 0 ? `+${slotBonus}` : '+0';
    skillCard.querySelector(`#${skillId}-final`).textContent = `= ${finalPercentage}%`;
    
    updateSkillSlots();
    updateActiveSkillsRolls();
}

// Update rogue skills based on level
function updateRogueSkills() {
    const level = parseInt(document.getElementById('level')?.value || 1);
    const primaryClass = document.getElementById('primary-dropdown-header')?.textContent?.trim() || '';
    
    // Only show rogue skills for appropriate classes
    const rogueClasses = ['Ladr√≥n', 'Bardo'];
    const rogueSkillsSection = document.getElementById('rogue-skills').parentElement;
    
    if (rogueClasses.includes(primaryClass)) {
        rogueSkillsSection.style.display = 'block';
        
        // Update each rogue skill
        Object.keys(rogueSkills).forEach(skillId => {
            updateRogueSkill(skillId);
        });
        
        // Show/hide Read Languages button based on level
        const readLanguagesBtn = document.getElementById('read-languages-btn');
        if (level >= 4) {
            readLanguagesBtn.style.display = 'inline-flex';
        } else {
            readLanguagesBtn.style.display = 'none';
        }
    } else {
        rogueSkillsSection.style.display = 'none';
    }
}

// Update individual rogue skill
function updateRogueSkill(skillId) {
    const level = parseInt(document.getElementById('level')?.value || 1);
    const skillData = rogueSkills[skillId];
    
    if (!skillData) return;
    
    // Check minimum level requirement
    if (skillData.minLevel && level < skillData.minLevel) {
        const skillCard = document.querySelector(`[data-skill="${skillId}"]`);
        skillCard.style.opacity = '0.5';
        return;
    } else {
        const skillCard = document.querySelector(`[data-skill="${skillId}"]`);
        skillCard.style.opacity = '1';
    }
    
    const levelBonus = (level - 1) * skillData.perLevel;
    const modifier = parseInt(document.querySelector(`[data-skill="${skillId}"] .skill-modifier`)?.value || 0);
    const finalPercentage = Math.min(95, Math.max(0, skillData.base + levelBonus + modifier));
    
    // Update display
    document.getElementById(`${skillId}-level`).textContent = `+${levelBonus}`;
    document.getElementById(`${skillId}-bonus`).textContent = modifier !== 0 ? `+${modifier}` : '+0';
    document.getElementById(`${skillId}-final`).textContent = `= ${finalPercentage}%`;
}

// Add weapon proficiency
function addWeaponProficiency() {
    if (weaponSlots.used >= weaponSlots.total) {
        showNotification('No tienes slots de armas disponibles', 'error');
        return;
    }
    
    const proficiencyId = `weapon-prof-${Date.now()}`;
    const proficiencyCard = document.createElement('div');
    proficiencyCard.className = 'weapon-proficiency-card';
    proficiencyCard.setAttribute('data-proficiency', proficiencyId);
    
    proficiencyCard.innerHTML = `
        <div class="weapon-proficiency-header-card">
            <h5 style="color: #e2e8f0; margin: 0;">‚öîÔ∏è Competencia con Arma</h5>
            <button class="remove-weapon-proficiency" onclick="removeWeaponProficiency('${proficiencyId}')">‚ùå</button>
        </div>
        <select class="weapon-proficiency-name" onchange="updateWeaponProficiency('${proficiencyId}')">
            <option value="">Seleccionar arma...</option>
            ${Object.entries(weaponTypes).map(([key, name]) => `<option value="${key}">${name}</option>`).join('')}
        </select>
        <div class="weapon-proficiency-levels">
            <label class="proficiency-level">
                <input type="radio" name="${proficiencyId}-level" value="proficient" checked onchange="updateWeaponProficiency('${proficiencyId}')">
                Competente (0 slots)
            </label>
            <label class="proficiency-level">
                <input type="radio" name="${proficiencyId}-level" value="specialized" onchange="updateWeaponProficiency('${proficiencyId}')">
                Especializado (+1 slot)
            </label>
            <label class="proficiency-level">
                <input type="radio" name="${proficiencyId}-level" value="mastery" onchange="updateWeaponProficiency('${proficiencyId}')">
                Maestr√≠a (+2 slots)
            </label>
        </div>
    `;
    
    document.getElementById('weapon-proficiencies-list').appendChild(proficiencyCard);
    
    // Add to tracking
    weaponSlots.proficiencies.push({
        id: proficiencyId,
        weapon: '',
        level: 'proficient',
        slots: 1
    });
    
    weaponSlots.used += 1;
    updateWeaponSlots();
}

// Remove weapon proficiency
function removeWeaponProficiency(proficiencyId) {
    const proficiencyCard = document.querySelector(`[data-proficiency="${proficiencyId}"]`);
    if (proficiencyCard) {
        proficiencyCard.remove();
    }
    
    // Remove from tracking
    const index = weaponSlots.proficiencies.findIndex(p => p.id === proficiencyId);
    if (index !== -1) {
        weaponSlots.used -= weaponSlots.proficiencies[index].slots;
        weaponSlots.proficiencies.splice(index, 1);
    }
    
    updateWeaponSlots();
}

// Update weapon proficiency
function updateWeaponProficiency(proficiencyId) {
    const proficiencyCard = document.querySelector(`[data-proficiency="${proficiencyId}"]`);
    if (!proficiencyCard) return;
    
    const weaponSelect = proficiencyCard.querySelector('.weapon-proficiency-name');
    const levelRadios = proficiencyCard.querySelectorAll(`input[name="${proficiencyId}-level"]`);
    
    let selectedLevel = 'proficient';
    levelRadios.forEach(radio => {
        if (radio.checked) selectedLevel = radio.value;
    });
    
    // Calculate slot cost
    let slotCost = 1;
    if (selectedLevel === 'specialized') slotCost = 2;
    else if (selectedLevel === 'mastery') slotCost = 3;
    
    // Update tracking
    const profIndex = weaponSlots.proficiencies.findIndex(p => p.id === proficiencyId);
    if (profIndex !== -1) {
        const oldSlots = weaponSlots.proficiencies[profIndex].slots;
        weaponSlots.used -= oldSlots;
        weaponSlots.used += slotCost;
        
        weaponSlots.proficiencies[profIndex] = {
            id: proficiencyId,
            weapon: weaponSelect.value,
            level: selectedLevel,
            slots: slotCost
        };
        
        // Check if exceeds available slots
        if (weaponSlots.used > weaponSlots.total) {
            showNotification('No tienes suficientes slots de armas disponibles', 'error');
            // Revert to proficient
            const proficientRadio = proficiencyCard.querySelector(`input[value="proficient"]`);
            proficientRadio.checked = true;
            weaponSlots.used -= slotCost - 1;
            weaponSlots.proficiencies[profIndex].level = 'proficient';
            weaponSlots.proficiencies[profIndex].slots = 1;
        }
    }
    
    updateWeaponSlots();
}

// Auto-assign skills based on class
function autoAssignSkills() {
    const primaryClass = document.getElementById('primary-dropdown-header')?.textContent?.trim() || '';
    
    // Reset current skills
    resetAllSkills();
    
    // Class-based skill recommendations
    const classSkills = {
        'Guerrero': ['armorer', 'blacksmithing', 'animal-handling'],
        'B√°rbaro': ['animal-handling', 'animal-lore', 'blacksmithing'],
        'Palad√≠n': ['animal-handling', 'armorer', 'artistic-ability'],
        'Ranger': ['animal-handling', 'animal-lore', 'bowyer-fletcher'],
        'Cl√©rigo': ['artistic-ability', 'astronomy', 'brewing'],
        'Druida': ['animal-handling', 'animal-lore', 'agriculture'],
        'Mago': ['astronomy', 'appraising', 'brewing'],
        'Ladr√≥n': ['appraising', 'armorer', 'carpentry'],
        'Bardo': ['artistic-ability', 'appraising', 'astronomy']
    };
    
    const recommendedSkills = classSkills[primaryClass] || ['agriculture', 'animal-handling', 'appraising'];
    
    // Auto-assign recommended skills
    let slotsToDistribute = skillSlots.total;
    recommendedSkills.forEach((skillId, index) => {
        if (slotsToDistribute > 0 && index < recommendedSkills.length) {
            const skillCard = document.querySelector(`[data-skill="${skillId}"]`);
            if (skillCard) {
                const checkbox = skillCard.querySelector('.skill-toggle');
                checkbox.checked = true;
                toggleSkill(skillId);
                
                // Distribute slots evenly
                const slotsPerSkill = Math.max(1, Math.floor(skillSlots.total / recommendedSkills.length));
                const actualSlots = Math.min(slotsPerSkill, slotsToDistribute);
                
                const slotsInput = skillCard.querySelector('.skill-slots');
                slotsInput.value = actualSlots;
                updateSkill(skillId);
                
                slotsToDistribute -= actualSlots;
            }
        }
    });
    
    showNotification(`Habilidades asignadas autom√°ticamente para ${primaryClass}`, 'success');
}

// Reset all skills
function resetAllSkills() {
    // Reset general skills
    Object.keys(skillSlots.skills).forEach(skillId => {
        const skillCard = document.querySelector(`[data-skill="${skillId}"]`);
        if (skillCard) {
            const checkbox = skillCard.querySelector('.skill-toggle');
            const slotsInput = skillCard.querySelector('.skill-slots');
            
            checkbox.checked = false;
            slotsInput.disabled = true;
            slotsInput.value = 0;
            skillCard.classList.remove('active');
        }
    });
    
    // Reset rogue skill modifiers
    document.querySelectorAll('.skill-modifier').forEach(input => {
        input.value = 0;
    });
    
    // Update all rogue skills
    Object.keys(rogueSkills).forEach(skillId => {
        updateRogueSkill(skillId);
    });
    
    // Reset tracking
    skillSlots.used = 0;
    skillSlots.skills = {};
    
    updateSkillSlots();
    updateActiveSkillsRolls();
    showNotification('Todas las habilidades han sido reiniciadas', 'info');
}

// Toggle category visibility
function toggleCategory(categoryId) {
    const category = document.getElementById(categoryId);
    const header = category.previousElementSibling;
    const toggle = header.querySelector('.category-toggle');
    
    if (category.classList.contains('collapsed')) {
        category.classList.remove('collapsed');
        category.style.display = 'grid';
        toggle.textContent = '‚ñº';
        header.classList.remove('collapsed');
    } else {
        category.classList.add('collapsed');
        category.style.display = 'none';
        toggle.textContent = '‚ñ∂';
        header.classList.add('collapsed');
    }
}

// Update active skills for quick rolls
function updateActiveSkillsRolls() {
    const container = document.getElementById('active-skills-rolls');
    container.innerHTML = '';
    
    Object.keys(skillSlots.skills).forEach(skillId => {
        if (skillSlots.skills[skillId] > 0) {
            const skillCard = document.querySelector(`[data-skill="${skillId}"]`);
            const skillName = skillCard.querySelector('h4').textContent;
            
            const rollBtn = document.createElement('button');
            rollBtn.className = 'skill-roll-btn';
            rollBtn.onclick = () => rollGeneralSkill(skillId);
            rollBtn.innerHTML = skillName;
            
            container.appendChild(rollBtn);
        }
    });
    
    if (container.children.length === 0) {
        container.innerHTML = '<p style="color: #cbd5e0; font-style: italic; text-align: center;">No hay pericias activas</p>';
    }
}

// Roll general skill check
function rollGeneralSkill(skillId) {
    const skillCard = document.querySelector(`[data-skill="${skillId}"]`);
    if (!skillCard) return;
    
    const skillName = skillCard.querySelector('h4').textContent;
    const finalPercentage = parseInt(skillCard.querySelector(`#${skillId}-final`).textContent.replace(/[^\d]/g, ''));
    
    const roll = Math.floor(Math.random() * 100) + 1;
    const success = roll <= finalPercentage;
    
    let resultClass = success ? 'success' : 'failure';
    let resultText = `${skillName}: ${roll} vs ${finalPercentage}% - ${success ? '√âXITO' : 'FALLO'}`;
    
    // Critical success/failure
    if (roll === 1) {
        resultText += ' ¬°CR√çTICO!';
        resultClass = 'critical';
    } else if (roll === 100) {
        resultText += ' ¬°PIFIA!';
        resultClass = 'failure';
    }
    
    logSkillResult(resultText, resultClass);
}

// Roll rogue skill check
function rollRogueSkill(skillId) {
    const skillData = rogueSkills[skillId];
    if (!skillData) return;
    
    const level = parseInt(document.getElementById('level')?.value || 1);
    
    // Check level requirement
    if (skillData.minLevel && level < skillData.minLevel) {
        showNotification(`Habilidad disponible a partir del nivel ${skillData.minLevel}`, 'error');
        return;
    }
    
    const finalPercentage = parseInt(document.getElementById(`${skillId}-final`).textContent.replace(/[^\d]/g, ''));
    const skillName = document.querySelector(`[data-skill="${skillId}"] h4`).textContent;
    
    const roll = Math.floor(Math.random() * 100) + 1;
    const success = roll <= finalPercentage;
    
    let resultClass = success ? 'success' : 'failure';
    let resultText = `${skillName}: ${roll} vs ${finalPercentage}% - ${success ? '√âXITO' : 'FALLO'}`;
    
    // Critical success/failure
    if (roll <= 5) {
        resultText += ' ¬°CR√çTICO!';
        resultClass = 'critical';
    } else if (roll >= 96) {
        resultText += ' ¬°PIFIA!';
        resultClass = 'failure';
    }
    
    logSkillResult(resultText, resultClass);
}

// Log skill roll result
function logSkillResult(message, type = 'info') {
    const resultsContent = document.getElementById('skill-results-content');
    const resultEntry = document.createElement('div');
    resultEntry.className = `skill-result-entry ${type}`;
    
    resultEntry.innerHTML = `
        ${message}
        <span class="result-timestamp">${new Date().toLocaleTimeString()}</span>
    `;
    
    resultsContent.appendChild(resultEntry);
    resultsContent.scrollTop = resultsContent.scrollHeight;
}

// Clear skill results
function clearSkillResults() {
    const resultsContent = document.getElementById('skill-results-content');
    resultsContent.innerHTML = '';
}

// Show notification
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 1000;
        animation: slideIn 0.3s ease;
    `;
    
    // Set background color based on type
    const colors = {
        'success': '#48bb78',
        'error': '#e53e3e',
        'info': '#4299e1',
        'warning': '#ed8936'
    };
    
    notification.style.background = colors[type] || colors.info;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Add CSS for notifications
const notificationStyle = document.createElement('style');
notificationStyle.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(notificationStyle);

// Initialize skills tab when the page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSkillsTab);
} else {
    initializeSkillsTab();
}

// Update skills when switching to skills tab
document.addEventListener('tabChanged', function(e) {
    if (e.detail === 'skills') {
        setTimeout(() => {
            initializeSkillsTab();
            calculateSkillSlots();
        }, 100);
    }
});

// Update skills when level or abilities change
document.addEventListener('statsChanged', function() {
    setTimeout(() => {
        calculateSkillSlots();
        updateRogueSkills();
        
        // Recalculate all active general skills
        Object.keys(skillSlots.skills).forEach(skillId => {
            updateSkill(skillId);
        });
    }, 100);
});

// Export skills data for other systems
function exportSkillsData() {
    return {
        generalSkills: skillSlots.skills,
        weaponProficiencies: weaponSlots.proficiencies,
        rogueSkills: Object.keys(rogueSkills).reduce((acc, skillId) => {
            const finalPercentage = parseInt(document.getElementById(`${skillId}-final`)?.textContent.replace(/[^\d]/g, '') || 0);
            acc[skillId] = finalPercentage;
            return acc;
        }, {})
    };
}

// Import skills data
function importSkillsData(data) {
    if (data.generalSkills) {
        Object.entries(data.generalSkills).forEach(([skillId, slots]) => {
            const skillCard = document.querySelector(`[data-skill="${skillId}"]`);
            if (skillCard && slots > 0) {
                const checkbox = skillCard.querySelector('.skill-toggle');
                const slotsInput = skillCard.querySelector('.skill-slots');
                
                checkbox.checked = true;
                toggleSkill(skillId);
                slotsInput.value = slots;
                updateSkill(skillId);
            }
        });
    }
    
    if (data.weaponProficiencies) {
        data.weaponProficiencies.forEach(prof => {
            addWeaponProficiency();
            // Set weapon type and level based on imported data
            // This would need additional implementation
        });
    }
}
</script>

Spell tab
.spell-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    border-color: #9f7aea;
}

.spell-card.prepared {
    border-color: #48bb78;
    box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.2);
}

.spell-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.8rem;
}

.spell-name {
    color: #e2e8f0;
    font-weight: bold;
    font-size: 1rem;
    margin: 0;
}

.spell-level-badge {
    background: linear-gradient(135deg, #9f7aea, #805ad5);
    color: white;
    padding: 0.2rem 0.6rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
}

.spell-school {
    color: #cbd5e0;
    font-size: 0.8rem;
    font-style: italic;
    margin-bottom: 0.5rem;
}

.spell-details {
    margin-bottom: 1rem;
}

.spell-detail-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.3rem;
    font-size: 0.9rem;
}

.spell-detail-label {
    color: #cbd5e0;
    font-weight: bold;
}

.spell-detail-value {
    color: #e2e8f0;
}

.spell-description {
    color: #a0aec0;
    font-size: 0.9rem;
    line-height: 1.4;
    margin-bottom: 1rem;
    max-height: 60px;
    overflow: hidden;
    position: relative;
}

.spell-description.expanded {
    max-height: none;
}

.spell-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.spell-action-btn {
    flex: 1;
    min-width: 80px;
    padding: 0.4rem 0.8rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: bold;
    transition: all 0.3s ease;
}

.prepare-btn {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

.prepare-btn.prepared {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
}

.cast-spell-btn {
    background: linear-gradient(135deg, #9f7aea, #805ad5);
    color: white;
}

.expand-btn {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
    flex: none;
    min-width: 60px;
}

.spell-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.spell-action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Prepared Spells Section */
.prepared-spells-section {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 1px solid #4a5568;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.prepared-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.prepared-header h3 {
    color: #f7fafc;
    margin: 0;
}

.prepared-controls {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.prepared-count {
    color: #cbd5e0;
    font-weight: bold;
}

.clear-prepared-btn {
    background: #e53e3e;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-size: 0.9rem;
}

.prepared-spells-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 1rem;
    min-height: 150px;
    background: rgba(0, 0, 0, 0.2);
    border: 2px dashed #4a5568;
    border-radius: 8px;
    padding: 1rem;
}

.prepared-placeholder {
    grid-column: 1 / -1;
    text-align: center;
    color: #718096;
    align-self: center;
}

.prepared-spell-card {
    background: linear-gradient(135deg, #48bb78, #38a169);
    border: 1px solid #48bb78;
    border-radius: 8px;
    padding: 0.8rem;
    color: white;
    position: relative;
}

.prepared-spell-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.5rem;
}

.prepared-spell-name {
    font-weight: bold;
    margin: 0;
}

.unprepare-btn {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 0.8rem;
}

.prepared-spell-info {
    font-size: 0.8rem;
    opacity: 0.9;
}

/* Spell Log Section */
.spell-log-section {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 1px solid #4a5568;
    border-radius: 12px;
    overflow: hidden;
}

.log-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    background: #2d3748;
    border-bottom: 1px solid #4a5568;
}

.log-header h3 {
    margin: 0;
    color: #e2e8f0;
}

.clear-log-btn {
    background: #e53e3e;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-size: 0.9rem;
}

.spell-log-content {
    max-height: 300px;
    overflow-y: auto;
    padding: 1rem;
}

.spell-log-entry {
    background: rgba(0, 0, 0, 0.2);
    border-left: 4px solid #9f7aea;
    padding: 0.8rem;
    margin-bottom: 0.8rem;
    border-radius: 0 8px 8px 0;
    color: #e2e8f0;
}

.spell-log-entry.cast {
    border-left-color: #9f7aea;
}

.spell-log-entry.prepared {
    border-left-color: #48bb78;
    background: rgba(72, 187, 120, 0.1);
}

.spell-log-entry.restored {
    border-left-color: #4299e1;
    background: rgba(66, 153, 225, 0.1);
}

.log-timestamp {
    font-size: 0.7rem;
    color: #a0aec0;
    float: right;
}

/* Custom Spell Modal */
.spell-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 1px solid #4a5568;
    border-radius: 12px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #4a5568;
}

.modal-header h3 {
    margin: 0;
    color: #e2e8f0;
}

.modal-close {
    background: none;
    border: none;
    color: #cbd5e0;
    font-size: 1.2rem;
    cursor: pointer;
}

.modal-body {
    padding: 1.5rem;
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.form-row {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}

.form-row.full-width {
    grid-column: 1 / -1;
}

.form-row label {
    color: #cbd5e0;
    font-weight: bold;
    font-size: 0.9rem;
}

.form-row input, .form-row select, .form-row textarea {
    padding: 0.6rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 6px;
    color: #e2e8f0;
}

.form-row textarea {
    resize: vertical;
    font-family: inherit;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid #4a5568;
}

.modal-btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
}

.modal-btn.cancel {
    background: #4a5568;
    color: white;
}

.modal-btn.save {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

/* Responsive Design */
@media (max-width: 768px) {
    .spells-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .spells-summary {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .spell-levels-grid {
        grid-template-columns: 1fr;
    }
    
    .spells-grid {
        grid-template-columns: 1fr;
    }
    
    .spellbook-header {
        flex-direction: column;
        align-items: stretch;
    }
    
    .spellbook-controls {
        justify-content: space-between;
    }
    
    .prepared-spells-grid {
        grid-template-columns: 1fr;
    }
    
    .modal-body {
        grid-template-columns: 1fr;
        padding: 1rem;
    }
}

@media (max-width: 480px) {
    .spells-container {
        padding: 0.5rem;
    }
    
    .spell-level-card {
        padding: 0.8rem;
    }
    
    .spells-actions {
        flex-direction: column;
    }
    
    .spell-card {
        padding: 0.8rem;
    }
    
    .spell-actions {
        flex-direction: column;
    }
}
</style>

<!-- SPELLS TAB JAVASCRIPT -->
<script>
// Spell progression tables by class (AD&D 2nd Edition)
const spellProgression = {
    'Cl√©rigo': {
        1: [1, 0, 0, 0, 0, 0, 0],
        2: [2, 0, 0, 0, 0, 0, 0],
        3: [2, 1, 0, 0, 0, 0, 0],
        4: [3, 2, 0, 0, 0, 0, 0],
        5: [3, 3, 1, 0, 0, 0, 0],
        6: [3, 3, 2, 0, 0, 0, 0],
        7: [3, 3, 2, 1, 0, 0, 0],
        8: [3, 3, 3, 2, 0, 0, 0],
        9: [4, 4, 3, 2, 1, 0, 0],
        10: [4, 4, 3, 3, 2, 0, 0],
        11: [5, 4, 4, 3, 2, 1, 0],
        12: [6, 5, 5, 3, 2, 2, 0],
        13: [6, 6, 6, 4, 2, 2, 0],
        14: [6, 6, 6, 5, 3, 2, 1],
        15: [6, 6, 6, 6, 4, 2, 1],
        16: [7, 7, 7, 6, 4, 3, 1],
        17: [7, 7, 7, 7, 5, 3, 2],
        18: [8, 8, 8, 8, 6, 4, 2],
        19: [9, 9, 8, 8, 6, 4, 2],
        20: [9, 9, 9, 8, 7, 5, 2]
    },
    'Druida': {
        1: [1, 0, 0, 0, 0, 0, 0],
        2: [2, 0, 0, 0, 0, 0, 0],
        3: [2, 1, 0, 0, 0, 0, 0],
        4: [3, 2, 0, 0, 0, 0, 0],
        5: [3, 3, 1, 0, 0, 0, 0],
        6: [3, 3, 2, 0, 0, 0, 0],
        7: [3, 3, 2, 1, 0, 0, 0],
        8: [3, 3, 3, 2, 0, 0, 0],
        9: [4, 4, 3, 2, 1, 0, 0],
        10: [4, 4, 3, 3, 2, 0, 0],
        11: [5, 4, 4, 3, 2, 1, 0],
        12: [6, 5, 5, 3, 2, 2, 0],
        13: [6, 6, 6, 4, 2, 2, 0],
        14: [6, 6, 6, 5, 3, 2, 1],
        15: [6, 6, 6, 6, 4, 2, 1],
        16: [7, 7, 7, 6, 4, 3, 1],
        17: [7, 7, 7, 7, 5, 3, 2],
        18: [8, 8, 8, 8, 6, 4, 2],
        19: [9, 9, 8, 8, 6, 4, 2],
        20: [9, 9, 9, 8, 7, 5, 2]
    },
    'Mago': {
        1: [1, 0, 0, 0, 0, 0, 0, 0, 0],
        2: [2, 0, 0, 0, 0, 0, 0, 0, 0],
        3: [2, 1, 0, 0, 0, 0, 0, 0, 0],
        4: [3, 2, 0, 0, 0, 0, 0, 0, 0],
        5: [4, 2, 1, 0, 0, 0, 0, 0, 0],
        6: [4, 2, 2, 0, 0, 0, 0, 0, 0],
        7: [4, 3, 2, 1, 0, 0, 0, 0, 0],
        8: [4, 3, 3, 2, 0, 0, 0, 0, 0],
        9: [4, 3, 3, 2, 1, 0, 0, 0, 0],
        10: [4, 4, 3, 2, 2, 0, 0, 0, 0],
        11: [4, 4, 4, 3, 3, 0, 0, 0, 0],
        12: [4, 4, 4, 4, 4, 1, 0, 0, 0],
        13: [5, 5, 5, 4, 4, 2, 0, 0, 0],
        14: [5, 5, 5, 4, 4, 2, 1, 0, 0],
        15: [5, 5, 5, 5, 5, 2, 1, 0, 0],
        16: [5, 5, 5, 5, 5, 3, 2, 1, 0],
        17: [5, 5, 5, 5, 5, 3, 3, 2, 0],
        18: [5, 5, 5, 5, 5, 3, 3, 2, 1],
        19: [5, 5, 5, 5, 5, 3, 3, 3, 1],
        20: [5, 5, 5, 5, 5, 4, 3, 3, 2]
    },
    'Hechicero': {
        1: [1, 0, 0, 0, 0, 0, 0, 0, 0],
        2: [2, 0, 0, 0, 0, 0, 0, 0, 0],
        3: [3, 1, 0, 0, 0, 0, 0, 0, 0],
        4: [4, 2, 0, 0, 0, 0, 0, 0, 0],
        5: [4, 3, 1, 0, 0, 0, 0, 0, 0],
        6: [4, 4, 2, 0, 0, 0, 0, 0, 0],
        7: [4, 4, 3, 1, 0, 0, 0, 0, 0],
        8: [4, 4, 4, 2, 0, 0, 0, 0, 0],
        9: [4, 4, 4, 3, 1, 0, 0, 0, 0],
        10: [4, 4, 4, 4, 2, 0, 0, 0, 0],
        11: [4, 4, 4, 4, 3, 1, 0, 0, 0],
        12: [4, 4, 4, 4, 4, 2, 0, 0, 0],
        13: [5, 5, 5, 4, 4, 3, 1, 0, 0],
        14: [5, 5, 5, 5, 4, 4, 2, 0, 0],
        15: [5, 5, 5, 5, 5, 4, 3, 1, 0],
        16: [5, 5, 5, 5, 5, 4, 4, 2, 0],
        17: [5, 5, 5, 5, 5, 5, 4, 3, 1],
        18: [5, 5, 5, 5, 5, 5, 4, 4, 2],
        19: [5, 5, 5, 5, 5, 5, 5, 4, 3],
        20: [5, 5, 5, 5, 5, 5, 5, 4, 4]
    },
    'Bardo': {
        2: [1, 0, 0, 0, 0, 0, 0],
        3: [2, 0, 0, 0, 0, 0, 0],
        4: [2, 1, 0, 0, 0, 0, 0],
        5: [3, 2, 0, 0, 0, 0, 0],
        6: [3, 2, 1, 0, 0, 0, 0],
        7: [3, 3, 2, 0, 0, 0, 0],
        8: [3, 3, 2, 1, 0, 0, 0],
        9: [3, 3, 3, 2, 0, 0, 0],
        10: [3, 3, 3, 2, 1, 0, 0],
        11: [4, 3, 3, 3, 2, 0, 0],
        12: [4, 4, 3, 3, 2, 1, 0],
        13: [4, 4, 4, 3, 3, 2, 0],
        14: [4, 4, 4, 4, 3, 2, 0],
        15: [4, 4, 4, 4, 4, 2, 1],
        16: [5, 4, 4, 4, 4, 3, 2],
        17: [5, 5, 4, 4, 4, 3, 2],
        18: [5, 5, 5, 4, 4, 3, 2],
        19: [5, 5, 5, 5, 4, 4, 3],
        20: [5, 5, 5, 5, 5, 4, 3]
    }
};

// Sample spells database
const spellsDatabase = {
    arcane: [
        {
            name: "Misiles M√°gicos",
            level: 1,
            school: "Evocaci√≥n",
            range: "60 metros",
            duration: "Instant√°neo",
            components: "V, S",
            description: "Creas tres dardos brillantes de fuerza m√°gica. Cada dardo impacta autom√°ticamente a una criatura que puedas ver dentro del alcance, causando 1d4+1 puntos de da√±o de fuerza. Los dardos impactan simult√°neamente y puedes dirigirlos a la misma criatura o a diferentes."
        },
        {
            name: "Armadura de Mago",
            level: 1,
            school: "Abjuraci√≥n",
            range: "Toque",
            duration: "8 horas",
            components: "V, S, M",
            description: "Tocas a una criatura voluntaria que no lleve armadura. Una fuerza m√°gica protectora la rodea hasta que termine el conjuro. La CA base del objetivo se convierte en 13 + su modificador de Destreza."
        },
        {
            name: "Detectar Magia",
            level: 1,
            school: "Adivinaci√≥n",
            range: "Personal",
            duration: "10 minutos",
            components: "V, S",
            description: "Durante la duraci√≥n, puedes sentir la presencia de magia a 30 metros de ti. Si sientes magia de esta manera, puedes usar tu acci√≥n para ver un aura tenue alrededor de cualquier criatura u objeto visible en el √°rea que contenga magia."
        },
        {
            name: "Bola de Fuego",
            level: 3,
            school: "Evocaci√≥n",
            range: "150 metros",
            duration: "Instant√°neo",
            components: "V, S, M",
            description: "Una explosi√≥n brillante de llamas surge desde un punto que elijas dentro del alcance. Cada criatura en una esfera de 6 metros de radio centrada en ese punto debe realizar una salvaci√≥n de Destreza. Un objetivo sufre 8d6 puntos de da√±o de fuego si falla la salvaci√≥n, o la mitad si la supera."
        }
    ],
    divine: [
        {
            name: "Curar Heridas Leves",
            level: 1,
            school: "Necromancia",
            range: "Toque",
            duration: "Instant√°neo",
            components: "V, S",
            description: "Una criatura que tocas recupera 1d8 + tu modificador de lanzamiento de conjuros en puntos de golpe. Este conjuro no afecta a no muertos o constructos."
        },
        {
            name: "Bendecir",
            level: 1,
            school: "Encantamiento",
            range: "30 metros",
            duration: "10 minutos",
            components: "V, S, M",
            description: "Bendices a hasta tres criaturas de tu elecci√≥n dentro del alcance. Cuando un objetivo realice una tirada de ataque o una salvaci√≥n antes de que termine el conjuro, puede tirar 1d4 y a√±adir el resultado a la tirada."
        },
        {
            name: "Detectar Mal",
            level: 1,
            school: "Adivinaci√≥n",
            range: "Personal",
            duration: "10 minutos",
            components: "V, S",
            description: "Durante la duraci√≥n, puedes detectar la presencia de mal en un radio de 60 metros. Puedes determinar si un lugar, objeto o criatura es maligno o ha sido consagrado o profanado."
        },
        {
            name: "Curar Heridas Graves",
            level: 3,
            school: "Necromancia",
            range: "Toque",
            duration: "Instant√°neo",
            components: "V, S",
            description: "Una criatura que tocas recupera 3d8 + tu modificador de lanzamiento de conjuros en puntos de golpe. Este conjuro no afecta a no muertos o constructos."
        }
    ]
};

// Current spell state
let currentSpellSlots = {
    1: { current: 0, max: 0 },
    2: { current: 0, max: 0 },
    3: { current: 0, max: 0 },
    4: { current: 0, max: 0 },
    5: { current: 0, max: 0 },
    6: { current: 0, max: 0 },
    7: { current: 0, max: 0 }
};

let preparedSpells = [];
let customSpells = [];

// Initialize spells tab
function initializeSpellsTab() {
    updateCasterInfo();
    updateProgressionTable();
    updateSpellSlots();
    updateSpellsDatabase();
    updatePreparedSpells();
    checkSpellcastingAbility();
}

// Update caster information
function updateCasterInfo() {
    const level = parseInt(document.getElementById('level')?.value || 1);
    const primaryClass = document.getElementById('primary-dropdown-header')?.textContent?.trim() || '';
    
    const spellcastingClasses = ['Cl√©rigo', 'Druida', 'Mago', 'Hechicero', 'Bardo'];
    const isCaster = spellcastingClasses.includes(primaryClass);
    
    const casterType = document.getElementById('caster-type');
    const casterLevel = document.getElementById('caster-level');
    const progressionSection = document.getElementById('spell-progression-section');
    
    if (isCaster) {
        let casterLevelValue = level;
        
        // Bards start casting at level 2
        if (primaryClass === 'Bardo' && level < 2) {
            casterLevelValue = 0;
        }
        
        casterType.textContent = primaryClass;
        casterLevel.textContent = `Nivel ${casterLevelValue}`;
        progressionSection.style.display = 'block';
    } else {
        casterType.textContent = 'No Conjurador';
        casterLevel.textContent = '';
        progressionSection.style.display = 'none';
    }
}

// Update spell progression table
function updateProgressionTable() {
    const level = parseInt(document.getElementById('level')?.value || 1);
    const primaryClass = document.getElementById('primary-dropdown-header')?.textContent?.trim() || '';
    const maxLevel = parseInt(document.getElementById('progression-max-level')?.value || 20);
    
    const progression = spellProgression[primaryClass];
    if (!progression) return;
    
    const table = document.getElementById('progression-table');
    table.innerHTML = '';
    
    // Create header
    const headerRow = table.insertRow();
    headerRow.insertCell().textContent = 'Nivel';
    
    // Determine max spell level for this class
    const maxSpellLevel = primaryClass === 'Mago' || primaryClass === 'Hechicero' ? 9 : 7;
    for (let i = 1; i <= maxSpellLevel; i++) {
        headerRow.insertCell().textContent = `Nivel ${i}`;
    }
    
    // Create data rows
    for (let lvl = 1; lvl <= maxLevel; lvl++) {
        if (!progression[lvl]) continue;
        
        const row = table.insertRow();
        
        // Level cell
        const levelCell = row.insertCell();
        levelCell.textContent = lvl;
        
        if (lvl === level) {
            row.className = 'current-level';
        }
        
        // Spell slots cells
        for (let spellLvl = 1; spellLvl <= maxSpellLevel; spellLvl++) {
            const cell = row.insertCell();
            const slots = progression[lvl][spellLvl - 1] || 0;
            cell.textContent = slots || '-';
            
            if (slots > 0) {
                cell.style.color = '#48bb78';
                cell.style.fontWeight = 'bold';
            }
        }
    }
}

// Check if character can cast spells
function checkSpellcastingAbility() {
    const primaryClass = document.getElementById('primary-dropdown-header')?.textContent?.trim() || '';
    const spellcastingClasses = ['Cl√©rigo', 'Druida', 'Mago', 'Hechicero', 'Bardo'];
    
    if (!spellcastingClasses.includes(primaryClass)) {
        // Hide spell-related sections for non-casters
        document.querySelector('.spell-slots-section').style.display = 'none';
        document.querySelector('.spellbook-section').style.display = 'none';
        document.querySelector('.prepared-spells-section').style.display = 'none';
        document.querySelector('.spell-log-section').style.display = 'none';
    } else {
        // Show spell-related sections for casters
        document.querySelector('.spell-slots-section').style.display = 'block';
        document.querySelector('.spellbook-section').style.display = 'block';
        document.querySelector('.prepared-spells-section').style.display = 'block';
        document.querySelector('.spell-log-section').style.display = 'block';
    }
}

// Apply automatic spell progression
function applySpellProgression() {
    const level = parseInt(document.getElementById('level')?.value || 1);
    const primaryClass = document.getElementById('primary-dropdown-header')?.textContent?.trim() || '';
    
    const progression = spellProgression[primaryClass];
    if (!progression || !progression[level]) {
        showSpellNotification('No hay progresi√≥n de conjuros disponible para esta clase/nivel', 'error');
        return;
    }
    
    const spellSlots = progression[level];
    const maxSpellLevel = primaryClass === 'Mago' || primaryClass === 'Hechicero' ? 9 : 7;
    
    // Apply progression to each spell level
    for (let i = 1; i <= maxSpellLevel; i++) {
        const slots = spellSlots[i - 1] || 0;
        currentSpellSlots[i].max = slots;
        currentSpellSlots[i].current = slots; // Full slots on level up
    }
    
    updateSpellSlots();
    logSpellAction(`Progresi√≥n aplicada para ${primaryClass} nivel ${level}`, 'restored');
    showSpellNotification(`Slots de conjuros actualizados para nivel ${level}`, 'success');
}

// Update spell slots display
function updateSpellSlots() {
    let totalSlots = 0;
    let usedSlots = 0;
    
    for (let level = 1; level <= 7; level++) {
        const slots = currentSpellSlots[level];
        const maxSpan = document.getElementById(`slots-level-${level}-max`);
        const currentSpan = document.getElementById(`slots-level-${level}-current`);
        const visual = document.getElementById(`slots-visual-${level}`);
        const castBtn = document.querySelector(`[onclick="castSpell(${level})"]`);
        
        if (maxSpan) maxSpan.textContent = slots.max;
        if (currentSpan) currentSpan.textContent = slots.current;
        
        // Update visual slots
        if (visual) {
            visual.innerHTML = '';
            for (let i = 0; i < slots.max; i++) {
                const circle = document.createElement('div');
                circle.className = 'slot-circle';
                circle.className += i < slots.current ? ' available' : ' used';
                circle.onclick = () => toggleSlot(level, i);
                visual.appendChild(circle);
            }
        }
        
        // Enable/disable cast button
        if (castBtn) {
            castBtn.disabled = slots.current === 0;
        }
        
        totalSlots += slots.max;
        usedSlots += (slots.max - slots.current);
    }
    
    // Update summary
    document.getElementById('total-slots').textContent = totalSlots;
    document.getElementById('used-slots').textContent = usedSlots;
    document.getElementById('available-slots').textContent = totalSlots - usedSlots;
}

// Adjust spell slots manually
function adjustSlots(level, change) {
    const slots = currentSpellSlots[level];
    
    if (change > 0) {
        slots.max += change;
    } else {
        slots.max = Math.max(0, slots.max + change);
        slots.current = Math.min(slots.current, slots.max);
    }
    
    updateSpellSlots();
    logSpellAction(`Slots de nivel ${level} ajustados: ${slots.current}/${slots.max}`, 'restored');
}

// Toggle individual slot
function toggleSlot(level, slotIndex) {
    const slots = currentSpellSlots[level];
    
    if (slotIndex < slots.current) {
        // Use slot
        slots.current--;
    } else if (slotIndex === slots.current && slots.current < slots.max) {
        // Restore slot
        slots.current++;
    }
    
    updateSpellSlots();
}

// Cast spell (use slot)
function castSpell(level) {
    const slots = currentSpellSlots[level];
    
    if (slots.current > 0) {
        slots.current--;
        updateSpellSlots();
        logSpellAction(`Slot de nivel ${level} usado`, 'cast');
        showSpellNotification(`Slot de nivel ${level} usado`, 'info');
    }
}

// Restore all slots for a specific level
function restoreLevel(level) {
    const slots = currentSpellSlots[level];
    slots.current = slots.max;
    updateSpellSlots();
    logSpellAction(`Todos los slots de nivel ${level} restaurados`, 'restored');
    showSpellNotification(`Slots de nivel ${level} restaurados`, 'success');
}

// Full rest - restore all spell slots
function restoreSpells() {
    for (let level = 1; level <= 7; level++) {
        currentSpellSlots[level].current = currentSpellSlots[level].max;
    }
    updateSpellSlots();
    logSpellAction('Descanso completo - Todos los slots restaurados', 'restored');
    showSpellNotification('¬°Descanso completo! Todos los slots restaurados', 'success');
}

// Reset all spells
function resetAllSpells() {
    // Reset slots
    for (let level = 1; level <= 7; level++) {
        currentSpellSlots[level] = { current: 0, max: 0 };
    }
    
    // Clear prepared spells
    preparedSpells = [];
    
    // Clear custom spells
    customSpells = [];
    
    updateSpellSlots();
    updateSpellsDatabase();
    updatePreparedSpells();
    clearSpellLog();
    
    showSpellNotification('Todos los conjuros han sido reiniciados', 'info');
}

// Update spells database display
function updateSpellsDatabase() {
    const primaryClass = document.getElementById('primary-dropdown-header')?.textContent?.trim() || '';
    
    // Determine which spells to show
    let availableSpells = [];
    
    if (['Mago', 'Hechicero'].includes(primaryClass)) {
        availableSpells = spellsDatabase.arcane;
        document.getElementById('arcane-spells-category').style.display = 'block';
        document.getElementById('divine-spells-category').style.display = 'none';
    } else if (['Cl√©rigo', 'Druida'].includes(primaryClass)) {
        availableSpells = spellsDatabase.divine;
        document.getElementById('arcane-spells-category').style.display = 'none';
        document.getElementById('divine-spells-category').style.display = 'block';
    } else if (primaryClass === 'Bardo') {
        availableSpells = [...spellsDatabase.arcane, ...spellsDatabase.divine];
        document.getElementById('arcane-spells-category').style.display = 'block';
        document.getElementById('divine-spells-category').style.display = 'block';
    } else {
        document.getElementById('arcane-spells-category').style.display = 'none';
        document.getElementById('divine-spells-category').style.display = 'none';
    }
    
    // Populate arcane spells
    populateSpellCategory('arcane-spells', spellsDatabase.arcane, 'arcane');
    
    // Populate divine spells
    populateSpellCategory('divine-spells', spellsDatabase.divine, 'divine');
    
    // Populate custom spells
    populateSpellCategory('custom-spells', customSpells, 'custom');
    
    filterSpells(); // Apply current filters
}

// Populate spell category
function populateSpellCategory(containerId, spells, type) {
    const container = document.getElementById(containerId);
    container.innerHTML = '';
    
    spells.forEach((spell, index) => {
        const spellCard = createSpellCard(spell, type, index);
        container.appendChild(spellCard);
    });
    
    if (spells.length === 0) {
        container.innerHTML = '<p style="color: #718096; text-align: center; grid-column: 1 / -1;">No hay conjuros disponibles</p>';
    }
}

// Create spell card element
function createSpellCard(spell, type, index) {
    const card = document.createElement('div');
    card.className = 'spell-card';
    card.setAttribute('data-spell-level', spell.level);
    card.setAttribute('data-spell-name', spell.name.toLowerCase());
    card.setAttribute('data-spell-type', type);
    card.setAttribute('data-spell-index', index);
    
    // Check if spell is prepared
    const isPrepared = preparedSpells.some(p => p.name === spell.name && p.type === type);
    if (isPrepared) {
        card.classList.add('prepared');
    }
    
    card.innerHTML = `
        <div class="spell-header">
            <h5 class="spell-name">${spell.name}</h5>
            <span class="spell-level-badge">Nivel ${spell.level}</span>
        </div>
        <div class="spell-school">${spell.school || 'Escuela desconocida'}</div>
        <div class="spell-details">
            <div class="spell-detail-row">
                <span class="spell-detail-label">Rango:</span>
                <span class="spell-detail-value">${spell.range || 'N/A'}</span>
            </div>
            <div class="spell-detail-row">
                <span class="spell-detail-label">Duraci√≥n:</span>
                <span class="spell-detail-value">${spell.duration || 'N/A'}</span>
            </div>
            <div class="spell-detail-row">
                <span class="spell-detail-label">Componentes:</span>
                <span class="spell-detail-value">${spell.components || 'N/A'}</span>
            </div>
        </div>
        <div class="spell-description">${spell.description || 'Sin descripci√≥n disponible.'}</div>
        <div class="spell-actions">
            <button class="spell-action-btn prepare-btn ${isPrepared ? 'prepared' : ''}" 
                    onclick="togglePrepareSpell('${spell.name}', '${type}', ${index})">
                ${isPrepared ? 'Despeparar' : 'Preparar'}
            </button>
            <button class="spell-action-btn cast-spell-btn" 
                    onclick="quickCastSpell('${spell.name}', ${spell.level}, '${type}', ${index})"
                    ${currentSpellSlots[spell.level]?.current > 0 ? '' : 'disabled'}>
                Lanzar
            </button>
            <button class="spell-action-btn expand-btn" onclick="toggleSpellDescription(this)">
                Ver m√°s
            </button>
        </div>
    `;
    
    return card;
}

// Toggle spell description expansion
function toggleSpellDescription(button) {
    const card = button.closest('.spell-card');
    const description = card.querySelector('.spell-description');
    
    if (description.classList.contains('expanded')) {
        description.classList.remove('expanded');
        button.textContent = 'Ver m√°s';
    } else {
        description.classList.add('expanded');
        button.textContent = 'Ver menos';
    }
}

// Toggle prepare spell
function togglePrepareSpell(spellName, type, index) {
    const spellData = type === 'custom' ? customSpells[index] : 
                     type === 'arcane' ? spellsDatabase.arcane[index] : 
                     spellsDatabase.divine[index];
    
    const existingIndex = preparedSpells.findIndex(p => p.name === spellName && p.type === type);
    
    if (existingIndex !== -1) {
        // Remove from prepared
        preparedSpells.splice(existingIndex, 1);
        logSpellAction(`${spellName} removido de conjuros preparados`, 'prepared');
        showSpellNotification(`${spellName} ya no est√° preparado`, 'info');
    } else {
        // Add to prepared
        preparedSpells.push({
            ...spellData,
            type: type,
            index: index
        });
        logSpellAction(`${spellName} a√±adido a conjuros preparados`, 'prepared');
        showSpellNotification(`${spellName} preparado`, 'success');
    }
    
    updateSpellsDatabase(); // Refresh to update prepare buttons
    updatePreparedSpells();
}

// Quick cast spell
function quickCastSpell(spellName, level, type, index) {
    if (currentSpellSlots[level]?.current > 0) {
        castSpell(level);
        logSpellAction(`${spellName} lanzado usando slot de nivel ${level}`, 'cast');
        showSpellNotification(`${spellName} lanzado`, 'success');
    } else {
        showSpellNotification(`No tienes slots de nivel ${level} disponibles`, 'error');
    }
}

// Update prepared spells display
function updatePreparedSpells() {
    const container = document.getElementById('prepared-spells-grid');
    const countSpan = document.getElementById('prepared-count');
    
    countSpan.textContent = preparedSpells.length;
    
    if (preparedSpells.length === 0) {
        container.innerHTML = `
            <div class="prepared-placeholder">
                <p>üìù Arrastra conjuros aqu√≠ para prepararlos</p>
                <p><small>o haz clic en "Preparar" en los conjuros conocidos</small></p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    preparedSpells.forEach((spell, index) => {
        const card = document.createElement('div');
        card.className = 'prepared-spell-card';
        
        card.innerHTML = `
            <div class="prepared-spell-header">
                <h6 class="prepared-spell-name">${spell.name}</h6>
                <button class="unprepare-btn" onclick="unprepareSpell(${index})">‚úï</button>
            </div>
            <div class="prepared-spell-info">
                Nivel ${spell.level} ‚Ä¢ ${spell.school || 'Desconocida'}
            </div>
        `;
        
        container.appendChild(card);
    });
}

// Unprepare spell
function unprepareSpell(index) {
    const spell = preparedSpells[index];
    preparedSpells.splice(index, 1);
    
    updatePreparedSpells();
    updateSpellsDatabase(); // Refresh to update prepare buttons
    
    logSpellAction(`${spell.name} removido de conjuros preparados`, 'prepared');
    showSpellNotification(`${spell.name} ya no est√° preparado`, 'info');
}

// Clear all prepared spells
function clearPreparedSpells() {
    preparedSpells = [];
    updatePreparedSpells();
    updateSpellsDatabase();
    
    logSpellAction('Todos los conjuros preparados han sido removidos', 'prepared');
    showSpellNotification('Lista de conjuros preparados limpiada', 'info');
}

// Filter spells
function filterSpells() {
    const searchTerm = document.getElementById('spell-search').value.toLowerCase();
    const levelFilter = document.getElementById('spell-level-filter').value;
    
    const allSpellCards = document.querySelectorAll('.spell-card');
    
    allSpellCards.forEach(card => {
        const spellName = card.getAttribute('data-spell-name');
        const spellLevel = card.getAttribute('data-spell-level');
        
        const matchesSearch = !searchTerm || spellName.includes(searchTerm);
        const matchesLevel = !levelFilter || spellLevel === levelFilter;
        
        if (matchesSearch && matchesLevel) {
            card.style.display = 'block';
        } else {
            card.style.display = 'none';
        }
    });
}

// Toggle spell category
function toggleSpellCategory(categoryId) {
    const category = document.getElementById(categoryId);
    const header = category.previousElementSibling;
    const toggle = header.querySelector('.category-toggle');
    
    if (category.classList.contains('collapsed')) {
        category.classList.remove('collapsed');
        category.style.display = 'grid';
        toggle.textContent = '‚ñº';
        header.classList.remove('collapsed');
    } else {
        category.classList.add('collapsed');
        category.style.display = 'none';
        toggle.textContent = '‚ñ∂';
        header.classList.add('collapsed');
    }
}

// Custom spell modal functions
function addCustomSpell() {
    document.getElementById('spell-modal').style.display = 'flex';
}

function closeSpellModal() {
    document.getElementById('spell-modal').style.display = 'none';
    
    // Clear form
    document.getElementById('custom-spell-name').value = '';
    document.getElementById('custom-spell-level').value = '1';
    document.getElementById('custom-spell-type').value = 'arcane';
    document.getElementById('custom-spell-school').value = '';
    document.getElementById('custom-spell-range').value = '';
    document.getElementById('custom-spell-duration').value = '';
    document.getElementById('custom-spell-components').value = '';
    document.getElementById('custom-spell-description').value = '';
}

function saveCustomSpell() {
    const name = document.getElementById('custom-spell-name').value.trim();
    const level = parseInt(document.getElementById('custom-spell-level').value);
    const type = document.getElementById('custom-spell-type').value;
    const school = document.getElementById('custom-spell-school').value.trim();
    const range = document.getElementById('custom-spell-range').value.trim();
    const duration = document.getElementById('custom-spell-duration').value.trim();
    const components = document.getElementById('custom-spell-components').value.trim();
    const description = document.getElementById('custom-spell-description').value.trim();
    
    if (!name) {
        showSpellNotification('El nombre del conjuro es requerido', 'error');
        return;
    }
    
    // Check for duplicate names
    const existsInCustom = customSpells.some(s => s.name.toLowerCase() === name.toLowerCase());
    const existsInArcane = spellsDatabase.arcane.some(s => s.name.toLowerCase() === name.toLowerCase());
    const existsInDivine = spellsDatabase.divine.some(s => s.name.toLowerCase() === name.toLowerCase());
    
    if (existsInCustom || existsInArcane || existsInDivine) {
        showSpellNotification('Ya existe un conjuro con ese nombre', 'error');
        return;
    }
    
    const newSpell = {
        name: name,
        level: level,
        school: school || 'Personalizada',
        range: range || 'N/A',
        duration: duration || 'N/A',
        components: components || 'N/A',
        description: description || 'Conjuro personalizado sin descripci√≥n.'
    };
    
    customSpells.push(newSpell);
    updateSpellsDatabase();
    closeSpellModal();
    
    showSpellNotification(`Conjuro "${name}" a√±adido exitosamente`, 'success');
    logSpellAction(`Conjuro personalizado "${name}" creado`, 'prepared');
}

// Spell logging
function logSpellAction(message, type = 'cast') {
    const logContent = document.getElementById('spell-log-content');
    const logEntry = document.createElement('div');
    logEntry.className = `spell-log-entry ${type}`;
    
    logEntry.innerHTML = `
        ${message}
        <span class="log-timestamp">${new Date().toLocaleTimeString()}</span>
    `;
    
    logContent.appendChild(logEntry);
    logContent.scrollTop = logContent.scrollHeight;
}

// Clear spell log
function clearSpellLog() {
    const logContent = document.getElementById('spell-log-content');
    logContent.innerHTML = '';
}

// Show spell notification
function showSpellNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `spell-notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 80px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 1001;
        max-width: 300px;
        animation: slideInSpell 0.3s ease;
    `;
    
    // Set background color based on type
    const colors = {
        'success': '#48bb78',
        'error': '#e53e3e',
        'info': '#4299e1',
        'warning': '#ed8936'
    };
    
    notification.style.background = colors[type] || colors.info;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutSpell 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Add CSS for spell notifications
const spellNotificationStyle = document.createElement('style');
spellNotificationStyle.textContent = `
    @keyframes slideInSpell {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutSpell {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(spellNotificationStyle);

// Initialize spells tab when the page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeSpellsTab);
} else {
    initializeSpellsTab();
}

// Update spells when switching to spells tab
document.addEventListener('tabChanged', function(e) {
    if (e.detail === 'spells') {
        setTimeout(() => {
            initializeSpellsTab();
        }, 100);
    }
});

// Update spells when level or class changes
document.addEventListener('statsChanged', function() {
    setTimeout(() => {
        updateCasterInfo();
        updateProgressionTable();
        checkSpellcastingAbility();
        updateSpellsDatabase();
    }, 100);
});

// Export spells data for other systems
function exportSpellsData() {
    return {
        currentSlots: currentSpellSlots,
        preparedSpells: preparedSpells,
        customSpells: customSpells
    };
}

// Import spells data
function importSpellsData(data) {
    if (data.currentSlots) {
        currentSpellSlots = { ...currentSpellSlots, ...data.currentSlots };
    }
    
    if (data.preparedSpells) {
        preparedSpells = data.preparedSpells;
    }
    
    if (data.customSpells) {
        customSpells = data.customSpells;
    }
    
    updateSpellSlots();
    updateSpellsDatabase();
    updatePreparedSpells();
}
</script><!-- SPELLS TAB -->
<div id="spells-tab" class="tab-content">
    <div class="spells-container">
        <!-- Spells Header -->
        <div class="spells-header">
            <h2>‚ú® Conjuros</h2>
            <div class="spells-summary">
                <div class="caster-info">
                    <span class="caster-type" id="caster-type">No Conjurador</span>
                    <span class="caster-level" id="caster-level">Nivel 1</span>
                </div>
                <div class="spells-actions">
                    <button class="auto-progression-btn" onclick="applySpellProgression()">üìà Aplicar Progresi√≥n</button>
                    <button class="reset-spells-btn" onclick="resetAllSpells()">üîÑ Reiniciar Conjuros</button>
                    <button class="rest-btn" onclick="restoreSpells()">üõå Descanso Completo</button>
                </div>
            </div>
        </div>

        <!-- Spell Progression Table -->
        <div class="spell-progression-section" id="spell-progression-section">
            <div class="progression-header">
                <h3>üìä Tabla de Progresi√≥n de Conjuros</h3>
                <div class="progression-controls">
                    <label>Mostrar hasta nivel:</label>
                    <select id="progression-max-level" onchange="updateProgressionTable()">
                        <option value="10">10</option>
                        <option value="15">15</option>
                        <option value="20" selected>20</option>
                    </select>
                </div>
            </div>
            <div class="progression-table-container">
                <table class="progression-table" id="progression-table">
                    <!-- Dynamic content will be generated here -->
                </table>
            </div>
        </div>

        <!-- Spell Slots Management -->
        <div class="spell-slots-section">
            <div class="slots-header">
                <h3>üé≠ Gesti√≥n de Slots de Conjuros</h3>
                <div class="slots-summary">
                    <span class="total-slots">Total: <span id="total-slots">0</span></span>
                    <span class="used-slots">Usados: <span id="used-slots">0</span></span>
                    <span class="available-slots">Disponibles: <span id="available-slots">0</span></span>
                </div>
            </div>
            
            <div class="spell-levels-grid">
                <!-- Spell Level 1 -->
                <div class="spell-level-card" data-level="1">
                    <div class="level-header">
                        <h4>1Ô∏è‚É£ Nivel 1</h4>
                        <div class="level-controls">
                            <button class="level-btn" onclick="adjustSlots(1, -1)">-</button>
                            <span class="current-slots">
                                <span id="slots-level-1-current">0</span>/<span id="slots-level-1-max">0</span>
                            </span>
                            <button class="level-btn" onclick="adjustSlots(1, 1)">+</button>
                        </div>
                    </div>
                    <div class="slots-visual" id="slots-visual-1">
                        <!-- Slot circles will be generated here -->
                    </div>
                    <div class="level-actions">
                        <button class="cast-btn" onclick="castSpell(1)" disabled>üéØ Lanzar</button>
                        <button class="restore-level-btn" onclick="restoreLevel(1)">üîÑ Restaurar</button>
                    </div>
                </div>

                <!-- Spell Level 2 -->
                <div class="spell-level-card" data-level="2">
                    <div class="level-header">
                        <h4>2Ô∏è‚É£ Nivel 2</h4>
                        <div class="level-controls">
                            <button class="level-btn" onclick="adjustSlots(2, -1)">-</button>
                            <span class="current-slots">
                                <span id="slots-level-2-current">0</span>/<span id="slots-level-2-max">0</span>
                            </span>
                            <button class="level-btn" onclick="adjustSlots(2, 1)">+</button>
                        </div>
                    </div>
                    <div class="slots-visual" id="slots-visual-2">
                        <!-- Slot circles will be generated here -->
                    </div>
                    <div class="level-actions">
                        <button class="cast-btn" onclick="castSpell(2)" disabled>üéØ Lanzar</button>
                        <button class="restore-level-btn" onclick="restoreLevel(2)">üîÑ Restaurar</button>
                    </div>
                </div>

                <!-- Spell Level 3 -->
                <div class="spell-level-card" data-level="3">
                    <div class="level-header">
                        <h4>3Ô∏è‚É£ Nivel 3</h4>
                        <div class="level-controls">
                            <button class="level-btn" onclick="adjustSlots(3, -1)">-</button>
                            <span class="current-slots">
                                <span id="slots-level-3-current">0</span>/<span id="slots-level-3-max">0</span>
                            </span>
                            <button class="level-btn" onclick="adjustSlots(3, 1)">+</button>
                        </div>
                    </div>
                    <div class="slots-visual" id="slots-visual-3">
                        <!-- Slot circles will be generated here -->
                    </div>
                    <div class="level-actions">
                        <button class="cast-btn" onclick="castSpell(3)" disabled>üéØ Lanzar</button>
                        <button class="restore-level-btn" onclick="restoreLevel(3)">üîÑ Restaurar</button>
                    </div>
                </div>

                <!-- Spell Level 4 -->
                <div class="spell-level-card" data-level="4">
                    <div class="level-header">
                        <h4>4Ô∏è‚É£ Nivel 4</h4>
                        <div class="level-controls">
                            <button class="level-btn" onclick="adjustSlots(4, -1)">-</button>
                            <span class="current-slots">
                                <span id="slots-level-4-current">0</span>/<span id="slots-level-4-max">0</span>
                            </span>
                            <button class="level-btn" onclick="adjustSlots(4, 1)">+</button>
                        </div>
                    </div>
                    <div class="slots-visual" id="slots-visual-4">
                        <!-- Slot circles will be generated here -->
                    </div>
                    <div class="level-actions">
                        <button class="cast-btn" onclick="castSpell(4)" disabled>üéØ Lanzar</button>
                        <button class="restore-level-btn" onclick="restoreLevel(4)">üîÑ Restaurar</button>
                    </div>
                </div>

                <!-- Spell Level 5 -->
                <div class="spell-level-card" data-level="5">
                    <div class="level-header">
                        <h4>5Ô∏è‚É£ Nivel 5</h4>
                        <div class="level-controls">
                            <button class="level-btn" onclick="adjustSlots(5, -1)">-</button>
                            <span class="current-slots">
                                <span id="slots-level-5-current">0</span>/<span id="slots-level-5-max">0</span>
                            </span>
                            <button class="level-btn" onclick="adjustSlots(5, 1)">+</button>
                        </div>
                    </div>
                    <div class="slots-visual" id="slots-visual-5">
                        <!-- Slot circles will be generated here -->
                    </div>
                    <div class="level-actions">
                        <button class="cast-btn" onclick="castSpell(5)" disabled>üéØ Lanzar</button>
                        <button class="restore-level-btn" onclick="restoreLevel(5)">üîÑ Restaurar</button>
                    </div>
                </div>

                <!-- Spell Level 6 -->
                <div class="spell-level-card" data-level="6">
                    <div class="level-header">
                        <h4>6Ô∏è‚É£ Nivel 6</h4>
                        <div class="level-controls">
                            <button class="level-btn" onclick="adjustSlots(6, -1)">-</button>
                            <span class="current-slots">
                                <span id="slots-level-6-current">0</span>/<span id="slots-level-6-max">0</span>
                            </span>
                            <button class="level-btn" onclick="adjustSlots(6, 1)">+</button>
                        </div>
                    </div>
                    <div class="slots-visual" id="slots-visual-6">
                        <!-- Slot circles will be generated here -->
                    </div>
                    <div class="level-actions">
                        <button class="cast-btn" onclick="castSpell(6)" disabled>üéØ Lanzar</button>
                        <button class="restore-level-btn" onclick="restoreLevel(6)">üîÑ Restaurar</button>
                    </div>
                </div>

                <!-- Spell Level 7 -->
                <div class="spell-level-card" data-level="7">
                    <div class="level-header">
                        <h4>7Ô∏è‚É£ Nivel 7</h4>
                        <div class="level-controls">
                            <button class="level-btn" onclick="adjustSlots(7, -1)">-</button>
                            <span class="current-slots">
                                <span id="slots-level-7-current">0</span>/<span id="slots-level-7-max">0</span>
                            </span>
                            <button class="level-btn" onclick="adjustSlots(7, 1)">+</button>
                        </div>
                    </div>
                    <div class="slots-visual" id="slots-visual-7">
                        <!-- Slot circles will be generated here -->
                    </div>
                    <div class="level-actions">
                        <button class="cast-btn" onclick="castSpell(7)" disabled>üéØ Lanzar</button>
                        <button class="restore-level-btn" onclick="restoreLevel(7)">üîÑ Restaurar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Spellbook/Known Spells Section -->
        <div class="spellbook-section">
            <div class="spellbook-header">
                <h3>üìö Grimorio / Conjuros Conocidos</h3>
                <div class="spellbook-controls">
                    <input type="text" id="spell-search" placeholder="üîç Buscar conjuro..." onkeyup="filterSpells()">
                    <select id="spell-level-filter" onchange="filterSpells()">
                        <option value="">Todos los niveles</option>
                        <option value="1">Nivel 1</option>
                        <option value="2">Nivel 2</option>
                        <option value="3">Nivel 3</option>
                        <option value="4">Nivel 4</option>
                        <option value="5">Nivel 5</option>
                        <option value="6">Nivel 6</option>
                        <option value="7">Nivel 7</option>
                    </select>
                    <button class="add-spell-btn" onclick="addCustomSpell()">‚ûï Agregar Conjuro</button>
                </div>
            </div>

            <div class="spells-categories">
                <!-- Arcane Spells -->
                <div class="spell-category" id="arcane-spells-category">
                    <div class="category-header" onclick="toggleSpellCategory('arcane-spells')">
                        <h4>üîÆ Conjuros Arcanos</h4>
                        <span class="category-toggle">‚ñº</span>
                    </div>
                    <div class="spells-grid" id="arcane-spells">
                        <!-- Arcane spells will be generated here -->
                    </div>
                </div>

                <!-- Divine Spells -->
                <div class="spell-category" id="divine-spells-category">
                    <div class="category-header" onclick="toggleSpellCategory('divine-spells')">
                        <h4>‚õ™ Conjuros Divinos</h4>
                        <span class="category-toggle">‚ñº</span>
                    </div>
                    <div class="spells-grid" id="divine-spells">
                        <!-- Divine spells will be generated here -->
                    </div>
                </div>

                <!-- Custom Spells -->
                <div class="spell-category" id="custom-spells-category">
                    <div class="category-header" onclick="toggleSpellCategory('custom-spells')">
                        <h4>üìú Conjuros Personalizados</h4>
                        <span class="category-toggle">‚ñº</span>
                    </div>
                    <div class="spells-grid" id="custom-spells">
                        <!-- Custom spells will be generated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Prepared Spells Section -->
        <div class="prepared-spells-section">
            <div class="prepared-header">
                <h3>üé≠ Conjuros Preparados</h3>
                <div class="prepared-controls">
                    <span class="prepared-count">
                        <span id="prepared-count">0</span> conjuros preparados
                    </span>
                    <button class="clear-prepared-btn" onclick="clearPreparedSpells()">üóëÔ∏è Limpiar</button>
                </div>
            </div>

            <div class="prepared-spells-grid" id="prepared-spells-grid">
                <div class="prepared-placeholder">
                    <p>üìù Arrastra conjuros aqu√≠ para prepararlos</p>
                    <p><small>o haz clic en "Preparar" en los conjuros conocidos</small></p>
                </div>
            </div>
        </div>

        <!-- Spell Casting Log -->
        <div class="spell-log-section">
            <div class="log-header">
                <h3>üìã Registro de Conjuros</h3>
                <button class="clear-log-btn" onclick="clearSpellLog()">üóëÔ∏è Limpiar Registro</button>
            </div>
            <div class="spell-log-content" id="spell-log-content">
                <!-- Spell casting log will appear here -->
            </div>
        </div>
    </div>
</div>

<!-- Custom Spell Modal -->
<div class="spell-modal" id="spell-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚ûï Agregar Conjuro Personalizado</h3>
            <button class="modal-close" onclick="closeSpellModal()">‚úñÔ∏è</button>
        </div>
        <div class="modal-body">
            <div class="form-row">
                <label>Nombre del Conjuro:</label>
                <input type="text" id="custom-spell-name" placeholder="Ej: Bola de Fuego">
            </div>
            <div class="form-row">
                <label>Nivel:</label>
                <select id="custom-spell-level">
                    <option value="1">1</option>
                    <option value="2">2</option>
                    <option value="3">3</option>
                    <option value="4">4</option>
                    <option value="5">5</option>
                    <option value="6">6</option>
                    <option value="7">7</option>
                </select>
            </div>
            <div class="form-row">
                <label>Tipo:</label>
                <select id="custom-spell-type">
                    <option value="arcane">Arcano</option>
                    <option value="divine">Divino</option>
                </select>
            </div>
            <div class="form-row">
                <label>Escuela:</label>
                <input type="text" id="custom-spell-school" placeholder="Ej: Evocaci√≥n">
            </div>
            <div class="form-row">
                <label>Rango:</label>
                <input type="text" id="custom-spell-range" placeholder="Ej: 150 metros">
            </div>
            <div class="form-row">
                <label>Duraci√≥n:</label>
                <input type="text" id="custom-spell-duration" placeholder="Ej: Instant√°neo">
            </div>
            <div class="form-row">
                <label>Componentes:</label>
                <input type="text" id="custom-spell-components" placeholder="Ej: V, S, M">
            </div>
            <div class="form-row full-width">
                <label>Descripci√≥n:</label>
                <textarea id="custom-spell-description" rows="4" placeholder="Descripci√≥n detallada del conjuro..."></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeSpellModal()">Cancelar</button>
            <button class="modal-btn save" onclick="saveCustomSpell()">Guardar Conjuro</button>
        </div>
    </div>
</div>

<!-- SPELLS TAB CSS -->
<style>
.spells-container {
    padding: 1rem;
    max-width: 1400px;
    margin: 0 auto;
}

/* Spells Header */
.spells-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #4a5568;
}

.spells-header h2 {
    color: #f7fafc;
    margin: 0;
}

.spells-summary {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.caster-info {
    background: linear-gradient(135deg, #9f7aea, #805ad5);
    padding: 0.8rem 1.2rem;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    text-align: center;
}

.caster-type {
    display: block;
    font-size: 1rem;
}

.caster-level {
    display: block;
    font-size: 0.8rem;
    opacity: 0.9;
}

.spells-actions {
    display: flex;
    gap: 1rem;
}

.auto-progression-btn, .reset-spells-btn, .rest-btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.auto-progression-btn {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

.reset-spells-btn {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
    color: white;
}

.rest-btn {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
}

.auto-progression-btn:hover, .reset-spells-btn:hover, .rest-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Spell Progression Table */
.spell-progression-section {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 1px solid #4a5568;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.progression-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.progression-header h3 {
    color: #f7fafc;
    margin: 0;
}

.progression-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #cbd5e0;
}

.progression-controls select {
    background: #2d3748;
    border: 1px solid #4a5568;
    color: #e2e8f0;
    padding: 0.3rem 0.6rem;
    border-radius: 4px;
}

.progression-table-container {
    overflow-x: auto;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 8px;
    padding: 1rem;
}

.progression-table {
    width: 100%;
    border-collapse: collapse;
    color: #e2e8f0;
}

.progression-table th {
    background: linear-gradient(135deg, #4a5568, #2d3748);
    padding: 0.8rem;
    text-align: center;
    border: 1px solid #718096;
    font-weight: bold;
}

.progression-table td {
    padding: 0.6rem;
    text-align: center;
    border: 1px solid #4a5568;
    background: rgba(45, 55, 72, 0.3);
}

.progression-table tr:hover td {
    background: rgba(66, 153, 225, 0.1);
}

.progression-table .current-level {
    background: rgba(72, 187, 120, 0.2) !important;
    font-weight: bold;
}

/* Spell Slots Section */
.spell-slots-section {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 1px solid #4a5568;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.slots-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.slots-header h3 {
    color: #f7fafc;
    margin: 0;
}

.slots-summary {
    display: flex;
    gap: 1rem;
    color: #cbd5e0;
    font-weight: bold;
}

.total-slots {
    color: #4299e1;
}

.used-slots {
    color: #e53e3e;
}

.available-slots {
    color: #48bb78;
}

.spell-levels-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1rem;
}

.spell-level-card {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 1px solid #4a5568;
    border-radius: 10px;
    padding: 1rem;
    transition: all 0.3s ease;
}

.spell-level-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    border-color: #9f7aea;
}

.level-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 1px solid #4a5568;
}

.level-header h4 {
    margin: 0;
    color: #e2e8f0;
}

.level-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.level-btn {
    background: #4a5568;
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.level-btn:hover {
    background: #718096;
    transform: scale(1.1);
}

.level-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

.current-slots {
    color: #e2e8f0;
    font-weight: bold;
    min-width: 50px;
    text-align: center;
}

.slots-visual {
    display: flex;
    flex-wrap: wrap;
    gap: 0.3rem;
    margin-bottom: 1rem;
    justify-content: center;
    min-height: 40px;
    align-items: center;
}

.slot-circle {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid #4a5568;
    transition: all 0.3s ease;
}

.slot-circle.available {
    background: linear-gradient(135deg, #48bb78, #38a169);
    border-color: #48bb78;
}

.slot-circle.used {
    background: linear-gradient(135deg, #e53e3e, #c53030);
    border-color: #e53e3e;
}

.slot-circle:hover {
    transform: scale(1.2);
}

.level-actions {
    display: flex;
    gap: 0.5rem;
    justify-content: space-between;
}

.cast-btn, .restore-level-btn {
    flex: 1;
    padding: 0.5rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.cast-btn {
    background: linear-gradient(135deg, #9f7aea, #805ad5);
    color: white;
}

.cast-btn:disabled {
    background: #4a5568;
    cursor: not-allowed;
}

.restore-level-btn {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
}

.cast-btn:hover:not(:disabled), .restore-level-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Spellbook Section */
.spellbook-section {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 1px solid #4a5568;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.spellbook-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    gap: 1rem;
}

.spellbook-header h3 {
    color: #f7fafc;
    margin: 0;
}

.spellbook-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
    flex-wrap: wrap;
}

.spellbook-controls input, .spellbook-controls select {
    padding: 0.5rem;
    background: #2d3748;
    border: 1px solid #4a5568;
    border-radius: 6px;
    color: #e2e8f0;
}

.add-spell-btn {
    background: linear-gradient(135deg, #48bb78, #38a169);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-weight: bold;
}

.spell-category {
    margin-bottom: 1.5rem;
}

.category-header {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    padding: 1rem;
    cursor: pointer;
    border-radius: 8px 8px 0 0;
    border: 1px solid #4a5568;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: all 0.3s ease;
}

.category-header:hover {
    background: linear-gradient(135deg, #4a5568, #2d3748);
}

.category-header h4 {
    margin: 0;
    color: #e2e8f0;
}

.category-toggle {
    color: #cbd5e0;
    font-size: 1.2rem;
    transition: transform 0.3s ease;
}

.category-header.collapsed .category-toggle {
    transform: rotate(-90deg);
}

.spells-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
    gap: 1rem;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border: 1px solid #4a5568;
    border-top: none;
    border-radius: 0 0 8px 8px;
}

.spells-grid.collapsed {
    display: none;
}

.spell-card {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 1px solid #4a5568;
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.spell-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    border-color: #9f7aea;

abilities: {
                str: 6, dex: 17, con: 12, int: 2, wis: 14, cha: 6
            },
            specialAbilities: ["Vuelo", "Vista Aguda", "Mensajero"],
            description: "Halc√≥n explorador. Ideal para reconocimiento a√©reo y mensajer√≠a."
        },
        {
            name: "Caballo de Guerra",
            type: "animal",
            size: "Grande",
            hd: "3",
            hp: 18,
            ac: 7,
            movement: 18,
            attacks: [
                { name: "Patadas", damage: "1d8+2", thac0: 18 }
            ],
            abilities: {
                str: 18, dex: 13, con: 16, int: 2, wis: 13, cha: 6
            },
            specialAbilities: ["Carga", "Resistencia"],
            description: "Noble caballo de guerra entrenado para el combate y largos viajes."
        }
    ],
    humanoids: [
        {
            name: "Escudero Humano",
            type: "humanoid",
            size: "Mediano",
            hd: "1",
            hp: 8,
            ac: 5,
            movement: 12,
            attacks: [
                { name: "Espada Larga", damage: "1d8+2", thac0: 18 },
                { name: "Arco Corto", damage: "1d6", thac0: 19 }
            ],
            abilities: {
                str: 15, dex: 14, con: 13, int: 12, wis: 11, cha: 13
            },
            specialAbilities: ["Primeros Auxilios", "Cuidado de Equipo"],
            description: "Joven escudero leal. Excelente ayudante en aventuras y combate."
        },
        {
            name: "Mercenario Enano",
            type: "humanoid",
            size: "Peque√±o",
            hd: "2",
            hp: 16,
            ac: 4,
            movement: 6,
            attacks: [
                { name: "Hacha de Batalla", damage: "1d8+3", thac0: 17 }
            ],
            abilities: {
                str: 17, dex: 12, con: 18, int: 11, wis: 13, cha: 9
            },
            specialAbilities: ["Resistencia a Magia", "Visi√≥n Infrarroja"],
            description: "Veterano mercenario enano. Resistente y confiable en combate."
        },
        {
            name: "Explorador √âlfico",
            type: "humanoid",
            size: "Mediano",
            hd: "1+1",
            hp: 9,
            ac: 6,
            movement: 12,
            attacks: [
                { name: "Arco Largo", damage: "1d6+1", thac0: 18 },
                { name: "Espada Corta", damage: "1d6", thac0: 19 }
            ],
            abilities: {
                str: 13, dex: 18, con: 12, int: 15, wis: 16, cha: 14
            },
            specialAbilities: ["Rastreo", "Sigilo", "Resistencia a Encantamientos"],
            description: "H√°bil explorador √©lfico. Excelente para reconocimiento y arquer√≠a."
        }
    ],
    magical: [
        {
            name: "Pseudodrag√≥n",
            type: "magical",
            size: "Diminuto",
            hd: "2",
            hp: 7,
            ac: 2,
            movement: 6,
            attacks: [
                { name: "Mordida", damage: "1d3", thac0: 19 },
                { name: "Aguij√≥n Venenoso", damage: "1", thac0: 17 }
            ],
            abilities: {
                str: 6, dex: 15, con: 13, int: 10, wis: 12, cha: 10
            },
            specialAbilities: ["Vuelo", "Invisibilidad", "Telepat√≠a Limitada"],
            description: "Peque√±o drag√≥n m√°gico. Compa√±ero inteligente con habilidades √∫nicas."
        },
        {
            name: "Familiar - Gato",
            type: "magical",
            size: "Diminuto",
            hd: "1/2",
            hp: 2,
            ac: 7,
            movement: 12,
            attacks: [
                { name: "Garras", damage: "1d2-1", thac0: 20 }
            ],
            abilities: {
                str: 3, dex: 16, con: 10, int: 12, wis: 12, cha: 7
            },
            specialAbilities: ["Sigilo Excepcional", "Visi√≥n Nocturna", "V√≠nculo M√°gico"],
            description: "Familiar m√°gico felino. Comparte HP y proporciona bonificaciones al conjurador."
        },
        {
            name: "Sprite",
            type: "magical",
            size: "Diminuto",
            hd: "1/2",
            hp: 2,
            ac: 6,
            movement: 6,
            attacks: [
                { name: "Espada Diminuta", damage: "1d2", thac0: 20 },
                { name: "Arco Diminuto", damage: "1", thac0: 20 }
            ],
            abilities: {
                str: 3, dex: 18, con: 10, int: 14, wis: 13, cha: 11
            },
            specialAbilities: ["Vuelo", "Invisibilidad", "Detecci√≥n de Mal"],
            description: "Peque√±a criatura fe√©rica. √ötil para exploraci√≥n y detecci√≥n m√°gica."
        }
    ]
};

// Current companions state
let activeCompanions = [];
let selectedCompanionTemplate = null;
let currentEditingCompanion = null;

// Initialize companions tab
function initializeCompanionsTab() {
    updateCompanionsDisplay();
    updateCompanionCounts();
    updateManagementStats();
}

// Show add companion modal
function showAddCompanionModal() {
    document.getElementById('modal-title').textContent = 'Seleccionar Tipo de Compa√±ero';
    
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <div class="companion-type-selection">
            <div class="selection-card" onclick="showAnimalSelection()">
                <h4>ü¶Ö Compa√±ero Animal</h4>
                <p>Lobos, osos, halcones y otros animales leales</p>
            </div>
            <div class="selection-card" onclick="showHumanoidSelection()">
                <h4>üë• Compa√±ero Humanoide</h4>
                <p>Escuderos, mercenarios y aliados humanoides</p>
            </div>
            <div class="selection-card" onclick="showMagicalSelection()">
                <h4>‚ú® Compa√±ero M√°gico</h4>
                <p>Familiares, pseudodragones y criaturas m√°gicas</p>
            </div>
            <div class="selection-card" onclick="showCustomCompanionModal()">
                <h4>üìú Compa√±ero Personalizado</h4>
                <p>Crea tu propio compa√±ero √∫nico</p>
            </div>
        </div>
    `;
    
    document.getElementById('companion-modal').style.display = 'flex';
    document.getElementById('save-companion-btn').style.display = 'none';
}

// Show animal selection
function showAnimalSelection() {
    document.getElementById('modal-title').textContent = 'Seleccionar Compa√±ero Animal';
    
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <div class="companion-selection-grid" id="animal-selection">
            ${companionTemplates.animals.map((animal, index) => `
                <div class="selection-card" onclick="selectCompanionTemplate('animals', ${index})">
                    <h4>üêæ ${animal.name}</h4>
                    <p><strong>Tama√±o:</strong> ${animal.size}</p>
                    <p><strong>HD:</strong> ${animal.hd} (${animal.hp} HP)</p>
                    <p><strong>CA:</strong> ${animal.ac}</p>
                    <p><strong>Movimiento:</strong> ${animal.movement}</p>
                    <p class="description">${animal.description}</p>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('save-companion-btn').style.display = 'inline-block';
    document.getElementById('save-companion-btn').textContent = 'Agregar Animal';
}

// Show humanoid selection
function showHumanoidSelection() {
    document.getElementById('modal-title').textContent = 'Seleccionar Compa√±ero Humanoide';
    
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <div class="companion-selection-grid" id="humanoid-selection">
            ${companionTemplates.humanoids.map((humanoid, index) => `
                <div class="selection-card" onclick="selectCompanionTemplate('humanoids', ${index})">
                    <h4>üë§ ${humanoid.name}</h4>
                    <p><strong>Tama√±o:</strong> ${humanoid.size}</p>
                    <p><strong>HD:</strong> ${humanoid.hd} (${humanoid.hp} HP)</p>
                    <p><strong>CA:</strong> ${humanoid.ac}</p>
                    <p><strong>Movimiento:</strong> ${humanoid.movement}</p>
                    <p class="description">${humanoid.description}</p>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('save-companion-btn').style.display = 'inline-block';
    document.getElementById('save-companion-btn').textContent = 'Agregar Humanoide';
}

// Show magical selection
function showMagicalSelection() {
    document.getElementById('modal-title').textContent = 'Seleccionar Compa√±ero M√°gico';
    
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <div class="companion-selection-grid" id="magical-selection">
            ${companionTemplates.magical.map((magical, index) => `
                <div class="selection-card" onclick="selectCompanionTemplate('magical', ${index})">
                    <h4>‚ú® ${magical.name}</h4>
                    <p><strong>Tama√±o:</strong> ${magical.size}</p>
                    <p><strong>HD:</strong> ${magical.hd} (${magical.hp} HP)</p>
                    <p><strong>CA:</strong> ${magical.ac}</p>
                    <p><strong>Movimiento:</strong> ${magical.movement}</p>
                    <p class="description">${magical.description}</p>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('save-companion-btn').style.display = 'inline-block';
    document.getElementById('save-companion-btn').textContent = 'Agregar Compa√±ero M√°gico';
}

// Show custom companion modal
function showCustomCompanionModal() {
    closeCompanionModal();
    
    document.getElementById('modal-title').textContent = 'Crear Compa√±ero Personalizado';
    
    const modalBody = document.getElementById('modal-body');
    modalBody.innerHTML = `
        <div class="companion-form">
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="custom-name" placeholder="Nombre del compa√±ero">
            </div>
            <div class="form-group">
                <label>Tipo:</label>
                <select id="custom-type">
                    <option value="animal">Animal</option>
                    <option value="humanoid">Humanoide</option>
                    <option value="magical">M√°gico</option>
                    <option value="custom">Personalizado</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tama√±o:</label>
                <select id="custom-size">
                    <option value="Diminuto">Diminuto</option>
                    <option value="Peque√±o">Peque√±o</option>
                    <option value="Mediano">Mediano</option>
                    <option value="Grande">Grande</option>
                    <option value="Enorme">Enorme</option>
                </select>
            </div>
            <div class="form-group">
                <label>Dados de Golpe:</label>
                <input type="text" id="custom-hd" placeholder="ej: 3+2">
            </div>
            <div class="form-group">
                <label>Puntos de Golpe:</label>
                <input type="number" id="custom-hp" min="1" max="200">
            </div>
            <div class="form-group">
                <label>Clase de Armadura:</label>
                <input type="number" id="custom-ac" min="1" max="10">
            </div>
            <div class="form-group">
                <label>Movimiento:</label>
                <input type="number" id="custom-movement" min="1" max="30">
            </div>
            <div class="form-group">
                <label>Nivel:</label>
                <input type="number" id="custom-level" value="1" min="1" max="20">
            </div>
            
            <h4 style="grid-column: 1 / -1; color: #e2e8f0; margin: 1rem 0 0.5rem 0;">Habilidades</h4>
            <div class="form-group">
                <label>Fuerza:</label>
                <input type="number" id="custom-str" value="10" min="3" max="25">
            </div>
            <div class="form-group">
                <label>Destreza:</label>
                <input type="number" id="custom-dex" value="10" min="3" max="25">
            </div>
            <div class="form-group">
                <label>Constituci√≥n:</label>
                <input type="number" id="custom-con" value="10" min="3" max="25">
            </div>
            <div class="form-group">
                <label>Inteligencia:</label>
                <input type="number" id="custom-int" value="10" min="3" max="25">
            </div>
            <div class="form-group">
                <label>Sabidur√≠a:</label>
                <input type="number" id="custom-wis" value="10" min="3" max="25">
            </div>
            <div class="form-group">
                <label>Carisma:</label>
                <input type="number" id="custom-cha" value="10" min="3" max="25">
            </div>
            
            <div class="form-group full-width">
                <label>Habilidades Especiales:</label>
                <input type="text" id="custom-abilities" placeholder="ej: Vuelo, Sigilo, Rastreo (separadas por comas)">
            </div>
            <div class="form-group full-width">
                <label>Descripci√≥n:</label>
                <textarea id="custom-description" placeholder="Descripci√≥n del compa√±ero..."></textarea>
            </div>
        </div>
    `;
    
    document.getElementById('companion-modal').style.display = 'flex';
    document.getElementById('save-companion-btn').style.display = 'inline-block';
    document.getElementById('save-companion-btn').textContent = 'Crear Compa√±ero';
    document.getElementById('save-companion-btn').onclick = saveCustomCompanion;
}

// Select companion template
function selectCompanionTemplate(category, index) {
    // Remove previous selection
    document.querySelectorAll('.selection-card.selected').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selection to clicked card
    event.target.closest('.selection-card').classList.add('selected');
    
    selectedCompanionTemplate = {
        category: category,
        index: index,
        data: companionTemplates[category][index]
    };
}

// Save companion
function saveCompanion() {
    if (!selectedCompanionTemplate) {
        showCompanionNotification('Selecciona un compa√±ero primero', 'error');
        return;
    }
    
    const template = selectedCompanionTemplate.data;
    const newCompanion = {
        id: Date.now(),
        name: template.name,
        originalName: template.name,
        type: template.type,
        size: template.size,
        level: 1,
        hd: template.hd,
        maxHp: template.hp,
        currentHp: template.hp,
        ac: template.ac,
        movement: template.movement,
        attacks: [...template.attacks],
        abilities: {...template.abilities},
        specialAbilities: [...template.specialAbilities],
        description: template.description,
        status: 'healthy',
        experience: 0,
        isActive: true,
        dateAdded: new Date().toLocaleDateString()
    };
    
    activeCompanions.push(newCompanion);
    updateCompanionsDisplay();
    updateCompanionCounts();
    updateManagementStats();
    closeCompanionModal();
    
    showCompanionNotification(`${template.name} a√±adido como compa√±ero`, 'success');
}

// Save custom companion
function saveCustomCompanion() {
    const name = document.getElementById('custom-name').value.trim();
    const type = document.getElementById('custom-type').value;
    const size = document.getElementById('custom-size').value;
    const hd = document.getElementById('custom-hd').value.trim();
    const hp = parseInt(document.getElementById('custom-hp').value) || 1;
    const ac = parseInt(document.getElementById('custom-ac').value) || 10;
    const movement = parseInt(document.getElementById('custom-movement').value) || 12;
    const level = parseInt(document.getElementById('custom-level').value) || 1;
    
    const abilities = {
        str: parseInt(document.getElementById('custom-str').value) || 10,
        dex: parseInt(document.getElementById('custom-dex').value) || 10,
        con: parseInt(document.getElementById('custom-con').value) || 10,
        int: parseInt(document.getElementById('custom-int').value) || 10,
        wis: parseInt(document.getElementById('custom-wis').value) || 10,
        cha: parseInt(document.getElementById('custom-cha').value) || 10
    };
    
    const specialAbilities = document.getElementById('custom-abilities').value
        .split(',').map(s => s.trim()).filter(s => s);
    const description = document.getElementById('custom-description').value.trim();
    
    if (!name) {
        showCompanionNotification('El nombre es requerido', 'error');
        return;
    }
    
    if (activeCompanions.some(c => c.name.toLowerCase() === name.toLowerCase())) {
        showCompanionNotification('Ya existe un compa√±ero con ese nombre', 'error');
        return;
    }
    
    const newCompanion = {
        id: Date.now(),
        name: name,
        originalName: name,
        type: type,
        size: size,
        level: level,
        hd: hd || '1',
        maxHp: hp,
        currentHp: hp,
        ac: ac,
        movement: movement,
        attacks: [
            { name: 'Ataque Natural', damage: '1d4', thac0: 20 }
        ],
        abilities: abilities,
        specialAbilities: specialAbilities,
        description: description || 'Compa√±ero personalizado',
        status: 'healthy',
        experience: 0,
        isActive: true,
        isCustom: true,
        dateAdded: new Date().toLocaleDateString()
    };
    
    activeCompanions.push(newCompanion);
    updateCompanionsDisplay();
    updateCompanionCounts();
    updateManagementStats();
    closeCompanionModal();
    
    showCompanionNotification(`${name} creado como compa√±ero personalizado`, 'success');
}

// Close companion modal
function closeCompanionModal() {
    document.getElementById('companion-modal').style.display = 'none';
    selectedCompanionTemplate = null;
    
    // Clear selection
    document.querySelectorAll('.selection-card.selected').forEach(card => {
        card.classList.remove('selected');
    });
}

// Update companions display
function updateCompanionsDisplay() {
    const categories = ['animal', 'humanoid', 'magical', 'custom'];
    
    categories.forEach(category => {
        const categoryCompanions = activeCompanions.filter(c => c.type === category);
        const container = document.getElementById(`${category}-companions`);
        
        if (categoryCompanions.length === 0) {
            container.innerHTML = `
                <div class="empty-companions">
                    <p>üåø No tienes compa√±eros ${getCategoryDisplayName(category)}</p>
                    <button class="add-${category}-btn" onclick="show${capitalize(category)}Selection()">
                        Agregar Compa√±ero ${capitalize(getCategoryDisplayName(category))}
                    </button>
                </div>
            `;
        } else {
            container.innerHTML = categoryCompanions.map(companion => createCompanionCard(companion)).join('');
        }
    });
}

// Create companion card HTML
function createCompanionCard(companion) {
    const healthPercentage = (companion.currentHp / companion.maxHp) * 100;
    const healthClass = healthPercentage > 75 ? '' : healthPercentage > 25 ? 'medium' : 'low';
    const statusClass = companion.currentHp <= 0 ? 'dead' : 
                       healthPercentage <= 25 ? 'critical' : 
                       healthPercentage <= 75 ? 'injured' : 'healthy';
    
    return `
        <div class="companion-card ${companion.type}" onclick="showCompanionDetails(${companion.id})">
            <div class="companion-status">
                <div class="status-indicator status-${statusClass}"></div>
            </div>
            
            <div class="companion-header">
                <div class="companion-info">
                    <h4>${companion.name}</h4>
                    <span class="companion-type">${capitalize(companion.type)} ‚Ä¢ ${companion.size}</span>
                </div>
                <div class="companion-level">Nivel ${companion.level}</div>
            </div>
            
            <div class="companion-stats">
                <div class="stat-item">
                    <span class="stat-value">${companion.ac}</span>
                    <span class="stat-label">CA</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${companion.hd}</span>
                    <span class="stat-label">HD</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${companion.movement}</span>
                    <span class="stat-label">Mov</span>
                </div>
            </div>
            
            <div class="companion-health">
                <div class="health-bar">
                    <div class="health-fill ${healthClass}" style="width: ${healthPercentage}%"></div>
                </div>
                <span class="health-text">${companion.currentHp}/${companion.maxHp}</span>
            </div>
            
            <div class="companion-actions" onclick="event.stopPropagation()">
                <button class="companion-action-btn action-attack" onclick="companionAttack(${companion.id})" ${companion.currentHp <= 0 ? 'disabled' : ''}>
                    ‚öîÔ∏è Ataque
                </button>
                <button class="companion-action-btn action-heal" onclick="healCompanion(${companion.id})" ${companion.currentHp >= companion.maxHp ? 'disabled' : ''}>
                    üíö Curar
                </button>
                <button class="companion-action-btn action-skill" onclick="companionSkill(${companion.id})" ${companion.currentHp <= 0 ? 'disabled' : ''}>
                    üéØ Habilidad
                </button>
                <button class="companion-action-btn action-rest" onclick="companionRest(${companion.id})">
                    üõå Descanso
                </button>
            </div>
        </div>
    `;
}

// Show companion details
function showCompanionDetails(companionId) {
    const companion = activeCompanions.find(c => c.id === companionId);
    if (!companion) return;
    
    currentEditingCompanion = companion;
    
    document.getElementById('detail-companion-name').textContent = companion.name;
    
    const detailBody = document.getElementById('detail-modal-body');
    detailBody.innerHTML = `
        <div class="companion-detail-content">
            <div class="detail-grid">
                <div class="detail-section">
                    <h4>üìä Estad√≠sticas B√°sicas</h4>
                    <div class="detail-stats">
                        <div class="detail-stat">
                            <label>Nivel:</label>
                            <span>${companion.level}</span>
                        </div>
                        <div class="detail-stat">
                            <label>Tipo:</label>
                            <span>${capitalize(companion.type)}</span>
                        </div>
                        <div class="detail-stat">
                            <label>Tama√±o:</label>
                            <span>${companion.size}</span>
                        </div>
                        <div class="detail-stat">
                            <label>Dados de Golpe:</label>
                            <span>${companion.hd}</span>
                        </div>
                        <div class="detail-stat">
                            <label>Puntos de Golpe:</label>
                            <span>${companion.currentHp}/${companion.maxHp}</span>
                        </div>
                        <div class="detail-stat">
                            <label>Clase de Armadura:</label>
                            <span>${companion.ac}</span>
                        </div>
                        <div class="detail-stat">
                            <label>Movimiento:</label>
                            <span>${companion.movement}</span>
                        </div>
                        <div class="detail-stat">
                            <label>Estado:</label>
                            <span>${getStatusText(companion)}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section">
                    <h4>üí™ Habilidades</h4>
                    <div class="ability-scores">
                        <div class="ability-score">
                            <label>FUE:</label>
                            <span>${companion.abilities.str}</span>
                        </div>
                        <div class="ability-score">
                            <label>DES:</label>
                            <span>${companion.abilities.dex}</span>
                        </div>
                        <div class="ability-score">
                            <label>CON:</label>
                            <span>${companion.abilities.con}</span>
                        </div>
                        <div class="ability-score">
                            <label>INT:</label>
                            <span>${companion.abilities.int}</span>
                        </div>
                        <div class="ability-score">
                            <label>SAB:</label>
                            <span>${companion.abilities.wis}</span>
                        </div>
                        <div class="ability-score">
                            <label>CAR:</label>
                            <span>${companion.abilities.cha}</span>
                        </div>
                    </div>
                </div>
                
                <div class="detail-section full-width">
                    <h4>‚öîÔ∏è Ataques</h4>
                    <div class="attacks-list">
                        ${companion.attacks.map(attack => `
                            <div class="attack-item">
                                <span class="attack-name">${attack.name}</span>
                                <span class="attack-damage">Da√±o: ${attack.damage}</span>
                                <span class="attack-thac0">GACO: ${attack.thac0}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="detail-section full-width">
                    <h4>‚ú® Habilidades Especiales</h4>
                    <div class="special-abilities">
                        ${companion.specialAbilities.map(ability => `
                            <span class="ability-tag">${ability}</span>
                        `).join('')}
                    </div>
                </div>
                
                <div class="detail-section full-width">
                    <h4>üìù Descripci√≥n</h4>
                    <p class="companion-description">${companion.description}</p>
                </div>
                
                <div class="detail-section full-width">
                    <h4>üìà Informaci√≥n Adicional</h4>
                    <div class="additional-info">
                        <div class="info-item">
                            <label>Experiencia:</label>
                            <span>${companion.experience || 0} XP</span>
                        </div>
                        <div class="info-item">
                            <label>Fecha A√±adido:</label>
                            <span>${companion.dateAdded}</span>
                        </div>
                        <div class="info-item">
                            <label>Activo:</label>
                            <span>${companion.isActive ? 'S√≠' : 'No'}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('companion-detail-modal').style.display = 'flex';
}

// Helper functions
function getCategoryDisplayName(category) {
    const names = {
        'animal': 'animales',
        'humanoid': 'humanoides', 
        'magical': 'm√°gicos',
        'custom': 'personalizados'
    };
    return names[category] || category;
}

function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

function getStatusText(companion) {
    const healthPercentage = (companion.currentHp / companion.maxHp) * 100;
    if (companion.currentHp <= 0) return 'üíÄ Muerto';
    if (healthPercentage <= 25) return 'ü©∏ Cr√≠tico';
    if (healthPercentage <= 75) return 'ü§ï Herido';
    return 'üíö Saludable';
}

// Companion actions
function companionAttack(companionId) {
    const companion = activeCompanions.find(c => c.id === companionId);
    if (!companion || companion.currentHp <= 0) return;
    
    const attack = companion.attacks[0]; // Use first attack
    const roll = Math.floor(Math.random() * 20) + 1;
    const damage = rollDamage(attack.damage);
    
    const message = `${companion.name} ataca con ${attack.name}: ${roll} vs GACO ${attack.thac0} - ${roll <= attack.thac0 ? 'IMPACTA' : 'FALLA'}`;
    const damageMessage = roll <= attack.thac0 ? ` causando ${damage} puntos de da√±o` : '';
    
    showCompanionNotification(message + damageMessage, roll <= attack.thac0 ? 'success' : 'info');
    logCompanionAction(`${companion.name}: ${message}${damageMessage}`);
}

function healCompanion(companionId) {
    const companion = activeCompanions.find(c => c.id === companionId);
    if (!companion || companion.currentHp >= companion.maxHp) return;
    
    const healAmount = Math.floor(companion.maxHp * 0.25) + Math.floor(Math.random() * 8) + 1; // 25% + 1d8
    const actualHeal = Math.min(healAmount, companion.maxHp - companion.currentHp);
    
    companion.currentHp += actualHeal;
    updateCompanionsDisplay();
    updateManagementStats();
    
    showCompanionNotification(`${companion.name} recupera ${actualHeal} puntos de golpe`, 'success');
    logCompanionAction(`${companion.name} curado: +${actualHeal} HP (${companion.currentHp}/${companion.maxHp})`);
}

function companionSkill(companionId) {
    const companion = activeCompanions.find(c => c.id === companionId);
    if (!companion || companion.currentHp <= 0 || companion.specialAbilities.length === 0) return;
    
    const randomSkill = companion.specialAbilities[Math.floor(Math.random() * companion.specialAbilities.length)];
    const roll = Math.floor(Math.random() * 20) + 1;
    const success = roll >= 10; // Simple skill check
    
    showCompanionNotification(`${companion.name} usa ${randomSkill}: ${roll} - ${success ? '√âXITO' : 'FALLO'}`, success ? 'success' : 'info');
    logCompanionAction(`${companion.name} usa ${randomSkill}: ${roll} (${success ? '√âxito' : 'Fallo'})`);
}

function companionRest(companionId) {
    const companion = activeCompanions.find(c => c.id === companionId);
    if (!companion) return;
    
    const healAmount = Math.floor(companion.maxHp * 0.5); // 50% heal on rest
    const actualHeal = Math.min(healAmount, companion.maxHp - companion.currentHp);
    
    companion.currentHp += actualHeal;
    updateCompanionsDisplay();
    updateManagementStats();
    
    showCompanionNotification(`${companion.name} descansa y recupera ${actualHeal} HP`, 'success');
    logCompanionAction(`${companion.name} descansa: +${actualHeal} HP (${companion.currentHp}/${companion.maxHp})`);
}

// Management functions
function toggleCompanionManagement() {
    const panel = document.getElementById('companion-management');
    const isVisible = panel.style.display !== 'none';
    panel.style.display = isVisible ? 'none' : 'block';
}

function restAllCompanions() {
    let healed = 0;
    activeCompanions.forEach(companion => {
        if (companion.currentHp < companion.maxHp) {
            const healAmount = Math.floor(companion.maxHp * 0.5);
            const actualHeal = Math.min(healAmount, companion.maxHp - companion.currentHp);
            companion.currentHp += actualHeal;
            healed++;
        }
    });
    
    updateCompanionsDisplay();
    updateManagementStats();
    showCompanionNotification(`${healed} compa√±eros han descansado`, 'success');
    logCompanionAction(`Descanso grupal aplicado a ${healed} compa√±eros`);
}

function healAllCompanions() {
    let healed = 0;
    activeCompanions.forEach(companion => {
        if (companion.currentHp < companion.maxHp) {
            companion.currentHp = companion.maxHp;
            healed++;
        }
    });
    
    updateCompanionsDisplay();
    updateManagementStats();
    showCompanionNotification(`${healed} compa√±eros completamente curados`, 'success');
    logCompanionAction(`Curaci√≥n completa aplicada a ${healed} compa√±eros`);
}

function levelUpCompanions() {
    let leveled = 0;
    activeCompanions.forEach(companion => {
        if (companion.level < 10) { // Max level 10 for companions
            companion.level++;
            // Increase HP
            const hpIncrease = Math.floor(Math.random() * 8) + 1; // 1d8
            companion.maxHp += hpIncrease;
            companion.currentHp += hpIncrease;
            leveled++;
        }
    });
    
    updateCompanionsDisplay();
    updateManagementStats();
    showCompanionNotification(`${leveled} compa√±eros han subido de nivel`, 'success');
    logCompanionAction(`Subida de nivel aplicada a ${leveled} compa√±eros`);
}

function exportCompanions() {
    const exportData = {
        companions: activeCompanions,
        exportDate: new Date().toISOString(),
        version: '1.0'
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `companions_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showCompanionNotification('Compa√±eros exportados exitosamente', 'success');
}

// Detail modal functions
function editCompanion() {
    if (!currentEditingCompanion) return;
    
    closeCompanionDetailModal();
    
    // Pre-fill the custom companion form with current data
    showCustomCompanionModal();
    
    setTimeout(() => {
        document.getElementById('custom-name').value = currentEditingCompanion.name;
        document.getElementById('custom-type').value = currentEditingCompanion.type;
        document.getElementById('custom-size').value = currentEditingCompanion.size;
        document.getElementById('custom-hd').value = currentEditingCompanion.hd;
        document.getElementById('custom-hp').value = currentEditingCompanion.maxHp;
        document.getElementById('custom-ac').value = currentEditingCompanion.ac;
        document.getElementById('custom-movement').value = currentEditingCompanion.movement;
        document.getElementById('custom-level').value = currentEditingCompanion.level;
        document.getElementById('custom-str').value = currentEditingCompanion.abilities.str;
        document.getElementById('custom-dex').value = currentEditingCompanion.abilities.dex;
        document.getElementById('custom-con').value = currentEditingCompanion.abilities.con;
        document.getElementById('custom-int').value = currentEditingCompanion.abilities.int;
        document.getElementById('custom-wis').value = currentEditingCompanion.abilities.wis;
        document.getElementById('custom-cha').value = currentEditingCompanion.abilities.cha;
        document.getElementById('custom-abilities').value = currentEditingCompanion.specialAbilities.join(', ');
        document.getElementById('custom-description').value = currentEditingCompanion.description;
        
        document.getElementById('modal-title').textContent = 'Editar Compa√±ero';
        document.getElementById('save-companion-btn').textContent = 'Guardar Cambios';
        document.getElementById('save-companion-btn').onclick = saveEditedCompanion;
    }, 100);
}

function saveEditedCompanion() {
    const name = document.getElementById('custom-name').value.trim();
    const type = document.getElementById('custom-type').value;
    const size = document.getElementById('custom-size').value;
    const hd = document.getElementById('custom-hd').value.trim();
    const maxHp = parseInt(document.getElementById('custom-hp').value) || 1;
    const ac = parseInt(document.getElementById('custom-ac').value) || 10;
    const movement = parseInt(document.getElementById('custom-movement').value) || 12;
    const level = parseInt(document.getElementById('custom-level').value) || 1;
    
    const abilities = {
        str: parseInt(document.getElementById('custom-str').value) || 10,
        dex: parseInt(document.getElementById('custom-dex').value) || 10,
        con: parseInt(document.getElementById('custom-con').value) || 10,
        int: parseInt(document.getElementById('custom-int').value) || 10,
        wis: parseInt(document.getElementById('custom-wis').value) || 10,
        cha: parseInt(document.getElementById('custom-cha').value) || 10
    };
    
    const specialAbilities = document.getElementById('custom-abilities').value
        .split(',').map(s => s.trim()).filter(s => s);
    const description = document.getElementById('custom-description').value.trim();
    
    if (!name) {
        showCompanionNotification('El nombre es requerido', 'error');
        return;
    }
    
    // Check for duplicate names (excluding current companion)
    if (activeCompanions.some(c => c.id !== currentEditingCompanion.id && c.name.toLowerCase() === name.toLowerCase())) {
        showCompanionNotification('Ya existe un compa√±ero con ese nombre', 'error');
        return;
    }
    
    // Update companion
    const companion = currentEditingCompanion;
    const hpDifference = maxHp - companion.maxHp;
    
    companion.name = name;
    companion.type = type;
    companion.size = size;
    companion.level = level;
    companion.hd = hd || '1';
    companion.maxHp = maxHp;
    companion.currentHp = Math.min(companion.currentHp + hpDifference, maxHp); // Adjust current HP proportionally
    companion.ac = ac;
    companion.movement = movement;
    companion.abilities = abilities;
    companion.specialAbilities = specialAbilities;
    companion.description = description || 'Compa√±ero personalizado';
    companion.isCustom = true;
    
    updateCompanionsDisplay();
    updateCompanionCounts();
    updateManagementStats();
    closeCompanionModal();
    
    showCompanionNotification(`${name} actualizado exitosamente`, 'success');
    logCompanionAction(`${name} editado y actualizado`);
}

function duplicateCompanion() {
    if (!currentEditingCompanion) return;
    
    const original = currentEditingCompanion;
    const duplicate = {
        ...original,
        id: Date.now(),
        name: `${original.name} (Copia)`,
        currentHp: original.maxHp, // Full health for duplicate
        experience: 0,
        dateAdded: new Date().toLocaleDateString()
    };
    
    activeCompanions.push(duplicate);
    updateCompanionsDisplay();
    updateCompanionCounts();
    updateManagementStats();
    closeCompanionDetailModal();
    
    showCompanionNotification(`${duplicate.name} creado como copia`, 'success');
    logCompanionAction(`${original.name} duplicado como ${duplicate.name}`);
}

function removeCompanion() {
    if (!currentEditingCompanion) return;
    
    if (confirm(`¬øEst√°s seguro de que quieres eliminar a ${currentEditingCompanion.name}?`)) {
        const companionName = currentEditingCompanion.name;
        const index = activeCompanions.findIndex(c => c.id === currentEditingCompanion.id);
        
        if (index !== -1) {
            activeCompanions.splice(index, 1);
            updateCompanionsDisplay();
            updateCompanionCounts();
            updateManagementStats();
            closeCompanionDetailModal();
            
            showCompanionNotification(`${companionName} ha sido eliminado`, 'info');
            logCompanionAction(`${companionName} eliminado del grupo`);
        }
    }
}

function closeCompanionDetailModal() {
    document.getElementById('companion-detail-modal').style.display = 'none';
    currentEditingCompanion = null;
}

// Update functions
function updateCompanionCounts() {
    const counts = {
        animal: activeCompanions.filter(c => c.type === 'animal').length,
        humanoid: activeCompanions.filter(c => c.type === 'humanoid').length,
        magical: activeCompanions.filter(c => c.type === 'magical').length,
        custom: activeCompanions.filter(c => c.type === 'custom').length
    };
    
    document.getElementById('active-companions').textContent = activeCompanions.length;
    document.getElementById('animal-count').textContent = counts.animal;
    document.getElementById('humanoid-count').textContent = counts.humanoid;
    document.getElementById('magical-count').textContent = counts.magical;
    document.getElementById('custom-count').textContent = counts.custom;
}

function updateManagementStats() {
    const totalHp = activeCompanions.reduce((sum, c) => sum + c.currentHp, 0);
    const averageLevel = activeCompanions.length > 0 ? 
        (activeCompanions.reduce((sum, c) => sum + c.level, 0) / activeCompanions.length).toFixed(1) : 0;
    const totalAttacks = activeCompanions.reduce((sum, c) => sum + c.attacks.length, 0);
    
    document.getElementById('total-companion-hp').textContent = totalHp;
    document.getElementById('average-companion-level').textContent = averageLevel;
    document.getElementById('total-companion-attacks').textContent = totalAttacks;
}

// Toggle category visibility
function toggleCompanionCategory(categoryId) {
    const category = document.getElementById(categoryId);
    const header = category.previousElementSibling;
    const toggle = header.querySelector('.category-toggle');
    
    if (category.classList.contains('collapsed')) {
        category.classList.remove('collapsed');
        category.style.display = 'grid';
        toggle.textContent = '‚ñº';
        header.classList.remove('collapsed');
    } else {
        category.classList.add('collapsed');
        category.style.display = 'none';
        toggle.textContent = '‚ñ∂';
        header.classList.add('collapsed');
    }
}

// Utility functions
function rollDamage(damageStr) {
    // Simple damage roller for dice notation like "1d8+2" or "2d4"
    const match = damageStr.match(/(\d+)d(\d+)(\+\d+)?/);
    if (!match) return 1;
    
    const numDice = parseInt(match[1]);
    const diceSize = parseInt(match[2]);
    const bonus = parseInt(match[3]) || 0;
    
    let total = 0;
    for (let i = 0; i < numDice; i++) {
        total += Math.floor(Math.random() * diceSize) + 1;
    }
    
    return total + bonus;
}

function showCompanionNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `companion-notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 1001;
        max-width: 350px;
        animation: slideInCompanion 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    `;
    
    // Set background color based on type
    const colors = {
        'success': 'linear-gradient(135deg, #48bb78, #38a169)',
        'error': 'linear-gradient(135deg, #f56565, #e53e3e)',
        'info': 'linear-gradient(135deg, #4299e1, #3182ce)',
        'warning': 'linear-gradient(135deg, #ed8936, #dd6b20)'
    };
    
    notification.style.background = colors[type] || colors.info;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutCompanion 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 4000);
}

function logCompanionAction(message) {
    // Simple logging - could be expanded to show in UI
    console.log(`[Compa√±eros] ${new Date().toLocaleTimeString()}: ${message}`);
}

// Add CSS for companion notifications
const companionNotificationStyle = document.createElement('style');
companionNotificationStyle.textContent = `
    @keyframes slideInCompanion {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutCompanion {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    .detail-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1.5rem;
    }
    
    .detail-section {
        background: rgba(0, 0, 0, 0.2);
        padding: 1rem;
        border-radius: 8px;
        border-left: 4px solid #805ad5;
    }
    
    .detail-section.full-width {
        grid-column: 1 / -1;
    }
    
    .detail-section h4 {
        color: #e2e8f0;
        margin: 0 0 1rem 0;
        font-size: 1rem;
    }
    
    .detail-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }
    
    .detail-stat {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.3rem 0;
        border-bottom: 1px solid rgba(74, 85, 104, 0.3);
    }
    
    .detail-stat label {
        color: #cbd5e0;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .detail-stat span {
        color: #e2e8f0;
        font-weight: bold;
    }
    
    .ability-scores {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
    }
    
    .ability-score {
        background: rgba(45, 55, 72, 0.5);
        padding: 0.5rem;
        border-radius: 6px;
        text-align: center;
    }
    
    .ability-score label {
        display: block;
        color: #cbd5e0;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .ability-score span {
        display: block;
        color: #4299e1;
        font-size: 1.1rem;
        font-weight: bold;
        margin-top: 0.2rem;
    }
    
    .attacks-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .attack-item {
        background: rgba(45, 55, 72, 0.5);
        padding: 0.8rem;
        border-radius: 6px;
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 1rem;
        align-items: center;
    }
    
    .attack-name {
        color: #e2e8f0;
        font-weight: bold;
    }
    
    .attack-damage {
        color: #f56565;
        font-weight: bold;
        text-align: center;
    }
    
    .attack-thac0 {
        color: #4299e1;
        font-weight: bold;
        text-align: center;
    }
    
    .special-abilities {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }
    
    .ability-tag {
        background: linear-gradient(135deg, #805ad5, #6b46c1);
        color: white;
        padding: 0.3rem 0.8rem;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: bold;
    }
    
    .companion-description {
        color: #a0aec0;
        line-height: 1.6;
        margin: 0;
    }
    
    .additional-info {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
    }
    
    .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background: rgba(45, 55, 72, 0.3);
        border-radius: 6px;
    }
    
    .info-item label {
        color: #cbd5e0;
        font-weight: bold;
        font-size: 0.9rem;
    }
    
    .info-item span {
        color: #e2e8f0;
        font-weight: bold;
    }
    
    .companion-type-selection {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
    }
    
    @media (max-width: 768px) {
        .detail-grid {
            grid-template-columns: 1fr;
        }
        
        .detail-stats {
            grid-template-columns: 1fr;
        }
        
        .ability-scores {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .attack-item {
            grid-template-columns: 1fr;
            text-align: center;
        }
        
        .additional-info {
            grid-template-columns: 1fr;
        }
        
        .companion-type-selection {
            grid-template-columns: 1fr;
        }
    }
`;
document.head.appendChild(companionNotificationStyle);

// Initialize companions tab when the page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeCompanionsTab);
} else {
    initializeCompanionsTab();
}

// Update companions when switching to companions tab
document.addEventListener('tabChanged', function(e) {
    if (e.detail === 'companions') {
        setTimeout(() => {
            initializeCompanionsTab();
        }, 100);
    }
});

// Export companions data for other systems
function exportCompanionsData() {
    return {
        activeCompanions: activeCompanions,
        companionTemplates: companionTemplates
    };
}

// Import companions data
function importCompanionsData(data) {
    if (data.activeCompanions) {
        activeCompanions = data.activeCompanions;
        updateCompanionsDisplay();
        updateCompanionCounts();
        updateManagementStats();
    }
    
    if (data.companionTemplates) {
        // Merge with existing templates
        Object.keys(data.companionTemplates).forEach(category => {
            if (companionTemplates[category]) {
                companionTemplates[category] = [...companionTemplates[category], ...data.companionTemplates[category]];
            }
        });
    }
}
</script><!-- COMPANIONS TAB -->
<div id="companions-tab" class="tab-content">
    <div class="companions-container">
        <!-- Companions Header -->
        <div class="companions-header">
            <h2>üêæ Compa√±eros</h2>
            <div class="companions-summary">
                <div class="companions-count">
                    <span class="active-companions" id="active-companions">0</span>
                    Compa√±eros Activos
                </div>
                <div class="companions-actions">
                    <button class="add-companion-btn" onclick="showAddCompanionModal()">‚ûï Agregar Compa√±ero</button>
                    <button class="manage-companions-btn" onclick="toggleCompanionManagement()">‚öôÔ∏è Gestionar</button>
                </div>
            </div>
        </div>

        <!-- Companion Categories -->
        <div class="companion-categories">
            <!-- Animal Companions -->
            <div class="companion-category" id="animal-companions-category">
                <div class="category-header" onclick="toggleCompanionCategory('animal-companions')">
                    <h3>ü¶Ö Compa√±eros Animales</h3>
                    <div class="category-info">
                        <span class="companion-type-count" id="animal-count">0</span> activos
                        <span class="category-toggle">‚ñº</span>
                    </div>
                </div>
                <div class="companions-grid" id="animal-companions">
                    <div class="empty-companions">
                        <p>üåø No tienes compa√±eros animales</p>
                        <button class="add-animal-btn" onclick="showAnimalSelection()">Agregar Compa√±ero Animal</button>
                    </div>
                </div>
            </div>

            <!-- Humanoid Companions -->
            <div class="companion-category" id="humanoid-companions-category">
                <div class="category-header" onclick="toggleCompanionCategory('humanoid-companions')">
                    <h3>üë• Compa√±eros Humanoides</h3>
                    <div class="category-info">
                        <span class="companion-type-count" id="humanoid-count">0</span> activos
                        <span class="category-toggle">‚ñº</span>
                    </div>
                </div>
                <div class="companions-grid" id="humanoid-companions">
                    <div class="empty-companions">
                        <p>üè∞ No tienes compa√±eros humanoides</p>
                        <button class="add-humanoid-btn" onclick="showHumanoidSelection()">Agregar Compa√±ero Humanoide</button>
                    </div>
                </div>
            </div>

            <!-- Magical Companions -->
            <div class="companion-category" id="magical-companions-category">
                <div class="category-header" onclick="toggleCompanionCategory('magical-companions')">
                    <h3>‚ú® Compa√±eros M√°gicos</h3>
                    <div class="category-info">
                        <span class="companion-type-count" id="magical-count">0</span> activos
                        <span class="category-toggle">‚ñº</span>
                    </div>
                </div>
                <div class="companions-grid" id="magical-companions">
                    <div class="empty-companions">
                        <p>üîÆ No tienes compa√±eros m√°gicos</p>
                        <button class="add-magical-btn" onclick="showMagicalSelection()">Agregar Compa√±ero M√°gico</button>
                    </div>
                </div>
            </div>

            <!-- Custom Companions -->
            <div class="companion-category" id="custom-companions-category">
                <div class="category-header" onclick="toggleCompanionCategory('custom-companions')">
                    <h3>üìú Compa√±eros Personalizados</h3>
                    <div class="category-info">
                        <span class="companion-type-count" id="custom-count">0</span> activos
                        <span class="category-toggle">‚ñº</span>
                    </div>
                </div>
                <div class="companions-grid" id="custom-companions">
                    <div class="empty-companions">
                        <p>üé≠ No tienes compa√±eros personalizados</p>
                        <button class="add-custom-btn" onclick="showCustomCompanionModal()">Crear Compa√±ero Personalizado</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Companion Management Panel -->
        <div class="companion-management" id="companion-management" style="display: none;">
            <div class="management-header">
                <h3>‚öôÔ∏è Panel de Gesti√≥n de Compa√±eros</h3>
                <button class="close-management-btn" onclick="toggleCompanionManagement()">‚úñÔ∏è</button>
            </div>
            <div class="management-content">
                <div class="management-actions">
                    <button class="action-btn rest-companions" onclick="restAllCompanions()">üõå Descanso Completo</button>
                    <button class="action-btn heal-companions" onclick="healAllCompanions()">üíö Curar Todos</button>
                    <button class="action-btn level-up-companions" onclick="levelUpCompanions()">üìà Subir Nivel</button>
                    <button class="action-btn export-companions" onclick="exportCompanions()">üì§ Exportar</button>
                </div>
                <div class="management-stats">
                    <div class="stat-card">
                        <span class="stat-value" id="total-companion-hp">0</span>
                        <span class="stat-label">HP Total</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="average-companion-level">0</span>
                        <span class="stat-label">Nivel Promedio</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="total-companion-attacks">0</span>
                        <span class="stat-label">Ataques Totales</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Companion Modal -->
<div class="companion-modal" id="companion-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-title">‚ûï Agregar Compa√±ero</h3>
            <button class="modal-close" onclick="closeCompanionModal()">‚úñÔ∏è</button>
        </div>
        <div class="modal-body" id="modal-body">
            <!-- Dynamic content will be loaded here -->
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeCompanionModal()">Cancelar</button>
            <button class="modal-btn save" id="save-companion-btn" onclick="saveCompanion()">Agregar Compa√±ero</button>
        </div>
    </div>
</div>

<!-- Companion Detail Modal -->
<div class="companion-detail-modal" id="companion-detail-modal" style="display: none;">
    <div class="detail-modal-content">
        <div class="detail-modal-header">
            <h3 id="detail-companion-name">Compa√±ero</h3>
            <div class="detail-modal-actions">
                <button class="modal-action-btn" onclick="editCompanion()" title="Editar">‚úèÔ∏è</button>
                <button class="modal-action-btn" onclick="duplicateCompanion()" title="Duplicar">üìã</button>
                <button class="modal-action-btn danger" onclick="removeCompanion()" title="Eliminar">üóëÔ∏è</button>
                <button class="modal-close" onclick="closeCompanionDetailModal()">‚úñÔ∏è</button>
            </div>
        </div>
        <div class="detail-modal-body" id="detail-modal-body">
            <!-- Companion details will be loaded here -->
        </div>
    </div>
</div>

<!-- COMPANIONS TAB CSS -->
<style>
.companions-container {
    padding: 1rem;
    max-width: 1400px;
    margin: 0 auto;
}

/* Companions Header */
.companions-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #4a5568;
}

.companions-header h2 {
    color: #f7fafc;
    margin: 0;
}

.companions-summary {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.companions-count {
    background: linear-gradient(135deg, #f56565, #e53e3e);
    padding: 0.8rem 1.2rem;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    text-align: center;
}

.active-companions {
    display: block;
    font-size: 1.2rem;
    margin-bottom: 0.2rem;
}

.companions-actions {
    display: flex;
    gap: 1rem;
}

.add-companion-btn, .manage-companions-btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.add-companion-btn {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

.manage-companions-btn {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
}

.add-companion-btn:hover, .manage-companions-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Companion Categories */
.companion-categories {
    margin-bottom: 2rem;
}

.companion-category {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 1px solid #4a5568;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    overflow: hidden;
}

.category-header {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    padding: 1rem 1.5rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #4a5568;
    transition: all 0.3s ease;
}

.category-header:hover {
    background: linear-gradient(135deg, #4a5568, #2d3748);
}

.category-header h3 {
    color: #e2e8f0;
    margin: 0;
    font-size: 1.2rem;
}

.category-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    color: #cbd5e0;
}

.companion-type-count {
    background: rgba(66, 153, 225, 0.2);
    padding: 0.3rem 0.8rem;
    border-radius: 12px;
    font-weight: bold;
}

.category-toggle {
    font-size: 1.2rem;
    transition: transform 0.3s ease;
}

.category-header.collapsed .category-toggle {
    transform: rotate(-90deg);
}

.companions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1rem;
    padding: 1.5rem;
    min-height: 120px;
}

.companions-grid.collapsed {
    display: none;
}

.empty-companions {
    grid-column: 1 / -1;
    text-align: center;
    color: #718096;
    padding: 2rem;
    border: 2px dashed #4a5568;
    border-radius: 12px;
    background: rgba(0, 0, 0, 0.2);
}

.empty-companions p {
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
}

.add-animal-btn, .add-humanoid-btn, .add-magical-btn, .add-custom-btn {
    background: linear-gradient(135deg, #805ad5, #6b46c1);
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.add-animal-btn:hover, .add-humanoid-btn:hover, .add-magical-btn:hover, .add-custom-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
}

/* Companion Cards */
.companion-card {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 1px solid #4a5568;
    border-radius: 12px;
    padding: 1rem;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.companion-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
    border-color: #805ad5;
}

.companion-card.animal {
    border-left: 4px solid #48bb78;
}

.companion-card.humanoid {
    border-left: 4px solid #4299e1;
}

.companion-card.magical {
    border-left: 4px solid #ed64a6;
}

.companion-card.custom {
    border-left: 4px solid #ed8936;
}

.companion-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.companion-info h4 {
    color: #e2e8f0;
    margin: 0 0 0.3rem 0;
    font-size: 1.1rem;
}

.companion-type {
    color: #cbd5e0;
    font-size: 0.9rem;
    font-style: italic;
}

.companion-level {
    background: linear-gradient(135deg, #805ad5, #6b46c1);
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
}

.companion-stats {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.stat-item {
    text-align: center;
    background: rgba(0, 0, 0, 0.3);
    padding: 0.5rem;
    border-radius: 6px;
}

.stat-value {
    display: block;
    color: #e2e8f0;
    font-weight: bold;
    font-size: 1.1rem;
}

.stat-label {
    display: block;
    color: #a0aec0;
    font-size: 0.7rem;
    margin-top: 0.2rem;
}

.companion-health {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.8rem;
}

.health-bar {
    flex: 1;
    height: 8px;
    background: #2d3748;
    border-radius: 4px;
    overflow: hidden;
}

.health-fill {
    height: 100%;
    background: linear-gradient(90deg, #48bb78, #38a169);
    transition: width 0.3s ease;
    border-radius: 4px;
}

.health-fill.low {
    background: linear-gradient(90deg, #f56565, #e53e3e);
}

.health-fill.medium {
    background: linear-gradient(90deg, #ed8936, #dd6b20);
}

.health-text {
    color: #cbd5e0;
    font-size: 0.8rem;
    font-weight: bold;
    min-width: 60px;
}

.companion-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.companion-action-btn {
    flex: 1;
    min-width: 70px;
    padding: 0.4rem 0.8rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: bold;
    transition: all 0.3s ease;
}

.action-attack {
    background: linear-gradient(135deg, #f56565, #e53e3e);
    color: white;
}

.action-heal {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

.action-skill {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
}

.action-rest {
    background: linear-gradient(135deg, #805ad5, #6b46c1);
    color: white;
}

.companion-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.companion-action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Status indicators */
.companion-status {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    display: flex;
    gap: 0.3rem;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #2d3748;
}

.status-healthy {
    background: #48bb78;
}

.status-injured {
    background: #ed8936;
}

.status-critical {
    background: #f56565;
}

.status-dead {
    background: #2d3748;
    border-color: #718096;
}

/* Management Panel */
.companion-management {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 1px solid #4a5568;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.management-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #4a5568;
}

.management-header h3 {
    color: #e2e8f0;
    margin: 0;
}

.close-management-btn {
    background: #e53e3e;
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1rem;
}

.management-content {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 2rem;
    align-items: start;
}

.management-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.action-btn {
    padding: 0.8rem 1.2rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.rest-companions {
    background: linear-gradient(135deg, #805ad5, #6b46c1);
    color: white;
}

.heal-companions {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

.level-up-companions {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
    color: white;
}

.export-companions {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.management-stats {
    display: flex;
    gap: 1rem;
}

.stat-card {
    background: rgba(0, 0, 0, 0.3);
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    min-width: 100px;
}

.stat-card .stat-value {
    color: #4299e1;
    font-size: 1.5rem;
    font-weight: bold;
    display: block;
    margin-bottom: 0.5rem;
}

.stat-card .stat-label {
    color: #cbd5e0;
    font-size: 0.8rem;
}

/* Modal Styles */
.companion-modal, .companion-detail-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content, .detail-modal-content {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 1px solid #4a5568;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header, .detail-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #4a5568;
}

.modal-header h3, .detail-modal-header h3 {
    margin: 0;
    color: #e2e8f0;
}

.detail-modal-actions {
    display: flex;
    gap: 0.5rem;
}

.modal-action-btn {
    background: #4a5568;
    border: none;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.modal-action-btn:hover {
    background: #718096;
    transform: scale(1.1);
}

.modal-action-btn.danger {
    background: #e53e3e;
}

.modal-action-btn.danger:hover {
    background: #c53030;
}

.modal-close {
    background: none;
    border: none;
    color: #cbd5e0;
    font-size: 1.2rem;
    cursor: pointer;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-body, .detail-modal-body {
    padding: 1.5rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid #4a5568;
}

.modal-btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
}

.modal-btn.cancel {
    background: #4a5568;
    color: white;
}

.modal-btn.save {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

/* Form styles within modals */
.companion-form {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    color: #cbd5e0;
    font-weight: bold;
    font-size: 0.9rem;
}

.form-group input, .form-group select, .form-group textarea {
    padding: 0.6rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 6px;
    color: #e2e8f0;
}

.form-group textarea {
    resize: vertical;
    font-family: inherit;
    min-height: 80px;
}

/* Companion selection grid */
.companion-selection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1rem;
    max-height: 400px;
    overflow-y: auto;
    padding: 1rem;
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
}

.selection-card {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 2px solid #4a5568;
    border-radius: 8px;
    padding: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.selection-card:hover {
    border-color: #805ad5;
    transform: translateY(-2px);
}

.selection-card.selected {
    border-color: #48bb78;
    background: linear-gradient(135deg, rgba(72, 187, 120, 0.2), rgba(56, 161, 105, 0.2));
}

.selection-card h4 {
    color: #e2e8f0;
    margin: 0 0 0.5rem 0;
}

.selection-card p {
    color: #a0aec0;
    font-size: 0.9rem;
    margin: 0;
}

/* Responsive Design */
@media (max-width: 768px) {
    .companions-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .companions-summary {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .companions-grid {
        grid-template-columns: 1fr;
        padding: 1rem;
    }
    
    .companion-stats {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .management-content {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .management-stats {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .companion-form {
        grid-template-columns: 1fr;
    }
    
    .companion-selection-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .companions-container {
        padding: 0.5rem;
    }
    
    .companion-card {
        padding: 0.8rem;
    }
    
    .companions-actions {
        flex-direction: column;
    }
    
    .companion-actions {
        flex-direction: column;
    }
    
    .management-actions {
        flex-direction: column;
    }
}
</style>

<!-- COMPANIONS TAB JAVASCRIPT -->
<script>
// Companion templates database
const companionTemplates = {
    animals: [
        {
            name: "Lobo",
            type: "animal",
            size: "Mediano",
            hd: "2+2",
            hp: 16,
            ac: 7,
            movement: 18,
            attacks: [
                { name: "Mordida", damage: "2d4", thac0: 19 }
            ],
            abilities: {
                str: 17, dex: 15, con: 15, int: 2, wis: 12, cha: 6
            },
            specialAbilities: ["Rastreo", "Sigilo"],
            description: "Compa√±ero lobo leal. Excelente rastreador y guardi√°n nocturno."
        },
        {
            name: "Oso Pardo",
            type: "animal", 
            size: "Grande",
            hd: "5+5",
            hp: 37,
            ac: 6,
            movement: 12,
            attacks: [
                { name: "Garra", damage: "1d6+6", thac0: 15 },
                { name: "Mordida", damage: "1d8+3", thac0: 15 }
            ],
            abilities: {
                str: 20, dex: 13, con: 19, int: 2, wis: 12, cha: 6
            },
            specialAbilities: ["Abrazo de Oso", "Olfato Agudo"],
            description: "Poderoso oso pardo. Excelente para combate y transporte de cargas pesadas."
        },
        {
            name: "Halc√≥n",
            type: "animal",
            size: "Peque√±o",
            hd: "1/2",
            hp: 2,
            ac: 7,
            movement: 24,
            attacks: [
                { name: "Garras", damage: "1d2", thac0: 20 }
            ],
            abilities: {

if (categoryItems.length === 0) {
            container.innerHTML = `
                <div class="empty-equipment">
                    <p>${getCategoryEmptyMessage(category)}</p>
                    <button class="add-category-btn" onclick="show${capitalize(category.slice(0, -1))}Selection()">
                        ${getCategoryAddButton(category)}
                    </button>
                </div>
            `;
        } else {
            container.innerHTML = categoryItems.map(item => createEquipmentCard(item)).join('');
        }
    });
}

// Create equipment card HTML
function createEquipmentCard(item) {
    const totalWeight = (item.weight * item.quantity).toFixed(1);
    const conditionIcon = getConditionIcon(item.condition);
    const equippedClass = item.equipped ? 'equipped' : '';
    
    return `
        <div class="equipment-card ${item.category.slice(0, -1)} ${equippedClass}" onclick="showItemDetails(${item.id})">
            <div class="item-status">
                ${item.equipped ? '<div class="status-indicator status-equipped"></div>' : ''}
                ${item.condition !== 'good' ? `<div class="status-indicator status-${item.condition}"></div>` : ''}
                ${item.isCustom || item.effect ? '<div class="status-indicator status-magical"></div>' : ''}
            </div>
            
            <div class="item-header">
                <div class="item-info">
                    <h4>${item.name}</h4>
                    <span class="item-type">${capitalize(item.category.slice(0, -1))} ‚Ä¢ ${item.condition}</span>
                </div>
                <div class="item-quantity">x${item.quantity}</div>
            </div>
            
            <div class="item-stats">
                <div class="stat-item">
                    <span class="stat-value">${totalWeight}</span>
                    <span class="stat-label">Peso (lb)</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value">${item.cost}</span>
                    <span class="stat-label">Valor (po)</span>
                </div>
                ${item.uses && item.maxUses ? `
                    <div class="stat-item">
                        <span class="stat-value">${item.uses}/${item.maxUses}</span>
                        <span class="stat-label">Usos</span>
                    </div>
                ` : ''}
                ${item.damage ? `
                    <div class="stat-item">
                        <span class="stat-value">${item.damage}</span>
                        <span class="stat-label">Da√±o</span>
                    </div>
                ` : ''}
                ${item.ac ? `
                    <div class="stat-item">
                        <span class="stat-value">${item.ac}</span>
                        <span class="stat-label">CA</span>
                    </div>
                ` : ''}
            </div>
            
            <div class="item-description">
                ${item.description || 'Sin descripci√≥n disponible.'}
            </div>
            
            <div class="item-actions" onclick="event.stopPropagation()">
                <button class="item-action-btn action-equip ${item.equipped ? 'equipped' : ''}" 
                        onclick="toggleEquipped(${item.id})">
                    ${item.equipped ? 'üì§ Desequipar' : 'üëï Equipar'}
                </button>
                ${item.uses > 0 ? `
                    <button class="item-action-btn action-use" onclick="useItem(${item.id})">
                        üéØ Usar
                    </button>
                ` : ''}
                <button class="item-action-btn action-sell" onclick="sellItem(${item.id})">
                    üí∞ Vender
                </button>
            </div>
        </div>
    `;
}

// Helper functions for display
function getCategoryEmptyMessage(category) {
    const messages = {
        weapons: '‚öîÔ∏è No tienes armas',
        armor: 'üõ°Ô∏è No tienes armadura',
        gear: 'üéí No tienes equipo de aventura',
        magic: '‚ú® No tienes objetos m√°gicos',
        containers: 'üì¶ No tienes contenedores'
    };
    return messages[category] || 'No hay items';
}

function getCategoryAddButton(category) {
    const buttons = {
        weapons: 'Agregar Arma',
        armor: 'Agregar Armadura', 
        gear: 'Agregar Equipo',
        magic: 'Agregar Objeto M√°gico',
        containers: 'Agregar Contenedor'
    };
    return buttons[category] || 'Agregar Item';
}

function getConditionIcon(condition) {
    const icons = {
        good: '‚úÖ',
        damaged: 'üîß',
        broken: 'üí•'
    };
    return icons[condition] || '‚úÖ';
}

function capitalize(str) {
    return str.charAt(0).toUpperCase() + str.slice(1);
}

// Calculate category weight
function calculateCategoryWeight(category) {
    return equipment[category].reduce((total, item) => {
        return total + (item.weight * item.quantity);
    }, 0);
}

// Calculate total weight
function calculateTotalWeight() {
    const categories = ['weapons', 'armor', 'gear', 'magic', 'containers'];
    return categories.reduce((total, category) => {
        return total + calculateCategoryWeight(category);
    }, 0);
}

// Update weight information
function updateWeightInfo() {
    const currentWeight = calculateTotalWeight();
    const maxWeight = getCarryingCapacity();
    const weightPercentage = (currentWeight / maxWeight) * 100;
    
    document.getElementById('current-weight').textContent = currentWeight.toFixed(1);
    document.getElementById('max-weight').textContent = maxWeight;
    
    const weightFill = document.getElementById('weight-fill');
    weightFill.style.width = `${Math.min(weightPercentage, 100)}%`;
    
    if (weightPercentage > 100) {
        weightFill.classList.add('overloaded');
    } else {
        weightFill.classList.remove('overloaded');
    }
}

// Update currency
function updateCurrency() {
    const gold = parseInt(document.getElementById('gold-coins').value) || 0;
    const silver = parseInt(document.getElementById('silver-coins').value) || 0;
    const copper = parseInt(document.getElementById('copper-coins').value) || 0;
    const electrum = parseInt(document.getElementById('electrum-coins').value) || 0;
    const platinum = parseInt(document.getElementById('platinum-coins').value) || 0;
    
    // Convert everything to gold pieces for total
    const totalInGold = gold + (silver * 0.1) + (copper * 0.01) + (electrum * 0.5) + (platinum * 5);
    
    document.getElementById('currency-total').textContent = totalInGold.toFixed(2);
    document.getElementById('total-currency-value').textContent = totalInGold.toFixed(2);
    
    currency = { gold, silver, copper, electrum, platinum };
}

// Toggle equipment category
function toggleEquipmentCategory(categoryId) {
    const category = document.getElementById(categoryId);
    const header = category.previousElementSibling;
    const toggle = header.querySelector('.category-toggle');
    
    if (category.classList.contains('collapsed')) {
        category.classList.remove('collapsed');
        category.style.display = 'grid';
        toggle.textContent = '‚ñº';
        header.classList.remove('collapsed');
    } else {
        category.classList.add('collapsed');
        category.style.display = 'none';
        toggle.textContent = '‚ñ∂';
        header.classList.add('collapsed');
    }
}

// Item actions
function toggleEquipped(itemId) {
    const item = findItemById(itemId);
    if (!item) return;
    
    item.equipped = !item.equipped;
    updateEquipmentDisplay();
    updateManagementStats();
    
    const action = item.equipped ? 'equipado' : 'desequipado';
    showEquipmentNotification(`${item.name} ${action}`, 'info');
}

function useItem(itemId) {
    const item = findItemById(itemId);
    if (!item || item.uses <= 0) return;
    
    item.uses--;
    
    if (item.uses <= 0) {
        showEquipmentNotification(`${item.name} agotado`, 'warning');
    } else {
        showEquipmentNotification(`${item.name} usado (${item.uses} usos restantes)`, 'info');
    }
    
    updateEquipmentDisplay();
}

function sellItem(itemId) {
    const item = findItemById(itemId);
    if (!item) return;
    
    if (confirm(`¬øVender ${item.name} por ${Math.floor(item.cost * 0.5)} po?`)) {
        // Add money (half price)
        const sellValue = Math.floor(item.cost * 0.5);
        currency.gold += sellValue;
        document.getElementById('gold-coins').value = currency.gold;
        updateCurrency();
        
        // Remove item
        removeItemFromInventory(itemId);
        
        showEquipmentNotification(`${item.name} vendido por ${sellValue} po`, 'success');
    }
}

// Show item details
function showItemDetails(itemId) {
    const item = findItemById(itemId);
    if (!item) return;
    
    currentEditingItem = item;
    
    document.getElementById('detail-item-name').textContent = item.name;
    document.getElementById('equip-toggle-btn').title = item.equipped ? 'Desequipar' : 'Equipar';
    
    const detailBody = document.getElementById('equipment-detail-modal-body');
    detailBody.innerHTML = `
        <div class="item-detail-grid">
            <div class="detail-section">
                <h4>üìä Informaci√≥n B√°sica</h4>
                <div class="detail-stats">
                    <div class="detail-stat">
                        <label>Categor√≠a:</label>
                        <span>${capitalize(item.category.slice(0, -1))}</span>
                    </div>
                    <div class="detail-stat">
                        <label>Peso:</label>
                        <span>${item.weight} lb (cada uno)</span>
                    </div>
                    <div class="detail-stat">
                        <label>Valor:</label>
                        <span>${item.cost} po (cada uno)</span>
                    </div>
                    <div class="detail-stat">
                        <label>Cantidad:</label>
                        <span>${item.quantity}</span>
                    </div>
                    <div class="detail-stat">
                        <label>Peso Total:</label>
                        <span>${(item.weight * item.quantity).toFixed(1)} lb</span>
                    </div>
                    <div class="detail-stat">
                        <label>Valor Total:</label>
                        <span>${(item.cost * item.quantity).toFixed(1)} po</span>
                    </div>
                    <div class="detail-stat">
                        <label>Estado:</label>
                        <span>${capitalize(item.condition)}</span>
                    </div>
                    <div class="detail-stat">
                        <label>Equipado:</label>
                        <span>${item.equipped ? 'S√≠' : 'No'}</span>
                    </div>
                </div>
            </div>
            
            ${item.damage || item.ac || item.range || item.acBonus ? `
                <div class="detail-section">
                    <h4>‚öîÔ∏è Estad√≠sticas de Combate</h4>
                    <div class="detail-stats">
                        ${item.damage ? `
                            <div class="detail-stat">
                                <label>Da√±o:</label>
                                <span>${item.damage}</span>
                            </div>
                        ` : ''}
                        ${item.ac ? `
                            <div class="detail-stat">
                                <label>Clase de Armadura:</label>
                                <span>${item.ac}</span>
                            </div>
                        ` : ''}
                        ${item.acBonus ? `
                            <div class="detail-stat">
                                <label>Bonus CA:</label>
                                <span>+${item.acBonus}</span>
                            </div>
                        ` : ''}
                        ${item.range ? `
                            <div class="detail-stat">
                                <label>Alcance:</label>
                                <span>${item.range}</span>
                            </div>
                        ` : ''}
                        ${item.hands ? `
                            <div class="detail-stat">
                                <label>Manos Requeridas:</label>
                                <span>${item.hands}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : ''}
            
            ${item.uses || item.capacity || item.effect ? `
                <div class="detail-section full-width">
                    <h4>‚ú® Propiedades Especiales</h4>
                    <div class="detail-stats">
                        ${item.uses && item.maxUses ? `
                            <div class="detail-stat">
                                <label>Usos:</label>
                                <span>${item.uses} / ${item.maxUses}</span>
                            </div>
                        ` : ''}
                        ${item.capacity ? `
                            <div class="detail-stat">
                                <label>Capacidad:</label>
                                <span>${item.capacity} lb</span>
                            </div>
                        ` : ''}
                        ${item.effect ? `
                            <div class="detail-stat">
                                <label>Efecto:</label>
                                <span>${item.effect}</span>
                            </div>
                        ` : ''}
                    </div>
                </div>
            ` : ''}
            
            <div class="detail-section full-width">
                <h4>üìù Descripci√≥n</h4>
                <p class="item-description-full">${item.description || 'Sin descripci√≥n disponible.'}</p>
            </div>
            
            <div class="detail-section full-width">
                <h4>üìà Informaci√≥n Adicional</h4>
                <div class="detail-stats">
                    <div class="detail-stat">
                        <label>Fecha A√±adido:</label>
                        <span>${item.dateAdded}</span>
                    </div>
                    <div class="detail-stat">
                        <label>Tipo:</label>
                        <span>${item.isCustom ? 'Personalizado' : 'Est√°ndar'}</span>
                    </div>
                    <div class="detail-stat">
                        <label>ID:</label>
                        <span>${item.id}</span>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('equipment-detail-modal').style.display = 'flex';
}

// Detail modal actions
function editItem() {
    if (!currentEditingItem) return;
    
    closeEquipmentDetailModal();
    showCustomItemModal();
    
    setTimeout(() => {
        document.getElementById('custom-item-name').value = currentEditingItem.name;
        document.getElementById('custom-item-category').value = currentEditingItem.category;
        document.getElementById('custom-item-weight').value = currentEditingItem.weight;
        document.getElementById('custom-item-cost').value = currentEditingItem.cost;
        document.getElementById('custom-item-quantity').value = currentEditingItem.quantity;
        document.getElementById('custom-item-uses').value = currentEditingItem.maxUses || 0;
        document.getElementById('custom-item-description').value = currentEditingItem.description;
        
        document.getElementById('equipment-modal-title').textContent = 'Editar Item';
        document.getElementById('save-item-btn').textContent = 'Guardar Cambios';
        document.getElementById('save-item-btn').onclick = saveEditedItem;
    }, 100);
}

function saveEditedItem() {
    const name = document.getElementById('custom-item-name').value.trim();
    const category = document.getElementById('custom-item-category').value;
    const weight = parseFloat(document.getElementById('custom-item-weight').value) || 1;
    const cost = parseFloat(document.getElementById('custom-item-cost').value) || 1;
    const quantity = parseInt(document.getElementById('custom-item-quantity').value) || 1;
    const uses = parseInt(document.getElementById('custom-item-uses').value) || 0;
    const description = document.getElementById('custom-item-description').value.trim();
    
    if (!name) {
        showEquipmentNotification('El nombre es requerido', 'error');
        return;
    }
    
    const item = currentEditingItem;
    
    // Move item if category changed
    if (item.category !== category) {
        removeItemFromInventory(item.id);
        item.category = category;
        equipment[category].push(item);
    }
    
    item.name = name;
    item.weight = weight;
    item.cost = cost;
    item.quantity = quantity;
    item.uses = Math.min(uses, item.uses); // Don't exceed current uses
    item.maxUses = uses;
    item.description = description;
    item.isCustom = true;
    
    updateEquipmentDisplay();
    updateWeightInfo();
    updateManagementStats();
    closeEquipmentModal();
    
    showEquipmentNotification(`${name} actualizado exitosamente`, 'success');
}

function duplicateItem() {
    if (!currentEditingItem) return;
    
    const original = currentEditingItem;
    const duplicate = {
        ...original,
        id: Date.now(),
        name: `${original.name} (Copia)`,
        equipped: false,
        uses: original.maxUses || 0,
        dateAdded: new Date().toLocaleDateString()
    };
    
    equipment[original.category].push(duplicate);
    updateEquipmentDisplay();
    updateWeightInfo();
    updateManagementStats();
    closeEquipmentDetailModal();
    
    showEquipmentNotification(`${duplicate.name} creado como copia`, 'success');
}

function toggleItemEquipped() {
    if (!currentEditingItem) return;
    
    toggleEquipped(currentEditingItem.id);
    closeEquipmentDetailModal();
}

function removeItem() {
    if (!currentEditingItem) return;
    
    if (confirm(`¬øEst√°s seguro de que quieres eliminar ${currentEditingItem.name}?`)) {
        const itemName = currentEditingItem.name;
        removeItemFromInventory(currentEditingItem.id);
        closeEquipmentDetailModal();
        
        showEquipmentNotification(`${itemName} eliminado del inventario`, 'info');
    }
}

function closeEquipmentDetailModal() {
    document.getElementById('equipment-detail-modal').style.display = 'none';
    currentEditingItem = null;
}

// Management functions
function toggleEquipmentManagement() {
    const panel = document.getElementById('equipment-management');
    const isVisible = panel.style.display !== 'none';
    panel.style.display = isVisible ? 'none' : 'block';
}

function sortEquipment() {
    const categories = ['weapons', 'armor', 'gear', 'magic', 'containers'];
    
    categories.forEach(category => {
        equipment[category].sort((a, b) => {
            // Sort by equipped first, then by name
            if (a.equipped !== b.equipped) {
                return b.equipped - a.equipped; // equipped first
            }
            return a.name.localeCompare(b.name);
        });
    });
    
    updateEquipmentDisplay();
    showEquipmentNotification('Inventario ordenado', 'success');
}

function repairAllEquipment() {
    let repairedCount = 0;
    const categories = ['weapons', 'armor', 'gear', 'magic', 'containers'];
    
    categories.forEach(category => {
        equipment[category].forEach(item => {
            if (item.condition !== 'good') {
                item.condition = 'good';
                repairedCount++;
            }
        });
    });
    
    updateEquipmentDisplay();
    showEquipmentNotification(`${repairedCount} items reparados`, 'success');
}

function showSellModal() {
    // This would show a modal to sell multiple items
    // For now, just show notification
    showEquipmentNotification('Funci√≥n de venta masiva pendiente', 'info');
}

function exportEquipment() {
    const exportData = {
        equipment: equipment,
        currency: currency,
        exportDate: new Date().toISOString(),
        version: '1.0'
    };
    
    const dataStr = JSON.stringify(exportData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `equipment_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showEquipmentNotification('Equipo exportado exitosamente', 'success');
}

function updateManagementStats() {
    const categories = ['weapons', 'armor', 'gear', 'magic', 'containers'];
    
    let totalItems = 0;
    let totalValue = 0;
    let equippedItems = 0;
    
    categories.forEach(category => {
        equipment[category].forEach(item => {
            totalItems += item.quantity;
            totalValue += item.cost * item.quantity;
            if (item.equipped) equippedItems++;
        });
    });
    
    document.getElementById('total-items').textContent = totalItems;
    document.getElementById('total-value').textContent = totalValue.toFixed(1);
    document.getElementById('equipped-items').textContent = equippedItems;
}

// Quick equip functions
function showQuickEquipModal() {
    document.getElementById('quick-equip-modal').style.display = 'flex';
}

function closeQuickEquipModal() {
    document.getElementById('quick-equip-modal').style.display = 'none';
}

function equipClass(className) {
    const classEquip = classEquipment[className];
    if (!classEquip) return;
    
    let itemsAdded = 0;
    
    // Add weapons
    if (classEquip.weapons) {
        classEquip.weapons.forEach(weaponName => {
            const weaponTemplate = equipmentDatabase.weapons.find(w => w.name === weaponName);
            if (weaponTemplate) {
                addItemFromTemplate(weaponTemplate, 'weapons');
                itemsAdded++;
            }
        });
    }
    
    // Add armor
    if (classEquip.armor) {
        classEquip.armor.forEach(armorName => {
            const armorTemplate = equipmentDatabase.armor.find(a => a.name === armorName);
            if (armorTemplate) {
                addItemFromTemplate(armorTemplate, 'armor');
                itemsAdded++;
            }
        });
    }
    
    // Add gear
    if (classEquip.gear) {
        classEquip.gear.forEach(gearName => {
            const gearTemplate = equipmentDatabase.gear.find(g => g.name === gearName);
            if (gearTemplate) {
                addItemFromTemplate(gearTemplate, 'gear');
                itemsAdded++;
            }
        });
    }
    
    // Add magic items
    if (classEquip.magic) {
        classEquip.magic.forEach(magicName => {
            const magicTemplate = equipmentDatabase.magic.find(m => m.name === magicName);
            if (magicTemplate) {
                addItemFromTemplate(magicTemplate, 'magic');
                itemsAdded++;
            }
        });
    }
    
    // Add money
    if (classEquip.money) {
        currency.gold += classEquip.money.gold || 0;
        currency.silver += classEquip.money.silver || 0;
        currency.copper += classEquip.money.copper || 0;
        
        document.getElementById('gold-coins').value = currency.gold;
        document.getElementById('silver-coins').value = currency.silver;
        document.getElementById('copper-coins').value = currency.copper;
        updateCurrency();
    }
    
    updateEquipmentDisplay();
    updateWeightInfo();
    updateManagementStats();
    closeQuickEquipModal();
    
    showEquipmentNotification(`Equipo de ${capitalize(className)} a√±adido (${itemsAdded} items)`, 'success');
}

// Helper functions
function addItemFromTemplate(template, category) {
    const newItem = {
        id: Date.now() + Math.random(),
        name: template.name,
        category: category,
        weight: template.weight || 0,
        cost: template.cost || 0,
        quantity: template.quantity || 1,
        uses: template.uses || 0,
        maxUses: template.uses || 0,
        equipped: false,
        condition: 'good',
        description: generateItemDescription(template),
        dateAdded: new Date().toLocaleDateString(),
        ...template
    };
    
    equipment[category].push(newItem);
}

function findItemById(itemId) {
    const categories = ['weapons', 'armor', 'gear', 'magic', 'containers'];
    
    for (const category of categories) {
        const item = equipment[category].find(item => item.id === itemId);
        if (item) return item;
    }
    
    return null;
}

function removeItemFromInventory(itemId) {
    const categories = ['weapons', 'armor', 'gear', 'magic', 'containers'];
    
    for (const category of categories) {
        const index = equipment[category].findIndex(item => item.id === itemId);
        if (index !== -1) {
            equipment[category].splice(index, 1);
            updateEquipmentDisplay();
            updateWeightInfo();
            updateManagementStats();
            return true;
        }
    }
    
    return false;
}

function showEquipmentNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `equipment-notification ${type}`;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 1001;
        max-width: 350px;
        animation: slideInEquipment 0.3s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    `;
    
    // Set background color based on type
    const colors = {
        'success': 'linear-gradient(135deg, #48bb78, #38a169)',
        'error': 'linear-gradient(135deg, #f56565, #e53e3e)',
        'info': 'linear-gradient(135deg, #4299e1, #3182ce)',
        'warning': 'linear-gradient(135deg, #ed8936, #dd6b20)'
    };
    
    notification.style.background = colors[type] || colors.info;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOutEquipment 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 4000);
}

// Add CSS for equipment notifications
const equipmentNotificationStyle = document.createElement('style');
equipmentNotificationStyle.textContent = `
    @keyframes slideInEquipment {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOutEquipment {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
    
    .equipment-selection-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1rem;
        max-height: 500px;
        overflow-y: auto;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }
    
    .selection-card {
        background: linear-gradient(135deg, #2d3748, #1a202c);
        border: 2px solid #4a5568;
        border-radius: 8px;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .selection-card:hover {
        border-color: #805ad5;
        transform: translateY(-2px);
    }
    
    .selection-card.selected {
        border-color: #48bb78;
        background: linear-gradient(135deg, rgba(72, 187, 120, 0.2), rgba(56, 161, 105, 0.2));
    }
    
    .selection-card.two-handed {
        border-left: 4px solid #ed8936;
    }
    
    .selection-card.magic-item {
        border-left: 4px solid #ed64a6;
    }
    
    .selection-card h4 {
        color: #e2e8f0;
        margin: 0 0 0.5rem 0;
        font-size: 1rem;
    }
    
    .selection-card p {
        color: #a0aec0;
        font-size: 0.9rem;
        margin: 0.2rem 0;
    }
    
    .equipment-category-selection {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 1rem;
    }
`;
document.head.appendChild(equipmentNotificationStyle);

// Initialize equipment tab when the page loads
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeEquipmentTab);
} else {
    initializeEquipmentTab();
}

// Update equipment when switching to equipment tab
document.addEventListener('tabChanged', function(e) {
    if (e.detail === 'equipment') {
        setTimeout(() => {
            initializeEquipmentTab();
        }, 100);
    }
});

// Update equipment when stats change (for carrying capacity)
document.addEventListener('statsChanged', function() {
    setTimeout(() => {
        updateWeightInfo();
    }, 100);
});

// Export equipment data for other systems
function exportEquipmentData() {
    return {
        equipment: equipment,
        currency: currency
    };
}

// Import equipment data
function importEquipmentData(data) {
    if (data.equipment) {
        equipment = { ...equipment, ...data.equipment };
        updateEquipmentDisplay();
        updateWeightInfo();
        updateManagementStats();
    }
    
    if (data.currency) {
        currency = { ...currency, ...data.currency };
        document.getElementById('gold-coins').value = currency.gold;
        document.getElementById('silver-coins').value = currency.silver;
        document.getElementById('copper-coins').value = currency.copper;
        document.getElementById('electrum-coins').value = currency.electrum;
        document.getElementById('platinum-coins').value = currency.platinum;
        updateCurrency();
    }
}

// Wrapper functions for modal calls (referenced in HTML)
function showWeaponSelection() { showAddWeapon(); }
function showArmorSelection() { showAddArmor(); }
function showGearSelection() { showAddGear(); }
function showMagicitemSelection() { showAddMagicItem(); }
function showContainerSelection() { showAddContainer(); }
</script>.modal-action-btn:hover {
    background: #718096;
    transform: scale(1.1);
}

.modal-action-btn.danger {
    background: #e53e3e;
}

.modal-action-btn.danger:hover {
    background: #c53030;
}

.modal-close {
    background: none;
    border: none;
    color: #cbd5e0;
    font-size: 1.2rem;
    cursor: pointer;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-body, .detail-modal-body {
    padding: 1.5rem;
}

.modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
    padding: 1rem 1.5rem;
    border-top: 1px solid #4a5568;
}

.modal-btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: bold;
}

.modal-btn.cancel {
    background: #4a5568;
    color: white;
}

.modal-btn.save {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

/* Form styles within modals */
.equipment-form {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
}

.form-group {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}

.form-group.full-width {
    grid-column: 1 / -1;
}

.form-group label {
    color: #cbd5e0;
    font-weight: bold;
    font-size: 0.9rem;
}

.form-group input, .form-group select, .form-group textarea {
    padding: 0.6rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 6px;
    color: #e2e8f0;
}

.form-group textarea {
    resize: vertical;
    font-family: inherit;
    min-height: 80px;
}

/* Quick Equip Options */
.quick-equip-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
}

.equip-option {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 2px solid #4a5568;
    border-radius: 12px;
    padding: 1.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.equip-option:hover {
    border-color: #805ad5;
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
}

.equip-option h4 {
    color: #e2e8f0;
    margin: 0 0 0.8rem 0;
    font-size: 1.2rem;
}

.equip-option p {
    color: #a0aec0;
    margin: 0;
    line-height: 1.4;
}

/* Item detail styles */
.item-detail-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 1.5rem;
}

.detail-section {
    background: rgba(0, 0, 0, 0.2);
    padding: 1rem;
    border-radius: 8px;
    border-left: 4px solid #805ad5;
}

.detail-section.full-width {
    grid-column: 1 / -1;
}

.detail-section h4 {
    color: #e2e8f0;
    margin: 0 0 1rem 0;
    font-size: 1rem;
}

.detail-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.5rem;
}

.detail-stat {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.3rem 0;
    border-bottom: 1px solid rgba(74, 85, 104, 0.3);
}

.detail-stat label {
    color: #cbd5e0;
    font-weight: bold;
    font-size: 0.9rem;
}

.detail-stat span {
    color: #e2e8f0;
    font-weight: bold;
}

.item-description-full {
    color: #a0aec0;
    line-height: 1.6;
    margin: 0;
}

/* Responsive Design */
@media (max-width: 768px) {
    .equipment-header {
        flex-direction: column;
        gap: 1rem;
        align-items: stretch;
    }
    
    .equipment-summary {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .equipment-grid {
        grid-template-columns: 1fr;
        padding: 1rem;
    }
    
    .currency-grid {
        grid-template-columns: 1fr;
    }
    
    .management-content {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .management-stats {
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .equipment-form {
        grid-template-columns: 1fr;
    }
    
    .quick-equip-options {
        grid-template-columns: 1fr;
    }
    
    .item-detail-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 480px) {
    .equipment-container {
        padding: 0.5rem;
    }
    
    .equipment-card {
        padding: 0.8rem;
    }
    
    .equipment-actions {
        flex-direction: column;
    }
    
    .item-actions {
        flex-direction: column;
    }
    
    .management-actions {
        flex-direction: column;
    }
}
</style>

<!-- EQUIPMENT TAB JAVASCRIPT -->
<script>
// Equipment database with AD&D 2nd Edition items
const equipmentDatabase = {
    weapons: [
        { name: "Espada Larga", damage: "1d8", type: "Cortante", weight: 4, cost: 15, hands: 1 },
        { name: "Espada Corta", damage: "1d6", type: "Cortante", weight: 3, cost: 10, hands: 1 },
        { name: "Daga", damage: "1d4", type: "Cortante/Perforante", weight: 1, cost: 2, hands: 1 },
        { name: "Maza", damage: "1d6+1", type: "Contundente", weight: 10, cost: 8, hands: 1 },
        { name: "Hacha de Batalla", damage: "1d8", type: "Cortante", weight: 7, cost: 5, hands: 1 },
        { name: "Arco Largo", damage: "1d6", type: "Perforante", weight: 3, cost: 75, hands: 2, range: "70/140/210" },
        { name: "Ballesta Ligera", damage: "1d4", type: "Perforante", weight: 7, cost: 35, hands: 2, range: "60/120/180" }
    ],
    armor: [
        { name: "Armadura de Cuero", ac: 8, weight: 15, cost: 5, type: "Ligera" },
        { name: "Cuero Tachonado", ac: 7, weight: 25, cost: 20, type: "Ligera" },
        { name: "Cota de Mallas", ac: 5, weight: 40, cost: 75, type: "Media" },
        { name: "Cota Laminada", ac: 4, weight: 45, cost: 80, type: "Media" },
        { name: "Armadura de Placas", ac: 3, weight: 50, cost: 400, type: "Pesada" },
        { name: "Escudo Peque√±o", ac: 1, weight: 3, cost: 3, type: "Escudo", acBonus: 1 },
        { name: "Escudo Grande", ac: 2, weight: 15, cost: 10, type: "Escudo", acBonus: 2 }
    ],
    gear: [
        { name: "Cuerda (15m)", weight: 20, cost: 2, uses: "unlimited" },
        { name: "Antorcha", weight: 1, cost: 0.01, uses: "6 hours", quantity: 6 },
        { name: "Raciones de Viaje", weight: 2, cost: 2, uses: "1 day", quantity: 7 },
        { name: "Mochila", weight: 2, cost: 2, capacity: 40 },
        { name: "Saco de Dormir", weight: 8, cost: 2 },
        { name: "Kit de Primeros Auxilios", weight: 3, cost: 5, uses: 10 },
        { name: "Ganz√∫as", weight: 1, cost: 30 },
        { name: "S√≠mbolo Sagrado", weight: 0, cost: 25 }
    ],
    magic: [
        { name: "Poci√≥n de Curaci√≥n", weight: 0, cost: 50, uses: 1, effect: "Cura 1d4+1 HP" },
        { name: "Pergamino de Conjuro", weight: 0, cost: 100, uses: 1, effect: "Contiene un conjuro de nivel 1" },
        { name: "Anillo de Protecci√≥n +1", weight: 0, cost: 1000, effect: "+1 CA, +1 salvaciones" },
        { name: "Varita de Misiles M√°gicos", weight: 1, cost: 2000, uses: 50, effect: "Lanza Misiles M√°gicos" }
    ]
};

// Class equipment templates
const classEquipment = {
    fighter: {
        weapons: ["Espada Larga", "Arco Largo"],
        armor: ["Cota de Mallas", "Escudo Grande"],
        gear: ["Mochila", "Cuerda (15m)", "Raciones de Viaje"],
        money: { gold: 30, silver: 0, copper: 0 }
    },
    wizard: {
        weapons: ["Daga"],
        armor: [],
        gear: ["Mochila", "Libro de Conjuros", "Componentes de Conjuro", "Antorcha"],
        magic: ["Pergamino de Conjuro"],
        money: { gold: 20, silver: 0, copper: 0 }
    },
    cleric: {
        weapons: ["Maza"],
        armor: ["Cuero Tachonado", "Escudo Peque√±o"],
        gear: ["Mochila", "S√≠mbolo Sagrado", "Raciones de Viaje", "Kit de Primeros Auxilios"],
        money: { gold: 25, silver: 0, copper: 0 }
    },
    thief: {
        weapons: ["Espada Corta", "Daga"],
        armor: ["Armadura de Cuero"],
        gear: ["Mochila", "Ganz√∫as", "Cuerda (15m)", "Antorcha"],
        money: { gold: 15, silver: 50, copper: 0 }
    },
    ranger: {
        weapons: ["Espada Larga", "Espada Corta", "Arco Largo"],
        armor: ["Cuero Tachonado"],
        gear: ["Mochila", "Cuerda (15m)", "Raciones de Viaje", "Saco de Dormir"],
        money: { gold: 35, silver: 0, copper: 0 }
    },
    adventurer: {
        weapons: ["Espada Corta", "Daga"],
        armor: ["Armadura de Cuero"],
        gear: ["Mochila", "Cuerda (15m)", "Antorcha", "Raciones de Viaje", "Saco de Dormir", "Kit de Primeros Auxilios"],
        money: { gold: 20, silver: 25, copper: 50 }
    }
};

// Current equipment state
let equipment = {
    weapons: [],
    armor: [],
    gear: [],
    magic: [],
    containers: []
};

let currency = {
    gold: 0,
    silver: 0,
    copper: 0,
    electrum: 0,
    platinum: 0
};

let currentEditingItem = null;

// Initialize equipment tab
function initializeEquipmentTab() {
    updateEquipmentDisplay();
    updateWeightInfo();
    updateCurrency();
    updateManagementStats();
}

// Calculate carrying capacity
function getCarryingCapacity() {
    const strength = parseInt(document.getElementById('strength-final')?.textContent || 10);
    
    // AD&D 2e carrying capacity (rough approximation)
    const capacityTable = {
        3: 5, 4: 10, 5: 10, 6: 20, 7: 20, 8: 35, 9: 35, 10: 40,
        11: 40, 12: 45, 13: 45, 14: 55, 15: 55, 16: 70, 17: 85,
        18: 110, 19: 185, 20: 335, 21: 485, 22: 635, 23: 785, 24: 935, 25: 1235
    };
    
    return capacityTable[Math.min(strength, 25)] || 40;
}

// Show add item modal
function showAddItemModal() {
    document.getElementById('equipment-modal-title').textContent = 'Seleccionar Categor√≠a';
    
    const modalBody = document.getElementById('equipment-modal-body');
    modalBody.innerHTML = `
        <div class="equipment-category-selection">
            <div class="equip-option" onclick="showAddWeapon()">
                <h4>‚öîÔ∏è Arma</h4>
                <p>Espadas, hachas, arcos y otras armas</p>
            </div>
            <div class="equip-option" onclick="showAddArmor()">
                <h4>üõ°Ô∏è Armadura</h4>
                <p>Armaduras corporales y escudos</p>
            </div>
            <div class="equip-option" onclick="showAddGear()">
                <h4>üéí Equipo</h4>
                <p>Equipo de aventura y herramientas</p>
            </div>
            <div class="equip-option" onclick="showAddMagicItem()">
                <h4>‚ú® Objeto M√°gico</h4>
                <p>Pociones, pergamilos y objetos encantados</p>
            </div>
            <div class="equip-option" onclick="showAddContainer()">
                <h4>üì¶ Contenedor</h4>
                <p>Mochilas, bolsas y otros contenedores</p>
            </div>
            <div class="equip-option" onclick="showCustomItemModal()">
                <h4>üìù Item Personalizado</h4>
                <p>Crea tu propio objeto √∫nico</p>
            </div>
        </div>
    `;
    
    document.getElementById('equipment-modal').style.display = 'flex';
    document.getElementById('save-item-btn').style.display = 'none';
}

// Show weapon selection
function showAddWeapon() {
    document.getElementById('equipment-modal-title').textContent = 'Agregar Arma';
    
    const modalBody = document.getElementById('equipment-modal-body');
    modalBody.innerHTML = `
        <div class="equipment-selection-grid">
            ${equipmentDatabase.weapons.map((weapon, index) => `
                <div class="selection-card ${weapon.hands === 2 ? 'two-handed' : ''}" onclick="selectItem('weapons', ${index})">
                    <h4>‚öîÔ∏è ${weapon.name}</h4>
                    <p><strong>Da√±o:</strong> ${weapon.damage}</p>
                    <p><strong>Tipo:</strong> ${weapon.type}</p>
                    <p><strong>Peso:</strong> ${weapon.weight} lb</p>
                    <p><strong>Costo:</strong> ${weapon.cost} po</p>
                    ${weapon.range ? `<p><strong>Alcance:</strong> ${weapon.range}</p>` : ''}
                    <p><strong>Manos:</strong> ${weapon.hands}</p>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('save-item-btn').style.display = 'inline-block';
    document.getElementById('save-item-btn').textContent = 'Agregar Arma';
}

// Show armor selection
function showAddArmor() {
    document.getElementById('equipment-modal-title').textContent = 'Agregar Armadura';
    
    const modalBody = document.getElementById('equipment-modal-body');
    modalBody.innerHTML = `
        <div class="equipment-selection-grid">
            ${equipmentDatabase.armor.map((armor, index) => `
                <div class="selection-card" onclick="selectItem('armor', ${index})">
                    <h4>üõ°Ô∏è ${armor.name}</h4>
                    <p><strong>CA:</strong> ${armor.ac}${armor.acBonus ? ` (Bonus: +${armor.acBonus})` : ''}</p>
                    <p><strong>Tipo:</strong> ${armor.type}</p>
                    <p><strong>Peso:</strong> ${armor.weight} lb</p>
                    <p><strong>Costo:</strong> ${armor.cost} po</p>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('save-item-btn').style.display = 'inline-block';
    document.getElementById('save-item-btn').textContent = 'Agregar Armadura';
}

// Show gear selection
function showAddGear() {
    document.getElementById('equipment-modal-title').textContent = 'Agregar Equipo';
    
    const modalBody = document.getElementById('equipment-modal-body');
    modalBody.innerHTML = `
        <div class="equipment-selection-grid">
            ${equipmentDatabase.gear.map((item, index) => `
                <div class="selection-card" onclick="selectItem('gear', ${index})">
                    <h4>üéí ${item.name}</h4>
                    <p><strong>Peso:</strong> ${item.weight} lb</p>
                    <p><strong>Costo:</strong> ${item.cost} po</p>
                    ${item.uses ? `<p><strong>Usos:</strong> ${item.uses}</p>` : ''}
                    ${item.capacity ? `<p><strong>Capacidad:</strong> ${item.capacity} lb</p>` : ''}
                    ${item.quantity ? `<p><strong>Cantidad:</strong> ${item.quantity}</p>` : ''}
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('save-item-btn').style.display = 'inline-block';
    document.getElementById('save-item-btn').textContent = 'Agregar Equipo';
}

// Show magic item selection
function showAddMagicItem() {
    document.getElementById('equipment-modal-title').textContent = 'Agregar Objeto M√°gico';
    
    const modalBody = document.getElementById('equipment-modal-body');
    modalBody.innerHTML = `
        <div class="equipment-selection-grid">
            ${equipmentDatabase.magic.map((item, index) => `
                <div class="selection-card magic-item" onclick="selectItem('magic', ${index})">
                    <h4>‚ú® ${item.name}</h4>
                    <p><strong>Peso:</strong> ${item.weight} lb</p>
                    <p><strong>Costo:</strong> ${item.cost} po</p>
                    ${item.uses ? `<p><strong>Usos:</strong> ${item.uses}</p>` : ''}
                    <p><strong>Efecto:</strong> ${item.effect}</p>
                </div>
            `).join('')}
        </div>
    `;
    
    document.getElementById('save-item-btn').style.display = 'inline-block';
    document.getElementById('save-item-btn').textContent = 'Agregar Objeto M√°gico';
}

// Show container selection
function showAddContainer() {
    document.getElementById('equipment-modal-title').textContent = 'Agregar Contenedor';
    
    const modalBody = document.getElementById('equipment-modal-body');
    modalBody.innerHTML = `
        <div class="equipment-form">
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="container-name" placeholder="ej: Mochila Grande">
            </div>
            <div class="form-group">
                <label>Capacidad (lb):</label>
                <input type="number" id="container-capacity" min="1" max="200" value="30">
            </div>
            <div class="form-group">
                <label>Peso Propio (lb):</label>
                <input type="number" id="container-weight" min="0" max="50" value="3">
            </div>
            <div class="form-group">
                <label>Costo (po):</label>
                <input type="number" id="container-cost" min="0" value="5">
            </div>
            <div class="form-group full-width">
                <label>Descripci√≥n:</label>
                <textarea id="container-description" placeholder="Descripci√≥n del contenedor..."></textarea>
            </div>
        </div>
    `;
    
    document.getElementById('save-item-btn').style.display = 'inline-block';
    document.getElementById('save-item-btn').textContent = 'Crear Contenedor';
    document.getElementById('save-item-btn').onclick = saveCustomContainer;
}

// Show custom item modal
function showCustomItemModal() {
    closeEquipmentModal();
    
    document.getElementById('equipment-modal-title').textContent = 'Crear Item Personalizado';
    
    const modalBody = document.getElementById('equipment-modal-body');
    modalBody.innerHTML = `
        <div class="equipment-form">
            <div class="form-group">
                <label>Nombre:</label>
                <input type="text" id="custom-item-name" placeholder="Nombre del item">
            </div>
            <div class="form-group">
                <label>Categor√≠a:</label>
                <select id="custom-item-category">
                    <option value="weapons">Arma</option>
                    <option value="armor">Armadura</option>
                    <option value="gear">Equipo</option>
                    <option value="magic">Objeto M√°gico</option>
                </select>
            </div>
            <div class="form-group">
                <label>Peso (lb):</label>
                <input type="number" id="custom-item-weight" min="0" step="0.1" value="1">
            </div>
            <div class="form-group">
                <label>Costo (po):</label>
                <input type="number" id="custom-item-cost" min="0" value="1">
            </div>
            <div class="form-group">
                <label>Cantidad:</label>
                <input type="number" id="custom-item-quantity" min="1" value="1">
            </div>
            <div class="form-group">
                <label>Usos (0 = ilimitado):</label>
                <input type="number" id="custom-item-uses" min="0" value="0">
            </div>
            <div class="form-group full-width">
                <label>Descripci√≥n:</label>
                <textarea id="custom-item-description" placeholder="Descripci√≥n del item..."></textarea>
            </div>
        </div>
    `;
    
    document.getElementById('equipment-modal').style.display = 'flex';
    document.getElementById('save-item-btn').style.display = 'inline-block';
    document.getElementById('save-item-btn').textContent = 'Crear Item';
    document.getElementById('save-item-btn').onclick = saveCustomItem;
}

let selectedItem = null;

// Select item from database
function selectItem(category, index) {
    // Remove previous selection
    document.querySelectorAll('.selection-card.selected').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Add selection to clicked card
    event.target.closest('.selection-card').classList.add('selected');
    
    selectedItem = {
        category: category,
        index: index,
        data: equipmentDatabase[category][index]
    };
}

// Save selected item
function saveItem() {
    if (!selectedItem) {
        showEquipmentNotification('Selecciona un item primero', 'error');
        return;
    }
    
    const template = selectedItem.data;
    const newItem = {
        id: Date.now(),
        name: template.name,
        category: selectedItem.category,
        weight: template.weight || 0,
        cost: template.cost || 0,
        quantity: template.quantity || 1,
        uses: template.uses || 0,
        maxUses: template.uses || 0,
        equipped: false,
        condition: 'good', // good, damaged, broken
        description: template.effect || generateItemDescription(template),
        dateAdded: new Date().toLocaleDateString(),
        // Category-specific properties
        ...template
    };
    
    equipment[selectedItem.category].push(newItem);
    updateEquipmentDisplay();
    updateWeightInfo();
    updateManagementStats();
    closeEquipmentModal();
    
    showEquipmentNotification(`${template.name} a√±adido al inventario`, 'success');
}

// Save custom container
function saveCustomContainer() {
    const name = document.getElementById('container-name').value.trim();
    const capacity = parseInt(document.getElementById('container-capacity').value) || 30;
    const weight = parseFloat(document.getElementById('container-weight').value) || 3;
    const cost = parseFloat(document.getElementById('container-cost').value) || 5;
    const description = document.getElementById('container-description').value.trim();
    
    if (!name) {
        showEquipmentNotification('El nombre es requerido', 'error');
        return;
    }
    
    const newContainer = {
        id: Date.now(),
        name: name,
        category: 'containers',
        weight: weight,
        cost: cost,
        quantity: 1,
        capacity: capacity,
        currentLoad: 0,
        equipped: false,
        condition: 'good',
        description: description || `Contenedor con capacidad de ${capacity} lb`,
        dateAdded: new Date().toLocaleDateString(),
        contents: []
    };
    
    equipment.containers.push(newContainer);
    updateEquipmentDisplay();
    updateWeightInfo();
    updateManagementStats();
    closeEquipmentModal();
    
    showEquipmentNotification(`${name} a√±adido como contenedor`, 'success');
}

// Save custom item
function saveCustomItem() {
    const name = document.getElementById('custom-item-name').value.trim();
    const category = document.getElementById('custom-item-category').value;
    const weight = parseFloat(document.getElementById('custom-item-weight').value) || 1;
    const cost = parseFloat(document.getElementById('custom-item-cost').value) || 1;
    const quantity = parseInt(document.getElementById('custom-item-quantity').value) || 1;
    const uses = parseInt(document.getElementById('custom-item-uses').value) || 0;
    const description = document.getElementById('custom-item-description').value.trim();
    
    if (!name) {
        showEquipmentNotification('El nombre es requerido', 'error');
        return;
    }
    
    const newItem = {
        id: Date.now(),
        name: name,
        category: category,
        weight: weight,
        cost: cost,
        quantity: quantity,
        uses: uses,
        maxUses: uses,
        equipped: false,
        condition: 'good',
        description: description || 'Item personalizado',
        dateAdded: new Date().toLocaleDateString(),
        isCustom: true
    };
    
    equipment[category].push(newItem);
    updateEquipmentDisplay();
    updateWeightInfo();
    updateManagementStats();
    closeEquipmentModal();
    
    showEquipmentNotification(`${name} creado y a√±adido al inventario`, 'success');
}

// Generate item description
function generateItemDescription(item) {
    let desc = `${item.name}`;
    
    if (item.damage) desc += `. Da√±o: ${item.damage}`;
    if (item.ac) desc += `. CA: ${item.ac}`;
    if (item.range) desc += `. Alcance: ${item.range}`;
    if (item.effect) desc += `. ${item.effect}`;
    
    return desc;
}

// Close equipment modal
function closeEquipmentModal() {
    document.getElementById('equipment-modal').style.display = 'none';
    selectedItem = null;
    
    // Clear selection
    document.querySelectorAll('.selection-card.selected').forEach(card => {
        card.classList.remove('selected');
    });
    
    // Reset save button
    document.getElementById('save-item-btn').onclick = saveItem;
}

// Update equipment display
function updateEquipmentDisplay() {
    const categories = ['weapons', 'armor', 'gear', 'magic', 'containers'];
    
    categories.forEach(category => {
        const categoryItems = equipment[category];
        const container = document.getElementById(category);
        
        // Update category counts
        document.getElementById(`${category}-count`).textContent = categoryItems.length;
        document.getElementById(`${category}-weight`).textContent = 
            `${calculateCategoryWeight(category).toFixed(1)} lb`;
        
        if (categoryItems.length === 0) {
            container.innerHTML = `
                <div class="empty-equipment">
                    <p>${getCategoryEmpty<!-- EQUIPMENT TAB -->
<div id="equipment-tab" class="tab-content">
    <div class="equipment-container">
        <!-- Equipment Header -->
        <div class="equipment-header">
            <h2>üéí Equipo</h2>
            <div class="equipment-summary">
                <div class="weight-info">
                    <span class="current-weight" id="current-weight">0</span> /
                    <span class="max-weight" id="max-weight">100</span> lb
                    <div class="weight-bar">
                        <div class="weight-fill" id="weight-fill" style="width: 0%"></div>
                    </div>
                </div>
                <div class="equipment-actions">
                    <button class="add-item-btn" onclick="showAddItemModal()">‚ûï Agregar Item</button>
                    <button class="manage-equipment-btn" onclick="toggleEquipmentManagement()">‚öôÔ∏è Gestionar</button>
                    <button class="quick-equip-btn" onclick="showQuickEquipModal()">‚ö° Equipo R√°pido</button>
                </div>
            </div>
        </div>

        <!-- Equipment Categories -->
        <div class="equipment-categories">
            <!-- Weapons -->
            <div class="equipment-category" id="weapons-category">
                <div class="category-header" onclick="toggleEquipmentCategory('weapons')">
                    <h3>‚öîÔ∏è Armas</h3>
                    <div class="category-info">
                        <span class="item-count" id="weapons-count">0</span> items
                        <span class="category-weight" id="weapons-weight">0 lb</span>
                        <span class="category-toggle">‚ñº</span>
                    </div>
                </div>
                <div class="equipment-grid" id="weapons">
                    <div class="empty-equipment">
                        <p>‚öîÔ∏è No tienes armas</p>
                        <button class="add-category-btn" onclick="showAddWeapon()">Agregar Arma</button>
                    </div>
                </div>
            </div>

            <!-- Armor -->
            <div class="equipment-category" id="armor-category">
                <div class="category-header" onclick="toggleEquipmentCategory('armor')">
                    <h3>üõ°Ô∏è Armadura</h3>
                    <div class="category-info">
                        <span class="item-count" id="armor-count">0</span> items
                        <span class="category-weight" id="armor-weight">0 lb</span>
                        <span class="category-toggle">‚ñº</span>
                    </div>
                </div>
                <div class="equipment-grid" id="armor">
                    <div class="empty-equipment">
                        <p>üõ°Ô∏è No tienes armadura</p>
                        <button class="add-category-btn" onclick="showAddArmor()">Agregar Armadura</button>
                    </div>
                </div>
            </div>

            <!-- Adventuring Gear -->
            <div class="equipment-category" id="gear-category">
                <div class="category-header" onclick="toggleEquipmentCategory('gear')">
                    <h3>üéí Equipo de Aventura</h3>
                    <div class="category-info">
                        <span class="item-count" id="gear-count">0</span> items
                        <span class="category-weight" id="gear-weight">0 lb</span>
                        <span class="category-toggle">‚ñº</span>
                    </div>
                </div>
                <div class="equipment-grid" id="gear">
                    <div class="empty-equipment">
                        <p>üéí No tienes equipo de aventura</p>
                        <button class="add-category-btn" onclick="showAddGear()">Agregar Equipo</button>
                    </div>
                </div>
            </div>

            <!-- Magic Items -->
            <div class="equipment-category" id="magic-category">
                <div class="category-header" onclick="toggleEquipmentCategory('magic')">
                    <h3>‚ú® Objetos M√°gicos</h3>
                    <div class="category-info">
                        <span class="item-count" id="magic-count">0</span> items
                        <span class="category-weight" id="magic-weight">0 lb</span>
                        <span class="category-toggle">‚ñº</span>
                    </div>
                </div>
                <div class="equipment-grid" id="magic">
                    <div class="empty-equipment">
                        <p>‚ú® No tienes objetos m√°gicos</p>
                        <button class="add-category-btn" onclick="showAddMagicItem()">Agregar Objeto M√°gico</button>
                    </div>
                </div>
            </div>

            <!-- Currency -->
            <div class="equipment-category" id="currency-category">
                <div class="category-header" onclick="toggleEquipmentCategory('currency')">
                    <h3>üí∞ Monedas</h3>
                    <div class="category-info">
                        <span class="total-value" id="total-currency-value">0</span> po
                        <span class="category-toggle">‚ñº</span>
                    </div>
                </div>
                <div class="currency-grid" id="currency">
                    <div class="currency-item">
                        <label>üí∞ Oro (po):</label>
                        <input type="number" id="gold-coins" min="0" value="0" onchange="updateCurrency()">
                    </div>
                    <div class="currency-item">
                        <label>ü•à Plata (pp):</label>
                        <input type="number" id="silver-coins" min="0" value="0" onchange="updateCurrency()">
                    </div>
                    <div class="currency-item">
                        <label>ü•â Cobre (pc):</label>
                        <input type="number" id="copper-coins" min="0" value="0" onchange="updateCurrency()">
                    </div>
                    <div class="currency-item">
                        <label>üíé Electrum (pe):</label>
                        <input type="number" id="electrum-coins" min="0" value="0" onchange="updateCurrency()">
                    </div>
                    <div class="currency-item">
                        <label>üíç Platino (pla):</label>
                        <input type="number" id="platinum-coins" min="0" value="0" onchange="updateCurrency()">
                    </div>
                    <div class="currency-total">
                        <strong>Total: <span id="currency-total">0</span> po</strong>
                    </div>
                </div>
            </div>

            <!-- Containers -->
            <div class="equipment-category" id="containers-category">
                <div class="category-header" onclick="toggleEquipmentCategory('containers')">
                    <h3>üì¶ Contenedores</h3>
                    <div class="category-info">
                        <span class="item-count" id="containers-count">0</span> items
                        <span class="category-weight" id="containers-weight">0 lb</span>
                        <span class="category-toggle">‚ñº</span>
                    </div>
                </div>
                <div class="equipment-grid" id="containers">
                    <div class="empty-equipment">
                        <p>üì¶ No tienes contenedores</p>
                        <button class="add-category-btn" onclick="showAddContainer()">Agregar Contenedor</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Equipment Management Panel -->
        <div class="equipment-management" id="equipment-management" style="display: none;">
            <div class="management-header">
                <h3>‚öôÔ∏è Gesti√≥n de Equipo</h3>
                <button class="close-management-btn" onclick="toggleEquipmentManagement()">‚úñÔ∏è</button>
            </div>
            <div class="management-content">
                <div class="management-actions">
                    <button class="action-btn sort-equipment" onclick="sortEquipment()">üìä Ordenar</button>
                    <button class="action-btn repair-equipment" onclick="repairAllEquipment()">üîß Reparar Todo</button>
                    <button class="action-btn sell-equipment" onclick="showSellModal()">üí∞ Vender Items</button>
                    <button class="action-btn export-equipment" onclick="exportEquipment()">üì§ Exportar</button>
                </div>
                <div class="management-stats">
                    <div class="stat-card">
                        <span class="stat-value" id="total-items">0</span>
                        <span class="stat-label">Items Totales</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="total-value">0</span>
                        <span class="stat-label">Valor Total (po)</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value" id="equipped-items">0</span>
                        <span class="stat-label">Items Equipados</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Item Modal -->
<div class="equipment-modal" id="equipment-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="equipment-modal-title">‚ûï Agregar Item</h3>
            <button class="modal-close" onclick="closeEquipmentModal()">‚úñÔ∏è</button>
        </div>
        <div class="modal-body" id="equipment-modal-body">
            <!-- Dynamic content will be loaded here -->
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeEquipmentModal()">Cancelar</button>
            <button class="modal-btn save" id="save-item-btn" onclick="saveItem()">Agregar Item</button>
        </div>
    </div>
</div>

<!-- Equipment Detail Modal -->
<div class="equipment-detail-modal" id="equipment-detail-modal" style="display: none;">
    <div class="detail-modal-content">
        <div class="detail-modal-header">
            <h3 id="detail-item-name">Item</h3>
            <div class="detail-modal-actions">
                <button class="modal-action-btn" onclick="editItem()" title="Editar">‚úèÔ∏è</button>
                <button class="modal-action-btn" onclick="duplicateItem()" title="Duplicar">üìã</button>
                <button class="modal-action-btn" onclick="toggleItemEquipped()" title="Equipar/Desequipar" id="equip-toggle-btn">üëï</button>
                <button class="modal-action-btn danger" onclick="removeItem()" title="Eliminar">üóëÔ∏è</button>
                <button class="modal-close" onclick="closeEquipmentDetailModal()">‚úñÔ∏è</button>
            </div>
        </div>
        <div class="detail-modal-body" id="equipment-detail-modal-body">
            <!-- Item details will be loaded here -->
        </div>
    </div>
</div>

<!-- Quick Equip Modal -->
<div class="quick-equip-modal" id="quick-equip-modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>‚ö° Equipo R√°pido por Clase</h3>
            <button class="modal-close" onclick="closeQuickEquipModal()">‚úñÔ∏è</button>
        </div>
        <div class="modal-body">
            <div class="quick-equip-options">
                <div class="equip-option" onclick="equipClass('fighter')">
                    <h4>‚öîÔ∏è Guerrero</h4>
                    <p>Espada larga, cota de mallas, escudo, arco largo</p>
                </div>
                <div class="equip-option" onclick="equipClass('wizard')">
                    <h4>üßô Mago</h4>
                    <p>Bast√≥n, t√∫nica, libro de conjuros, componentes</p>
                </div>
                <div class="equip-option" onclick="equipClass('cleric')">
                    <h4>‚õ™ Cl√©rigo</h4>
                    <p>Maza, cota de escamas, escudo, s√≠mbolo sagrado</p>
                </div>
                <div class="equip-option" onclick="equipClass('thief')">
                    <h4>ü•∑ Ladr√≥n</h4>
                    <p>Espada corta, armadura de cuero, ganz√∫as, cuerda</p>
                </div>
                <div class="equip-option" onclick="equipClass('ranger')">
                    <h4>üèπ Ranger</h4>
                    <p>Arco largo, espadas gemelas, armadura de cuero, equipo de supervivencia</p>
                </div>
                <div class="equip-option" onclick="equipClass('adventurer')">
                    <h4>üéí Aventurero B√°sico</h4>
                    <p>Equipo de aventura est√°ndar, antorchas, raciones, cuerda</p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn cancel" onclick="closeQuickEquipModal()">Cerrar</button>
        </div>
    </div>
</div>

<!-- EQUIPMENT TAB CSS -->
<style>
.equipment-container {
    padding: 1rem;
    max-width: 1400px;
    margin: 0 auto;
}

/* Equipment Header */
.equipment-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 2rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #4a5568;
}

.equipment-header h2 {
    color: #f7fafc;
    margin: 0;
}

.equipment-summary {
    display: flex;
    align-items: center;
    gap: 2rem;
}

.weight-info {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
    padding: 0.8rem 1.2rem;
    border-radius: 8px;
    color: white;
    font-weight: bold;
    min-width: 200px;
}

.current-weight {
    font-size: 1.1rem;
}

.weight-bar {
    width: 100%;
    height: 6px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: 3px;
    margin-top: 0.5rem;
    overflow: hidden;
}

.weight-fill {
    height: 100%;
    background: linear-gradient(90deg, #48bb78, #f56565);
    transition: width 0.3s ease;
    border-radius: 3px;
}

.weight-fill.overloaded {
    background: linear-gradient(90deg, #f56565, #e53e3e);
}

.equipment-actions {
    display: flex;
    gap: 1rem;
}

.add-item-btn, .manage-equipment-btn, .quick-equip-btn {
    padding: 0.6rem 1.2rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.add-item-btn {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

.manage-equipment-btn {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
}

.quick-equip-btn {
    background: linear-gradient(135deg, #805ad5, #6b46c1);
    color: white;
}

.add-item-btn:hover, .manage-equipment-btn:hover, .quick-equip-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

/* Equipment Categories */
.equipment-categories {
    margin-bottom: 2rem;
}

.equipment-category {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 1px solid #4a5568;
    border-radius: 12px;
    margin-bottom: 1.5rem;
    overflow: hidden;
}

.category-header {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    padding: 1rem 1.5rem;
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #4a5568;
    transition: all 0.3s ease;
}

.category-header:hover {
    background: linear-gradient(135deg, #4a5568, #2d3748);
}

.category-header h3 {
    color: #e2e8f0;
    margin: 0;
    font-size: 1.2rem;
}

.category-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    color: #cbd5e0;
    font-size: 0.9rem;
}

.item-count, .category-weight, .total-value {
    background: rgba(66, 153, 225, 0.2);
    padding: 0.3rem 0.8rem;
    border-radius: 12px;
    font-weight: bold;
}

.category-toggle {
    font-size: 1.2rem;
    transition: transform 0.3s ease;
}

.category-header.collapsed .category-toggle {
    transform: rotate(-90deg);
}

.equipment-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1rem;
    padding: 1.5rem;
    min-height: 120px;
}

.equipment-grid.collapsed {
    display: none;
}

.empty-equipment {
    grid-column: 1 / -1;
    text-align: center;
    color: #718096;
    padding: 2rem;
    border: 2px dashed #4a5568;
    border-radius: 12px;
    background: rgba(0, 0, 0, 0.2);
}

.empty-equipment p {
    margin: 0 0 1rem 0;
    font-size: 1.1rem;
}

.add-category-btn {
    background: linear-gradient(135deg, #805ad5, #6b46c1);
    border: none;
    padding: 0.8rem 1.5rem;
    border-radius: 8px;
    color: white;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
}

.add-category-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
}

/* Equipment Cards */
.equipment-card {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 1px solid #4a5568;
    border-radius: 12px;
    padding: 1rem;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
}

.equipment-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.4);
    border-color: #805ad5;
}

.equipment-card.equipped {
    border-left: 4px solid #48bb78;
    box-shadow: 0 0 0 2px rgba(72, 187, 120, 0.2);
}

.equipment-card.weapon {
    border-left: 4px solid #f56565;
}

.equipment-card.armor {
    border-left: 4px solid #4299e1;
}

.equipment-card.magic {
    border-left: 4px solid #ed64a6;
}

.equipment-card.gear {
    border-left: 4px solid #ed8936;
}

.item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.item-info h4 {
    color: #e2e8f0;
    margin: 0 0 0.3rem 0;
    font-size: 1.1rem;
}

.item-type {
    color: #cbd5e0;
    font-size: 0.9rem;
    font-style: italic;
}

.item-quantity {
    background: linear-gradient(135deg, #805ad5, #6b46c1);
    color: white;
    padding: 0.3rem 0.8rem;
    border-radius: 12px;
    font-size: 0.8rem;
    font-weight: bold;
}

.item-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.stat-item {
    text-align: center;
    background: rgba(0, 0, 0, 0.3);
    padding: 0.5rem;
    border-radius: 6px;
}

.stat-value {
    display: block;
    color: #e2e8f0;
    font-weight: bold;
    font-size: 1rem;
}

.stat-label {
    display: block;
    color: #a0aec0;
    font-size: 0.7rem;
    margin-top: 0.2rem;
}

.item-description {
    color: #a0aec0;
    font-size: 0.9rem;
    line-height: 1.4;
    margin-bottom: 1rem;
    max-height: 60px;
    overflow: hidden;
}

.item-actions {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
}

.item-action-btn {
    flex: 1;
    min-width: 70px;
    padding: 0.4rem 0.8rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.8rem;
    font-weight: bold;
    transition: all 0.3s ease;
}

.action-equip {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

.action-equip.equipped {
    background: linear-gradient(135deg, #ed8936, #dd6b20);
}

.action-use {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
}

.action-sell {
    background: linear-gradient(135deg, #f56565, #e53e3e);
    color: white;
}

.item-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

.item-action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

/* Status indicators */
.item-status {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    display: flex;
    gap: 0.3rem;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid #2d3748;
}

.status-equipped {
    background: #48bb78;
}

.status-damaged {
    background: #ed8936;
}

.status-broken {
    background: #f56565;
}

.status-magical {
    background: #ed64a6;
}

/* Currency Grid */
.currency-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    padding: 1.5rem;
}

.currency-item {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 1px solid #4a5568;
    border-radius: 8px;
    padding: 1rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.currency-item label {
    color: #e2e8f0;
    font-weight: bold;
}

.currency-item input {
    width: 80px;
    padding: 0.5rem;
    background: #1a202c;
    border: 1px solid #4a5568;
    border-radius: 4px;
    color: #e2e8f0;
    text-align: center;
}

.currency-total {
    grid-column: 1 / -1;
    background: linear-gradient(135deg, #ed8936, #dd6b20);
    color: white;
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    font-size: 1.1rem;
}

/* Management Panel */
.equipment-management {
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    border: 1px solid #4a5568;
    border-radius: 12px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}

.management-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 1px solid #4a5568;
}

.management-header h3 {
    color: #e2e8f0;
    margin: 0;
}

.close-management-btn {
    background: #e53e3e;
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    cursor: pointer;
    font-size: 1rem;
}

.management-content {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 2rem;
    align-items: start;
}

.management-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
}

.action-btn {
    padding: 0.8rem 1.2rem;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.sort-equipment {
    background: linear-gradient(135deg, #805ad5, #6b46c1);
    color: white;
}

.repair-equipment {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
}

.sell-equipment {
    background: linear-gradient(135deg, #f56565, #e53e3e);
    color: white;
}

.export-equipment {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
}

.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
}

.management-stats {
    display: flex;
    gap: 1rem;
}

.stat-card {
    background: rgba(0, 0, 0, 0.3);
    padding: 1rem;
    border-radius: 8px;
    text-align: center;
    min-width: 100px;
}

.stat-card .stat-value {
    color: #4299e1;
    font-size: 1.5rem;
    font-weight: bold;
    display: block;
    margin-bottom: 0.5rem;
}

.stat-card .stat-label {
    color: #cbd5e0;
    font-size: 0.8rem;
}

/* Modal Styles */
.equipment-modal, .equipment-detail-modal, .quick-equip-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.modal-content, .detail-modal-content {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    border: 1px solid #4a5568;
    border-radius: 12px;
    width: 90%;
    max-width: 800px;
    max-height: 90vh;
    overflow-y: auto;
}

.modal-header, .detail-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #4a5568;
}

.modal-header h3, .detail-modal-header h3 {
    margin: 0;
    color: #e2e8f0;
}

.detail-modal-actions {
    display: flex;
    gap: 0.5rem;
}

.modal-action-btn {
    background: #4a5568;
    border: none;
    color: white;
    width: 35px;
    height: 35px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.modal-action-btn:hover {
    background: #718096;
    transform: scale(1.1);
