<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AD&D 2.Pandunk - Basic Tab</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e, #16213e, #0f3460);
            color: #e5e5e5;
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 2rem;
        }

        h2 {
            color: #ffd700;
            margin-bottom: 2rem;
            text-align: center;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-label {
            font-weight: 600;
            color: #ffd700;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input {
            padding: 0.8rem 1rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: #e5e5e5;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.2);
        }

        .saves-headers {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0.8rem 1rem;
            background: rgba(0, 150, 0, 0.15);
            border-radius: 8px;
            border: 1px solid rgba(0, 150, 0, 0.3);
        }

        .save-type-header {
            color: #90EE90;
            font-weight: bold;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex: 2;
        }

        .save-data-headers {
            display: flex;
            align-items: center;
            gap: 2rem;
            flex: 3;
        }

        .header-item {
            color: #90EE90;
            font-weight: bold;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            text-align: center;
            min-width: 60px;
        }

        .saving-throws-vertical {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            margin-bottom: 2rem;
        }

        .saving-throw-row {
            background: rgba(0, 150, 0, 0.08);
            border: 1px solid rgba(0, 150, 0, 0.25);
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: all 0.3s ease;
        }

        .saving-throw-row:hover {
            background: rgba(0, 150, 0, 0.12);
            border-color: rgba(0, 150, 0, 0.4);
            transform: translateX(3px);
        }

        .save-type-name {
            color: #e5e5e5;
            font-weight: 600;
            font-size: 0.95rem;
            flex: 2;
            min-width: 200px;
        }

        .save-data-row {
            display: flex;
            align-items: center;
            gap: 2rem;
            flex: 3;
        }

        .save-value {
            color: #00FF7F;
            font-weight: bold;
            font-size: 1.1rem;
            min-width: 60px;
            text-align: center;
            background: rgba(0, 255, 127, 0.1);
            padding: 0.3rem 0.6rem;
            border-radius: 6px;
            border: 1px solid rgba(0, 255, 127, 0.3);
        }

        .save-modifier-input {
            width: 60px;
            padding: 0.4rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #e5e5e5;
            font-size: 0.9rem;
            text-align: center;
            font-weight: 500;
        }

        .save-modifier-input:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.3);
        }

        .save-total-value {
            color: #ffd700;
            font-weight: bold;
            font-size: 1.2rem;
            min-width: 60px;
            text-align: center;
            background: rgba(255, 215, 0, 0.15);
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            border: 2px solid rgba(255, 215, 0, 0.4);
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(255, 215, 0, 0.3);
        }

        .stat-value-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #ffd700;
            margin-bottom: 0.5rem;
        }

        .stat-detail {
            font-size: 0.8rem;
            color: #b0b0b0;
            text-align: center;
            min-height: 20px;
            font-weight: 500;
        }

        .stat-label {
            color: #b0b0b0;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .manual-bonus-input {
            width: 70px;
            padding: 0.3rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 6px;
            color: #e5e5e5;
            font-size: 0.8rem;
            text-align: center;
            margin-top: 0.3rem;
        }

        .manual-bonus-input:focus {
            outline: none;
            border-color: #ffd700;
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 8px rgba(255, 215, 0, 0.2);
        }

        .mana-card {
            background: linear-gradient(135deg, rgba(75, 0, 130, 0.1), rgba(138, 43, 226, 0.1));
            border: 1px solid rgba(138, 43, 226, 0.3);
        }

        .psp-card {
            background: linear-gradient(135deg, rgba(255, 20, 147, 0.1), rgba(199, 21, 133, 0.1));
            border: 1px solid rgba(199, 21, 133, 0.3);
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Información Básica del Personaje</h2>
        
        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">Nombre del Personaje</label>
                <input type="text" class="form-input" id="characterName" placeholder="Nombre">
            </div>
            
            <div class="form-group">
                <label class="form-label">Jugador</label>
                <input type="text" class="form-input" id="playerName" placeholder="Tu nombre">
            </div>
            
            <div class="form-group">
                <label class="form-label">Raza</label>
                <select class="form-input" id="race">
                    <option value="">Selecciona Raza</option>
                    <option value="humano">Humano</option>
                    <option value="elfo">Elfo</option>
                    <option value="enano">Enano</option>
                    <option value="mediano">Mediano</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Alineamiento</label>
                <select class="form-input" id="alignment">
                    <option value="LB">Legal Bueno</option>
                    <option value="NB">Neutral Bueno</option>
                    <option value="CB">Caótico Bueno</option>
                    <option value="LN">Legal Neutral</option>
                    <option value="N" selected>Neutral Auténtico</option>
                    <option value="CN">Caótico Neutral</option>
                    <option value="LM">Legal Malvado</option>
                    <option value="NM">Neutral Malvado</option>
                    <option value="CM">Caótico Malvado</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Altura (cm)</label>
                <input type="number" class="form-input" id="characterHeight" min="1" max="30000" placeholder="175">
            </div>

            <div class="form-group">
                <label class="form-label">Tamaño</label>
                <input type="text" class="form-input" id="characterSize" value="Mediano" readonly>
            </div>

            <div class="form-group">
                <label class="form-label">Experiencia</label>
                <input type="number" class="form-input" id="experience" value="0">
            </div>
            
            <div class="form-group">
                <label class="form-label">Nivel</label>
                <input type="number" class="form-input" id="Level" value="1" min="1" max="30">
            </div>
        </div>

        <h3 style="color: #ffd700; margin-top: 2rem; margin-bottom: 1rem;">Tiradas de Salvación</h3>
        
        <div class="saves-headers">
            <div class="save-type-header">Tipo de Salvación</div>
            <div class="save-data-headers">
                <span class="header-item">Base</span>
                <span class="header-item">Mod1</span>
                <span class="header-item">Mod2</span>
                <span class="header-item">Total</span>
            </div>
        </div>
        
        <div class="saving-throws-vertical">
            <div class="saving-throw-row">
                <div class="save-type-name">Parálisis/Veneno/Muerte</div>
                <div class="save-data-row">
                    <span class="save-value" id="save-paralysis-base">14</span>
                    <input type="number" id="save-paralysis-mod1" value="0" class="save-modifier-input">
                    <input type="number" id="save-paralysis-mod2" value="0" class="save-modifier-input">
                    <span class="save-total-value" id="save-paralysis-total">14</span>
                </div>
            </div>
            
            <div class="saving-throw-row">
                <div class="save-type-name">Cetros/Varas/Varitas</div>
                <div class="save-data-row">
                    <span class="save-value" id="save-rods-base">16</span>
                    <input type="number" id="save-rods-mod1" value="0" class="save-modifier-input">
                    <input type="number" id="save-rods-mod2" value="0" class="save-modifier-input">
                    <span class="save-total-value" id="save-rods-total">16</span>
                </div>
            </div>
            
            <div class="saving-throw-row">
                <div class="save-type-name">Petrificación/Polimorfismo</div>
                <div class="save-data-row">
                    <span class="save-value" id="save-petrification-base">12</span>
                    <input type="number" id="save-petrification-mod1" value="0" class="save-modifier-input">
                    <input type="number" id="save-petrification-mod2" value="0" class="save-modifier-input">
                    <span class="save-total-value" id="save-petrification-total">12</span>
                </div>
            </div>
            
            <div class="saving-throw-row">
                <div class="save-type-name">Arma de Aliento</div>
                <div class="save-data-row">
                    <span class="save-value" id="save-breath-base">17</span>
                    <input type="number" id="save-breath-mod1" value="0" class="save-modifier-input">
                    <input type="number" id="save-breath-mod2" value="0" class="save-modifier-input">
                    <span class="save-total-value" id="save-breath-total">17</span>
                </div>
            </div>
            
            <div class="saving-throw-row">
                <div class="save-type-name">Conjuros</div>
                <div class="save-data-row">
                    <span class="save-value" id="save-spells-base">17</span>
                    <input type="number" id="save-spells-mod1" value="0" class="save-modifier-input">
                    <input type="number" id="save-spells-mod2" value="0" class="save-modifier-input">
                    <span class="save-total-value" id="save-spells-total">17</span>
                </div>
            </div>
        </div>

        <h3 style="color: #ffd700; margin-top: 2rem; margin-bottom: 1rem;">Estadísticas Principales</h3>
        
        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value-container">
                    <div class="stat-value" id="totalHP">10</div>
                    <div class="stat-detail" id="hp-breakdown">10 base</div>
                    <input type="number" id="hp-manual-bonus" value="0" class="manual-bonus-input" placeholder="Bonus">
                </div>
                <div class="stat-label">Puntos de Golpe</div>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-card mana-card" id="arcane-mana-card" style="display: none;">
                <div class="stat-value-container">
                    <div class="stat-value" id="arcaneMana">0</div>
                    <div class="stat-detail" id="arcane-mana-breakdown">-</div>
                    <input type="number" id="arcane-mana-manual" value="0" class="manual-bonus-input" placeholder="Bonus">
                </div>
                <div class="stat-label">Maná Arcano</div>
            </div>
            
            <div class="stat-card mana-card" id="divine-mana-card" style="display: none;">
                <div class="stat-value-container">
                    <div class="stat-value" id="divineMana">0</div>
                    <div class="stat-detail" id="divine-mana-breakdown">-</div>
                    <input type="number" id="divine-mana-manual" value="0" class="manual-bonus-input" placeholder="Bonus">
                </div>
                <div class="stat-label">Maná Divino</div>
            </div>
            
            <div class="stat-card psp-card" id="psp-card" style="display: none;">
                <div class="stat-value-container">
                    <div class="stat-value" id="pspPool">0</div>
                    <div class="stat-detail" id="psp-breakdown">-</div>
                    <input type="number" id="psp-manual" value="0" class="manual-bonus-input" placeholder="Bonus">
                </div>
                <div class="stat-label">Pool PSP</div>
            </div>
        </div>

        <!-- Campos ocultos para simular los dropdowns y totales de habilidades -->
        <div style="display: none;">
            <div id="primary-selected-name">Guerrero</div>
            <div id="secondary-selected-name">Ninguno</div>
            <div id="tertiary-selected-name">Ninguno</div>
            <div id="con-hp">0</div>
            <div id="int-total">10</div>
            <div id="wis-total">10</div>
            <div id="cha-total">10</div>
        </div>
    </div>

    <script>
        const CharacterCalculator = (function() {
            const SAVING_THROWS = {
                "luchador": {
                    1: {paralysis: 14, rods: 16, petrification: 15, breath: 17, spells: 17},
                    3: {paralysis: 13, rods: 15, petrification: 14, breath: 16, spells: 16},
                    5: {paralysis: 11, rods: 13, petrification: 12, breath: 13, spells: 14},
                    7: {paralysis: 10, rods: 12, petrification: 11, breath: 12, spells: 13},
                    9: {paralysis: 8, rods: 10, petrification: 9, breath: 9, spells: 11},
                    11: {paralysis: 7, rods: 9, petrification: 8, breath: 8, spells: 10},
                    13: {paralysis: 5, rods: 7, petrification: 6, breath: 5, spells: 8},
                    15: {paralysis: 4, rods: 6, petrification: 5, breath: 4, spells: 7},
                    17: {paralysis: 3, rods: 5, petrification: 4, breath: 4, spells: 6}
                },
                "sacerdote": {
                    1: {paralysis: 10, rods: 14, petrification: 13, breath: 16, spells: 15},
                    3: {paralysis: 9, rods: 13, petrification: 12, breath: 15, spells: 14},
                    5: {paralysis: 7, rods: 11, petrification: 10, breath: 13, spells: 12},
                    7: {paralysis: 6, rods: 10, petrification: 9, breath: 12, spells: 11},
                    9: {paralysis: 4, rods: 8, petrification: 7, breath: 10, spells: 9},
                    11: {paralysis: 3, rods: 7, petrification: 6, breath: 9, spells: 8},
                    13: {paralysis: 2, rods: 5, petrification: 4, breath: 7, spells: 6},
                    15: {paralysis: 1, rods: 4, petrification: 3, breath: 6, spells: 5},
                    17: {paralysis: 1, rods: 2, petrification: 2, breath: 5, spells: 4}
                },
                "hechicero": {
                    1: {paralysis: 14, rods: 11, petrification: 13, breath: 15, spells: 12},
                    3: {paralysis: 13, rods: 10, petrification: 12, breath: 14, spells: 11},
                    5: {paralysis: 11, rods: 8, petrification: 10, breath: 12, spells: 9},
                    7: {paralysis: 10, rods: 7, petrification: 9, breath: 11, spells: 8},
                    9: {paralysis: 8, rods: 5, petrification: 7, breath: 9, spells: 6},
                    11: {paralysis: 7, rods: 4, petrification: 6, breath: 8, spells: 5},
                    13: {paralysis: 5, rods: 2, petrification: 4, breath: 6, spells: 3},
                    15: {paralysis: 4, rods: 1, petrification: 3, breath: 5, spells: 2},
                    17: {paralysis: 3, rods: 1, petrification: 2, breath: 4, spells: 1}
                },
                "bribon": {
                    1: {paralysis: 13, rods: 14, petrification: 12, breath: 16, spells: 15},
                    3: {paralysis: 12, rods: 13, petrification: 11, breath: 15, spells: 14},
                    5: {paralysis: 11, rods: 12, petrification: 10, breath: 14, spells: 13},
                    7: {paralysis: 10, rods: 11, petrification: 9, breath: 13, spells: 12},
                    9: {paralysis: 9, rods: 10, petrification: 8, breath: 12, spells: 11},
                    11: {paralysis: 8, rods: 9, petrification: 7, breath: 11, spells: 10},
                    13: {paralysis: 7, rods: 8, petrification: 6, breath: 10, spells: 9},
                    15: {paralysis: 6, rods: 7, petrification: 5, breath: 9, spells: 8},
                    17: {paralysis: 5, rods: 6, petrification: 4, breath: 8, spells: 7}
                }
            };

            const PSP_TABLE = {
                wisdom: {
                    1: {base: 0, perLevel: 0}, 9: {base: 1, perLevel: 0}, 10: {base: 2, perLevel: 0},
                    11: {base: 3, perLevel: 0}, 12: {base: 5, perLevel: 0}, 13: {base: 6, perLevel: 1},
                    14: {base: 7, perLevel: 1}, 15: {base: 8, perLevel: 2}, 16: {base: 9, perLevel: 2},
                    17: {base: 10, perLevel: 3}, 18: {base: 11, perLevel: 3}, 19: {base: 12, perLevel: 4},
                    20: {base: 13, perLevel: 4}, 21: {base: 14, perLevel: 5}, 25: {base: 18, perLevel: 9}
                },
                intelligence: {
                    1: {bonus: 0}, 9: {bonus: 1}, 10: {bonus: 2}, 11: {bonus: 3}, 12: {bonus: 4},
                    13: {bonus: 5}, 14: {bonus: 6}, 15: {bonus: 7}, 16: {bonus: 8}, 17: {bonus: 9},
                    18: {bonus: 10}, 19: {bonus: 11}, 20: {bonus: 12}, 25: {bonus: 17}
                },
                constitution: {
                    1: {bonus: 0}, 9: {bonus: 1}, 10: {bonus: 2}, 11: {bonus: 3}, 12: {bonus: 4},
                    13: {bonus: 5}, 14: {bonus: 6}, 15: {bonus: 7}, 16: {bonus: 8}, 17: {bonus: 9},
                    18: {bonus: 10}, 19: {bonus: 11}, 20: {bonus: 12}, 25: {bonus: 17}
                }
            };

            const HIT_DICE = {
                "Bárbaro": 12, "Guerrero": 10, "Ranger": 10, "Paladín": 10, "Samurái": 10,
                "Clérigo": 8, "Druida": 8, "Chamán": 8,
                "Mago": 4, "Hechicero": 4, "Bruja": 4, "Artífice": 4,
                "Ladrón": 6, "Bardo": 6, "Ninja": 6, "Psiónico": 6, "Pistolero": 6
            };

            const SPELLCASTING_CLASSES = {
                arcane: ["Mago", "Bruja", "Artífice"],
                divine: ["Clérigo", "Druida", "Chamán"],
                charisma: ["Bardo", "Hechicero"]
            };

            function findClosestLevel(table, level) {
                const levels = Object.keys(table).map(Number).sort((a, b) => a - b);
                for (let i = levels.length - 1; i >= 0; i--) {
                    if (level >= levels[i]) return table[levels[i]];
                }
                return table[levels[0]];
            }

            function findClosestScore(table, score) {
                const scores = Object.keys(table).map(Number).sort((a, b) => a - b);
                for (let i = scores.length - 1; i >= 0; i--) {
                    if (score >= scores[i]) return table[scores[i]];
                }
                return table[scores[0]];
            }

            function getSelectedClass(id) {
                const el = document.getElementById(id);
                return el ? el.textContent.trim() : "";
            }

            function getCategoryFromClass(className) {
                if (["Bárbaro", "Guerrero", "Ranger", "Paladín", "Samurái"].includes(className)) return "luchador";
                if (["Clérigo", "Druida", "Chamán"].includes(className)) return "sacerdote";
                if (["Mago", "Hechicero", "Bruja", "Artífice"].includes(className)) return "hechicero";
                if (["Ladrón", "Bardo", "Ninja", "Psiónico", "Pistolero"].includes(className)) return "bribon";
                return null;
            }

            function getAbilityScore(id) {
                const el = document.getElementById(id);
                return el ? parseInt(el.textContent) || 10 : 10;
            }

            function updateSavingThrows() {
                const primaryClass = getSelectedClass('primary-selected-name');
                const category = getCategoryFromClass(primaryClass);
                const level = parseInt(document.getElementById('Level')?.value) || 1;

                if (!category) return;

                const saves = findClosestLevel(SAVING_THROWS[category], level);
                
                document.getElementById('save-paralysis-base').textContent = saves.paralysis;
                document.getElementById('save-rods-base').textContent = saves.rods;
                document.getElementById('save-petrification-base').textContent = saves.petrification;
                document.getElementById('save-breath-base').textContent = saves.breath;
                document.getElementById('save-spells-base').textContent = saves.spells;

                ['paralysis', 'rods', 'petrification', 'breath', 'spells'].forEach(type => {
                    const base = parseInt(document.getElementById(`save-${type}-base`).textContent) || 0;
                    const mod1 = parseInt(document.getElementById(`save-${type}-mod1`).value) || 0;
                    const mod2 = parseInt(document.getElementById(`save-${type}-mod2`).value) || 0;
                    document.getElementById(`save-${type}-total`).textContent = base + mod1 + mod2;
                });
            }

            function updateHitPoints() {
                const level = parseInt(document.getElementById('Level')?.value) || 1;
                const conHP = getAbilityScore('con-hp');
                const manualBonus = parseInt(document.getElementById('hp-manual-bonus')?.value) || 0;

                const primaryClass = getSelectedClass('primary-selected-name');
                const secondaryClass = getSelectedClass('secondary-selected-name');
                const tertiaryClass = getSelectedClass('tertiary-selected-name');

                let totalHP = 10;
                let breakdown = "10 base";

                if (level === 1) {
                    totalHP += conHP;
                    breakdown += ` + ${conHP} CON`;
                } else {
                    const classes = [primaryClass, secondaryClass, tertiaryClass].filter(c => 
                        c && c !== "Selecciona una clase" && c !== "Ninguno" && HIT_DICE[c]
                    );

                    if (classes.length > 0) {
                        let avgHD = classes.reduce((sum, cls) => sum + (HIT_DICE[cls] || 6), 0) / classes.length;
                        let levelHP = Math.floor(avgHD * (level - 1));
                        totalHP = 10 + levelHP + (conHP * level);
                        breakdown = `10 + ${levelHP} HD + (${conHP}×${level})`;
                    }
                }

                totalHP += manualBonus;
                if (manualBonus !== 0) breakdown += ` + ${manualBonus}`;

                document.getElementById('totalHP').textContent = totalHP;
                document.getElementById('hp-breakdown').textContent = breakdown;
            }

            function updateManaPoolsAndPSP() {
                const level = parseInt(document.getElementById('Level')?.value) || 1;
                const primaryClass = getSelectedClass('primary-selected-name');
                const secondaryClass = getSelectedClass('secondary-selected-name');
                const tertiaryClass = getSelectedClass('tertiary-selected-name');

                const classes = [primaryClass, secondaryClass, tertiaryClass];
                
                let hasArcane = false, hasDivine = false, hasCharisma = false, hasPsionic = false;

                classes.forEach(cls => {
                    if (SPELLCASTING_CLASSES.arcane.includes(cls)) hasArcane = true;
                    if (SPELLCASTING_CLASSES.divine.includes(cls)) hasDivine = true;
                    if (SPELLCASTING_CLASSES.charisma.includes(cls)) hasCharisma = true;
                    if (cls === "Psiónico") hasPsionic = true;
                });

                document.getElementById('arcane-mana-card').style.display = (hasArcane || hasCharisma) ? 'block' : 'none';
                document.getElementById('divine-mana-card').style.display = hasDivine ? 'block' : 'none';
                document.getElementById('psp-card').style.display = hasPsionic ? 'block' : 'none';

                if (hasArcane || hasCharisma) {
                    const int = getAbilityScore('int-total');
                    const cha = getAbilityScore('cha-total');
                    const wis = getAbilityScore('wis-total');
                    
                    const primaryStat = hasArcane ? int : cha;
                    const mana = Math.round((wis / 4) + (primaryStat + 1)) * level;
                    const manual = parseInt(document.getElementById('arcane-mana-manual')?.value) || 0;
                    
                    document.getElementById('arcaneMana').textContent = mana + manual;
                    document.getElementById('arcane-mana-breakdown').textContent = 
                        `((${wis}/4)+(${primaryStat}+1))×${level}`;
                }

                if (hasDivine) {
                    const wis = getAbilityScore('wis-total');
                    const mana = Math.round((wis / 4) + (wis + 1)) * level;
                    const manual = parseInt(document.getElementById('divine-mana-manual')?.value) || 0;
                    
                    document.getElementById('divineMana').textContent = mana + manual;
                    document.getElementById('divine-mana-breakdown').textContent = 
                        `((${wis}/4)+(${wis}+1))×${level}`;
                }

                if (hasPsionic) {
                    const wis = getAbilityScore('wis-total');
                    const int = getAbilityScore('int-total');
                    const con = getAbilityScore('con-total');

                    if (level === 1) {
                        const wisData = findClosestScore(PSP_TABLE.wisdom, wis);
                        const intBonus = findClosestScore(PSP_TABLE.intelligence, int).bonus || 0;
                        const conBonus = findClosestScore(PSP_TABLE.constitution, con).bonus || 0;
                        const basePSP = (wisData.base || 0) + intBonus + conBonus;
                        const manual = parseInt(document.getElementById('psp-manual')?.value) || 0;
                        
                        document.getElementById('pspPool').textContent = basePSP + manual;
                        document.getElementById('psp-breakdown').textContent = 
                            `${wisData.base || 0} + ${intBonus} + ${conBonus}`;
                    } else {
                        const wisData = findClosestScore(PSP_TABLE.wisdom, wis);
                        const intBonus = findClosestScore(PSP_TABLE.intelligence, int).bonus || 0;
                        const conBonus = findClosestScore(PSP_TABLE.constitution, con).bonus || 0;
                        const level1PSP = (wisData.base || 0) + intBonus + conBonus;
                        const perLevelPSP = ((10 + (wisData.perLevel || 0)) * (level - 1));
                        const totalPSP = level1PSP + perLevelPSP;
                        const manual = parseInt(document.getElementById('psp-manual')?.value) || 0;
                        
                        document.getElementById('pspPool').textContent = totalPSP + manual;
                        document.getElementById('psp-breakdown').textContent = 
                            `${level1PSP} + (10+${wisData.perLevel || 0})×${level-1}`;
                    }
                }
            }

            function updateCharacterSize() {
                const height = parseInt(document.getElementById('characterHeight')?.value) || 0;
                let size = "Mediano";

                if (height < 60) size = "Diminuto";
                else if (height < 120) size = "Pequeño";
                else if (height < 240) size = "Mediano";
                else if (height < 480) size = "Grande";
                else if (height < 960) size = "Enorme";
                else size = "Gargantuesco";

                document.getElementById('characterSize').value = size;
            }

            function updateAll() {
                updateSavingThrows();
                updateHitPoints();
                updateManaPoolsAndPSP();
            }

            function init() {
                const observer = new MutationObserver(() => {
                    updateAll();
                });

                ['primary-selected-name', 'secondary-selected-name', 'tertiary-selected-name'].forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        observer.observe(element, { childList: true, characterData: true, subtree: true });
                    }
                });

                const levelInput = document.getElementById('Level');
                if (levelInput) {
                    levelInput.addEventListener('input', updateAll);
                }

                const heightInput = document.getElementById('characterHeight');
                if (heightInput) {
                    heightInput.addEventListener('input', updateCharacterSize);
                }

                ['save-paralysis-mod1', 'save-paralysis-mod2', 'save-rods-mod1', 'save-rods-mod2',
                 'save-petrification-mod1', 'save-petrification-mod2', 'save-breath-mod1', 'save-breath-mod2',
                 'save-spells-mod1', 'save-spells-mod2'].forEach(id => {
                    const input = document.getElementById(id);
                    if (input) input.addEventListener('input', updateSavingThrows);
                });

                const hpManual = document.getElementById('hp-manual-bonus');
                if (hpManual) hpManual.addEventListener('input', updateHitPoints);

                const arcaneManual = document.getElementById('arcane-mana-manual');
                if (arcaneManual) arcaneManual.addEventListener('input', updateManaPoolsAndPSP);

                const divineManual = document.getElementById('divine-mana-manual');
                if (divineManual) divineManual.addEventListener('input', updateManaPoolsAndPSP);

                const pspManual = document.getElementById('psp-manual');
                if (pspManual) pspManual.addEventListener('input', updateManaPoolsAndPSP);

                updateAll();
            }

            return {
                init,
                updateSavingThrows,
                updateHitPoints,
                updateManaPoolsAndPSP,
                updateCharacterSize,
                updateAll
            };
        })();

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', CharacterCalculator.init);
        } else {
            CharacterCalculator.init();
        }

        window.CharacterCalculator = CharacterCalculator;
        window.updateSavingThrows = () => CharacterCalculator.updateSavingThrows();
        window.updateHitPoints = () => CharacterCalculator.updateHitPoints();
        window.updateArcaneMana = () => CharacterCalculator.updateManaPoolsAndPSP();
        window.updateDivineMana = () => CharacterCalculator.updateManaPoolsAndPSP();
        window.updatePSPPool = () => CharacterCalculator.updateManaPoolsAndPSP();
        window.updateCharacterSize = () => CharacterCalculator.updateCharacterSize();
    </script>
</body>
</html>

... <!-- Abilities Tab --> 
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AD&D 2nd Edition - Características</title>
    <style>
        body {
            background: linear-gradient(135deg, #0c1421 0%, #1e2a3a 100%);
            color: #e5e5e5;
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h2 {
            text-align: center;
            color: #ffd700;
            margin-bottom: 1rem;
        }

        .info-panel {
            background: #2b303b;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .info-label {
            font-size: 0.8rem;
            color: #b0b0b0;
        }

        .info-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #ffd700;
        }

        .abilities-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }

        .ability-card {
            background: #2b303b;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .ability-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 0.8rem;
        }

        .ability-main-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            width: 100%;
        }

        .dice-input {
            width: 60px;
            height: 60px;
            font-size: 1.8rem;
            font-weight: bold;
            text-align: center;
            background: #16213e;
            border: 2px solid #4a5464;
            border-radius: 8px;
            color: #e5e5e5;
            flex-shrink: 0;
        }

        .dice-input:focus {
            outline: none;
            border-color: #ffd700;
        }

        .total-display {
            width: 80px;
            height: 80px;
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            background: linear-gradient(135deg, #1a472a 0%, #2d5f3d 100%);
            border: 3px solid #4CAF50;
            border-radius: 12px;
            color: #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            position: relative;
        }

        .level-btn {
            position: absolute;
            top: -8px;
            right: -8px;
            width: 24px;
            height: 24px;
            background: #ffd700;
            border: none;
            border-radius: 50%;
            color: #0c1421;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .level-btn:hover {
            background: #ffed4e;
            transform: scale(1.1);
        }

        .ability-details-row {
            display: flex;
            gap: 0.6rem;
            flex-wrap: wrap;
            flex: 1;
        }

        .ability-detail-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.2rem;
            padding: 0.5rem;
            background: #16213e;
            border: 1px solid #4a5464;
            border-radius: 8px;
            min-width: 70px;
            flex: 0 0 auto;
        }

        .detail-name {
            font-size: 0.75rem;
            color: #b0b0b0;
            white-space: nowrap;
        }

        .detail-value {
            font-size: 1rem;
            font-weight: bold;
            color: #e5e5e5;
        }

        .separator {
            width: 2px;
            height: 60px;
            background: linear-gradient(to bottom, transparent, #4a5464, transparent);
            flex-shrink: 0;
        }

        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Sistema de Características</h2>
        
        <div class="info-panel">
            <div class="info-item">
                <span class="info-label">Raza</span>
                <span class="info-value" id="race-display">Humano</span>
            </div>
            <div class="info-item">
                <span class="info-label">Trasfondo</span>
                <span class="info-value" id="background-display">Ninguno</span>
            </div>
            <div class="info-item">
                <span class="info-label">Nivel</span>
                <span class="info-value" id="level-display">1</span>
            </div>
            <div class="info-item">
                <span class="info-label">Puntos Disponibles</span>
                <span class="info-value" id="points-available">0</span>
            </div>
        </div>
        
        <div class="abilities-grid">
            <div class="ability-card">
                <div class="ability-name">FUERZA</div>
                <div class="ability-main-row">
                    <input type="number" class="dice-input" id="str-dice" min="1" max="65" value="10" 
                           oninput="AbilitySystem.updateAbility('strength')">
                    <div class="separator"></div>
                    <div class="total-display" id="str-total">10
                        <button class="level-btn" onclick="AbilitySystem.addLevelPoint('strength')">+</button>
                    </div>
                    <div class="ability-details-row">
                        <div class="ability-detail-box">
                            <span class="detail-name">Golpe</span>
                            <span class="detail-value" id="str-hit">+0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Daño</span>
                            <span class="detail-value" id="str-dmg">+0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Peso</span>
                            <span class="detail-value" id="str-weight">0kg</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Esf.Máx</span>
                            <span class="detail-value" id="str-effort">0kg</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Puertas</span>
                            <span class="detail-value" id="str-doors">0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Barras</span>
                            <span class="detail-value" id="str-bars">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ability-card">
                <div class="ability-name">DESTREZA</div>
                <div class="ability-main-row">
                    <input type="number" class="dice-input" id="dex-dice" min="1" max="65" value="10" 
                           oninput="AbilitySystem.updateAbility('dexterity')">
                    <div class="separator"></div>
                    <div class="total-display" id="dex-total">10
                        <button class="level-btn" onclick="AbilitySystem.addLevelPoint('dexterity')">+</button>
                    </div>
                    <div class="ability-details-row">
                        <div class="ability-detail-box">
                            <span class="detail-name">Ajuste Reacción</span>
                            <span class="detail-value" id="dex-reaction">0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Atq. Proyectiles</span>
                            <span class="detail-value" id="dex-missile">0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Def. CA</span>
                            <span class="detail-value" id="dex-defense">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ability-card">
                <div class="ability-name">CONSTITUCIÓN</div>
                <div class="ability-main-row">
                    <input type="number" class="dice-input" id="con-dice" min="1" max="65" value="10" 
                           oninput="AbilitySystem.updateAbility('constitution')">
                    <div class="separator"></div>
                    <div class="total-display" id="con-total">10
                        <button class="level-btn" onclick="AbilitySystem.addLevelPoint('constitution')">+</button>
                    </div>
                    <div class="ability-details-row">
                        <div class="ability-detail-box">
                            <span class="detail-name">HP/Nivel</span>
                            <span class="detail-value" id="con-hp">0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Shock Sistema</span>
                            <span class="detail-value" id="con-shock">0%</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Superv. Revivir</span>
                            <span class="detail-value" id="con-res">0%</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Prot. Veneno</span>
                            <span class="detail-value" id="con-poison">0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Regeneración</span>
                            <span class="detail-value" id="con-regen">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ability-card">
                <div class="ability-name">INTELIGENCIA</div>
                <div class="ability-main-row">
                    <input type="number" class="dice-input" id="int-dice" min="1" max="65" value="10" 
                           oninput="AbilitySystem.updateAbility('intelligence')">
                    <div class="separator"></div>
                    <div class="total-display" id="int-total">10
                        <button class="level-btn" onclick="AbilitySystem.addLevelPoint('intelligence')">+</button>
                    </div>
                    <div class="ability-details-row">
                        <div class="ability-detail-box">
                            <span class="detail-name">Idiomas</span>
                            <span class="detail-value" id="int-lang">0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Niv. Conjuros</span>
                            <span class="detail-value" id="int-spell-lvl">0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Oport. Conjuros</span>
                            <span class="detail-value" id="int-spell-chance">0%</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Max Conjuros</span>
                            <span class="detail-value" id="int-max-spells">0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Inmunidad</span>
                            <span class="detail-value" id="int-immunity">--</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ability-card">
                <div class="ability-name">SABIDURÍA</div>
                <div class="ability-main-row">
                    <input type="number" class="dice-input" id="wis-dice" min="1" max="65" value="10" 
                           oninput="AbilitySystem.updateAbility('wisdom')">
                    <div class="separator"></div>
                    <div class="total-display" id="wis-total">10
                        <button class="level-btn" onclick="AbilitySystem.addLevelPoint('wisdom')">+</button>
                    </div>
                    <div class="ability-details-row">
                        <div class="ability-detail-box">
                            <span class="detail-name">Def. Mágica</span>
                            <span class="detail-value" id="wis-magic-def">0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Bonif. Conjuros</span>
                            <span class="detail-value" id="wis-spell-bonus">0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Fracaso Conjuro</span>
                            <span class="detail-value" id="wis-spell-fail">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="ability-card">
                <div class="ability-name">CARISMA</div>
                <div class="ability-main-row">
                    <input type="number" class="dice-input" id="cha-dice" min="1" max="65" value="10" 
                           oninput="AbilitySystem.updateAbility('charisma')">
                    <div class="separator"></div>
                    <div class="total-display" id="cha-total">10
                        <button class="level-btn" onclick="AbilitySystem.addLevelPoint('charisma')">+</button>
                    </div>
                    <div class="ability-details-row">
                        <div class="ability-detail-box">
                            <span class="detail-name">Servidores</span>
                            <span class="detail-value" id="cha-servants">0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Lealtad Base</span>
                            <span class="detail-value" id="cha-loyalty">0</span>
                        </div>
                        <div class="ability-detail-box">
                            <span class="detail-name">Ajuste Reacción</span>
                            <span class="detail-value" id="cha-reaction">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const AbilitySystem = (function() {
            const racialModifiers = {
                'Humano': { str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 0 },
                'Elfo': { str: 0, dex: 1, con: -1, int: 0, wis: 0, cha: 0 },
                'Enano': { str: 0, dex: 0, con: 1, int: 0, wis: 0, cha: -1 }
            };

            const backgroundModifiers = {
                'Ninguno': { str: 0, dex: 0, con: 0, int: 0, wis: 0, cha: 0 },
                'Noble': { str: 0, dex: 0, con: 0, int: 1, wis: 0, cha: 1 }
            };

            const levelPoints = {
                strength: 0, dexterity: 0, constitution: 0,
                intelligence: 0, wisdom: 0, charisma: 0
            };

            let currentRace = 'Humano';
            let currentBackground = 'Ninguno';
            let currentLevel = 1;

            const abilityTables = {
                strength: [
                    {s:1,h:-5,d:-4,w:0.5,e:1.5,do:1,b:"0%"},
                    {s:3,h:-3,d:-1,w:2.5,e:5,do:2,b:"0%"},
                    {s:6,h:-1,d:0,w:10,e:28,do:4,b:"0%"},
                    {s:10,h:0,d:0,w:20,e:58,do:6,b:"2%"},
                    {s:15,h:0,d:0,w:28,e:85,do:8,b:"7%"},
                    {s:16,h:0,d:1,w:35,e:98,do:9,b:"10%"},
                    {s:18,h:1,d:2,w:55,e:130,do:11,b:"16%"},
                    {s:20,h:3,d:8,w:270,e:350,do:17,b:"60%"},
                    {s:45,h:27,d:54,w:3770,e:3975,do:19,b:"99%"},
                    {s:65,h:47,d:94,w:6770,e:7075,do:19,b:"99%"}
                ],
                dexterity: [
                    {s:1,r:-6,m:-6,df:5},
                    {s:6,r:0,m:0,df:0},
                    {s:10,r:0,m:0,df:0},
                    {s:16,r:1,m:1,df:-1},
                    {s:18,r:2,m:2,df:-4},
                    {s:45,r:16,m:16,df:-17},
                    {s:65,r:36,m:36,df:-37}
                ],
                constitution: [
                    {s:1,hp:-3,sh:"25%",res:"30%",p:-2,rg:"--"},
                    {s:10,hp:0,sh:"70%",res:"75%",p:0,rg:"--"},
                    {s:15,hp:1,sh:"90%",res:"94%",p:0,rg:"--"},
                    {s:18,hp:3,sh:"99%",res:"100%",p:0,rg:"--"},
                    {s:45,hp:15,sh:"100%",res:"100%",p:0,rg:"9"},
                    {s:65,hp:25,sh:"100%",res:"100%",p:0,rg:"16"}
                ],
                intelligence: [
                    {s:1,l:0,sl:"--",ch:"0%",mx:0,im:"--"},
                    {s:10,l:2,sl:"5",ch:"40%",mx:7,im:"--"},
                    {s:18,l:7,sl:"9",ch:"85%",mx:18,im:"--"},
                    {s:45,l:34,sl:"19",ch:"100%",mx:150,im:"9"},
                    {s:65,l:54,sl:"29",ch:"100%",mx:250,im:"15"}
                ],
                wisdom: [
                    {s:1,md:-6,b:0,f:"80%"},
                    {s:10,md:0,b:0,f:"15%"},
                    {s:13,md:0,b:1,f:"0%"},
                    {s:18,md:4,b:4,f:"0%"},
                    {s:45,md:15,b:17,f:"0%"},
                    {s:65,md:25,b:27,f:"0%"}
                ],
                charisma: [
                    {s:1,sv:0,ly:-8,rc:-7},
                    {s:10,sv:4,ly:0,rc:0},
                    {s:18,sv:15,ly:8,rc:7},
                    {s:45,sv:64,ly:32,rc:32},
                    {s:65,sv:104,ly:52,rc:52}
                ]
            };

            function findData(table, score) {
                let exact = table.find(e => e.s === score);
                if (exact) return exact;
                return table.reduce((p,c) => Math.abs(c.s-score)<Math.abs(p.s-score)?c:p);
            }

            function getPrefix(ability) {
                return {strength:'str',dexterity:'dex',constitution:'con',
                        intelligence:'int',wisdom:'wis',charisma:'cha'}[ability];
            }

            function calculateTotal(ability) {
                const dice = parseInt(document.getElementById(`${getPrefix(ability)}-dice`).value)||10;
                const key = {strength:'str',dexterity:'dex',constitution:'con',
                             intelligence:'int',wisdom:'wis',charisma:'cha'}[ability];
                return dice + racialModifiers[currentRace][key] + 
                       backgroundModifiers[currentBackground][key] + levelPoints[ability];
            }

            function updateModifiers(ability, total) {
                const pre = getPrefix(ability);
                switch(ability) {
                    case 'strength':
                        const sd = findData(abilityTables.strength, total);
                        document.getElementById('str-hit').textContent = sd.h>=0?`+${sd.h}`:sd.h;
                        document.getElementById('str-dmg').textContent = sd.d>=0?`+${sd.d}`:sd.d;
                        document.getElementById('str-weight').textContent = sd.w+'kg';
                        document.getElementById('str-effort').textContent = sd.e+'kg';
                        document.getElementById('str-doors').textContent = sd.do;
                        document.getElementById('str-bars').textContent = sd.b;
                        break;
                    case 'dexterity':
                        const dd = findData(abilityTables.dexterity, total);
                        document.getElementById('dex-reaction').textContent = dd.r>=0?`+${dd.r}`:dd.r;
                        document.getElementById('dex-missile').textContent = dd.m>=0?`+${dd.m}`:dd.m;
                        document.getElementById('dex-defense').textContent = dd.df>=0?`+${dd.df}`:dd.df;
                        break;
                    case 'constitution':
                        const cd = findData(abilityTables.constitution, total);
                        document.getElementById('con-hp').textContent = cd.hp>=0?`+${cd.hp}`:cd.hp;
                        document.getElementById('con-shock').textContent = cd.sh;
                        document.getElementById('con-res').textContent = cd.res;
                        document.getElementById('con-poison').textContent = cd.p>=0?`+${cd.p}`:cd.p;
                        document.getElementById('con-regen').textContent = cd.rg;
                        break;
                    case 'intelligence':
                        const id = findData(abilityTables.intelligence, total);
                        document.getElementById('int-lang').textContent = id.l;
                        document.getElementById('int-spell-lvl').textContent = id.sl;
                        document.getElementById('int-spell-chance').textContent = id.ch;
                        document.getElementById('int-max-spells').textContent = id.mx;
                        document.getElementById('int-immunity').textContent = id.im;
                        break;
                    case 'wisdom':
                        const wd = findData(abilityTables.wisdom, total);
                        document.getElementById('wis-magic-def').textContent = wd.md>=0?`+${wd.md}`:wd.md;
                        document.getElementById('wis-spell-bonus').textContent = wd.b>=0?`+${wd.b}`:wd.b;
                        document.getElementById('wis-spell-fail').textContent = wd.f;
                        break;
                    case 'charisma':
                        const chd = findData(abilityTables.charisma, total);
                        document.getElementById('cha-servants').textContent = chd.sv;
                        document.getElementById('cha-loyalty').textContent = chd.ly>=0?`+${chd.ly}`:chd.ly;
                        document.getElementById('cha-reaction').textContent = chd.rc>=0?`+${chd.rc}`:chd.rc;
                        break;
                }
            }

            function updateAbility(ability) {
                const total = calculateTotal(ability);
                document.getElementById(`${getPrefix(ability)}-total`).textContent = total;
                updateModifiers(ability, total);
            }

            function addLevelPoint(ability) {
                const bonusLevels = [3,6,9,12,15,18,21,24,27,30];
                let totalPoints = bonusLevels.filter(l => currentLevel >= l).length;
                let usedPoints = Object.values(levelPoints).reduce((s,v) => s+v, 0);
                if (usedPoints < totalPoints) {
                    levelPoints[ability]++;
                    updateAbility(ability);
                    document.getElementById('points-available').textContent = totalPoints - usedPoints - 1;
                }
            }

            function init() {
                ['strength','dexterity','constitution','intelligence','wisdom','charisma']
                    .forEach(a => updateAbility(a));
            }

            return {updateAbility, addLevelPoint, init};
        })();

        window.addEventListener('DOMContentLoaded', () => AbilitySystem.init());
    </script>
</body>
</html>

<!-- Combat Tab -->
<div id="combat-tab" class="tab-content">
    <h2 style="color: #ffd700; margin-bottom: 2rem;">⚔️ Combate</h2>

    <!-- Stats de Combate -->
    <div class="combat-stats-row">
        <div class="stat-card combat-stat">
            <div class="stat-value" id="combatAC">10</div>
            <div class="stat-label">Clase de Armadura</div>
        </div>
        <div class="stat-card combat-stat">
            <div class="stat-value" id="combatGaco">20</div>
            <div class="stat-label">GACO Base</div>
        </div>
        <div class="stat-card combat-stat">
            <div class="stat-value" id="combatInitiative">+0</div>
            <div class="stat-label">Iniciativa</div>
        </div>
        <div class="stat-card combat-stat">
            <div class="stat-value" id="combatMovement">30m</div>
            <div class="stat-label">Movimiento</div>
        </div>
    </div>

    <!-- Armas Equipadas -->
    <div class="combat-section">
        <h3 style="color: #ffd700; margin-bottom: 1rem;">⚔️ Armas Equipadas</h3>
        
        <div class="equipped-weapons" id="equipped-weapons-container">
            <div class="weapon-slot-combat" data-slot="main-hand">
                <div class="slot-label">🗡️ Mano Principal</div>
                <div class="weapon-info" id="main-hand-weapon">
                    <div class="weapon-name-combat">Sin Arma</div>
                    <div class="weapon-stats-combat">
                        <span class="weapon-gaco">GACO: 20</span>
                        <span class="weapon-damage">Daño: 1d2</span>
                        <span class="weapon-attacks">Ataques: 1</span>
                    </div>
                </div>
                <button class="equip-weapon-btn" onclick="openWeaponSelector('main-hand')">Equipar</button>
            </div>

            <div class="weapon-slot-combat" data-slot="off-hand">
                <div class="slot-label">🛡️ Mano Secundaria</div>
                <div class="weapon-info" id="off-hand-weapon">
                    <div class="weapon-name-combat">Vacío</div>
                    <div class="weapon-stats-combat">
                        <span class="weapon-note">Segunda arma o escudo</span>
                    </div>
                </div>
                <button class="equip-weapon-btn" onclick="openWeaponSelector('off-hand')">Equipar</button>
            </div>

            <div class="weapon-slot-combat" data-slot="ranged">
                <div class="slot-label">🏹 Arma a Distancia</div>
                <div class="weapon-info" id="ranged-weapon">
                    <div class="weapon-name-combat">Sin Arma</div>
                    <div class="weapon-stats-combat">
                        <span class="weapon-gaco">GACO: 20</span>
                        <span class="weapon-damage">Daño: --</span>
                        <span class="weapon-range">Alcance: --</span>
                    </div>
                </div>
                <button class="equip-weapon-btn" onclick="openWeaponSelector('ranged')">Equipar</button>
            </div>
        </div>
    </div>

    <!-- Estilos de Combate Activos -->
    <div class="combat-section">
        <h3 style="color: #ffd700; margin-bottom: 1rem;">🥋 Estilos de Combate</h3>
        
        <div class="active-combat-styles" id="active-combat-styles">
            <div class="no-styles-active">
                <p style="color: #b0b0b0; font-style: italic; text-align: center;">
                    No tienes estilos de combate disponibles.<br>
                    <small>Compra estilos en la pestaña de Pericias para habilitarlos aquí.</small>
                </p>
            </div>
        </div>
    </div>

    <!-- Armadura y Protección -->
    <div class="combat-section">
        <h3 style="color: #ffd700; margin-bottom: 1rem;">🛡️ Armadura y Protección</h3>
        
        <div class="armor-protection-grid">
            <div class="armor-slot-combat">
                <div class="armor-type-label">Armadura Corporal</div>
                <div class="armor-info" id="body-armor-info">
                    <div class="armor-name">Sin Armadura</div>
                    <div class="armor-stats">
                        <span class="armor-ac">CA: 10</span>
                        <span class="armor-dex-bonus">Dex: Sin límite</span>
                    </div>
                </div>
                <button class="change-armor-btn" onclick="openArmorSelector('body')">Cambiar</button>
            </div>

            <div class="armor-slot-combat">
                <div class="armor-type-label">Escudo</div>
                <div class="armor-info" id="shield-info">
                    <div class="armor-name">Sin Escudo</div>
                    <div class="armor-stats">
                        <span class="shield-ac">CA: +0</span>
                        <span class="shield-attacks">Ataques: +0</span>
                    </div>
                </div>
                <button class="change-armor-btn" onclick="openArmorSelector('shield')">Cambiar</button>
            </div>
        </div>

        <!-- Modificadores de CA -->
        <div class="ac-modifiers" id="ac-breakdown">
            <h4 style="color: #ffd700; margin-bottom: 0.5rem;">Desglose de CA:</h4>
            <div class="ac-breakdown-list">
                <div class="ac-modifier-item">
                    <span>Armadura base:</span>
                    <span id="ac-base-armor">10</span>
                </div>
                <div class="ac-modifier-item">
                    <span>Modificador de Destreza:</span>
                    <span id="ac-dex-mod">+0</span>
                </div>
                <div class="ac-modifier-item">
                    <span>Escudo:</span>
                    <span id="ac-shield">+0</span>
                </div>
                <div class="ac-modifier-item">
                    <span>Estilos de combate:</span>
                    <span id="ac-style-bonus">+0</span>
                </div>
                <div class="ac-modifier-item">
                    <span>Bonificaciones mágicas:</span>
                    <span id="ac-magic-bonus">+0</span>
                </div>
                <div class="ac-modifier-total">
                    <span><strong>CA Total:</strong></span>
                    <span id="ac-total"><strong>10</strong></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Ataques por Ronda -->
    <div class="combat-section">
        <h3 style="color: #ffd700; margin-bottom: 1rem;">⚡ Ataques por Ronda</h3>
        
        <div class="attacks-per-round" id="attacks-breakdown">
            <div class="attacks-info">
                <div class="base-attacks">
                    <span class="attacks-label">Ataques base por nivel:</span>
                    <span class="attacks-value" id="base-attacks-value">1</span>
                </div>
                <div class="specialization-attacks">
                    <span class="attacks-label">Por especialización en armas:</span>
                    <span class="attacks-value" id="specialization-attacks-value">+0</span>
                </div>
                <div class="style-attacks">
                    <span class="attacks-label">Por estilos de combate:</span>
                    <span class="attacks-value" id="style-attacks-value">+0</span>
                </div>
                <div class="total-attacks">
                    <span class="attacks-label"><strong>Total por ronda:</strong></span>
                    <span class="attacks-value" id="total-attacks-value"><strong>1</strong></span>
                </div>
            </div>
            
            <div class="attacks-note">
                <p style="color: #b0b0b0; font-size: 0.9rem; font-style: italic;">
                    * Los ataques adicionales por especialización se alternan entre rondas.<br>
                    Ejemplo: 1.5 ataques = 2 ataques en una ronda, 1 en la siguiente.
                </p>
            </div>
        </div>
    </div>

</div>

<style>
/* Estilos específicos para Combat Tab */
.combat-stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.combat-stat {
    background: linear-gradient(135deg, rgba(220, 20, 60, 0.1), rgba(255, 69, 0, 0.1));
    border: 1px solid rgba(220, 20, 60, 0.3);
}

.combat-section {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
}

/* Armas Equipadas */
.equipped-weapons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
}

.weapon-slot-combat {
    background: rgba(0, 0, 0, 0.3);
    border: 2px dashed rgba(255, 255, 255, 0.2);
    border-radius: 12px;
    padding: 1.5rem;
    text-align: center;
    transition: all 0.3s ease;
}

.weapon-slot-combat:hover {
    border-color: rgba(255, 215, 0, 0.5);
    background: rgba(255, 215, 0, 0.05);
}

.weapon-slot-combat.equipped {
    border-style: solid;
    border-color: #ffd700;
    background: rgba(255, 215, 0, 0.1);
}

.slot-label {
    color: #b0b0b0;
    font-size: 0.9rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 1rem;
}

.weapon-info {
    margin-bottom: 1rem;
}

.weapon-name-combat {
    color: #ffd700;
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

.weapon-stats-combat {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
    color: #e5e5e5;
    font-size: 0.9rem;
}

.weapon-note {
    color: #b0b0b0;
    font-style: italic;
}

.equip-weapon-btn, .change-armor-btn {
    padding: 0.6rem 1.2rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    background: rgba(255, 255, 255, 0.05);
    color: #e5e5e5;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.9rem;
}

.equip-weapon-btn:hover, .change-armor-btn:hover {
    border-color: #ffd700;
    background: rgba(255, 215, 0, 0.1);
    color: #ffd700;
}

/* Estilos de Combate Activos */
.active-combat-styles {
    display: grid;
    gap: 1rem;
}

.combat-style-active {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 215, 0, 0.3);
    border-radius: 8px;
    padding: 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.style-info-active {
    flex: 1;
}

.style-name-active {
    color: #ffd700;
    font-weight: bold;
    font-size: 1.1rem;
    margin-bottom: 0.5rem;
}

.style-level-active {
    color: #b0b0b0;
    font-size: 0.9rem;
    margin-bottom: 0.3rem;
}

.style-effects-active {
    color: #e5e5e5;
    font-size: 0.9rem;
}

.style-toggle-btn {
    padding: 0.8rem 1.2rem;
    border: 2px solid rgba(255, 215, 0, 0.5);
    border-radius: 8px;
    background: transparent;
    color: #ffd700;
    cursor: pointer;
    transition: all 0.3s ease;
    font-weight: bold;
}

.style-toggle-btn:hover {
    background: rgba(255, 215, 0, 0.1);
}

.style-toggle-btn.active {
    background: rgba(255, 215, 0, 0.3);
    border-color: #ffd700;
}

/* Armadura y Protección */
.armor-protection-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.armor-slot-combat {
    background: rgba(0, 100, 200, 0.1);
    border: 1px solid rgba(0, 100, 200, 0.3);
    border-radius: 8px;
    padding: 1.5rem;
    text-align: center;
}

.armor-type-label {
    color: #4da6ff;
    font-weight: bold;
    margin-bottom: 1rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.armor-info {
    margin-bottom: 1rem;
}

.armor-name {
    color: #4da6ff;
    font-weight: bold;
    font-size: 1rem;
    margin-bottom: 0.5rem;
}

.armor-stats {
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
    color: #e5e5e5;
    font-size: 0.9rem;
}

/* Desglose de CA */
.ac-modifiers {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.ac-breakdown-list {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.ac-modifier-item {
    display: flex;
    justify-content: space-between;
    color: #e5e5e5;
    font-size: 0.9rem;
}

.ac-modifier-total {
    display: flex;
    justify-content: space-between;
    color: #ffd700;
    font-size: 1rem;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
}

/* Ataques por Ronda */
.attacks-per-round {
    display: grid;
    gap: 1.5rem;
}

.attacks-info {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
    padding: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    display: grid;
    gap: 0.8rem;
}

.base-attacks, .specialization-attacks, .style-attacks, .total-attacks {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.attacks-label {
    color: #e5e5e5;
    font-size: 0.9rem;
}

.attacks-value {
    color: #ffd700;
    font-weight: bold;
}

.total-attacks {
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    padding-top: 0.8rem;
    margin-top: 0.5rem;
}

.attacks-note {
    background: rgba(255, 215, 0, 0.05);
    border-left: 3px solid #ffd700;
    padding: 1rem;
    border-radius: 0 8px 8px 0;
}

/* Tiradas de Salvación */
.saving-throws-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.saving-throw-item {
    background: rgba(0, 150, 0, 0.1);
    border: 1px solid rgba(0, 150, 0, 0.3);
    border-radius: 8px;
    padding: 1rem;
    text-align: center;
    transition: all 0.3s ease;
}

.saving-throw-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 150, 0, 0.2);
}

.save-name {
    color: #90EE90;
    font-weight: bold;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.save-value {
    color: #00FF7F;
    font-size: 1.5rem;
    font-weight: bold;
}

.no-styles-active {
    text-align: center;
    padding: 2rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border: 1px dashed rgba(255, 255, 255, 0.2);
}

/* Responsive Design */
@media (max-width: 768px) {
    .combat-stats-row {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .equipped-weapons {
        grid-template-columns: 1fr;
    }
    
    .armor-protection-grid {
        grid-template-columns: 1fr;
    }
    
    .saving-throws-grid {
        grid-template-columns: 1fr;
    }
    
    .weapon-stats-combat {
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 0.5rem;
    }
}

@media (max-width: 480px) {
    .combat-stats-row {
        grid-template-columns: 1fr;
    }
    
    .weapon-stats-combat {
        flex-direction: column;
    }
}
</style>

<<!-- Skills Tab -->
<div id="skills-tab" class="tab-content">
    <h2 style="color: #ffd700; margin-bottom: 2rem;">🎯 Pericias</h2>

    <!-- Pericias en Armas -->
    <div class="skills-section">
        <h3 style="color: #ffd700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            ⚔️ Pericias en Armas
            <span class="slot-counter" id="weapon-slots-counter">0/0 casillas</span>
        </h3>
        
        <div class="weapons-proficiency-container">
            <div class="weapon-search-container">
                <input type="text" id="weapon-search" class="form-input" placeholder="🔍 Buscar arma..." style="margin-bottom: 1rem;">
            </div>
            
            <div class="weapons-grid" id="weapons-proficiency-grid">
                <!-- Las armas se cargarán dinámicamente aquí -->
            </div>
        </div>
    </div>

    <!-- Pericias en No-Armas -->
    <div class="skills-section">
        <h3 style="color: #ffd700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            🛠️ Pericias en No-Armas
            <span class="slot-counter" id="nonweapon-slots-counter">0/0 casillas</span>
        </h3>
        
        <div class="nonweapon-proficiency-container">
            <div class="skill-search-container">
                <input type="text" id="skill-search" class="form-input" placeholder="🔍 Buscar pericia..." style="margin-bottom: 1rem;">
                <select id="skill-group-filter" class="form-input" style="margin-bottom: 1rem;">
                    <option value="all">Todos los grupos</option>
                    <option value="Gen">General (Gen)</option>
                    <option value="Luc">Luchador (Luc)</option>
                    <option value="Sac">Sacerdote (Sac)</option>
                    <option value="Hec">Hechicero (Hec/Mago)</option>
                    <option value="Bri">Bribón (Bri)</option>
                    <option value="Psi">Psiónico (Psi)</option>
                </select>
            </div>
            
            <div class="skills-grid" id="nonweapon-skills-grid">
                <!-- Las pericias se cargarán dinámicamente aquí -->
            </div>
        </div>
    </div>

    <!-- Estilos de Combate -->
    <div class="skills-section">
        <h3 style="color: #ffd700; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
            🥋 Estilos de Combate
            <span class="slot-counter" id="combat-styles-counter">0/0 casillas</span>
            <small style="color: #b0b0b0; font-size: 0.8rem; margin-left: 1rem;">(Solo Luchadores)</small>
        </h3>
        
        <div class="combat-styles-container" id="combat-styles-container">
            <!-- Los estilos se cargarán dinámicamente según la clase -->
        </div>
    </div>
</div>

<style>
/* Estilos específicos para el tab de Skills */
.skills-section {
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
}

.slot-counter {
    background: rgba(255, 215, 0, 0.2);
    color: #ffd700;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: bold;
    border: 1px solid rgba(255, 215, 0, 0.3);
}

.weapons-grid, .skills-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1rem;
    max-height: 500px;
    overflow-y: auto;
    padding: 0.5rem;
}

.weapon-item, .skill-item {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.3s ease;
    position: relative;
}

.weapon-item:hover, .skill-item:hover {
    border-color: rgba(255, 215, 0, 0.5);
    background: rgba(255, 215, 0, 0.05);
    transform: translateY(-2px);
}

.item-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.8rem;
}

.item-name {
    color: #ffd700;
    font-weight: bold;
    font-size: 1rem;
    flex: 1;
}

.item-group {
    background: rgba(0, 150, 255, 0.2);
    color: #87ceeb;
    padding: 0.2rem 0.5rem;
    border-radius: 12px;
    font-size: 0.75rem;
    margin-left: 0.5rem;
}

.item-details {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    color: #e5e5e5;
    font-size: 0.9rem;
}

.item-characteristic {
    color: #b0b0b0;
}

.item-modifier {
    color: #ffd700;
    font-weight: bold;
}

.proficiency-controls {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.proficiency-level {
    display: flex;
    align-items: center;
    gap: 0.3rem;
}

.level-btn {
    width: 30px;
    height: 30px;
    border: 2px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    background: transparent;
    color: #e5e5e5;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.8rem;
    font-weight: bold;
}

.level-btn:hover {
    border-color: #ffd700;
    background: rgba(255, 215, 0, 0.1);
}

.level-btn.active {
    border-color: #ffd700;
    background: rgba(255, 215, 0, 0.3);
    color: #ffd700;
}

.level-btn.disabled {
    border-color: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.3);
    cursor: not-allowed;
}

.mastery-info {
    margin-top: 0.5rem;
    padding: 0.5rem;
    background: rgba(255, 215, 0, 0.1);
    border-radius: 6px;
    border-left: 3px solid #ffd700;
    font-size: 0.8rem;
    color: #e5e5e5;
    display: none;
}

.mastery-info.show {
    display: block;
}

.slots-required {
    color: #ffd700;
    font-weight: bold;
    margin-left: auto;
    font-size: 0.85rem;
}

.combat-styles-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: 1.5rem;
}

.combat-style-card {
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    padding: 1.5rem;
    transition: all 0.3s ease;
}

.combat-style-card:hover {
    border-color: rgba(255, 215, 0, 0.5);
    background: rgba(255, 215, 0, 0.05);
}

.style-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.style-name {
    color: #ffd700;
    font-weight: bold;
    font-size: 1.1rem;
}

.style-cost {
    color: #b0b0b0;
    font-size: 0.85rem;
}

.style-description {
    color: #e5e5e5;
    margin-bottom: 1rem;
    line-height: 1.4;
    font-size: 0.9rem;
}

.style-levels {
    display: flex;
    flex-direction: column;
    gap: 0.8rem;
}

.style-level {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 0.8rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
    border-left: 3px solid transparent;
    transition: all 0.3s ease;
}

.style-level.purchased {
    border-left-color: #ffd700;
    background: rgba(255, 215, 0, 0.1);
}

.style-level-name {
    font-weight: bold;
    color: #ffd700;
    min-width: 100px;
}

.style-level-effect {
    flex: 1;
    color: #e5e5e5;
    font-size: 0.9rem;
}

.style-level-btn {
    padding: 0.4rem 0.8rem;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
    background: transparent;
    color: #e5e5e5;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 0.8rem;
}

.style-level-btn:hover {
    border-color: #ffd700;
    background: rgba(255, 215, 0, 0.1);
    color: #ffd700;
}

.style-level-btn.purchased {
    background: rgba(255, 215, 0, 0.3);
    border-color: #ffd700;
    color: #ffd700;
}

.style-level-btn.disabled {
    border-color: rgba(255, 255, 255, 0.1);
    color: rgba(255, 255, 255, 0.3);
    cursor: not-allowed;
}

.no-styles-message {
    text-align: center;
    color: #b0b0b0;
    font-style: italic;
    padding: 2rem;
    background: rgba(255, 255, 255, 0.05);
    border-radius: 8px;
}

/* Filtros y búsqueda */
.weapon-search-container, .skill-search-container {
    margin-bottom: 1rem;
    display: grid;
    grid-template-columns: 1fr;
    gap: 0.5rem;
}

.skill-search-container {
    grid-template-columns: 1fr 200px;
}

@media (max-width: 768px) {
    .weapons-grid, .skills-grid {
        grid-template-columns: 1fr;
    }
    
    .combat-styles-container {
        grid-template-columns: 1fr;
    }
    
    .skill-search-container {
        grid-template-columns: 1fr;
    }
}
</style>
            <!-- Spells Tab -->
            <div id="spells-tab" class="tab-content">
                <h2 style="color: #ffd700; margin-bottom: 2rem;">✨ Conjuros</h2>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">Tipo de Lanzador</label>
                        <select class="form-input" id="casterType" onchange="updateSpellList()">
                            <option value="">Selecciona tipo</option>
                            <option value="wizard">Mago/Hechicero</option>
                            <option value="priest">Clérigo/Druida</option>
                            <option value="psionic">Psiónico</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Nivel de Conjuro</label>
                        <select class="form-input" id="spellLevel" onchange="filterSpells()">
                            <option value="">Todos los niveles</option>
                            <option value="1">Nivel 1</option>
                            <option value="2">Nivel 2</option>
                            <option value="3">Nivel 3</option>
                            <option value="4">Nivel 4</option>
                            <option value="5">Nivel 5</option>
                            <option value="6">Nivel 6</option>
                            <option value="7">Nivel 7</option>
                            <option value="8">Nivel 8</option>
                            <option value="9">Nivel 9</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Buscar Conjuro</label>
                        <input type="text" class="form-input" id="spellSearch" placeholder="Nombre del conjuro..." oninput="searchSpells()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Explorar Listas</label>
                        <button class="btn btn-secondary" onclick="browseSpellLists()">📜 Ver Lista Completa</button>
                    </div>
                </div>
                
                <!-- Botones adicionales para manejo de conjuros -->
                <div class="form-grid" style="margin-bottom: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Buscar Online</label>
                        <button class="btn btn-secondary" onclick="searchSpellOnline()" id="onlineSearchBtn" disabled>🔍 Buscar en Wiki</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Importar Texto</label>
                        <button class="btn btn-primary" onclick="parseSpellsFromText()">🔥 Importar Lista</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Gestión</label>
                        <button class="btn btn-secondary" onclick="exportCustomSpells()">📤 Exportar</button>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Archivos</label>
                        <button class="btn btn-secondary" onclick="importCustomSpells()">📁 Importar JSON</button>
                    </div>
                </div>

                <!-- Spell Slots Display -->
                <div id="spellSlotsContainer" style="display: none;">
                    <h3 style="color: #ffd700; margin: 2rem 0 1rem;">Espacios de Conjuro por Nivel</h3>
                    <div id="spellSlotsGrid" class="stats-row">
                        <!-- Spell slots will be dynamically generated here -->
                    </div>
                </div>

                <!-- Known Spells -->
                <div id="knownSpellsContainer">
                    <h3 style="color: #ffd700; margin: 2rem 0 1rem;">Conjuros Conocidos</h3>
                    <div id="knownSpellsList" class="spells-list">
                        <p style="color: #b0b0b0; text-align: center; margin: 2rem 0;">
                            Selecciona un tipo de lanzador para ver conjuros disponibles
                        </p>
                    </div>
                </div>

                <!-- Add Spell Button -->
                <div style="text-align: center; margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="addCustomSpell()" id="addSpellBtn" disabled">➕ Añadir Conjuro Manual</button>
                </div>
            </div>

            <!-- Equipment Tab -->
            <div id="equipment-tab" class="tab-content active">
                <h2 style="color: #ffd700; margin-bottom: 2rem;">🎒 Equipo del Personaje</h2>
                
                <!-- Quick Equipment Buttons -->
                <div class="quick-equip-buttons">
                    <button class="quick-equip-btn" onclick="quickEquipSet('warrior')">⚔️ Guerrero</button>
                    <button class="quick-equip-btn" onclick="quickEquipSet('mage')">🔮 Mago</button>
                    <button class="quick-equip-btn" onclick="quickEquipSet('rogue')">🗡️ Pícaro</button>
                    <button class="quick-equip-btn" onclick="quickEquipSet('priest')">🛡️ Clérigo</button>
                    <button class="quick-equip-btn" onclick="clearAllEquipment()">🧹 Limpiar Todo</button>
                </div>

                <!-- Head & Neck Equipment -->
                <div class="equipment-section">
                    <h3>👑 Cabeza y Cuello</h3>
                    <div class="equipment-grid">
                        <div class="equipment-slot" id="helmet-slot" onclick="equipItem('helmet')">
                            <div class="slot-label">Casco/Yelmo</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                        <div class="equipment-slot" id="crown-slot" onclick="equipItem('crown')">
                            <div class="slot-label">Corona/Tiara</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                        <div class="equipment-slot" id="neck-slot" onclick="equipItem('neck')">
                            <div class="slot-label">Cuello</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                        <div class="equipment-slot" id="cloak-slot" onclick="equipItem('cloak')">
                            <div class="slot-label">Capa/Manto</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                    </div>
                </div>

                <!-- Arms & Hands Equipment -->
                <div class="equipment-section">
                    <h3>🤲 Brazos y Manos</h3>
                    <div class="equipment-grid">
                        <div class="equipment-slot" id="bracers-slot" onclick="equipItem('bracers')">
                            <div class="slot-label">Brazales</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                        <div class="equipment-slot" id="gauntlets-slot" onclick="equipItem('gauntlets')">
                            <div class="slot-label">Guanteletes</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                        <div class="equipment-slot" id="ring1-slot" onclick="equipItem('ring1')">
                            <div class="slot-label">Anillo 1</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                        <div class="equipment-slot" id="ring2-slot" onclick="equipItem('ring2')">
                            <div class="slot-label">Anillo 2</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                    </div>
                </div>

                <!-- Body & Feet Equipment -->
                <div class="equipment-section">
                    <h3>👕 Cuerpo y Pies</h3>
                    <div class="equipment-grid">
                        <div class="equipment-slot" id="armor-slot" onclick="equipItem('armor')">
                            <div class="slot-label">Armadura</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                        <div class="equipment-slot" id="shield-slot" onclick="equipItem('shield')">
                            <div class="slot-label">Escudo</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                        <div class="equipment-slot" id="boots-slot" onclick="equipItem('boots')">
                            <div class="slot-label">Botas</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                        <div class="equipment-slot" id="belt-slot" onclick="equipItem('belt')">
                            <div class="slot-label">Cinturón</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                    </div>
                </div>

                <!-- Weapons Section -->
                <div class="equipment-section">
                    <h3>⚔️ Armas</h3>
                    <div class="equipment-grid">
                        <div class="equipment-slot weapon-slot" id="weapon1-slot" onclick="equipWeapon('weapon1')">
                            <div class="slot-label">Arma Principal</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                        <div class="equipment-slot weapon-slot" id="weapon2-slot" onclick="equipWeapon('weapon2')">
                            <div class="slot-label">Arma Secundaria</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                        <div class="equipment-slot weapon-slot" id="weapon3-slot" onclick="equipWeapon('weapon3')">
                            <div class="slot-label">Arma Terciaria</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                        <div class="equipment-slot weapon-slot" id="weapon4-slot" onclick="equipWeapon('weapon4')">
                            <div class="slot-label">Arma de Distancia</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                        <div class="equipment-slot weapon-slot" id="weapon5-slot" onclick="equipWeapon('weapon5')">
                            <div class="slot-label">Arma Especial</div>
                            <div class="slot-item slot-empty">Vacío</div>
                        </div>
                    </div>
                </div>

                <!-- Armor Statistics -->
                <div class="armor-stats">
                    <h4>📊 Estadísticas de Protección</h4>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="label">Clase de Armadura:</span>
                            <span class="value" id="equipmentAC">10</span>
                        </div>
                        <div class="stat-item">
                            <span class="label">Peso Total:</span>
                            <span class="value" id="totalWeight">0 kg</span>
                        </div>
                        <div class="stat-item">
                            <span class="label">Penalizador Destreza:</span>
                            <span class="value" id="dexPenalty">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="label">Max Bonif. Destreza:</span>
                            <span class="value" id="maxDexBonus">+6</span>
                        </div>
                        <div class="stat-item">
                            <span class="label">Velocidad:</span>
                            <span class="value" id="armorSpeed">12</span>
                        </div>
                        <div class="stat-item">
                            <span class="label">Resistencia Mágica:</span>
                            <span class="value" id="magicResistance">0%</span>
                        </div>
                    </div>
                </div>

                <!-- Additional Equipment -->
                <div class="equipment-section">
                    <h3>🎒 Inventario Adicional</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">Dinero (MO)</label>
                            <input type="number" class="form-input" id="gold" value="0" min="0" onchange="updateMoney()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monedas Plata (MP)</label>
                            <input type="number" class="form-input" id="silver" value="0" min="0" onchange="updateMoney()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Monedas Cobre (MC)</label>
                            <input type="number" class="form-input" id="copper" value="0" min="0" onchange="updateMoney()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valor Total (MO)</label>
                            <input type="text" class="form-input" id="totalValue" value="0 MO" readonly>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Objetos Adicionales</label>
                        <textarea class="form-input" id="additionalItems" rows="4" placeholder="Ej: Cuerda de seda (50 pies), Kit de ladrón, Poción de curación..."></textarea>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Dice Roller -->
    <div class="dice-roller">
        <button class="dice-btn" onclick="rollDice(20)" title="Tirar d20">🎲</button>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
        // Global character data
        let character = {
            name: '',
            playerName: '',
            race: '',
            alignment: 'N',
            primaryClass: '',
            secondaryClass: '',
            tertiaryClass: '',
            specificClass: '',
            level: 1,
            experience: 0,
            abilities: {
                strength: 10,
                dexterity: 10,
                constitution: 10,
                intelligence: 10,
                wisdom: 10,
                charisma: 10
            },
            hitPoints: 10,
            armorClass: 10,
            gaco: 20,
            equipment: {
                helmet: null,
                crown: null,
                neck: null,
                cloak: null,
                bracers: null,
                gauntlets: null,
                ring1: null,
                ring2: null,
                armor: null,
                shield: null,
                boots: null,
                belt: null,
                weapon1: null,
                weapon2: null,
                weapon3: null,
                weapon4: null,
                weapon5: null
            },
            money: {
                gold: 0,
                silver: 0,
                copper: 0
            },
            additionalItems: '',
            knownSpells: []
        };

        // Equipment Database
        const equipmentDatabase = {
            helmet: [
                { name: 'Casco de Cuero', ac: 0, weight: 1, type: 'light', price: '5 MO' },
                { name: 'Yelmo de Acero', ac: 0, weight: 3, type: 'medium', price: '15 MO' },
                { name: 'Gran Yelmo', ac: 1, weight: 5, type: 'heavy', price: '50 MO' },
                { name: 'Yelmo Encantado +1', ac: 1, weight: 3, type: 'magic', price: '1000 MO' }
            ],
            crown: [
                { name: 'Corona de Cobre', ac: 0, weight: 0.5, type: 'light', price: '25 MO' },
                { name: 'Corona Real', ac: 0, weight: 1, type: 'medium', price: '500 MO' },
                { name: 'Tiara Élfica', ac: 0, weight: 0.2, type: 'magic', price: '2000 MO' },
                { name: 'Diadema del Intelecto', ac: 0, weight: 0.1, type: 'magic', price: '5000 MO' }
            ],
            neck: [
                { name: 'Collar de Cuero', ac: 0, weight: 0.2, type: 'light', price: '2 MO' },
                { name: 'Cadena de Plata', ac: 0, weight: 0.5, type: 'medium', price: '50 MO' },
                { name: 'Amuleto de Protección', ac: 1, weight: 0.1, type: 'magic', price: '1500 MO' },
                { name: 'Medallón Sagrado', ac: 0, weight: 0.3, type: 'magic', price: '800 MO' }
            ],
            cloak: [
                { name: 'Capa de Viaje', ac: 0, weight: 2, type: 'light', price: '8 MO' },
                { name: 'Manto de Lana', ac: 0, weight: 3, type: 'medium', price: '15 MO' },
                { name: 'Capa de Desplazamiento', ac: 2, weight: 1, type: 'magic', price: '3500 MO' },
                { name: 'Manto Élfico', ac: 1, weight: 1.5, type: 'magic', price: '2000 MO' }
            ],
            bracers: [
                { name: 'Brazales de Cuero', ac: 0, weight: 1, type: 'light', price: '10 MO' },
                { name: 'Brazales de Acero', ac: 1, weight: 3, type: 'medium', price: '75 MO' },
                { name: 'Brazales de Defensa CA 6', ac: 4, weight: 2, type: 'magic', price: '2000 MO' },
                { name: 'Brazales de Defensa CA 4', ac: 6, weight: 2, type: 'magic', price: '8000 MO' }
            ],
            gauntlets: [
                { name: 'Guantes de Cuero', ac: 0, weight: 0.5, type: 'light', price: '5 MO' },
                { name: 'Guanteletes', ac: 0, weight: 2, type: 'medium', price: '25 MO' },
                { name: 'Guanteletes de Poder de Ogro', ac: 0, weight: 2, type: 'magic', price: '3000 MO' },
                { name: 'Guanteletes de Destreza', ac: 0, weight: 1, type: 'magic', price: '2500 MO' }
            ],
            ring1: [
                { name: 'Anillo de Cobre', ac: 0, weight: 0.1, type: 'light', price: '1 MO' },
                { name: 'Anillo de Plata', ac: 0, weight: 0.1, type: 'medium', price: '10 MO' },
                { name: 'Anillo de Protección +1', ac: 1, weight: 0.1, type: 'magic', price: '2000 MO' },
                { name: 'Anillo de Invisibilidad', ac: 0, weight: 0.1, type: 'magic', price: '7500 MO' }
            ],
            ring2: [
                { name: 'Anillo de Cobre', ac: 0, weight: 0.1, type: 'light', price: '1 MO' },
                { name: 'Anillo de Oro', ac: 0, weight: 0.1, type: 'medium', price: '50 MO' },
                { name: 'Anillo de Protección +2', ac: 2, weight: 0.1, type: 'magic', price: '5000 MO' },
                { name: 'Anillo de Regeneración', ac: 0, weight: 0.1, type: 'magic', price: '15000 MO' }
            ],
            armor: [
                { name: 'Sin Armadura', ac: 10, weight: 0, type: 'none', price: '0 MO' },
                { name: 'Armadura de Cuero', ac: 8, weight: 13, type: 'light', price: '10 MO' },
                { name: 'Cuero Tachonado', ac: 7, weight: 11, type: 'light', price: '25 MO' },
                { name: 'Cota de Malla', ac: 5, weight: 18, type: 'medium', price: '100 MO' },
                { name: 'Armadura de Escamas', ac: 6, weight: 18, type: 'medium', price: '120 MO' },
                { name: 'Armadura de Placas', ac: 3, weight: 22, type: 'heavy', price: '600 MO' },
                { name: 'Armadura Completa', ac: 2, weight: 31, type: 'heavy', price: '1200 MO' },
                { name: 'Armadura +1', ac: 2, weight: 18, type: 'magic', price: '3000 MO' }
            ],
            shield: [
                { name: 'Sin Escudo', ac: 0, weight: 0, type: 'none', price: '0 MO' },
                { name: 'Escudo Pequeño', ac: 1, weight: 2, type: 'light', price: '3 MO' },
                { name: 'Escudo Mediano', ac: 1, weight: 5, type: 'medium', price: '7 MO' },
                { name: 'Escudo Grande', ac: 2, weight: 8, type: 'heavy', price: '15 MO' },
                { name: 'Escudo +1', ac: 2, weight: 5, type: 'magic', price: '1500 MO' },
                { name: 'Escudo +2', ac: 3, weight: 5, type: 'magic', price: '4000 MO' }
            ],
            boots: [
                { name: 'Sandalias', ac: 0, weight: 0.5, type: 'light', price: '2 MO' },
                { name: 'Botas de Cuero', ac: 0, weight: 1, type: 'medium', price: '8 MO' },
                { name: 'Botas de Velocidad', ac: 0, weight: 1, type: 'magic', price: '5000 MO' },
                { name: 'Botas de Andar por el Agua', ac: 0, weight: 1, type: 'magic', price: '3000 MO' }
            ],
            belt: [
                { name: 'Cinturón de Cuerda', ac: 0, weight: 0.5, type: 'light', price: '1 MO' },
                { name: 'Cinturón de Cuero', ac: 0, weight: 1, type: 'medium', price: '5 MO' },
                { name: 'Cinturón de Fuerza de Gigante', ac: 0, weight: 1, type: 'magic', price: '8000 MO' },
                { name: 'Cinturón Élfico', ac: 0, weight: 0.5, type: 'magic', price: '2500 MO' }
            ],
            weapon1: [
                { name: 'Puños', damage: '1d3', weight: 0, type: 'none', price: '0 MO' },
                { name: 'Daga', damage: '1d4', weight: 1, type: 'light', price: '2 MO' },
                { name: 'Espada Corta', damage: '1d6', weight: 1, type: 'light', price: '10 MO' },
                { name: 'Espada Larga', damage: '1d8', weight: 2, type: 'medium', price: '15 MO' },
                { name: 'Espada Mandoble', damage: '2d6', weight: 7, type: 'heavy', price: '50 MO' },
                { name: 'Hacha de Mano', damage: '1d6', weight: 2, type: 'light', price: '5 MO' },
                { name: 'Hacha de Batalla', damage: '1d8', weight: 3, type: 'medium', price: '5 MO' },
                { name: 'Gran Hacha', damage: '1d12', weight: 7, type: 'heavy', price: '30 MO' },
                { name: 'Martillo de Guerra', damage: '1d8', weight: 3, type: 'medium', price: '2 MO' },
                { name: 'Maza', damage: '1d6', weight: 4, type: 'medium', price: '5 MO' },
                { name: 'Lanza', damage: '1d6', weight: 2, type: 'medium', price: '6 MO' },
                { name: 'Alabarda', damage: '1d10', weight: 7, type: 'heavy', price: '10 MO' },
                { name: 'Espada +1', damage: '1d8+1', weight: 2, type: 'magic', price: '2000 MO' },
                { name: 'Espada Flamígera +2', damage: '1d8+2', weight: 2, type: 'magic', price: '5000 MO' }
            ],
            weapon2: [
                { name: 'Vacío', damage: '0', weight: 0, type: 'none', price: '0 MO' },
                { name: 'Daga Arrojadiza', damage: '1d4', weight: 1, type: 'light', price: '2 MO' },
                { name: 'Puñal', damage: '1d4', weight: 1, type: 'light', price: '2 MO' },
                { name: 'Martillo Ligero', damage: '1d4', weight: 2, type: 'light', price: '2 MO' },
                { name: 'Hacha de Mano', damage: '1d6', weight: 2, type: 'light', price: '5 MO' },
                { name: 'Maza Ligera', damage: '1d6', weight: 4, type: 'medium', price: '5 MO' },
                { name: 'Cimitarra', damage: '1d6', weight: 2, type: 'light', price: '15 MO' },
                { name: 'Estoque', damage: '1d6', weight: 2, type: 'light', price: '25 MO' }
            ],
            weapon3: [
                { name: 'Vacío', damage: '0', weight: 0, type: 'none', price: '0 MO' },
                { name: 'Bastón', damage: '1d6', weight: 4, type: 'medium', price: '1 MO' },
                { name: 'Vara', damage: '1d8', weight: 8, type: 'medium', price: '2 MO' },
                { name: 'Tridente', damage: '1d6', weight: 2, type: 'medium', price: '15 MO' },
                { name: 'Lanza de Caballería', damage: '1d12', weight: 5, type: 'heavy', price: '10 MO' }
            ],
            weapon4: [
                { name: 'Vacío', damage: '0', weight: 0, type: 'none', price: '0 MO' },
                { name: 'Honda', damage: '1d4', weight: 0, type: 'light', price: '5 MC' },
                { name: 'Dardo', damage: '1d3', weight: 0.25, type: 'light', price: '5 PP' },
                { name: 'Jabalina', damage: '1d6', weight: 1, type: 'light', price: '5 PP' },
                { name: 'Arco Corto', damage: '1d6', weight: 1, type: 'medium', price: '30 MO' },
                { name: 'Arco Largo', damage: '1d8', weight: 2, type: 'medium', price: '75 MO' },
                { name: 'Ballesta Ligera', damage: '1d8', weight: 2, type: 'medium', price: '35 MO' },
                { name: 'Ballesta Pesada', damage: '1d10', weight: 6, type: 'heavy', price: '50 MO' },
                { name: 'Arco Largo +1', damage: '1d8+1', weight: 2, type: 'magic', price: '2500 MO' }
            ],
            weapon5: [
                { name: 'Vacío', damage: '0', weight: 0, type: 'none', price: '0 MO' },
                { name: 'Látigo', damage: '1d2', weight: 1, type: 'exotic', price: '1 MO' },
                { name: 'Red', damage: '0', weight: 2, type: 'exotic', price: '8 MO' },
                { name: 'Mayal', damage: '1d4', weight: 6, type: 'exotic', price: '15 MO' },
                { name: 'Katana', damage: '1d10', weight: 6, type: 'exotic', price: '500+ MO' },
                { name: 'Espada Bastarda', damage: '1d8', weight: 5, type: 'exotic', price: '25 MO' },
                { name: 'Arcabuz', damage: '1d10', weight: 5, type: 'exotic', price: '500 MO' }
            ]
        };

        // Spell data - Basic spell database with most common spells
        const spellDatabase = {
            wizard: {
                1: [
                    { name: "Magic Missile", school: "Evocation", description: "Automatically hits target for 1d4+1 damage per missile" },
                    { name: "Shield", school: "Abjuration", description: "Grants AC 2 vs. missiles, AC 4 vs. other attacks" },
                    { name: "Sleep", school: "Enchantment", description: "Causes 4d4 HD of creatures to fall asleep" },
                    { name: "Charm Person", school: "Enchantment", description: "Makes person friendly and helpful" },
                    { name: "Detect Magic", school: "Divination", description: "Reveals magical auras within 60 feet" },
                    { name: "Light", school: "Alteration", description: "Creates bright light in 20-foot radius" },
                    { name: "Read Magic", school: "Divination", description: "Allows reading of magical writings" },
                    { name: "Burning Hands", school: "Alteration", description: "Cone of fire deals 1d3+2 per level damage" },
                    { name: "Identify", school: "Divination", description: "Reveals properties of magical items" },
                    { name: "Feather Fall", school: "Alteration", description: "Slows falling rate to 2 feet per second" }
                ],
                2: [
                    { name: "Fireball", school: "Evocation", description: "Explodes for 1d6 per level damage" },
                    { name: "Web", school: "Evocation", description: "Creates sticky webs to entangle foes" },
                    { name: "Mirror Image", school: "Illusion", description: "Creates 1d4+1 duplicate images" },
                    { name: "Invisibility", school: "Illusion", description: "Makes creature invisible until it attacks" },
                    { name: "Knock", school: "Alteration", description: "Opens locked doors and containers" },
                    { name: "Levitate", school: "Alteration", description: "Moves up and down at 20 feet per round" },
                    { name: "Detect Invisibility", school: "Divination", description: "Reveals invisible creatures and objects" },
                    { name: "Strength", school: "Alteration", description: "Raises Strength to 18/00 for a time" }
                ],
                3: [
                    { name: "Lightning Bolt", school: "Evocation", description: "Bolt deals 1d6 per level damage" },
                    { name: "Dispel Magic", school: "Abjuration", description: "Cancels magical effects" },
                    { name: "Hold Person", school: "Enchantment", description: "Paralyzes 1-4 persons" },
                    { name: "Fly", school: "Alteration", description: "Grants flight at 18 movement rate" },
                    { name: "Haste", school: "Alteration", description: "Doubles movement and attacks" },
                    { name: "Slow", school: "Alteration", description: "Halves movement and attacks" }
                ]
            },
            priest: {
                1: [
                    { name: "Cure Light Wounds", school: "Necromancy", description: "Heals 1d8 points of damage" },
                    { name: "Bless", school: "Conjuration", description: "Improves morale and attack rolls" },
                    { name: "Command", school: "Enchantment", description: "Subject obeys one-word command" },
                    { name: "Detect Evil", school: "Divination", description: "Reveals evil auras within 60 feet" },
                    { name: "Light", school: "Alteration", description: "Creates bright light in 20-foot radius" },
                    { name: "Protection from Evil", school: "Abjuration", description: "Ward against evil attacks" },
                    { name: "Remove Fear", school: "Abjuration", description: "Suppresses fear effects" },
                    { name: "Sanctuary", school: "Abjuration", description: "Opponents can't attack caster" }
                ],
                2: [
                    { name: "Cure Moderate Wounds", school: "Necromancy", description: "Heals 1d8+1 points of damage" },
                    { name: "Hold Person", school: "Enchantment", description: "Paralyzes one person" },
                    { name: "Silence 15' Radius", school: "Alteration", description: "Creates zone of absolute silence" },
                    { name: "Spiritual Hammer", school: "Invocation", description: "Magical hammer attacks foes" },
                    { name: "Know Alignment", school: "Divination", description: "Reveals creature's alignment" },
                    { name: "Snake Charm", school: "Enchantment", description: "Charms snakes within area" }
                ],
                3: [
                    { name: "Cure Serious Wounds", school: "Necromancy", description: "Heals 2d8+1 points of damage" },
                    { name: "Dispel Magic", school: "Abjuration", description: "Cancels magical effects" },
                    { name: "Prayer", school: "Conjuration", description: "Aids allies and hinders enemies" },
                    { name: "Remove Curse", school: "Abjuration", description: "Removes curses from creature or object" }
                ]
            },
            psionic: [
                { name: "Mind Blast", discipline: "Telepathy", description: "Mental attack that stuns opponents" },
                { name: "Levitation", discipline: "Psychokinesis", description: "Lift objects or self with mind power" },
                { name: "ESP", discipline: "Telepathy", description: "Read surface thoughts of others" },
                { name: "Telekinesis", discipline: "Psychokinesis", description: "Move objects with mental force" },
                { name: "Body Equilibrium", discipline: "Psychometabolism", description: "Walk on water or other surfaces" },
                { name: "Invisibility", discipline: "Psychometabolism", description: "Bend light to become invisible" }
            ]
        };

        // Character spell slots by level (simplified AD&D progression)
        const spellSlotsByLevel = {
            wizard: {
                1: [1, 0, 0, 0, 0, 0, 0, 0, 0],
                2: [2, 0, 0, 0, 0, 0, 0, 0, 0],
                3: [2, 1, 0, 0, 0, 0, 0, 0, 0],
                4: [3, 2, 0, 0, 0, 0, 0, 0, 0],
                5: [4, 2, 1, 0, 0, 0, 0, 0, 0],
                6: [4, 2, 2, 0, 0, 0, 0, 0, 0],
                7: [4, 3, 2, 1, 0, 0, 0, 0, 0],
                8: [4, 3, 3, 2, 0, 0, 0, 0, 0],
                9: [4, 3, 3, 2, 1, 0, 0, 0, 0],
                10: [4, 4, 3, 3, 2, 0, 0, 0, 0]
            },
            priest: {
                1: [1, 0, 0, 0, 0, 0, 0],
                2: [2, 0, 0, 0, 0, 0, 0],
                3: [2, 1, 0, 0, 0, 0, 0],
                4: [3, 2, 0, 0, 0, 0, 0],
                5: [3, 3, 1, 0, 0, 0, 0],
                6: [3, 3, 2, 0, 0, 0, 0],
                7: [3, 3, 2, 1, 0, 0, 0],
                8: [3, 3, 3, 2, 0, 0, 0],
                9: [4, 4, 3, 2, 1, 0, 0],
                10: [4, 4, 3, 3, 2, 0, 0]
            }
        };

        // Class data structure
        const classData = {
            luchador: {
                name: 'Luchador',
                classes: ['Bárbaro', 'Ranger', 'Guerrero', 'Paladín', 'Samurái'],
                hitDie: 'd10',
                primaryAbility: 'strength'
            },
            sacerdote: {
                name: 'Sacerdote',
                classes: ['Clérigo', 'Druida', 'Chamán'],
                hitDie: 'd8',
                primaryAbility: 'wisdom'
            },
            hechicero: {
                name: 'Hechicero',
                classes: ['Mago', 'Hechicero', 'Bruja', 'Artífice'],
                hitDie: 'd4',
                primaryAbility: 'intelligence'
            },
            bribon: {
                name: 'Bribón',
                classes: ['Ladrón', 'Bardo', 'Ninja', 'Psiónico', 'Pistolero'],
                hitDie: 'd6',
                primaryAbility: 'dexterity'
            }
        };

        // AD&D ability score modifiers
        const abilityModifiers = {
            strength: {
                1: { hit: -5, damage: -4 }, 2: { hit: -3, damage: -2 }, 3: { hit: -3, damage: -1 },
                4: { hit: -2, damage: -1 }, 5: { hit: -2, damage: -1 }, 6: { hit: -1, damage: 0 },
                7: { hit: -1, damage: 0 }, 8: { hit: 0, damage: 0 }, 9: { hit: 0, damage: 0 },
                10: { hit: 0, damage: 0 }, 11: { hit: 0, damage: 0 }, 12: { hit: 0, damage: 0 },
                13: { hit: 0, damage: 0 }, 14: { hit: 0, damage: 0 }, 15: { hit: 0, damage: 0 },
                16: { hit: 0, damage: 1 }, 17: { hit: 1, damage: 1 }, 18: { hit: 1, damage: 2 },
                19: { hit: 3, damage: 7 }, 20: { hit: 3, damage: 8 }, 21: { hit: 4, damage: 9 },
                22: { hit: 4, damage: 10 }, 23: { hit: 5, damage: 11 }, 24: { hit: 6, damage: 12 },
                25: { hit: 7, damage: 14 }
            },
            dexterity: {
                1: { reaction: -6, missile: -6, ac: 5 }, 2: { reaction: -4, missile: -4, ac: 5 },
                3: { reaction: -3, missile: -3, ac: 4 }, 4: { reaction: -2, missile: -2, ac: 3 },
                5: { reaction: -1, missile: -1, ac: 2 }, 6: { reaction: 0, missile: 0, ac: 1 },
                7: { reaction: 0, missile: 0, ac: 0 }, 8: { reaction: 0, missile: 0, ac: 0 },
                9: { reaction: 0, missile: 0, ac: 0 }, 10: { reaction: 0, missile: 0, ac: 0 },
                11: { reaction: 0, missile: 0, ac: 0 }, 12: { reaction: 0, missile: 0, ac: 0 },
                13: { reaction: 0, missile: 0, ac: 0 }, 14: { reaction: 0, missile: 0, ac: 0 },
                15: { reaction: 0, missile: 0, ac: -1 }, 16: { reaction: 1, missile: 1, ac: -2 },
                17: { reaction: 2, missile: 2, ac: -3 }, 18: { reaction: 2, missile: 2, ac: -4 },
                19: { reaction: 3, missile: 3, ac: -4 }, 20: { reaction: 3, missile: 3, ac: -4 },
                21: { reaction: 4, missile: 4, ac: -5 }, 22: { reaction: 4, missile: 4, ac: -5 },
                23: { reaction: 5, missile: 5, ac: -6 }, 24: { reaction: 5, missile: 5, ac: -6 },
                25: { reaction: 6, missile: 6, ac: -7 }
            },
            constitution: {
                1: { hp: -3, shock: 25, resurrection: 30 }, 2: { hp: -2, shock: 30, resurrection: 35 },
                3: { hp: -2, shock: 35, resurrection: 40 }, 4: { hp: -1, shock: 40, resurrection: 45 },
                5: { hp: -1, shock: 45, resurrection: 50 }, 6: { hp: -1, shock: 50, resurrection: 55 },
                7: { hp: 0, shock: 55, resurrection: 60 }, 8: { hp: 0, shock: 60, resurrection: 65 },
                9: { hp: 0, shock: 65, resurrection: 70 }, 10: { hp: 0, shock: 70, resurrection: 75 },
                11: { hp: 0, shock: 75, resurrection: 80 }, 12: { hp: 0, shock: 80, resurrection: 85 },
                13: { hp: 0, shock: 85, resurrection: 90 }, 14: { hp: 0, shock: 88, resurrection: 92 },
                15: { hp: 1, shock: 90, resurrection: 94 }, 16: { hp: 2, shock: 95, resurrection: 96 },
                17: { hp: 3, shock: 97, resurrection: 98 }, 18: { hp: 4, shock: 99, resurrection: 100 },
                19: { hp: 5, shock: 99, resurrection: 100 }, 20: { hp: 5, shock: 99, resurrection: 100 },
                21: { hp: 6, shock: 99, resurrection: 100 }, 22: { hp: 6, shock: 99, resurrection: 100 },
                23: { hp: 6, shock: 99, resurrection: 100 }, 24: { hp: 7, shock: 99, resurrection: 100 },
                25: { hp: 7, shock: 100, resurrection: 100 }
            }
        };

        // Equipment Functions
        function equipItem(slotType) {
            const items = equipmentDatabase[slotType] || [];
            if (items.length === 0) {
                showNotification('No hay objetos disponibles para este slot');
                return;
            }

            let optionsHtml = '<option value="">Seleccionar objeto...</option>';
            items.forEach((item, index) => {
                optionsHtml += `<option value="${index}">${item.name} (AC: ${item.ac > 0 ? '+' : ''}${item.ac}, Peso: ${item.weight}kg, ${item.price})</option>`;
            });

            const selection = prompt(`Selecciona un objeto para ${slotType}:\n\n${items.map((item, index) => 
                `${index + 1}. ${item.name} (AC: ${item.ac > 0 ? '+' : ''}${item.ac}, Peso: ${item.weight}kg, ${item.price})`
            ).join('\n')}\n\n0. Quitar objeto actual\n\nIngresa el número:`);

            if (selection === null) return;
            
            const itemIndex = parseInt(selection) - 1;
            
            if (selection === '0') {
                character.equipment[slotType] = null;
                updateEquipmentSlot(slotType, null);
            } else if (itemIndex >= 0 && itemIndex < items.length) {
                character.equipment[slotType] = items[itemIndex];
                updateEquipmentSlot(slotType, items[itemIndex]);
            } else {
                showNotification('Selección inválida');
                return;
            }
            
            updateArmorStats();
        }

        function equipWeapon(slotType) {
            equipItem(slotType);
        }

        function updateEquipmentSlot(slotType, item) {
            const slot = document.getElementById(`${slotType}-slot`);
            const itemDiv = slot.querySelector('.slot-item');
            
            if (item) {
                itemDiv.textContent = item.name;
                itemDiv.className = 'slot-item';
                slot.classList.add('occupied');
                
                if (slotType.startsWith('weapon')) {
                    itemDiv.textContent += ` (${item.damage})`;
                }
            } else {
                itemDiv.textContent = 'Vacío';
                itemDiv.className = 'slot-item slot-empty';
                slot.classList.remove('occupied');
            }
        }

        function updateArmorStats() {
            let totalAC = 10;
            let totalWeight = 0;
            let dexPenalty = 0;
            let maxDexBonus = 6;
            let speed = 12;
            
            // Calculate from equipped items
            Object.values(character.equipment).forEach(item => {
                if (item) {
                    totalWeight += item.weight;
                    if (item.ac) {
                        if (item.name === 'Sin Armadura' || item.name === 'Sin Escudo' || item.name === 'Vacío') {
                            // These don't affect AC
                        } else {
                            totalAC -= Math.abs(item.ac);
                        }
                    }
                }
            });

            // Apply dexterity modifier
            const dex = parseInt(document.getElementById('dexterity').value) || 10;
            const dexMod = abilityModifiers.dexterity[dex]?.ac || 0;
            totalAC += dexMod;

            // Update display
            document.getElementById('equipmentAC').textContent = totalAC;
            document.getElementById('totalWeight').textContent = `${totalWeight} kg`;
            document.getElementById('dexPenalty').textContent = dexPenalty;
            document.getElementById('maxDexBonus').textContent = `+${maxDexBonus}`;
            document.getElementById('armorSpeed').textContent = speed;
            document.getElementById('magicResistance').textContent = '0%';
            
            // Update main AC displays
            character.armorClass = totalAC;
            document.getElementById('armorClass').textContent = totalAC;
            document.getElementById('combatAC').textContent = totalAC;
        }

        function quickEquipSet(setType) {
            // Clear current equipment
            Object.keys(character.equipment).forEach(slot => {
                character.equipment[slot] = null;
            });

            // Quick equip sets
            const sets = {
                warrior: {
                    armor: equipmentDatabase.armor[4], // Chain Mail
                    shield: equipmentDatabase.shield[2], // Medium Shield
                    helmet: equipmentDatabase.helmet[1], // Steel Helm
                    weapon1: equipmentDatabase.weapon1[3], // Long Sword
                    weapon2: equipmentDatabase.weapon2[4], // Hand Axe
                    weapon4: equipmentDatabase.weapon4[4], // Short Bow
                    boots: equipmentDatabase.boots[1], // Leather Boots
                    cloak: equipmentDatabase.cloak[0], // Travel Cloak
                    gauntlets: equipmentDatabase.gauntlets[0] // Leather Gloves
                },
                priest: {
                    armor: equipmentDatabase.armor[3], // Chain Mail
                    shield: equipmentDatabase.shield[1], // Small Shield
                    helmet: equipmentDatabase.helmet[0], // Leather Cap
                    weapon1: equipmentDatabase.weapon1[9], // Mace
                    weapon3: equipmentDatabase.weapon3[1], // Rod
                    cloak: equipmentDatabase.cloak[1], // Wool Cloak
                    boots: equipmentDatabase.boots[1], // Leather Boots
                    neck: equipmentDatabase.neck[3] // Sacred Medallion
                }
            };

            const selectedSet = sets[setType];
            if (selectedSet) {
                Object.entries(selectedSet).forEach(([slot, item]) => {
                    character.equipment[slot] = item;
                    updateEquipmentSlot(slot, item);
                });
                updateArmorStats();
                showNotification(`Equipo de ${setType} equipado correctamente`);
            }
        }

        function clearAllEquipment() {
            Object.keys(character.equipment).forEach(slot => {
                character.equipment[slot] = null;
                updateEquipmentSlot(slot, null);
            });
            updateArmorStats();
            showNotification('Todo el equipo ha sido removido');
        }

        function updateMoney() {
            const gold = parseInt(document.getElementById('gold').value) || 0;
            const silver = parseInt(document.getElementById('silver').value) || 0;
            const copper = parseInt(document.getElementById('copper').value) || 0;
            
            character.money.gold = gold;
            character.money.silver = silver;
            character.money.copper = copper;
            
            // Calculate total value in gold
            const totalValue = gold + (silver / 10) + (copper / 100);
            document.getElementById('totalValue').value = `${totalValue.toFixed(2)} MO`;
        }

        // Notification system
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Tab system
        function showTab(tabName, element) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => tab.classList.remove('active'));
            
            // Remove active class from all tab buttons
            const tabBtns = document.querySelectorAll('.tab-btn');
            tabBtns.forEach(btn => btn.classList.remove('active'));
            
            // Show selected tab and mark button as active
            document.getElementById(tabName + '-tab').classList.add('active');
            element.classList.add('active');
        }

        // Character management functions
        function updateCharacterDisplay() {
            const name = document.getElementById('characterName').value || 'Nuevo Personaje';
            const race = document.getElementById('race').value;
            
            document.getElementById('characterNameDisplay').textContent = name;
            
            if (character.primaryClass) {
                let classDisplay = classData[character.primaryClass].name;
                if (character.specificClass) {
                    classDisplay = character.specificClass;
                }
                if (race) {
                    classDisplay = `${race} ${classDisplay}`;
                }
                document.getElementById('characterClassDisplay').textContent = classDisplay;
            }
        }

        function selectPrimaryCategory(category) {
            // Update selection
            document.querySelectorAll('.category-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`[data-category="${category}"]`).classList.add('selected');
            
            character.primaryClass = category;
            
            // Update secondary categories
            const secondaryGrid = document.getElementById('secondaryCategoryGrid');
            const otherCategories = Object.keys(classData).filter(cat => cat !== category);
            
            secondaryGrid.innerHTML = '';
            otherCategories.forEach(cat => {
                const option = document.createElement('div');
                option.className = 'category-option';
                option.setAttribute('data-category', cat);
                option.onclick = () => selectSecondaryCategory(cat);
                
                option.innerHTML = `
                    <span class="category-name">${classData[cat].name}</span>
                    <span class="category-desc">${classData[cat].classes.join(', ')}</span>
                `;
                
                secondaryGrid.appendChild(option);
            });
            
            // Update specific class options
            updateSpecificClassOptions();
            updateCharacterDisplay();
        }

        function selectSecondaryCategory(category) {
            document.querySelectorAll('#secondaryCategoryGrid .category-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`#secondaryCategoryGrid [data-category="${category}"]`).classList.add('selected');
            
            character.secondaryClass = category;
            
            // Update tertiary categories
            const tertiaryGrid = document.getElementById('tertiaryCategoryGrid');
            const remainingCategories = Object.keys(classData).filter(cat => 
                cat !== character.primaryClass && cat !== category
            );
            
            tertiaryGrid.innerHTML = '';
            remainingCategories.forEach(cat => {
                const option = document.createElement('div');
                option.className = 'category-option';
                option.setAttribute('data-category', cat);
                option.onclick = () => selectTertiaryCategory(cat);
                
                option.innerHTML = `
                    <span class="category-name">${classData[cat].name}</span>
                    <span class="category-desc">${classData[cat].classes.join(', ')}</span>
                `;
                
                tertiaryGrid.appendChild(option);
            });
        }

        function selectTertiaryCategory(category) {
            document.querySelectorAll('#tertiaryCategoryGrid .category-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`#tertiaryCategoryGrid [data-category="${category}"]`).classList.add('selected');
            
            character.tertiaryClass = category;
        }

        function updateSpecificClassOptions() {
            const specificClassSelect = document.getElementById('specificClass');
            
            if (character.primaryClass) {
                const classes = classData[character.primaryClass].classes;
                
                specificClassSelect.innerHTML = '<option value="">Selecciona una clase específica</option>';
                classes.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    specificClassSelect.appendChild(option);
                });
            }
        }
// ==========================================
// SISTEMA DE PERICIAS Y COMBATE AD&D 2e
// ==========================================

// Variables globales para el sistema
let skillsData = null;
let weaponsData = null;
let armorData = null;
let characterSkills = {
    weaponProficiencies: {},
    nonWeaponProficiencies: {},
    combatStyles: {}
};

// ==========================================
// DATOS BASE DEL SISTEMA
// ==========================================

// Grupos de clases
const CLASS_GROUPS = {
    'luchador': ['Bárbaro', 'Ranger', 'Guerrero', 'Paladín', 'Samurái'],
    'sacerdote': ['Clérigo', 'Druida', 'Chamán'],
    'hechicero': ['Mago', 'Hechicero', 'Bruja', 'Artífice'],
    'bribon': ['Ladrón', 'Bardo', 'Ninja', 'Psiónico', 'Pistolero']
};

// Datos de estilos de combate
const COMBAT_STYLES = {
    'sin-armas': {
        name: 'Sin Armas (Puños)',
        description: 'Combate desarmado especializado',
        availableFor: ['todos'],
        levels: {
            especialista: {
                name: 'Especialista',
                cost: 1,
                effects: '+4 CA, +0.5 ataques/ronda, 1 Arte Marcial'
            },
            maestro: {
                name: 'Maestro',
                cost: 2,
                effects: '+0.5 ataques/ronda adicional, Mejora Arte Marcial'
            }
        }
    },
    'arma-unica': {
        name: 'Arma Única',
        description: 'Especialización en combate con una sola arma',
        availableFor: ['todos'],
        levels: {
            especialista: {
                name: 'Especialista',
                cost: 1,
                effects: '+1 CA defensiva'
            },
            maestro: {
                name: 'Maestro',
                cost: 2,
                effects: '+2 CA defensiva total'
            }
        }
    },
    'arma-y-escudo': {
        name: 'Arma y Escudo',
        description: 'Combate con arma de una mano y escudo',
        availableFor: ['luchador', 'sacerdote'],
        levels: {
            especialista: {
                name: 'Especialista',
                cost: 1,
                effects: '+2 CA adicional del escudo'
            },
            maestro: {
                name: 'Maestro',
                cost: 2,
                effects: '1 ataque con escudo adicional'
            }
        }
    },
    'arma-dos-manos': {
        name: 'Arma a Dos Manos',
        description: 'Especialización en armas de dos manos',
        availableFor: ['luchador', 'sacerdote', 'hechicero'],
        levels: {
            especialista: {
                name: 'Especialista',
                cost: 1,
                effects: '+50% ajuste al daño por Fuerza'
            },
            maestro: {
                name: 'Maestro',
                cost: 2,
                effects: '+100% ajuste al daño por Fuerza'
            }
        }
    },
    'dos-armas': {
        name: 'Dos Armas',
        description: 'Combate con arma en cada mano',
        availableFor: ['luchador', 'bribon'],
        levels: {
            especialista: {
                name: 'Especialista',
                cost: 1,
                effects: 'Reduce penalizadores por combate con dos armas'
            },
            maestro: {
                name: 'Maestro',
                cost: 2,
                effects: 'Misma cantidad de ataques en ambas manos'
            }
        }
    },
    'arqueria': {
        name: 'Arquería',
        description: 'Especialización en arcos',
        availableFor: ['luchador', 'bribon'],
        levels: {
            especialista: {
                name: 'Especialista',
                cost: 1,
                effects: '+2 daño con arcos, +50% alcance'
            },
            maestro: {
                name: 'Maestro',
                cost: 2,
                effects: '+4 daño total, +100% alcance'
            }
        }
    },
    'ballestas': {
        name: 'Ballestas',
        description: 'Especialización en ballestas',
        availableFor: ['luchador', 'bribon'],
        levels: {
            especialista: {
                name: 'Especialista',
                cost: 1,
                effects: 'Recarga más rápida, +0.5 ataques/ronda'
            },
            maestro: {
                name: 'Maestro',
                cost: 2,
                effects: 'Recarga de rayo, +0.5 ataques/ronda adicional'
            }
        }
    }
};

// Armas básicas para el sistema
const BASIC_WEAPONS = [
    // Armas cuerpo a cuerpo
    { name: 'Puños', type: 'melee', size: 'S', damage: '1d2', speed: 2, category: 'Desarmado' },
    { name: 'Daga', type: 'melee', size: 'S', damage: '1d4', speed: 2, category: 'Cuchilla Pequeña' },
    { name: 'Espada Corta', type: 'melee', size: 'S', damage: '1d6', speed: 3, category: 'Cuchilla Pequeña' },
    { name: 'Espada Larga', type: 'melee', size: 'M', damage: '1d8', speed: 5, category: 'Cuchilla Larga' },
    { name: 'Espada de dos Manos', type: 'melee', size: 'L', damage: '1d10', speed: 10, category: 'Cuchilla Larga' },
    { name: 'Hacha de Mano', type: 'melee', size: 'M', damage: '1d6', speed: 4, category: 'Hacha' },
    { name: 'Hacha de Guerra', type: 'melee', size: 'M', damage: '1d8', speed: 7, category: 'Hacha' },
    { name: 'Maza', type: 'melee', size: 'M', damage: '1d6+1', speed: 7, category: 'Contundente' },
    { name: 'Martillo de Guerra', type: 'melee', size: 'M', damage: '1d4+1', speed: 4, category: 'Contundente' },
    { name: 'Lanza', type: 'melee', size: 'M', damage: '1d6', speed: 6, category: 'Lanza' },
    { name: 'Alabarda', type: 'melee', size: 'L', damage: '1d10', speed: 9, category: 'Asta' },
    { name: 'Bastón', type: 'melee', size: 'L', damage: '1d6', speed: 4, category: 'Bastón' },
    
    // Armas a distancia
    { name: 'Arco Corto', type: 'ranged', size: 'M', damage: '1d6', speed: 7, range: '50/100/150', category: 'Arco' },
    { name: 'Arco Largo', type: 'ranged', size: 'L', damage: '1d6', speed: 8, range: '70/140/210', category: 'Arco' },
    { name: 'Ballesta Ligera', type: 'ranged', size: 'M', damage: '1d4', speed: 7, range: '60/120/180', category: 'Ballesta' },
    { name: 'Ballesta Pesada', type: 'ranged', size: 'L', damage: '1d4+1', speed: 10, range: '80/160/240', category: 'Ballesta' },
    { name: 'Honda', type: 'ranged', size: 'S', damage: '1d4+1', speed: 6, range: '40/80/160', category: 'Honda' },
    { name: 'Jabalina', type: 'thrown', size: 'M', damage: '1d6', speed: 4, range: '20/40/60', category: 'Lanza' },
    { name: 'Daga Arrojadiza', type: 'thrown', size: 'S', damage: '1d4', speed: 2, range: '10/20/30', category: 'Cuchilla Pequeña' }
];

// Armaduras básicas
const BASIC_ARMOR = [
    { name: 'Sin Armadura', ac: 10, type: 'none', weight: 0, dexBonus: 'unlimited' },
    { name: 'Cuero', ac: 8, type: 'light', weight: 15, dexBonus: 'unlimited' },
    { name: 'Cuero Tachonado', ac: 7, type: 'light', weight: 20, dexBonus: 'unlimited' },
    { name: 'Cota de Anillas', ac: 7, type: 'medium', weight: 30, dexBonus: 2 },
    { name: 'Cota de Escamas', ac: 6, type: 'medium', weight: 40, dexBonus: 1 },
    { name: 'Cota de Mallas', ac: 5, type: 'medium', weight: 40, dexBonus: 1 },
    { name: 'Armadura de Bandas', ac: 4, type: 'heavy', weight: 35, dexBonus: 1 },
    { name: 'Armadura de Placas', ac: 3, type: 'heavy', weight: 45, dexBonus: 0 },
    { name: 'Armadura de Placas Completa', ac: 1, type: 'heavy', weight: 70, dexBonus: 0 }
];

// ==========================================
// FUNCIONES DE UTILIDAD
// ==========================================

// Obtener grupo de clase actual
function getCurrentClassGroup() {
    const primaryClass = document.getElementById('primary-selected-name')?.textContent || '';
    
    for (const [group, classes] of Object.entries(CLASS_GROUPS)) {
        if (classes.includes(primaryClass)) {
            return group;
        }
    }
    return 'luchador'; // Default
}

// Obtener nivel del personaje
function getCurrentLevel() {
    return parseInt(document.getElementById('characterLevel')?.value) || 1;
}

// Obtener valor de habilidad
function getAbilityScore(ability) {
    const element = document.getElementById(ability.toLowerCase());
    return parseInt(element?.value) || 10;
}

// Calcular modificador de habilidad
function getAbilityModifier(score, type = 'standard') {
    if (!window.AbilityCalculator || !window.AbilityCalculator.abilityData) {
        // Fallback calculation
        return Math.floor((score - 10) / 2);
    }

    const data = window.AbilityCalculator.abilityData;
    let abilityTable;
    
    switch (type) {
        case 'strength-hit':
            abilityTable = data.fuerza;
            return findAbilityValue(abilityTable, score, 'Probab. de Golpe') || 0;
        case 'strength-damage':
            abilityTable = data.fuerza;
            return findAbilityValue(abilityTable, score, 'Ajuste de daño') || 0;
        case 'dexterity-defensive':
            abilityTable = data.destreza;
            return findAbilityValue(abilityTable, score, 'Ajuste defensivo') || 0;
        case 'dexterity-missile':
            abilityTable = data.destreza;
            return findAbilityValue(abilityTable, score, 'Ajuste Atq Proyectiles') || 0;
        default:
            return Math.floor((score - 10) / 2);
    }
}

// Buscar valor en tabla de habilidades
function findAbilityValue(table, score, column) {
    const entry = table.find(row => {
        const abilityScore = row['Punt. Habilidad'] || row['Puntuación habilidad'];
        return parseInt(abilityScore) === score;
    });
    
    if (entry) {
        const value = entry[column];
        return parseInt(value) || 0;
    }
    return 0;
}

// ==========================================
// CÁLCULOS DE COMBATE
// ==========================================

// Calcular GACO base por clase y nivel
function calculateBaseGaco() {
    const classGroup = getCurrentClassGroup();
    const level = getCurrentLevel();
    let baseGaco = 20;

    switch (classGroup) {
        case 'luchador':
            baseGaco = 21 - level; // Mejora cada nivel
            break;
        case 'sacerdote':
        case 'bribon':
            baseGaco = 20 - Math.floor((level - 1) / 2); // Mejora cada 2 niveles
            break;
        case 'hechicero':
            baseGaco = 20 - Math.floor((level - 1) / 3); // Mejora cada 3 niveles
            break;
    }

    return Math.max(1, baseGaco); // Mínimo GACO 1
}

// Calcular Clase de Armadura
function calculateArmorClass() {
    let ac = 10; // CA base sin armadura
    
    // CA de armadura equipada (implementar cuando esté el sistema de equipo)
    const equippedArmor = getEquippedArmor();
    if (equippedArmor) {
        ac = equippedArmor.ac;
    }
    
    // Modificador defensivo de destreza
    const dexScore = getAbilityScore('dexterity');
    const dexDefensive = getAbilityModifier(dexScore, 'dexterity-defensive');
    ac -= dexDefensive; // En AD&D menor CA es mejor
    
    // Escudo equipado
    const hasShield = getEquippedShield();
    if (hasShield) {
        ac -= 1; // Escudo base
        
        // Especialización en "Arma y escudo"
        if (hasCombatStyleActive('arma-y-escudo')) {
            ac -= 2; // +2 CA adicional del escudo
        }
    }
    
    // Bonificaciones por otros estilos
    if (hasCombatStyleActive('arma-unica')) {
        const styleLevel = getCombatStyleLevel('arma-unica');
        ac -= styleLevel === 'maestro' ? 2 : 1;
    }
    
    if (hasCombatStyleActive('sin-armas')) {
        ac -= 4; // +4 CA por combate desarmado
    }
    
    return Math.max(ac, -10); // Límite práctico de CA
}

// Calcular Iniciativa
function calculateInitiative() {
    const dexScore = getAbilityScore('dexterity');
    const dexReaction = getAbilityModifier(dexScore, 'dexterity-missile'); // Usar missile para reacción
    return dexReaction;
}

// ==========================================
// SISTEMA DE PERICIAS EN ARMAS
// ==========================================

// Calcular casillas de armas disponibles
function calculateWeaponProficiencySlots() {
    const classGroup = getCurrentClassGroup();
    const level = getCurrentLevel();
    let slots = 0;
    
    switch (classGroup) {
        case 'luchador':
            slots = 4 + Math.floor((level - 1) / 3); // 4 iniciales + 1 cada 3 niveles
            break;
        case 'sacerdote':
        case 'bribon':
            slots = 2 + Math.floor((level - 1) / 4); // 2 iniciales + 1 cada 4 niveles
            break;
        case 'hechicero':
            slots = 1 + Math.floor((level - 1) / 6); // 1 inicial + 1 cada 6 niveles
            break;
    }
    
    return slots;
}

// Obtener penalizador sin pericia
function getWeaponPenaltyWithoutProficiency() {
    const classGroup = getCurrentClassGroup();
    
    switch (classGroup) {
        case 'luchador': return -2;
        case 'sacerdote':
        case 'bribon': return -3;
        case 'hechicero': return -5;
        default: return -2;
    }
}

// Renderizar pericias en armas
function renderWeaponProficiencies() {
    const container = document.getElementById('weapons-proficiency-grid');
    const slotsCounter = document.getElementById('weapon-slots-counter');
    
    if (!container || !slotsCounter) return;
    
    const totalSlots = calculateWeaponProficiencySlots();
    const usedSlots = calculateUsedWeaponSlots();
    const availableSlots = totalSlots - usedSlots;
    
    slotsCounter.textContent = `${availableSlots}/${totalSlots} casillas`;
    
    // Limpiar contenedor
    container.innerHTML = '';
    
    // Renderizar armas
    BASIC_WEAPONS.forEach(weapon => {
        const weaponElement = createWeaponProficiencyElement(weapon, availableSlots);
        container.appendChild(weaponElement);
    });
}

// Crear elemento de pericia en arma
function createWeaponProficiencyElement(weapon, availableSlots) {
    const div = document.createElement('div');
    div.className = 'weapon-item';
    
    const currentLevel = characterSkills.weaponProficiencies[weapon.name] || 0;
    const canIncrease = availableSlots > 0 && currentLevel < 4;
    const canDecrease = currentLevel > 0;
    
    div.innerHTML = `
        <div class="item-header">
            <span class="item-name">${weapon.name}</span>
            <span class="item-group">${weapon.category}</span>
        </div>
        <div class="item-details">
            <span class="item-characteristic">Daño: ${weapon.damage}</span>
            <span class="item-modifier">Vel: ${weapon.speed}</span>
        </div>
        <div class="proficiency-controls">
            <div class="proficiency-level">
                <button class="level-btn ${canDecrease ? '' : 'disabled'}" 
                        onclick="adjustWeaponProficiency('${weapon.name}', -1)" 
                        ${!canDecrease ? 'disabled' : ''}>-</button>
                <span class="slots-required">${currentLevel}</span>
                <button class="level-btn ${canIncrease ? '' : 'disabled'}" 
                        onclick="adjustWeaponProficiency('${weapon.name}', 1)" 
                        ${!canIncrease ? 'disabled' : ''}>+</button>
            </div>
            <span class="mastery-level">${getMasteryLevelName(currentLevel)}</span>
        </div>
        <div class="mastery-info ${currentLevel > 0 ? 'show' : ''}">
            ${getMasteryEffects(currentLevel)}
        </div>
    `;
    
    return div;
}

// Obtener nombre del nivel de maestría
function getMasteryLevelName(level) {
    switch (level) {
        case 0: return 'Sin Pericia';
        case 1: return 'Pericia Básica';
        case 2: return 'Especialización';
        case 3: return 'Maestro';
        case 4: return 'Gran Maestro';
        default: return 'Sin Pericia';
    }
}

// Obtener efectos de la maestría
function getMasteryEffects(level) {
    switch (level) {
        case 0: return `Penalizador: ${getWeaponPenaltyWithoutProficiency()}`;
        case 1: return 'Sin penalizador';
        case 2: return '+1 ataque, +2 daño, +0.5 ataques/ronda';
        case 3: return '+2 ataque, +4 daño, +0.5 ataques/ronda';
        case 4: return '+3 ataque, +6 daño, +0.5 ataques/ronda';
        default: return '';
    }
}

// Ajustar nivel de pericia en arma
function adjustWeaponProficiency(weaponName, change) {
    const currentLevel = characterSkills.weaponProficiencies[weaponName] || 0;
    const newLevel = Math.max(0, Math.min(4, currentLevel + change));
    
    if (newLevel !== currentLevel) {
        characterSkills.weaponProficiencies[weaponName] = newLevel;
        if (newLevel === 0) {
            delete characterSkills.weaponProficiencies[weaponName];
        }
        renderWeaponProficiencies();
        updateCombatStats();
    }
}

// Calcular casillas de armas usadas
function calculateUsedWeaponSlots() {
    return Object.values(characterSkills.weaponProficiencies).reduce((total, level) => total + level, 0);
}

// ==========================================
// SISTEMA DE PERICIAS EN NO-ARMAS
// ==========================================

// Cargar pericias desde JSON
async function loadSkillsData() {
    try {
        const response = await fetch('https://raw.githubusercontent.com/slurn84-beep/AD-D2.PANDUNK/refs/heads/main/Tabla%20Pericias.html');
        const data = await response.json();
        skillsData = data;
        renderNonWeaponProficiencies();
    } catch (error) {
        console.error('Error loading skills data:', error);
        // Usar datos de fallback si falla la carga
        skillsData = getFallbackSkillsData();
        renderNonWeaponProficiencies();
    }
}

// Datos de fallback para pericias
function getFallbackSkillsData() {
    return [
        { "Pericia": "Natación", "Grupo": "Gen", "Ranuras": "1", "Caracteristica": "Fue", "Modificador": "0" },
        { "Pericia": "Trepar", "Grupo": "Gen", "Ranuras": "1", "Caracteristica": "Fue", "Modificador": "0" },
        { "Pericia": "Rastreo", "Grupo": "Bri", "Ranuras": "2", "Caracteristica": "Sab", "Modificador": "0" },
        { "Pericia": "Supervivencia", "Grupo": "Bri", "Ranuras": "2", "Caracteristica": "Int", "Modificador": "0" },
        { "Pericia": "Primeros Auxilios", "Grupo": "Gen", "Ranuras": "1", "Caracteristica": "Sab", "Modificador": "0" }
    ];
}

// Calcular casillas de no-armas disponibles
function calculateNonWeaponProficiencySlots() {
    const classGroup = getCurrentClassGroup();
    const level = getCurrentLevel();
    const wisdom = getAbilityScore('wisdom');
    
    let baseSlots = 0;
    
    switch (classGroup) {
        case 'luchador':
            baseSlots = 3 + Math.floor((level - 1) / 3); // 3 iniciales + 1 cada 3 niveles
            break;
        case 'sacerdote':
        case 'hechicero':
            baseSlots = 4 + Math.floor((level - 1) / 3); // 4 iniciales + 1 cada 3 niveles
            break;
        case 'bribon':
            baseSlots = 3 + Math.floor((level - 1) / 4); // 3 iniciales + 1 cada 4 niveles
            break;
    }
    
    // Bonificación por Sabiduría
    const wisdomBonus = Math.max(0, Math.floor((wisdom - 8) / 2));
    
    return baseSlots + wisdomBonus;
}

// Renderizar pericias en no-armas
function renderNonWeaponProficiencies() {
    const container = document.getElementById('nonweapon-skills-grid');
    const slotsCounter = document.getElementById('nonweapon-slots-counter');
    
    if (!container || !slotsCounter || !skillsData) return;
    
    const totalSlots = calculateNonWeaponProficiencySlots();
    const usedSlots = calculateUsedNonWeaponSlots();
    const availableSlots = totalSlots - usedSlots;
    
    slotsCounter.textContent = `${availableSlots}/${totalSlots} casillas`;
    
    // Obtener filtros
    const searchTerm = document.getElementById('skill-search')?.value.toLowerCase() || '';
    const groupFilter = document.getElementById('skill-group-filter')?.value || 'all';
    
    // Limpiar contenedor
    container.innerHTML = '';
    
    // Filtrar y renderizar pericias
    const filteredSkills = skillsData.filter(skill => {
        const matchesSearch = skill.Pericia.toLowerCase().includes(searchTerm);
        const matchesGroup = groupFilter === 'all' || skill.Grupo === groupFilter;
        return matchesSearch && matchesGroup;
    });
    
    filteredSkills.forEach(skill => {
        const skillElement = createNonWeaponProficiencyElement(skill, availableSlots);
        container.appendChild(skillElement);
    });
}

// Crear elemento de pericia en no-armas
function createNonWeaponProficiencyElement(skill, availableSlots) {
    const div = document.createElement('div');
    div.className = 'skill-item';
    
    const currentRanks = characterSkills.nonWeaponProficiencies[skill.Pericia] || 0;
    const maxRanks = parseInt(skill.Ranuras);
    const canIncrease = availableSlots > 0 && currentRanks < maxRanks;
    const canDecrease = currentRanks > 0;
    
    // Calcular modificador total
    const baseModifier = parseInt(skill.Modificador) || 0;
    const groupPenalty = getGroupPenalty(skill.Grupo);
    const armorPenalty = getArmorPenalty(skill.Caracteristica);
    const totalModifier = baseModifier + groupPenalty + armorPenalty;
    
    const modifierText = totalModifier >= 0 ? `+${totalModifier}` : `${totalModifier}`;
    
    div.innerHTML = `
        <div class="item-header">
            <span class="item-name">${skill.Pericia}</span>
            <span class="item-group">${skill.Grupo}</span>
        </div>
        <div class="item-details">
            <span class="item-characteristic">${skill.Caracteristica}</span>
            <span class="item-modifier">${modifierText}</span>
        </div>
        <div class="proficiency-controls">
            <div class="proficiency-level">
                <button class="level-btn ${canDecrease ? '' : 'disabled'}" 
                        onclick="adjustNonWeaponProficiency('${skill.Pericia}', -1)" 
                        ${!canDecrease ? 'disabled' : ''}>-</button>
                <span class="slots-required">${currentRanks}/${maxRanks}</span>
                <button class="level-btn ${canIncrease ? '' : 'disabled'}" 
                        onclick="adjustNonWeaponProficiency('${skill.Pericia}', 1)" 
                        ${!canIncrease ? 'disabled' : ''}>+</button>
            </div>
        </div>
        ${currentRanks > 0 ? `
            <div class="mastery-info show">
                Pericia adquirida: ${currentRanks} de ${maxRanks} rangos
            </div>
        ` : ''}
    `;
    
    return div;
}

// Obtener penalizador por grupo
function getGroupPenalty(skillGroup) {
    const classGroup = getCurrentClassGroup();
    
    // Sin penalizador para grupos correspondientes o General
    if (skillGroup === 'Gen') return 0;
    
    const groupMap = {
        'Luc': 'luchador',
        'Sac': 'sacerdote', 
        'Hec': 'hechicero',
        'Mago': 'hechicero',
        'Bri': 'bribon',
        'Psi': 'bribon'
    };
    
    if (groupMap[skillGroup] === classGroup) {
        return 0; // Sin penalizador para su grupo
    }
    
    return 3; // +3 penalizador para otros grupos
}

// Obtener penalizador por armadura (solo para Destreza)
function getArmorPenalty(characteristic) {
    if (characteristic !== 'Des') return 0;
    
    const equippedArmor = getEquippedArmor();
    if (!equippedArmor) return 0;
    
    // Penalizadores por tipo de armadura en pericias de Destreza
    switch (equippedArmor.type) {
        case 'none':
        case 'light': return 0;
        case 'medium': return 2;
        case 'heavy': return 4;
        default: return 0;
    }
}

// Ajustar nivel de pericia en no-armas
function adjustNonWeaponProficiency(skillName, change) {
    const currentRanks = characterSkills.nonWeaponProficiencies[skillName] || 0;
    const skill = skillsData.find(s => s.Pericia === skillName);
    const maxRanks = skill ? parseInt(skill.Ranuras) : 1;
    const newRanks = Math.max(0, Math.min(maxRanks, currentRanks + change));
    
    if (newRanks !== currentRanks) {
        if (newRanks === 0) {
            delete characterSkills.nonWeaponProficiencies[skillName];
        } else {
            characterSkills.nonWeaponProficiencies[skillName] = newRanks;
        }
        renderNonWeaponProficiencies();
    }
}

// Calcular casillas de no-armas usadas
function calculateUsedNonWeaponSlots() {
    return Object.values(characterSkills.nonWeaponProficiencies).reduce((total, ranks) => total + ranks, 0);
}

// ==========================================
// SISTEMA DE ESTILOS DE COMBATE
// ==========================================

// Renderizar estilos de combate
function renderCombatStyles() {
    const container = document.getElementById('combat-styles-container');
    const slotsCounter = document.getElementById('combat-styles-counter');
    
    if (!container || !slotsCounter) return;
    
    const classGroup = getCurrentClassGroup();
    
    // Solo luchadores pueden usar estilos de combate
    if (classGroup !== 'luchador') {
        container.innerHTML = `
            <div class="no-styles-message">
                Los estilos de combate solo están disponibles para Luchadores
            </div>
        `;
        slotsCounter.textContent = '0/0 casillas';
        return;
    }
    
    const totalSlots = calculateWeaponProficiencySlots(); // Usan las mismas casillas que armas
    const usedWeaponSlots = calculateUsedWeaponSlots();
    const usedStyleSlots = calculateUsedStyleSlots();
    const availableSlots = totalSlots - usedWeaponSlots - usedStyleSlots;
    
    slotsCounter.textContent = `${availableSlots}/${totalSlots} casillas`;
    
    container.innerHTML = '';
    
    // Renderizar estilos disponibles
    Object.entries(COMBAT_STYLES).forEach(([styleId, style]) => {
        if (isStyleAvailableForClass(style, classGroup)) {
            const styleElement = createCombatStyleElement(styleId, style, availableSlots);
            container.appendChild(styleElement);
        }
    });
}

// Crear elemento de estilo de combate
function createCombatStyleElement(styleId, style, availableSlots) {
    const div = document.createElement('div');
    div.className = 'combat-style-card';
    
    const currentLevel = characterSkills.combatStyles[styleId] || null;
    
    div.innerHTML = `
        <div class="style-header">
            <span class="style-name">${style.name}</span>
            <span class="style-cost">1+2 casillas</span>
        </div>
        <div class="style-description">${style.description}</div>
        <div class="style-levels">
            ${Object.entries(style.levels).map(([levelId, level]) => {
                const isPurchased = currentLevel === levelId || (currentLevel === 'maestro' && levelId === 'especialista');
                const canPurchase = !isPurchased && availableSlots >= level.cost && 
                    (levelId === 'especialista' || currentLevel === 'especialista');
                
                return `
                    <div class="style-level ${isPurchased ? 'purchased' : ''}">
                        <span class="style-level-name">${level.name}</span>
                        <span class="style-level-effect">${level.effects}</span>
                        <button class="style-level-btn ${isPurchased ? 'purchased' : (canPurchase ? '' : 'disabled')}"
                                onclick="purchaseCombatStyle('${styleId}', '${levelId}')"
                                ${!canPurchase && !isPurchased ? 'disabled' : ''}>
                            ${isPurchased ? 'Comprado' : `${level.cost} casillas`}
                        </button>
                    </div>
                `;
            }).join('')}
        </div>
    `;
    
    return div;
}

// Verificar si el estilo está disponible para la clase
function isStyleAvailableForClass(style, classGroup) {
    return style.availableFor.includes('todos') || style.availableFor.includes(classGroup);
}

// Comprar estilo de combate
function purchaseCombatStyle(styleId, levelId) {
    const style = COMBAT_STYLES[styleId];
    const level = style.levels[levelId];
    const currentLevel = characterSkills.combatStyles[styleId];
    
    // Verificar si ya está comprado
    if (currentLevel === levelId || (currentLevel === 'maestro' && levelId === 'especialista')) {
        return;
    }
    
    // Verificar casillas disponibles
    const totalSlots = calculateWeaponProficiencySlots();
    const usedSlots = calculateUsedWeaponSlots() + calculateUsedStyleSlots();
    const availableSlots = totalSlots - usedSlots;
    
    if (availableSlots < level.cost) {
        alert('No tienes suficientes casillas de pericia disponibles');
        return;
    }
    
    // Verificar prerrequisitos
    if (levelId === 'maestro' && currentLevel !== 'especialista') {
        alert('Debes tener el nivel Especialista antes de comprar Maestro');
        return;
    }
    
    // Comprar el estilo
    characterSkills.combatStyles[styleId] = levelId;
    renderCombatStyles();
    renderCombatStylesInCombatTab();
    updateCombatStats();
}

// Calcular casillas de estilos usadas
function calculateUsedStyleSlots() {
    return Object.entries(characterSkills.combatStyles).reduce((total, [styleId, level]) => {
        const style = COMBAT_STYLES[styleId];
        if (!style) return total;
        
        if (level === 'especialista') {
            return total + style.levels.especialista.cost;
        } else if (level === 'maestro') {
            return total + style.levels.especialista.cost + style.levels.maestro.cost;
        }
        return total;
    }, 0);
}

// ==========================================
// SISTEMA DE COMBATE - TAB COMBAT
// ==========================================

// Renderizar estilos en el tab de combate
function renderCombatStylesInCombatTab() {
    const container = document.getElementById('active-combat-styles');
    if (!container) return;
    
    const purchasedStyles = Object.entries(characterSkills.combatStyles);
    
    if (purchasedStyles.length === 0) {
        container.innerHTML = `
            <div class="no-styles-active">
                <p style="color: #b0b0b0; font-style: italic; text-align: center;">
                    No tienes estilos de combate disponibles.<br>
                    <small>Compra estilos en la pestaña de Pericias para habilitarlos aquí.</small>
                </p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = '';
    
    purchasedStyles.forEach(([styleId, level]) => {
        const style = COMBAT_STYLES[styleId];
        if (style) {
            const styleElement = createActiveCombatStyleElement(styleId, style, level);
            container.appendChild(styleElement);
        }
    });
}

// Crear elemento de estilo activo en combate
function createActiveCombatStyleElement(styleId, style, level) {
    const div = document.createElement('div');
    div.className = 'combat-style-active';
    
    const isActive = characterSkills.activeCombatStyles?.[styleId] || false;
    const effectsText = level === 'maestro' 
        ? `${style.levels.especialista.effects} + ${style.levels.maestro.effects}`
        : style.levels[level].effects;
    
    div.innerHTML = `
        <div class="style-info-active">
            <div class="style-name-active">${style.name}</div>
            <div class="style-level-active">${getMasteryLevelName(level === 'maestro' ? 2 : 1)}</div>
            <div class="style-effects-active">${effectsText}</div>
        </div>
        <button class="style-toggle-btn ${isActive ? 'active' : ''}"
                onclick="toggleCombatStyle('${styleId}')">
            ${isActive ? 'Activo' : 'Activar'}
        </button>
    `;
    
    return div;
}

// Alternar estilo de combate activo
function toggleCombatStyle(styleId) {
    if (!characterSkills.activeCombatStyles) {
        characterSkills.activeCombatStyles = {};
    }
    
    characterSkills.activeCombatStyles[styleId] = !characterSkills.activeCombatStyles[styleId];
    renderCombatStylesInCombatTab();
    updateCombatStats();
}

// ==========================================
// FUNCIONES DE EQUIPO (PLACEHOLDER)
// ==========================================

// Obtener armadura equipada (placeholder)
function getEquippedArmor() {
    // Por ahora retorna armadura base, implementar cuando esté el sistema de equipo
    return BASIC_ARMOR[0]; // Sin armadura
}

// Obtener escudo equipado (placeholder)
function getEquippedShield() {
    // Por ahora retorna false, implementar cuando esté el sistema de equipo
    return false;
}

// Verificar si tiene estilo activo
function hasCombatStyleActive(styleId) {
    return characterSkills.activeCombatStyles?.[styleId] || false;
}

// Obtener nivel de estilo
function getCombatStyleLevel(styleId) {
    return characterSkills.combatStyles[styleId] || null;
}

// ==========================================
// ACTUALIZACIÓN DE STATS DE COMBATE
// ==========================================

// Actualizar todos los stats de combate
function updateCombatStats() {
    updateBaseGaco();
    updateArmorClass();
    updateInitiative();
    updateSavingThrows();
    updateAttacksPerRound();
    updateArmorBreakdown();
}

// Actualizar GACO base
function updateBaseGaco() {
    const baseGaco = calculateBaseGaco();
    
    // Actualizar en ambos lugares
    const combatGacoElement = document.getElementById('combatGaco');
    const gacoElement = document.getElementById('gaco');
    
    if (combatGacoElement) combatGacoElement.textContent = baseGaco;
    if (gacoElement) gacoElement.textContent = baseGaco;
}

// Actualizar CA
function updateArmorClass() {
    const ac = calculateArmorClass();
    
    // Actualizar en ambos lugares
    const combatACElement = document.getElementById('combatAC');
    const armorClassElement = document.getElementById('armorClass');
    
    if (combatACElement) combatACElement.textContent = ac;
    if (armorClassElement) armorClassElement.textContent = ac;
}

// Actualizar iniciativa
function updateInitiative() {
    const initiative = calculateInitiative();
    const initiativeText = initiative >= 0 ? `+${initiative}` : `${initiative}`;
    
    const combatInitiativeElement = document.getElementById('combatInitiative');
    const initiativeElement = document.getElementById('initiative');
    
    if (combatInitiativeElement) combatInitiativeElement.textContent = initiativeText;
    if (initiativeElement) initiativeElement.textContent = initiativeText;
}

// Actualizar tiradas de salvación (placeholder)
function updateSavingThrows() {
    const classGroup = getCurrentClassGroup();
    const level = getCurrentLevel();
    
    // Valores base por clase y nivel (simplificado)
    const saves = calculateBaseSavingThrows(classGroup, level);
    
    const saveElements = {
        'save-paralysis': saves.paralysis,
        'save-rods': saves.rods,
        'save-petrification': saves.petrification,
        'save-breath': saves.breath,
        'save-spells': saves.spells
    };
    
    Object.entries(saveElements).forEach(([elementId, value]) => {
        const element = document.getElementById(elementId);
        if (element) element.textContent = value;
    });
}

// Calcular salvaciones base (simplificado)
function calculateBaseSavingThrows(classGroup, level) {
    // Valores simplificados - implementar tabla completa después
    const baseSaves = {
        luchador: { paralysis: 14, rods: 16, petrification: 15, breath: 17, spells: 17 },
        sacerdote: { paralysis: 10, rods: 14, petrification: 13, breath: 16, spells: 15 },
        hechicero: { paralysis: 14, rods: 11, petrification: 13, breath: 15, spells: 12 },
        bribon: { paralysis: 13, rods: 14, petrification: 12, breath: 16, spells: 15 }
    };
    
    const base = baseSaves[classGroup] || baseSaves.luchador;
    const levelMod = Math.floor((level - 1) / 3); // Mejora cada 3 niveles
    
    return {
        paralysis: Math.max(2, base.paralysis - levelMod),
        rods: Math.max(2, base.rods - levelMod),
        petrification: Math.max(2, base.petrification - levelMod),
        breath: Math.max(2, base.breath - levelMod),
        spells: Math.max(2, base.spells - levelMod)
    };
}

// Actualizar ataques por ronda
function updateAttacksPerRound() {
    const classGroup = getCurrentClassGroup();
    const level = getCurrentLevel();
    
    let baseAttacks = 1;
    let specializationAttacks = 0;
    let styleAttacks = 0;
    
    // Ataques base por nivel (solo luchadores)
    if (classGroup === 'luchador' && level >= 7) {
        baseAttacks = level >= 13 ? 2 : 1.5; // 3/2 a nivel 7, 2/1 a nivel 13
    }
    
    // Ataques por especialización en armas
    Object.entries(characterSkills.weaponProficiencies).forEach(([weapon, level]) => {
        if (level >= 2) { // Especialización o superior
            specializationAttacks += 0.5 * (level - 1);
        }
    });
    
    // Ataques por estilos de combate
    if (hasCombatStyleActive('sin-armas')) {
        const level = getCombatStyleLevel('sin-armas');
        styleAttacks += level === 'maestro' ? 1 : 0.5;
    }
    
    if (hasCombatStyleActive('ballestas')) {
        const level = getCombatStyleLevel('ballestas');
        styleAttacks += level === 'maestro' ? 1 : 0.5;
    }
    
    const totalAttacks = baseAttacks + specializationAttacks + styleAttacks;
    
    // Actualizar elementos
    const elements = {
        'base-attacks-value': baseAttacks,
        'specialization-attacks-value': specializationAttacks > 0 ? `+${specializationAttacks}` : '+0',
        'style-attacks-value': styleAttacks > 0 ? `+${styleAttacks}` : '+0',
        'total-attacks-value': totalAttacks
    };
    
    Object.entries(elements).forEach(([elementId, value]) => {
        const element = document.getElementById(elementId);
        if (element) element.textContent = value;
    });
}

// Actualizar desglose de CA
function updateArmorBreakdown() {
    const equippedArmor = getEquippedArmor();
    const dexScore = getAbilityScore('dexterity');
    const dexMod = getAbilityModifier(dexScore, 'dexterity-defensive');
    const hasShield = getEquippedShield();
    
    let acBase = equippedArmor ? equippedArmor.ac : 10;
    let acDex = dexMod;
    let acShield = 0;
    let acStyle = 0;
    let acMagic = 0;
    
    if (hasShield) {
        acShield = 1;
        if (hasCombatStyleActive('arma-y-escudo')) {
            acStyle += 2;
        }
    }
    
    if (hasCombatStyleActive('arma-unica')) {
        const level = getCombatStyleLevel('arma-unica');
        acStyle += level === 'maestro' ? 2 : 1;
    }
    
    if (hasCombatStyleActive('sin-armas')) {
        acStyle += 4;
    }
    
    const totalAC = acBase - acDex - acShield - acStyle - acMagic;
    
    // Actualizar elementos
    const elements = {
        'ac-base-armor': acBase,
        'ac-dex-mod': acDex > 0 ? `+${acDex}` : `${acDex}`,
        'ac-shield': acShield > 0 ? `+${acShield}` : '+0',
        'ac-style-bonus': acStyle > 0 ? `+${acStyle}` : '+0',
        'ac-magic-bonus': acMagic > 0 ? `+${acMagic}` : '+0',
        'ac-total': totalAC
    };
    
    Object.entries(elements).forEach(([elementId, value]) => {
        const element = document.getElementById(elementId);
        if (element) element.textContent = value;
    });
}

// ==========================================
// EVENTOS Y FILTROS
// ==========================================

// Event listeners para búsqueda y filtros
function setupSkillsEventListeners() {
    // Búsqueda de armas
    const weaponSearch = document.getElementById('weapon-search');
    if (weaponSearch) {
        weaponSearch.addEventListener('input', renderWeaponProficiencies);
    }
    
    // Búsqueda de pericias
    const skillSearch = document.getElementById('skill-search');
    if (skillSearch) {
        skillSearch.addEventListener('input', renderNonWeaponProficiencies);
    }
    
    // Filtro de grupos
    const groupFilter = document.getElementById('skill-group-filter');
    if (groupFilter) {
        groupFilter.addEventListener('change', renderNonWeaponProficiencies);
    }
}

// ==========================================
// INICIALIZACIÓN
// ==========================================

// Inicializar sistema de pericias
function initializeSkillsSystem() {
    loadSkillsData();
    renderWeaponProficiencies();
    renderCombatStyles();
    renderCombatStylesInCombatTab();
    updateCombatStats();
    setupSkillsEventListeners();
}

// Ejecutar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    // Esperar un poco para asegurar que otros sistemas estén cargados
    setTimeout(initializeSkillsSystem, 100);
});

// También ejecutar cuando se cambie de clase o nivel
function onCharacterChanged() {
    renderWeaponProficiencies();
    renderNonWeaponProficiencies();
    renderCombatStyles();
    renderCombatStylesInCombatTab();
    updateCombatStats();
}

// Hook para integrar con el sistema existente
if (window.AbilityCalculator) {
    const originalCalculateModifiers = window.AbilityCalculator.calculateModifiers;
    window.AbilityCalculator.calculateModifiers = function() {
        if (originalCalculateModifiers) {
            originalCalculateModifiers.call(this);
        }
        updateCombatStats();
    };
}
              
        function updateClassSelection() {
            character.specificClass = document.getElementById('specificClass').value;
            updateCharacterDisplay();
        }

        function updateLevel() {
            const level = parseInt(document.getElementById('level').value) || 1;
            character.level = level;
            document.getElementById('characterLevelDisplay').textContent = level;
        }

        function updateFromXP() {
            const xp = parseInt(document.getElementById('experience').value) || 0;
            character.experience = xp;
            
            // Basic XP to level conversion (can be refined)
            let level = 1;
            if (xp >= 2000) level = 2;
            if (xp >= 4000) level = 3;
            if (xp >= 8000) level = 4;
            if (xp >= 16000) level = 5;
            if (xp >= 32000) level = 6;
            if (xp >= 64000) level = 7;
            if (xp >= 125000) level = 8;
            if (xp >= 250000) level = 9;
            if (xp >= 500000) level = 10;
            
            document.getElementById('level').value = level;
            updateLevel();
        }

        // Ability score functions
        function calculateModifiers() {
            const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
            
            abilities.forEach(ability => {
                const score = parseInt(document.getElementById(ability).value) || 10;
                character.abilities[ability] = score;
                
                let modifier = 0;
                if (score <= 3) modifier = -3;
                else if (score <= 5) modifier = -2;
                else if (score <= 8) modifier = -1;
                else if (score <= 12) modifier = 0;
                else if (score <= 15) modifier = 1;
                else if (score <= 17) modifier = 2;
                else modifier = 3;
                
                const modElement = document.getElementById(ability.substring(0, 3) + 'Mod');
                modElement.textContent = modifier >= 0 ? '+' + modifier : modifier.toString();
                
                // Update modifier classes
                modElement.className = 'ability-modifier ';
                if (modifier > 0) modElement.className += 'modifier-positive';
                else if (modifier < 0) modElement.className += 'modifier-negative';
                else modElement.className += 'modifier-zero';
            });
            
            // Update constitution bonus info
            updateConstitutionBonus();
            updateArmorStats(); // Update AC with dexterity changes
        }

        function updateConstitutionBonus() {
            const con = character.abilities.constitution;
            const conData = abilityModifiers.constitution[con] || { hp: 0, shock: 70, resurrection: 75 };
            
            document.getElementById('conHPBonus').textContent = `HP por nivel: ${conData.hp >= 0 ? '+' : ''}${conData.hp}`;
            document.getElementById('conShockSurvival').textContent = `Shock del sistema: ${conData.shock}%`;
            document.getElementById('conResurrection').textContent = `Supervivencia/Revivir: ${conData.resurrection}%`;
            
            document.getElementById('constitutionBonusInfo').style.display = 'block';
        }

        function rollAbilities() {
            const abilities = ['strength', 'dexterity', 'constitution', 'intelligence', 'wisdom', 'charisma'];
            
            abilities.forEach(ability => {
                // Roll 4d6, drop lowest
                const rolls = [];
                for (let i = 0; i < 4; i++) {
                    rolls.push(Math.floor(Math.random() * 6) + 1);
                }
                rolls.sort((a, b) => b - a);
                const total = rolls[0] + rolls[1] + rolls[2];
                
                document.getElementById(ability).value = total;
            });
            
            calculateModifiers();
            showNotification('Habilidades rodadas con 4d6, descartando el menor');
        }

        function rollHitPoints() {
            let hitDie = 8; // Default
            if (character.primaryClass && classData[character.primaryClass]) {
                const die = classData[character.primaryClass].hitDie;
                hitDie = parseInt(die.substring(1));
            }
            
            const roll = Math.floor(Math.random() * hitDie) + 1;
            const conBonus = abilityModifiers.constitution[character.abilities.constitution]?.hp || 0;
            const total = Math.max(1, roll + conBonus);
            
            character.hitPoints = total;
            document.getElementById('totalHP').textContent = total;
            document.getElementById('combatHP').textContent = total;
            
            showNotification(`HP rodados: ${roll} + ${conBonus} (CON) = ${total}`);
        }

        function rollDice(sides) {
            const roll = Math.floor(Math.random() * sides) + 1;
            showNotification(`d${sides}: ${roll}`);
        }

// Función para actualizar el tamaño del personaje basado en la altura
function updateCharacterSize() {
    const heightInput = document.getElementById('characterHeight');
    const sizeInput = document.getElementById('characterSize');
    
    if (!heightInput || !sizeInput) return;
    
    const height = parseInt(heightInput.value) || 0;
    let size = 'Mediano'; // Valor por defecto
    
    if (height >= 1 && height <= 30) {
        size = 'Diminuto';
    } else if (height >= 31 && height <= 60) {
        size = 'Minúsculo';
    } else if (height >= 61 && height <= 120) {
        size = 'Pequeño';
    } else if (height >= 121 && height <= 240) {
        size = 'Mediano';
    } else if (height >= 241 && height <= 480) {
        size = 'Grande';
    } else if (height >= 481 && height <= 960) {
        size = 'Enorme';
    } else if (height >= 961 && height <= 2000) {
        size = 'Gargantuesco';
    } else if (height > 2000) {
        size = 'Colosal';
    }
    
    sizeInput.value = size;
    
    console.log(`Altura: ${height}cm → Tamaño: ${size}`);
}
// Tabla de experiencia por clase
const xpTables = {
    guerrero: [0, 2000, 4000, 8000, 16000, 32000, 64000, 125000, 250000, 500000, 750000, 1000000, 1250000, 1500000, 1750000, 2000000, 2250000, 2500000, 2750000, 3000000],
    
    luchador: [0, 2250, 4500, 9000, 18000, 32000, 75000, 150000, 300000, 600000, 900000, 1200000, 1500000, 1800000, 2100000, 2400000, 2700000, 3000000, 3300000, 3600000],
    
    hechicero: [0, 2500, 5000, 10000, 20000, 40000, 60000, 90000, 135000, 250000, 375000, 750000, 1125000, 1500000, 1875000, 2250000, 2625000, 3000000, 3375000, 3750000],
    
    clerigo: [0, 1500, 3000, 6000, 13000, 27500, 55000, 110000, 225000, 450000, 675000, 900000, 1125000, 1350000, 1575000, 1800000, 2025000, 2250000, 2475000, 2700000],
    
    druida: [0, 2000, 4000, 7500, 12500, 20000, 35000, 60000, 90000, 125000, 200000, 300000, 750000, 1500000, 3000000, 3500000, 500000, 1500000, 1500000, 2000000], // Nivel 17 = 500000
    
    ladron: [0, 1250, 2500, 5000, 10000, 20000, 40000, 70000, 110000, 160000, 220000, 440000, 660000, 880000, 1100000, 1320000, 1540000, 1760000, 1980000, 2200000]
};

// Mapeo de clases a tablas
const classToTable = {
    'guerrero': 'guerrero',
    'ranger': 'luchador',
    'bárbaro': 'luchador', 
    'paladín': 'luchador',
    'samurái': 'luchador',
    'mago': 'hechicero',
    'hechicero': 'hechicero',
    'bruja': 'hechicero',
    'artífice': 'hechicero',
    'clérigo': 'clerigo',
    'chamán': 'clerigo',
    'druida': 'druida',
    'ladrón': 'ladron',
    'bardo': 'ladron',
    'ninja': 'ladron',
    'psiónico': 'ladron',
    'pistolero': 'ladron'
};

// Función para determinar si es humano
function isHuman() {
    const race = document.getElementById('race')?.value?.toLowerCase() || '';
    return race === 'humano' || race === '';
}

// Función para obtener todas las clases activas
function getActiveClasses() {
    const classes = [];
    
    // Clase principal
    const primary = document.getElementById('primary-selected-name')?.textContent;
    if (primary && primary !== 'Selecciona una clase') {
        classes.push(primary.toLowerCase());
    }
    
    // Clase secundaria
    const secondary = document.getElementById('secondary-selected-name')?.textContent;
    if (secondary && secondary !== 'Selecciona una clase' && secondary !== 'Selecciona primero una categoría principal') {
        classes.push(secondary.toLowerCase());
    }
    
    // Clase terciaria
    const tertiary = document.getElementById('tertiary-selected-name')?.textContent;
    if (tertiary && tertiary !== 'Selecciona una clase' && tertiary !== 'Selecciona primero una categoría secundaria') {
        classes.push(tertiary.toLowerCase());
    }
    
    return classes;
}

// Función para calcular XP requerida para multiclase
function calculateMulticlassXP(level, classes, isHumanRace) {
    if (classes.length === 0) return 0;
    
    let totalXP = 0;
    
    classes.forEach(className => {
        const tableKey = classToTable[className] || 'ladron';
        const table = xpTables[tableKey];
        
        if (level <= table.length) {
            let classXP = table[level - 1] || 0;
            
            // Aplicar penalización por raza no humana
            if (!isHumanRace) {
                classXP *= 2;
            }
            
            totalXP += classXP;
        }
    });
    
    // Para multiclase, dividir entre número de clases
    if (classes.length > 1) {
        totalXP = Math.floor(totalXP / classes.length);
    }
    
    return totalXP;
}

// Función principal para actualizar desde XP
function updateFromXP() {
    const xpInput = document.getElementById('experience');
    if (!xpInput) return;
    
    const currentXP = parseInt(xpInput.value) || 0;
    const classes = getActiveClasses();
    const isHumanRace = isHuman();
    
    if (classes.length === 0) {
        showNextLevelInfo(currentXP, 1, null, 'No hay clases seleccionadas');
        return;
    }
    
    // Calcular nivel actual
    let currentLevel = 1;
    for (let testLevel = 2; testLevel <= 20; testLevel++) {
        const requiredXP = calculateMulticlassXP(testLevel, classes, isHumanRace);
        if (currentXP >= requiredXP) {
            currentLevel = testLevel;
        } else {
            break;
        }
    }
    
    // Calcular XP para siguiente nivel
    let nextLevelXP = null;
    if (currentLevel < 20) {
        nextLevelXP = calculateMulticlassXP(currentLevel + 1, classes, isHumanRace);
    }
    
    // Actualizar displays
    const levelDisplay = document.getElementById('characterLevelDisplay');
    if (levelDisplay) {
        levelDisplay.textContent = currentLevel;
    }
    
    const levelField = document.getElementById('Level');
    if (levelField) {
        levelField.value = currentLevel;
    }
    
    // Mostrar información detallada
    showNextLevelInfo(currentXP, currentLevel, nextLevelXP, classes, isHumanRace);
    
    // Actualizar cálculos de combate
    if (typeof updateAllCombatStats === 'function') {
        updateAllCombatStats();
    }
}

// Función para mostrar información del siguiente nivel
function showNextLevelInfo(currentXP, currentLevel, nextLevelXP, classes, isHumanRace) {
    let infoElement = document.getElementById('nextLevelInfo');
    if (!infoElement) {
        infoElement = document.createElement('div');
        infoElement.id = 'nextLevelInfo';
        infoElement.style.cssText = `
            margin-top: 0.5rem;
            padding: 0.8rem;
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            border-radius: 6px;
            font-size: 0.85rem;
            color: #ffd700;
            line-height: 1.4;
        `;
        
        const xpInput = document.getElementById('experience');
        if (xpInput && xpInput.parentNode) {
            xpInput.parentNode.appendChild(infoElement);
        }
    }
    
    if (typeof classes === 'string') {
        // Caso de error
        infoElement.innerHTML = `<span style="color: #ff6b6b">${classes}</span>`;
        return;
    }
    
    let info = `<strong>Nivel ${currentLevel}</strong>`;
    
    // Mostrar clases activas
    if (classes && classes.length > 0) {
        info += `<br><small>Clases: ${classes.join(', ')}</small>`;
        
        if (classes.length > 1) {
            info += `<br><small>Multiclase (XP promediado)</small>`;
        }
        
        if (!isHumanRace) {
            info += `<br><small style="color: #ffed4e">Raza no humana (XP x2)</small>`;
        }
    }
    
    if (nextLevelXP) {
        const xpNeeded = nextLevelXP - currentXP;
        const percentage = Math.min(100, (currentXP / nextLevelXP) * 100);
        
        info += `<br><br><strong>Siguiente nivel (${currentLevel + 1}):</strong>`;
        info += `<br>Requiere: ${nextLevelXP.toLocaleString()} XP`;
        info += `<br>Faltan: <span style="color: #ffed4e">${xpNeeded.toLocaleString()} XP</span>`;
        info += `<br><small>Progreso: ${percentage.toFixed(1)}%</small>`;
        
        // Barra de progreso visual
        info += `<div style="
            width: 100%; 
            height: 8px; 
            background: rgba(0,0,0,0.3); 
            border-radius: 4px; 
            margin-top: 4px;
            overflow: hidden;
        ">
            <div style="
                width: ${percentage}%; 
                height: 100%; 
                background: linear-gradient(90deg, #ffd700, #ffed4e);
                transition: width 0.3s ease;
            "></div>
        </div>`;
    } else {
        info += `<br><br><span style="color: #00ff7f">¡Nivel máximo alcanzado!</span>`;
    }
    
    infoElement.innerHTML = info;
}

// Event listeners para actualizar cuando cambien las clases
function setupXPListeners() {
    const classElements = [
        'primary-selected-name',
        'secondary-selected-name', 
        'tertiary-selected-name',
        'race'
    ];
    
    classElements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            // Observer para detectar cambios en el texto
            const observer = new MutationObserver(() => {
                setTimeout(updateFromXP, 100);
            });
            observer.observe(element, { childList: true, characterData: true, subtree: true });
        }
    });
}

// Inicializar listeners cuando cargue la página
document.addEventListener('DOMContentLoaded', function() {
    setupXPListeners();
    // Actualizar una vez al cargar
    setTimeout(updateFromXP, 500);
});
              
        // Spell system functions (simplified placeholders)
        function updateSpellList() {
            const casterType = document.getElementById('casterType').value;
            document.getElementById('onlineSearchBtn').disabled = !casterType;
            document.getElementById('addSpellBtn').disabled = !casterType;
            
            if (casterType) {
                showNotification(`Tipo de lanzador seleccionado: ${casterType}`);
            }
        }

        function filterSpells() {
            showNotification('Función de filtrado implementada');
        }

        function searchSpells() {
            showNotification('Función de búsqueda implementada');
        }

        function browseSpellLists() {
            showNotification('Lista de conjuros en desarrollo');
        }

        function searchSpellOnline() {
            showNotification('Búsqueda online en desarrollo');
        }

        function parseSpellsFromText() {
            showNotification('Importación de texto en desarrollo');
        }

        function exportCustomSpells() {
            showNotification('Exportación en desarrollo');
        }

        function importCustomSpells() {
            showNotification('Importación JSON en desarrollo');
        }

        function addCustomSpell() {
            showNotification('Añadir conjuro manual en desarrollo');
        }

        // Character management
        function saveCharacter() {
            const characterData = JSON.stringify(character, null, 2);
            showNotification('Personaje guardado en memoria (localStorage no disponible)');
            console.log('Character data:', characterData);
        }

        function exportCharacter() {
            const characterData = JSON.stringify(character, null, 2);
            const blob = new Blob([characterData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${character.name || 'personaje'}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Personaje exportado como archivo JSON');
        }

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            calculateModifiers();
            updateArmorStats();
            
            // Initialize all equipment slots as empty
            Object.keys(character.equipment).forEach(slot => {
                updateEquipmentSlot(slot, null);
            });
        });
 // ==========================================
// SISTEMA DE SALVACIONES Y STATS MEJORADO
// ==========================================

// Datos de salvaciones por clase y nivel
const SAVING_THROWS_TABLE = {
    'bribon': {
        '1-4': { paralysis: 13, rods: 14, petrification: 12, breath: 16, spells: 15 },
        '5-8': { paralysis: 12, rods: 12, petrification: 11, breath: 15, spells: 13 },
        '9-12': { paralysis: 11, rods: 10, petrification: 10, breath: 14, spells: 11 },
        '13-16': { paralysis: 10, rods: 8, petrification: 9, breath: 13, spells: 9 },
        '17-20': { paralysis: 9, rods: 6, petrification: 8, breath: 12, spells: 7 },
        '21+': { paralysis: 8, rods: 7, petrification: 4, breath: 11, spells: 5 }
    },
    'hechicero': {
        '1-5': { paralysis: 14, rods: 11, petrification: 13, breath: 15, spells: 12 },
        '6-10': { paralysis: 13, rods: 9, petrification: 11, breath: 13, spells: 10 },
        '11-15': { paralysis: 11, rods: 7, petrification: 9, breath: 11, spells: 8 },
        '16-20': { paralysis: 10, rods: 5, petrification: 7, breath: 9, spells: 6 },
        '21+': { paralysis: 8, rods: 3, petrification: 5, breath: 7, spells: 4 }
    },
    'luchador': {
        '0': { paralysis: 16, rods: 18, petrification: 17, breath: 20, spells: 19 },
        '1-2': { paralysis: 14, rods: 16, petrification: 15, breath: 17, spells: 17 },
        '3-4': { paralysis: 13, rods: 15, petrification: 14, breath: 16, spells: 16 },
        '5-6': { paralysis: 11, rods: 13, petrification: 12, breath: 13, spells: 14 },
        '7-8': { paralysis: 10, rods: 12, petrification: 11, breath: 12, spells: 13 },
        '9-10': { paralysis: 8, rods: 10, petrification: 9, breath: 9, spells: 11 },
        '11-12': { paralysis: 7, rods: 9, petrification: 8, breath: 8, spells: 10 },
        '13-14': { paralysis: 5, rods: 7, petrification: 6, breath: 5, spells: 8 },
        '15-16': { paralysis: 4, rods: 6, petrification: 5, breath: 4, spells: 7 },
        '17-20': { paralysis: 3, rods: 5, petrification: 4, breath: 4, spells: 6 },
        '21+': { paralysis: 2, rods: 4, petrification: 3, breath: 4, spells: 5 }
    },
    'sacerdote': {
        '1-3': { paralysis: 10, rods: 14, petrification: 13, breath: 16, spells: 15 },
        '4-6': { paralysis: 9, rods: 12, petrification: 12, breath: 15, spells: 14 },
        '7-9': { paralysis: 7, rods: 11, petrification: 10, breath: 13, spells: 12 },
        '10-12': { paralysis: 6, rods: 10, petrification: 9, breath: 12, spells: 11 },
        '13-15': { paralysis: 5, rods: 9, petrification: 8, breath: 11, spells: 10 },
        '16-18': { paralysis: 4, rods: 8, petrification: 7, breath: 10, spells: 9 },
        '19-20': { paralysis: 2, rods: 6, petrification: 5, breath: 8, spells: 7 },
        '21+': { paralysis: 2, rods: 5, petrification: 4, breath: 7, spells: 6 }
    }
};

// Tabla PSP por puntuación de característica
const PSP_TABLE = {
    5: { base: 0, modifier: 0 }, 6: { base: 2, modifier: 0 }, 7: { base: 4, modifier: 0 },
    8: { base: 6, modifier: 0 }, 9: { base: 8, modifier: 0 }, 10: { base: 10, modifier: 0 },
    11: { base: 12, modifier: 0 }, 12: { base: 14, modifier: 0 }, 13: { base: 16, modifier: 0 },
    14: { base: 18, modifier: 0 }, 15: { base: 20, modifier: 0 }, 16: { base: 22, modifier: 1 },
    17: { base: 24, modifier: 2 }, 18: { base: 26, modifier: 3 }, 19: { base: 28, modifier: 4 },
    20: { base: 30, modifier: 5 }, 21: { base: 32, modifier: 6 }, 22: { base: 34, modifier: 7 },
    23: { base: 36, modifier: 8 }, 24: { base: 38, modifier: 9 }, 25: { base: 40, modifier: 10 },
    26: { base: 42, modifier: 11 }, 27: { base: 44, modifier: 12 }, 28: { base: 46, modifier: 13 },
    29: { base: 48, modifier: 14 }, 30: { base: 50, modifier: 15 }, 31: { base: 52, modifier: 16 },
    32: { base: 54, modifier: 17 }, 33: { base: 56, modifier: 18 }, 34: { base: 58, modifier: 19 },
    35: { base: 60, modifier: 20 }, 36: { base: 62, modifier: 21 }, 37: { base: 64, modifier: 22 },
    38: { base: 66, modifier: 23 }, 39: { base: 68, modifier: 24 }, 40: { base: 70, modifier: 25 },
    41: { base: 72, modifier: 26 }, 42: { base: 74, modifier: 27 }, 43: { base: 76, modifier: 28 },
    44: { base: 78, modifier: 29 }, 45: { base: 80, modifier: 30 }, 46: { base: 82, modifier: 31 },
    47: { base: 84, modifier: 32 }, 48: { base: 86, modifier: 33 }, 49: { base: 88, modifier: 34 },
    50: { base: 90, modifier: 35 }, 51: { base: 92, modifier: 36 }, 52: { base: 94, modifier: 37 },
    53: { base: 96, modifier: 38 }, 54: { base: 98, modifier: 39 }, 55: { base: 100, modifier: 40 },
    56: { base: 102, modifier: 41 }, 57: { base: 104, modifier: 42 }, 58: { base: 106, modifier: 43 },
    59: { base: 108, modifier: 44 }, 60: { base: 110, modifier: 45 }, 61: { base: 112, modifier: 46 },
    62: { base: 114, modifier: 47 }, 63: { base: 116, modifier: 48 }, 64: { base: 118, modifier: 49 },
    65: { base: 120, modifier: 50 }
};

// Dados de golpe por clase
const HIT_DICE = {
    'luchador': 10,
    'sacerdote': 8,
    'bribon': 6,
    'hechicero': 4
};

// ==========================================
// FUNCIONES DE UTILIDAD
// ==========================================

// Obtener nivel de rango para salvaciones
function getSavingThrowLevelRange(classGroup, level) {
    const ranges = Object.keys(SAVING_THROWS_TABLE[classGroup] || {});
    
    for (const range of ranges) {
        if (range === '21+' && level >= 21) return range;
        if (range === '0' && level === 0) return range;
        
        if (range.includes('-')) {
            const [min, max] = range.split('-').map(n => parseInt(n));
            if (level >= min && level <= max) return range;
        }
    }
    
    return ranges[0] || '1-2'; // Fallback
}

// Obtener clases activas del personaje
function getActiveClasses() {
    const classes = [];
    const primary = document.getElementById('primary-selected-name')?.textContent;
    const secondary = document.getElementById('secondary-selected-name')?.textContent;
    const tertiary = document.getElementById('tertiary-selected-name')?.textContent;
    
    if (primary && primary !== 'Selecciona una clase') classes.push(primary);
    if (secondary && secondary !== 'Selecciona una clase') classes.push(secondary);
    if (tertiary && tertiary !== 'Selecciona una clase') classes.push(tertiary);
    
    return classes;
}

// Verificar si es multiclase
function isMulticlass() {
    return getActiveClasses().length > 1;
}

// Verificar si tiene una clase específica
function hasClassInGroup(targetGroup) {
    const activeClasses = getActiveClasses();
    return activeClasses.some(className => {
        for (const [group, classes] of Object.entries(CLASS_GROUPS)) {
            if (group === targetGroup && classes.includes(className)) {
                return true;
            }
        }
        return false;
    });
}

// Obtener bonificación de HP por constitución
function getConstitutionHPBonus() {
    const constitution = parseInt(document.getElementById('constitution')?.value) || 10;
    
    if (window.AbilityCalculator && window.AbilityCalculator.abilityData) {
        const constitutionData = window.AbilityCalculator.abilityData.constitucion;
        const entry = constitutionData.find(row => 
            parseInt(row['Puntuación habilidad']) === constitution
        );
        
        if (entry) {
            return parseInt(entry['Bonif HP/Nivel']) || 0;
        }
    }
    
    // Fallback calculation
    if (constitution <= 3) return -2;
    if (constitution <= 6) return -1;
    if (constitution <= 14) return 0;
    if (constitution <= 16) return 2;
    if (constitution === 17) return 2;
    if (constitution === 18) return 3;
    return Math.floor((constitution - 15) / 2);
}

// ==========================================
// ACTUALIZACIÓN DE SALVACIONES
// ==========================================

function updateSavingThrows() {
    const classGroup = getCurrentClassGroup();
    const level = getCurrentLevel();
    const levelRange = getSavingThrowLevelRange(classGroup, level);
    
    const baseSaves = SAVING_THROWS_TABLE[classGroup]?.[levelRange] || {
        paralysis: 15, rods: 15, petrification: 15, breath: 15, spells: 15
    };
    
    // Actualizar cada tipo de salvación
    const saveTypes = ['paralysis', 'rods', 'petrification', 'breath', 'spells'];
    
    saveTypes.forEach(saveType => {
        const baseValue = baseSaves[saveType];
        const mod1 = parseInt(document.getElementById(`save-${saveType}-mod1`)?.value) || 0;
        const mod2 = parseInt(document.getElementById(`save-${saveType}-mod2`)?.value) || 0;
        const total = baseValue - mod1 - mod2;
        
        // Actualizar elementos
        const baseElement = document.getElementById(`save-${saveType}-base`);
        const totalElement = document.getElementById(`save-${saveType}-total`);
        
        if (baseElement) baseElement.textContent = baseValue;
        if (totalElement) totalElement.textContent = Math.max(1, total); // Mínimo 1
    });
}

// ==========================================
// PUNTOS DE GOLPE
// ==========================================

function updateHitPoints() {
    const level = getCurrentLevel();
    const constitutionBonus = getConstitutionHPBonus();
    const manualBonus = parseInt(document.getElementById('hp-manual-bonus')?.value) || 0;
    
    let hpPerLevel = 0;
    let totalHP = 0;
    
    if (isMulticlass()) {
        // Multiclase: promedio de dados de golpe
        const activeClasses = getActiveClasses();
        const classGroups = activeClasses.map(className => {
            for (const [group, classes] of Object.entries(CLASS_GROUPS)) {
                if (classes.includes(className)) return group;
            }
            return 'luchador'; // Fallback
        });
        
        const hitDiceSum = classGroups.reduce((sum, group) => sum + HIT_DICE[group], 0);
        hpPerLevel = Math.floor(hitDiceSum / classGroups.length) + constitutionBonus;
        
        // Nivel 1: 10 + bonus, niveles siguientes: promedio + bonus
        totalHP = 10 + constitutionBonus; // Nivel 1
        if (level > 1) {
            totalHP += (level - 1) * hpPerLevel;
        }
    } else {
        // Clase única
        const classGroup = getCurrentClassGroup();
        const hitDie = HIT_DICE[classGroup] || 10;
        hpPerLevel = hitDie + constitutionBonus;
        
        // Nivel 1: 10 + bonus, niveles siguientes: dado + bonus
        totalHP = 10 + constitutionBonus; // Nivel 1
        if (level > 1) {
            totalHP += (level - 1) * hpPerLevel;
        }
    }
    
    const finalTotal = totalHP + manualBonus;
    
    // Actualizar elementos
    const totalHPElement = document.getElementById('totalHP');
    const breakdownElement = document.getElementById('hp-breakdown');
    
    if (totalHPElement) totalHPElement.textContent = finalTotal;
    if (breakdownElement) {
        if (level === 1) {
            breakdownElement.textContent = manualBonus > 0 ? `10 + ${manualBonus}` : '10';
        } else {
            breakdownElement.textContent = manualBonus > 0 
                ? `${hpPerLevel}/${totalHP} + ${manualBonus}` 
                : `${hpPerLevel}/${totalHP}`;
        }
    }
}

// ==========================================
// MANÁ ARCANO
// ==========================================

function updateArcaneMana() {
    const manaCard = document.getElementById('arcane-mana-card');
    
    if (!hasClassInGroup('hechicero')) {
        if (manaCard) manaCard.style.display = 'none';
        return;
    }
    
    if (manaCard) manaCard.style.display = 'block';
    
    const level = getCurrentLevel();
    const intelligence = parseInt(document.getElementById('intelligence')?.value) || 10;
    const constitution = parseInt(document.getElementById('constitution')?.value) || 10;
    const manualBonus = parseInt(document.getElementById('arcane-mana-manual')?.value) || 0;
    
    // Maná por nivel: (Int + 1) + (Con / 4)
    const manaPerLevel = (intelligence + 1) + Math.floor(constitution / 4);
    const totalMana = level * manaPerLevel;
    const finalTotal = totalMana + manualBonus;
    
    // Actualizar elementos
    const manaElement = document.getElementById('arcaneMana');
    const breakdownElement = document.getElementById('arcane-mana-breakdown');
    
    if (manaElement) manaElement.textContent = finalTotal;
    if (breakdownElement) {
        breakdownElement.textContent = manualBonus > 0 
            ? `${manaPerLevel}/${totalMana} + ${manualBonus}` 
            : `${manaPerLevel}/${totalMana}`;
    }
}

// ==========================================
// MANÁ DIVINO
// ==========================================

function updateDivineMana() {
    const manaCard = document.getElementById('divine-mana-card');
    
    if (!hasClassInGroup('sacerdote')) {
        if (manaCard) manaCard.style.display = 'none';
        return;
    }
    
    if (manaCard) manaCard.style.display = 'block';
    
    const level = getCurrentLevel();
    const wisdom = parseInt(document.getElementById('wisdom')?.value) || 10;
    const constitution = parseInt(document.getElementById('constitution')?.value) || 10;
    
    // Maná por nivel: (Sab + 1) + (Con / 4)
    const manaPerLevel = (wisdom + 1) + Math.floor(constitution / 4);
    const totalMana = level * manaPerLevel;
    const finalTotal = totalMana + manualBonus;
    
    // Actualizar elementos
    const manaElement = document.getElementById('divineMana');
    const breakdownElement = document.getElementById('divine-mana-breakdown');
    
    if (manaElement) manaElement.textContent = finalTotal;
    if (breakdownElement) {
        breakdownElement.textContent = manualBonus > 0 
            ? `${manaPerLevel}/${totalMana} + ${manualBonus}` 
            : `${manaPerLevel}/${totalMana}`;
    }
}

// ==========================================
// POOL DE PSP (PSIÓNICO)
// ==========================================

function updatePSPPool() {
    const pspCard = document.getElementById('psp-card');
    const activeClasses = getActiveClasses();
    const isPsionic = activeClasses.some(className => className === 'Psiónico');
    
    if (!isPsionic) {
        if (pspCard) pspCard.style.display = 'none';
        return;
    }
    
    if (pspCard) pspCard.style.display = 'block';
    
    const level = getCurrentLevel();
    const wisdom = parseInt(document.getElementById('wisdom')?.value) || 10;
    const constitution = parseInt(document.getElementById('constitution')?.value) || 10;
    const intelligence = parseInt(document.getElementById('intelligence')?.value) || 10;
    const manualBonus = parseInt(document.getElementById('psp-manual')?.value) || 0;
    
    // Obtener modificadores de la tabla PSP
    const wisdomPSP = PSP_TABLE[Math.min(65, Math.max(5, wisdom))] || PSP_TABLE[10];
    const constitutionPSP = PSP_TABLE[Math.min(65, Math.max(5, constitution))] || PSP_TABLE[10];
    const intelligencePSP = PSP_TABLE[Math.min(65, Math.max(5, intelligence))] || PSP_TABLE[10];
    
    let totalPSP = 0;
    
    if (level === 1) {
        // Nivel 1: Base de Sabiduría + Mod. Constitución + Mod. Inteligencia
        totalPSP = wisdomPSP.base + constitutionPSP.modifier + intelligencePSP.modifier;
    } else {
        // Nivel 1 base + niveles adicionales
        const basePSP = wisdomPSP.base + constitutionPSP.modifier + intelligencePSP.modifier;
        const additionalPSP = (level - 1) * (10 + wisdomPSP.modifier);
        totalPSP = basePSP + additionalPSP;
    }
    
    const finalTotal = totalPSP + manualBonus;
    
    // Actualizar elementos
    const pspElement = document.getElementById('pspPool');
    const breakdownElement = document.getElementById('psp-breakdown');
    
    if (pspElement) pspElement.textContent = finalTotal;
    if (breakdownElement) {
        if (level === 1) {
            breakdownElement.textContent = manualBonus > 0 
                ? `Base: ${totalPSP} + ${manualBonus}` 
                : `Base: ${totalPSP}`;
        } else {
            const perLevelGain = 10 + wisdomPSP.modifier;
            breakdownElement.textContent = manualBonus > 0 
                ? `${perLevelGain}/niv + ${manualBonus}` 
                : `${perLevelGain}/nivel`;
        }
    }
}

// ==========================================
// FUNCIONES DE ACTUALIZACIÓN GENERAL
// ==========================================

// Actualizar todos los stats cuando cambie algo
function updateAllStats() {
    updateSavingThrows();
    updateHitPoints();
    updateArcaneMana();
    updateDivineMana();
    updatePSPPool();
}

// Integrar con el sistema existente
function integrateWithExistingSystem() {
    // Hook en el calculador de habilidades existente
    if (window.AbilityCalculator) {
        const originalCalculateModifiers = window.AbilityCalculator.calculateModifiers;
        window.AbilityCalculator.calculateModifiers = function() {
            if (originalCalculateModifiers) {
                originalCalculateModifiers.call(this);
            }
            // Actualizar nuestros stats después del cálculo de habilidades
            setTimeout(updateAllStats, 50);
        };
    }
    
    // Hook en cambios de nivel
    const levelInput = document.getElementById('characterLevel');
    if (levelInput) {
        levelInput.addEventListener('input', updateAllStats);
    }
    
    // Hook en cambios de experiencia
    const expInput = document.getElementById('experience');
    if (expInput) {
        expInput.addEventListener('input', updateAllStats);
    }
    
    // Hook en cambios de clase (si existe la función)
    if (window.selectPrimaryCategory) {
        const originalSelectPrimary = window.selectPrimaryCategory;
        window.selectPrimaryCategory = function(category) {
            originalSelectPrimary(category);
            setTimeout(updateAllStats, 100);
        };
    }
    
    if (window.selectSecondaryCategory) {
        const originalSelectSecondary = window.selectSecondaryCategory;
        window.selectSecondaryCategory = function(category) {
            originalSelectSecondary(category);
            setTimeout(updateAllStats, 100);
        };
    }
    
    // Actualizar cuando se cargue la página
    setTimeout(updateAllStats, 200);
}

// ==========================================
// FUNCIONES DE COMPATIBILIDAD
// ==========================================

// Usar las funciones existentes del sistema principal si están disponibles
if (typeof getCurrentClassGroup === 'undefined') {
    window.getCurrentClassGroup = function() {
        const primaryClass = document.getElementById('primary-selected-name')?.textContent || '';
        
        const CLASS_GROUPS_LOCAL = {
            'luchador': ['Bárbaro', 'Ranger', 'Guerrero', 'Paladín', 'Samurái'],
            'sacerdote': ['Clérigo', 'Druida', 'Chamán'],
            'hechicero': ['Mago', 'Hechicero', 'Bruja', 'Artífice'],
            'bribon': ['Ladrón', 'Bardo', 'Ninja', 'Psiónico', 'Pistolero']
        };
        
        for (const [group, classes] of Object.entries(CLASS_GROUPS_LOCAL)) {
            if (classes.includes(primaryClass)) {
                return group;
            }
        }
        return 'luchador'; // Default
    };
}

if (typeof getCurrentLevel === 'undefined') {
    window.getCurrentLevel = function() {
        return parseInt(document.getElementById('characterLevel')?.value) || 1;
    };
}

// Definir CLASS_GROUPS si no existe
if (typeof CLASS_GROUPS === 'undefined') {
    window.CLASS_GROUPS = {
        'luchador': ['Bárbaro', 'Ranger', 'Guerrero', 'Paladín', 'Samurái'],
        'sacerdote': ['Clérigo', 'Druida', 'Chamán'],
        'hechicero': ['Mago', 'Hechicero', 'Bruja', 'Artífice'],
        'bribon': ['Ladrón', 'Bardo', 'Ninja', 'Psiónico', 'Pistolero']
    };
}

// ==========================================
// INICIALIZACIÓN
// ==========================================

// Ejecutar cuando el DOM esté listo
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(integrateWithExistingSystem, 300);
});

// También ejecutar si ya está cargado
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(integrateWithExistingSystem, 300);
    });
} else {
    setTimeout(integrateWithExistingSystem, 300);
}

// Exponer funciones globalmente para uso manual
window.updateSavingThrows = updateSavingThrows;
window.updateHitPoints = updateHitPoints;
window.updateArcaneMana = updateArcaneMana;
window.updateDivineMana = updateDivineMana;
window.updatePSPPool = updatePSPPool;
window.updateAllStats = updateAllStats;             
    </script>
</body>
</html> 
